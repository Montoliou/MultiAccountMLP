<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Der Flow - Vom Einkommen zum Vermögen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- v2.0: Inter-Font entfernt — Arial ist MLP-Systemfont, kein CDN nötig -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.5"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ═══════════════════════════════════════════════════════
           v2.0 Design Token System — EINZIGER :root Block
           MLP Finanzberatung SE Corporate Design
           ═══════════════════════════════════════════════════════ */
        :root {
            /* ── MLP Brand Colors ── */
            --mlp-primary: #033D5D;
            --mlp-secondary: #BEB6AA;
            --mlp-accent: #47A190;

            /* ── Text ── */
            --mlp-text-dark: #2B2B2B;
            --mlp-text-medium: #717171;
            --mlp-text-light: #FFFFFF;

            /* ── Backgrounds ── */
            --mlp-bg-white: #FFFFFF;
            --mlp-bg-gray: #F8F8F8;

            /* ── Functional (semantisch) ── */
            --mlp-info: #047584;
            --mlp-success: #13853E;
            --mlp-warning: #E3691E;
            --mlp-error: #C1293D;

            /* ── Spacing (8px Grid) ── */
            --space-xs: 8px; --space-sm: 16px; --space-md: 24px;
            --space-lg: 32px; --space-xl: 48px; --space-xxl: 64px;

            /* ── Typography ── */
            --font-family: Arial, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --font-size-body: 16px; --font-size-small: 14px;
            --font-size-h1: 32px; --font-size-h2: 24px; --font-size-h3: 20px;

            /* ── Shadows & Radius ── */
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-elevated: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-modal: 0 25px 50px -12px rgba(0,0,0,0.5);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px;

            /* ── Backwards-Kompatibilität (100+ var()-Referenzen) ── */
            --mlp-corporate-blue: var(--mlp-primary);
            --mlp-titanium: var(--mlp-secondary);
            --mlp-turkis: var(--mlp-accent);
            --mlp-blue: var(--mlp-primary);
            --mlp-blue-primary: var(--mlp-primary);
            --mlp-blue-dark: var(--mlp-primary);
            --mlp-blue-light: var(--mlp-accent);
            --mlp-blue-1: var(--mlp-primary);
            --mlp-blue-2: #2a6a8a;
            --mlp-gold: var(--mlp-secondary);
            --mlp-platin: var(--mlp-secondary);
            --color-success: var(--mlp-success);
            --color-warning: var(--mlp-warning);
            --color-error: var(--mlp-error);
            --color-error-dark: #A1223A;
            --color-error-light: #E8A0AA;

            /* ── Gray Scale (Tailwind-Kompatibilität) ── */
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
            --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937;
            --gray-900: #111827;

            --input-bg: #ffffff;
            --input-border: #BEB6AA;
        }

        body { font-family: var(--font-family); }
        .skip-link { position: absolute; left: -1000px; top: auto; width: 1px; height: 1px; overflow: hidden; }
        .skip-link:focus { left: 50%; top: 1rem; width: auto; height: auto; padding: 0.75rem 1rem; background: var(--mlp-blue-primary); color: #ffffff; border-radius: 999px; transform: translateX(-50%); z-index: 9999; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
        .account-basin {
            background-color: var(--card); border: 1px solid var(--border); padding: 1rem; border-radius: 0.75rem;
            text-align: center; width: 220px; height: 140px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out; position: absolute; z-index: 10; overflow: hidden;
        }
        button.account-basin { appearance: none; background-color: var(--card); color: inherit; border: 1px solid var(--border); }
        button.account-basin:hover { border-color: var(--mlp-primary); box-shadow: var(--shadow-subtle); }
        button.account-basin:focus { outline: none; }
        button.account-basin:focus-visible { outline: 3px solid var(--mlp-primary); outline-offset: 4px; }
        .flow-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; overflow: visible; }
        .flow-path { fill: none; stroke: var(--mlp-blue-1); stroke: url(#flow-gradient); stroke-linecap: round; stroke-linejoin: round; transition: opacity 0.5s, stroke-width 0.5s; opacity: 0; }
        .flow-path.active { opacity: 1; }
        .flow-path-animation { stroke: white; stroke-width: 2px; stroke-dasharray: 10 15; animation: flow 2s linear infinite; opacity: 0; transition: opacity 0.5s; }
        .flow-path.active + .flow-path-animation { opacity: 0.6; }
        /* Erase any underlay with background color (covers legacy grey ribbons) */
        .flow-erase {
          fill: none;
          stroke-linecap: round;
          stroke-linejoin: round;
          opacity: 1;
          pointer-events: none;
          shape-rendering: geometricPrecision;
        }
        .theme-light .flow-erase { stroke: #ffffff !important; }
        .theme-dark  .flow-erase { stroke: var(--gray-900) !important; }
        /* Light theme: full blue flows, no grey halo */
        .theme-light .flow-path { stroke: var(--mlp-blue-1); filter: none; }
        .theme-light .flow-path-animation { stroke: #2f6fb2; stroke-dasharray: 8 14; opacity: .9; }
        .flow-dot { fill: var(--mlp-blue-light); opacity: .95; }
        .theme-light .flow-dot { fill: var(--mlp-blue-2); }
        @keyframes flow { from { stroke-dashoffset: 0; } to { stroke-dashoffset: -25; } }
        .flow-label { position: absolute; color: var(--gray-400); font-size: 0.75rem; font-weight: 500; z-index: 15; transform: translate(-50%, -130%); white-space: nowrap; transition: top 0.3s, left 0.3s; }
        /* Better readability for labels on blue rivers (light) */
        .theme-light .flow-label {
          color: var(--fg);
          background: rgba(255,255,255,.95);
          border: 1px solid var(--border);
          padding: 2px 6px;
          border-radius: 999px;
          line-height: 1.1;
          box-shadow: 0 1px 2px rgba(0,0,0,.06);
        }
        .flow-value { position: absolute; background-color: var(--bg); color: var(--muted); padding: 4px 10px; border-radius: 9999px; font-size: 0.9rem; font-weight: 600; z-index: 15; border: 1px solid var(--border); white-space: nowrap; transform: translate(-50%, -50%); transition: top 0.3s, left 0.3s; }
        .limit-line { position: absolute; width: 100%; height: 2px; left: 0; z-index: 12; }
        .limit-line span { position: absolute; right: 4px; transform: translateY(-50%); font-size: 10px; background: var(--gray-800); padding: 0 3px; font-weight: 500;}
        /* v2.0: Smooth Modal Animations */
        .modal {
            display: flex !important;
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s;
        }
        .modal-active {
            opacity: 1; visibility: visible; pointer-events: auto;
        }
        .modal > [role="document"], .modal > div:first-child {
            transform: translateY(12px) scale(0.98);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-active > [role="document"], .modal-active > div:first-child {
            transform: translateY(0) scale(1);
        }
        .schutzschirm {
            fill: rgba(3, 61, 93, 0.12);
            stroke: rgba(71, 161, 144, 0.4);
            stroke-width: 2px;
            transition: opacity 0.5s, fill 0.5s, stroke 0.5s;
            animation: pulse-shield 4s infinite ease-in-out;
            pointer-events: none;
        }

        /* v1.6.1: Schutzschild Info-Badge (Redesigned - Dezent & Click-triggered) */
        .schutzschild {
            cursor: pointer; /* Make shield clickable */
        }

        .schutzschild-badge {
            position: absolute;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 4px;
            background: white;
            border: 1px solid var(--mlp-corporate-blue);
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 120px;
            font-size: 10px;
        }

        .schutzschild-badge--visible {
            display: flex;
        }

        .schutzschild-badge-icon {
            font-size: 14px;
            line-height: 1;
            text-align: center;
            margin-bottom: 2px;
        }

        .schutzschild-badge-title {
            font-size: 9px;
            font-weight: 600;
            color: var(--mlp-corporate-blue);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
        }

        .schutzschild-badge-puffer {
            font-size: 11px;
            font-weight: 700;
            color: var(--gray-800);
            text-align: center;
        }

        .schutzschild-badge-amount {
            font-size: 9px;
            color: var(--gray-600);
            text-align: center;
        }

        /* Color states for badge */
        .schutzschild-badge--green { border-color: var(--color-success); }
        .schutzschild-badge--green .schutzschild-badge-title { color: var(--color-success); }
        .schutzschild-badge--yellow { border-color: var(--color-warning); }
        .schutzschild-badge--yellow .schutzschild-badge-title { color: var(--color-warning); }
        .schutzschild-badge--red { border-color: var(--color-error); }
        .schutzschild-badge--red .schutzschild-badge-title { color: var(--color-error); }

        /* Animations */
        @keyframes fadeInBadge {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulseShield {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 0 transparent);
            }
            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 8px currentColor);
            }
        }

        .schutzschild-badge--fade-in {
            animation: fadeInBadge 0.4s ease-out;
        }

        .basin--pulse-green {
            animation: pulseShield 0.6s ease-in-out;
            color: rgba(16, 185, 129, 0.6);
        }

        .basin--pulse-yellow {
            animation: pulseShield 0.6s ease-in-out;
            color: rgba(251, 191, 36, 0.6);
        }

        .basin--pulse-red {
            animation: pulseShield 0.6s ease-in-out;
            color: rgba(239, 68, 68, 0.6);
        }

        .shield--pulse-green {
            animation: pulseShield 0.6s ease-in-out;
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.6));
        }

        .shield--pulse-yellow {
            animation: pulseShield 0.6s ease-in-out;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
        }

        .shield--pulse-red {
            animation: pulseShield 0.6s ease-in-out;
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6));
        }

        /* v1.6.1 Level 2: Enterprise-Style Shield Impact Flash (on tooltip hover) */
        .shield--impact-green {
            animation: shieldImpact 1.5s ease-out infinite;
            filter: drop-shadow(0 0 20px rgba(16, 185, 129, 1));
        }

        .shield--impact-yellow {
            animation: shieldImpact 1s ease-out infinite;
            filter: drop-shadow(0 0 20px rgba(251, 191, 36, 1));
        }

        .shield--impact-red {
            animation: shieldImpact 0.6s ease-out infinite;
            filter: drop-shadow(0 0 20px rgba(239, 68, 68, 1));
        }

        @keyframes shieldImpact {
            0% {
                opacity: 1;
                filter: brightness(3) drop-shadow(0 0 30px currentColor);
            }
            10% {
                opacity: 0.9;
                filter: brightness(2) drop-shadow(0 0 25px currentColor);
            }
            30% {
                opacity: 0.7;
                filter: brightness(1.2) drop-shadow(0 0 15px currentColor);
            }
            100% {
                opacity: 0.5;
                filter: brightness(1) drop-shadow(0 0 8px currentColor);
            }
        }

        /* v1.6.1 Level 2: Hover-Tooltip (compact, basin-style) */
        .schutzschild-tooltip {
            position: absolute;
            display: none;
            flex-direction: column;
            background: rgba(14, 40, 61, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 110;
            width: 200px;
            font-size: 11px;
            line-height: 1.4;
        }

        .schutzschild-tooltip--visible {
            display: flex;
        }

        .schutzschild-tooltip-puffer {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .schutzschild-tooltip-icon {
            font-size: 16px;
            filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.6));
        }

        .schutzschild-tooltip-puffer-text {
            flex: 1;
        }

        .schutzschild-tooltip-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.15);
            margin: 8px 0;
        }

        .schutzschild-tooltip-benefit {
            color: rgba(255, 255, 255, 0.9);
            font-size: 11px;
            line-height: 1.5;
        }

        /* Color states for tooltip */
        .schutzschild-tooltip--green {
            border-color: rgba(16, 185, 129, 0.4);
        }

        .schutzschild-tooltip--green .schutzschild-tooltip-icon {
            filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.8));
        }

        .schutzschild-tooltip--yellow {
            border-color: rgba(251, 191, 36, 0.4);
        }

        .schutzschild-tooltip--yellow .schutzschild-tooltip-icon {
            filter: drop-shadow(0 0 6px rgba(251, 191, 36, 0.8));
        }

        .schutzschild-tooltip--red {
            border-color: rgba(239, 68, 68, 0.4);
        }

        .schutzschild-tooltip--red .schutzschild-tooltip-icon {
            filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.8));
        }

        /* v1.6.1 Level 2: Tooltip Connection Line Animation */
        .tooltip-connection-line {
            stroke-width: 2.5px;
            stroke-dasharray: 10 15;
            animation: flow 2s linear infinite;
            opacity: 0.8;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--gray-700); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #printable-report { display: none; }

        /* No-print class for elements that should never be printed */
        @media print {
          /* Page setup: minimal margins for maximum content space */
          @page {
            size: A4;
            margin: 8mm 10mm;
          }

          .no-print { display: none !important; }

          /* Hide everything except the report */
          body > *:not(#printable-report) { display: none !important; }

          /* Report container */
          #printable-report {
            display: block;
            color: #000;
            background: #fff;
            padding: 8mm 10mm;
            max-width: 100%;
            overflow: hidden;
          }

          /* Images: use transform scale for guaranteed sizing */
          #printable-report img {
            max-width: none !important;
            width: auto !important;
            height: auto !important;
            transform: scale(0.38) !important;
            transform-origin: center top !important;
            display: block !important;
            margin: 0 auto !important;
            page-break-inside: avoid !important;
          }

          /* Headers */
          #printable-report h1 {
            font-size: 24pt;
            margin-bottom: 12pt;
            color: var(--mlp-blue-dark);
          }

          #printable-report h2 {
            font-size: 16pt;
            margin-top: 20pt;
            margin-bottom: 10pt;
            color: var(--mlp-blue-dark);
            break-after: avoid;
            page-break-after: avoid;
          }

          #printable-report p.muted {
            font-size: 10pt;
            color: #666;
            margin-bottom: 8pt;
          }

          /* Tables */
          .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 2rem;
            break-inside: avoid;
            page-break-inside: avoid;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }

          .print-table th, .print-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            font-size: 10pt;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }

          .print-table th {
            background-color: #f2f2f2;
            font-weight: bold;
          }

          /* Sum rows in tables */
          .print-table tr.sum-row th,
          .print-table tr.sum-row td {
            font-weight: bold;
            background-color: #e8e8e8;
            border-top: 2px solid #999;
          }

          /* Positive/Negative values */
          .text-positive { color: #059669; font-weight: 600; }
          .text-negative { color: #dc2626; font-weight: 600; }

          /* Prevent orphaned table headers */
          .print-table thead {
            break-after: avoid;
            page-break-after: avoid;
          }

          /* Print breaks */
          .print-break {
            page-break-after: always;
            break-after: page;
            height: 1px;
          }

          /* Eigene Seite für den Finanzfluss */
          .print-finanzfluss {
            break-before: page;
            page-break-before: always;
          }

          /* Verhindert „hängende" Überschrift am Seitenende */
          .print-finanzfluss h2 {
            break-after: avoid;
            page-break-after: avoid;
          }

          /* v1.7.2: Educational module sections in PDF */
          .print-erklaerer {
            break-before: page;
            page-break-before: always;
            padding: 20px 0;
          }

          .print-erklaerer h2 {
            color: #033D5D;
            margin-bottom: 10px;
            break-after: avoid;
            page-break-after: avoid;
          }

          .print-erklaerer h3 {
            color: #033D5D;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1em;
          }

          .erklaerer-summary {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #033D5D;
            border-radius: 4px;
          }

          .erklaerer-summary p {
            margin-bottom: 12px;
            line-height: 1.6;
          }

          .erklaerer-summary ul {
            margin: 10px 0 10px 20px;
            line-height: 1.8;
          }

          .erklaerer-summary li {
            margin-bottom: 8px;
          }

          /* Optimize flowchart container for print */
          #flow-container-print {
            break-inside: avoid;
            page-break-inside: avoid;
            transform: scale(0.75) !important;
            transform-origin: top center !important;
            width: 1100px !important;
            margin: 0 auto -380px auto !important;
            position: relative !important;
            left: 50% !important;
            margin-left: -720px !important;
          }
        }

        /* === THEME TOKENS (Dark stays default) === */
        /* v2.0: Zweiter :root-Block entfernt — alle Tokens jetzt im einzigen :root oben */
        /* v2.0: Theme-Klassen mit korrekten MLP-Farben */
        .theme-dark {
          --bg: #111827;
          --fg: #FFFFFF;
          --card: #1f2937;
          --border: #374151;
          --muted: #9ca3af;
          --accent1: var(--mlp-primary);     /* MLP Blau statt Tailwind Blau */
          --accent2: var(--mlp-accent);      /* Türkis statt Indigo */
          --input-bg: rgba(17, 24, 39, 0.92);
          --input-border: #374151;
        }
        .theme-light {
          --bg: var(--mlp-bg-white);
          --fg: var(--mlp-text-dark);
          --card: var(--mlp-bg-gray);
          --border: var(--mlp-secondary);    /* Titanium */
          --muted: var(--mlp-text-medium);
          --accent1: var(--mlp-primary);
          --accent2: var(--mlp-accent);      /* Türkis statt Gold */
          --input-bg: var(--mlp-bg-white);
          --input-border: var(--mlp-secondary);
        }

        /* Base background/text via CSS vars (keine Änderung an Tailwind nötig) */
        body { background: var(--bg); color: var(--fg); }

        /* === HORIZONTAL GRADIENT ZONES === */
        .gradient-zone {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 100vw;
            pointer-events: none;
            z-index: 0;
            transition: opacity 0.6s ease;
        }

        /* Ebene 1: WOLKEN - Einkommen (Himmelblau, luftig) */
        .gradient-zone-1 {
            background: linear-gradient(
                to bottom,
                rgba(100, 180, 255, 0.15) 0%,
                rgba(60, 120, 200, 0.20) 100%
            );
        }

        /* Ebene 2: HORIZONT - Girokonten (Grau-Blau, geerdet) */
        .gradient-zone-2 {
            background: linear-gradient(
                to bottom,
                rgba(60, 120, 200, 0.20) 0%,
                rgba(70, 90, 120, 0.25) 100%
            );
        }

        /* Ebene 3: SCHUPPEN - Liquidität (Dunkel-Teal, geschützt) */
        .gradient-zone-3 {
            background: linear-gradient(
                to bottom,
                rgba(70, 90, 120, 0.25) 0%,
                rgba(40, 80, 100, 0.30) 100%
            );
        }

        /* Ebene 4: FELDER - Vermögensaufbau (MLP Platin, fruchtbar) */
        .gradient-zone-4 {
            background: linear-gradient(
                to bottom,
                rgba(40, 80, 100, 0.30) 0%,
                rgba(189, 161, 119, 0.25) 50%,
                rgba(189, 161, 119, 0.35) 100%
            );
        }

        /* Light Theme - Metapher bleibt, nur heller */
        .theme-light .gradient-zone-1 {
            background: linear-gradient(
                to bottom,
                rgba(100, 180, 255, 0.10) 0%,
                rgba(60, 120, 200, 0.12) 100%
            );
        }

        .theme-light .gradient-zone-2 {
            background: linear-gradient(
                to bottom,
                rgba(60, 120, 200, 0.12) 0%,
                rgba(70, 90, 120, 0.15) 100%
            );
        }

        .theme-light .gradient-zone-3 {
            background: linear-gradient(
                to bottom,
                rgba(70, 90, 120, 0.15) 0%,
                rgba(40, 80, 100, 0.18) 100%
            );
        }

        .theme-light .gradient-zone-4 {
            background: linear-gradient(
                to bottom,
                rgba(40, 80, 100, 0.18) 0%,
                rgba(189, 161, 119, 0.15) 50%,
                rgba(189, 161, 119, 0.22) 100%
            );
        }

        /* === SESSION MODAL OVERLAY (v2.0) === */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s;
        }

        .modal-overlay.modal-active {
            opacity: 1; visibility: visible; pointer-events: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-modal);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(12px) scale(0.98);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.modal-active .modal-content {
            transform: translateY(0) scale(1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Smooth scrollbar for modal content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }

        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border: 0;
        }

        /* Planning cockpit */
        .planning-panel{position:relative;background:var(--card);border-radius:24px;border:1px solid var(--border);padding:clamp(2.4rem,3vw+2rem,3.5rem) clamp(1.6rem,2vw+1.2rem,2.6rem);display:flex;flex-direction:column;gap:1.75rem;box-shadow:0 24px 48px -28px rgba(0,47,108,0.45);}
        .theme-dark .planning-panel{background:linear-gradient(150deg,#1e293b 0%,#0f172a 100%);border-color:rgba(148,163,184,0.15);box-shadow:0 35px 55px -35px rgba(15,23,42,0.8);}
        .panel-header{display:flex;flex-direction:column;gap:1.5rem;align-items:flex-start;}
        @media (min-width:768px){.panel-header{flex-direction:row;justify-content:space-between;align-items:flex-end;gap:2rem;}}
        .panel-title{max-width:420px;display:flex;flex-direction:column;gap:.4rem;align-items:flex-start;text-align:left;padding-left:1.5rem;}
        .panel-eyebrow{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:700;}
        .panel-title h2{margin:0;font-size:clamp(1.9rem,2vw+1.6rem,2.4rem);font-weight:700;color:var(--fg);}
        /* v1.5.2: Removed .panel-controls (moved to Control Bar in v1.4.0) */
        .control-chip{position:relative;display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border:1px solid var(--border);border-radius:14px;background:rgba(0,47,108,0.04);transition:all .25s ease;cursor:pointer;}
        .control-chip:focus-within{box-shadow:0 0 0 3px rgba(0,47,108,0.18);}
        .theme-dark .control-chip{background:rgba(148,163,184,0.08);border-color:rgba(148,163,184,0.2);}
        .control-chip input{position:absolute;inset:0;opacity:0;cursor:pointer;}
        .chip-icon,.chip-pair{display:flex;align-items:center;justify-content:center;width:100%;height:100%;border-radius:inherit;background:transparent;gap:.2rem;transition:background .25s ease,color .25s ease;}
        .control-chip .icon{width:18px;height:18px;color:var(--muted);transition:opacity .2s ease,transform .2s ease;}
        .control-chip--toggle .icon-moon{opacity:0;transform:scale(.65);}
        .control-chip--toggle input:checked + .chip-icon{background:rgba(0,47,108,0.08);}
        .theme-light .control-chip--toggle input:checked + .chip-icon{background:rgba(0,47,108,0.12);}
        .control-chip--toggle input:checked + .chip-icon .icon-sun{opacity:0;transform:scale(.65);}
        .control-chip--toggle input:checked + .chip-icon .icon-moon{opacity:1;transform:scale(1);}
        .control-chip--toggle input:checked + .chip-icon .icon{color:var(--accent1);}
        .chip-pair{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.2rem;align-items:center;justify-items:center;}
        .chip-state{display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:999px;font-size:.8rem;font-weight:600;color:var(--muted);background:rgba(0,47,108,0.05);transition:all .2s ease;}
        .theme-dark .chip-state{background:rgba(148,163,184,0.12);color:#cbd5f5;}
        .chip-state--active{color:#ffffff;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 10px 18px -12px rgba(0,47,108,0.6);}
        .theme-dark .chip-state--active{background:linear-gradient(135deg,#60a5fa,#818cf8);box-shadow:0 0 10px rgba(96,165,250,0.45),0 10px 18px -12px rgba(96,165,250,0.3);}
        .control-chip--consultation{width:44px;}
        .control-chip--consultation .chip-button{display:flex;align-items:center;justify-content:center;width:100%;height:100%;border:none;background:transparent;color:var(--muted);cursor:pointer;transition:color .2s ease,background .2s ease;}
        .control-chip--consultation .chip-button:hover{color:var(--accent1);}
        .control-chip--consultation .chip-button .icon{width:20px;height:20px;}
        .control-chip--consultation .chip-button.hidden{display:none;}
        .control-chip--consultation.is-active{background:linear-gradient(135deg,var(--accent1),var(--accent2));border-color:transparent;box-shadow:0 10px 18px -12px rgba(0,47,108,0.6);}
        .control-chip--consultation.is-active .chip-button .icon{color:#ffffff;}

        /* ========================================
           CONTROL BAR (v1.4.0) - Top-Right Fixed
           ======================================== */
        #control-bar {
            position: fixed;
            top: 16px; /* 2 * 8px grid */
            right: 16px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px; /* 8px grid */
            padding: 8px;
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.25s ease;
        }
        .theme-dark #control-bar {
            background: rgba(15, 23, 42, 0.90);
            border-color: rgba(148, 163, 184, 0.2);
        }

        /* Control Bar Items (same as control-chip but adapted) */
        .control-bar-item {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 44px; /* Touch target minimum */
            height: 44px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(0, 47, 108, 0.04);
            transition: all 0.25s ease;
            cursor: pointer;
        }
        .control-bar-item:hover {
            border-color: var(--accent1);
            color: var(--accent1);
        }
        .control-bar-item:focus-within {
            box-shadow: 0 0 0 3px rgba(0, 47, 108, 0.18);
        }
        .theme-dark .control-bar-item {
            background: rgba(148, 163, 184, 0.08);
            border-color: rgba(148, 163, 184, 0.2);
        }

        /* Theme Toggle */
        .control-bar-item--theme input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .control-bar-item--theme .bar-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border-radius: inherit;
        }
        .control-bar-item--theme .icon {
            width: 18px;
            height: 18px;
            color: var(--muted);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .control-bar-item--theme .icon-moon {
            opacity: 0;
            transform: scale(0.65);
        }
        .control-bar-item--theme input:checked + .bar-icon {
            background: rgba(0, 47, 108, 0.08);
        }
        .theme-light .control-bar-item--theme input:checked + .bar-icon {
            background: rgba(0, 47, 108, 0.12);
        }
        .control-bar-item--theme input:checked + .bar-icon .icon-sun {
            opacity: 0;
            transform: scale(0.65);
        }
        .control-bar-item--theme input:checked + .bar-icon .icon-moon {
            opacity: 1;
            transform: scale(1);
        }
        .control-bar-item--theme input:checked + .bar-icon .icon {
            color: var(--accent1);
        }

        /* Variant Toggle */
        .control-bar-item--variant {
            min-width: 64px; /* Space for A|B */
        }
        .control-bar-item--variant input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .control-bar-item--variant .bar-pair {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 4px; /* Half of 8px for tight grouping */
            align-items: center;
            justify-items: center;
            width: 100%;
            height: 100%;
            padding: 6px;
        }
        .control-bar-item--variant .bar-state {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--muted);
            background: rgba(0, 47, 108, 0.05);
            transition: all 0.2s ease;
        }
        .theme-dark .control-bar-item--variant .bar-state {
            background: rgba(148, 163, 184, 0.12);
            color: #cbd5f5;
        }
        .control-bar-item--variant .bar-state--active {
            color: #ffffff;
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            box-shadow: 0 4px 8px -4px rgba(0, 47, 108, 0.6);
        }
        .theme-dark .control-bar-item--variant .bar-state--active {
            background: linear-gradient(135deg, #60a5fa, #818cf8);
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.45), 0 4px 8px -4px rgba(96, 165, 250, 0.3);
        }

        /* Consultation Button */
        .control-bar-item--consultation {
            min-width: 44px;
        }
        .control-bar-item--consultation .bar-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .control-bar-item--consultation .bar-button:hover {
            color: var(--accent1);
        }
        .control-bar-item--consultation .bar-button .icon {
            width: 20px;
            height: 20px;
        }
        .control-bar-item--consultation .bar-button.hidden {
            display: none;
        }
        .control-bar-item--consultation.is-active {
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            border-color: transparent;
            box-shadow: 0 4px 8px -4px rgba(0, 47, 108, 0.6);
        }
        .control-bar-item--consultation.is-active .bar-button .icon {
            color: #ffffff;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #control-bar {
                top: 64px; /* Below session button */
                right: 16px;
                flex-direction: column;
                gap: 8px;
            }
        }

        /* ========================================
           INLINE EDITOR (v1.4.0) - Basin Editing
           ======================================== */
        .account-basin--editable {
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .account-basin--editable:hover {
            border-color: var(--accent1) !important;
            box-shadow: 0 0 0 3px rgba(3, 61, 93, 0.18);
        }

        /* Inline Editor Overlay */
        .basin-inline-editor {
            position: fixed; /* Fixed statt absolute - schwebt über allem */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999; /* Sehr hoch, über allem */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px; /* 2 * 8px grid */
            padding: 40px; /* 5 * 8px grid - viel Platz */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            min-width: 400px; /* Mindestbreite */
            max-width: 90vw; /* Max 90% Viewport-Breite */

            /* Smooth animation without transform conflict */
            opacity: 0;
            animation: smoothFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        .theme-dark .basin-inline-editor {
            background: rgba(15, 23, 42, 0.98);
        }

        /* Backdrop for inline editor */
        .basin-inline-backdrop {
            position: fixed;
            inset: 0;
            z-index: 9998;
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: backdropFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Smooth Animations */
        @keyframes smoothFadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -48%);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes smoothFadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -48%);
            }
        }

        @keyframes backdropFadeIn {
            0% {
                opacity: 0;
                background: rgba(0, 0, 0, 0);
                backdrop-filter: blur(0px);
            }
            100% {
                opacity: 1;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
            }
        }

        @keyframes backdropFadeOut {
            0% {
                opacity: 1;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
            }
            100% {
                opacity: 0;
                background: rgba(0, 0, 0, 0);
                backdrop-filter: blur(0px);
            }
        }

        /* Old animations - keep for backward compatibility */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Inline Editor Input */
        .basin-inline-input {
            width: 100%;
            max-width: 280px;
            padding: 10px 12px; /* 8px grid: kompakter für Dual-Input */
            font-size: 1rem; /* 16px - kleiner für mehr Platz */
            font-weight: 600;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            color: var(--fg);
            transition: all 0.25s ease;
            font-family: 'Courier New', monospace;
        }
        .basin-inline-input:focus {
            outline: none;
            border-color: var(--accent1);
            box-shadow: 0 0 0 3px rgba(3, 61, 93, 0.18);
        }
        .basin-inline-input::placeholder {
            color: var(--muted);
            opacity: 0.6;
        }

        /* Inline Editor Label */
        .basin-inline-label {
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Inline Editor Hint */
        .basin-inline-hint {
            font-size: 0.75rem; /* 12px */
            color: var(--muted);
            text-align: center;
        }

        /* Inline Editor Button Group */
        .basin-inline-buttons {
            display: flex;
            gap: 8px; /* 8px grid */
            margin-top: 8px;
        }

        .basin-inline-btn {
            padding: 8px 16px; /* 8px grid: 1 * 8, 2 * 8 */
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--fg);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .basin-inline-btn:hover {
            border-color: var(--accent1);
            color: var(--accent1);
        }
        .basin-inline-btn--primary {
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            color: #ffffff;
            border-color: transparent;
        }
        .basin-inline-btn--primary:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 8px rgba(3, 61, 93, 0.3);
        }

        /* Multi-Input Grid (for Konsum, Tagesgeld) */
        .basin-inline-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; /* 1.5 * 8px grid - kompakter */
            width: 100%;
            max-width: 360px; /* Etwas kleiner für bessere Passform */
        }

        .basin-inline-field {
            display: flex;
            flex-direction: column;
            gap: 6px; /* Kompakter Gap */
        }

        .basin-inline-field .basin-inline-input {
            max-width: 100%; /* Volle Breite im Grid */
            font-size: 0.9rem; /* Noch kleiner für Dual-Input */
            padding: 8px 10px;
        }

        /* Edit Indicator (Pencil Icon) - v1.5.3: 44px minimum touch target (WCAG 2.1 AA) */
        .basin-edit-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(3, 61, 93, 0.15);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        .account-basin--editable:hover .basin-edit-indicator {
            opacity: 1;
        }
        .basin-edit-indicator svg {
            width: 16px;
            height: 16px;
            color: var(--accent1);
        }

        /* ========================================
           FAB (Floating Action Button) - v1.4.0
           ======================================== */
        #booking-fab {
            position: fixed;
            bottom: 24px; /* 3 * 8px grid */
            right: 24px;
            z-index: 1000;
            width: 56px; /* Material Design Standard */
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(3, 61, 93, 0.4);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
        }

        #booking-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(3, 61, 93, 0.5);
        }

        #booking-fab:active {
            transform: scale(0.95);
        }

        #booking-fab svg {
            width: 24px;
            height: 24px;
            color: #ffffff;
        }

        /* FAB Label (appears on hover) */
        .fab-label {
            position: absolute;
            right: 72px; /* 56px FAB + 16px gap */
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transform: translateX(8px);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #booking-fab:hover .fab-label {
            opacity: 1;
            transform: translateX(0);
        }

        /* Booking Modal (v1.4.0) */
        #booking-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            padding: 24px;
            animation: fadeIn 0.3s ease;
        }

        #booking-modal.active {
            display: flex;
        }

        .booking-modal-content {
            background: var(--bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: smoothFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .booking-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
        }

        .booking-modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--fg);
            margin: 0;
        }

        .booking-modal-close {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .booking-modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--fg);
        }

        .theme-dark .booking-modal-close:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .booking-modal-body {
            padding: 32px;
            overflow-y: auto;
        }

        /* Mobile: FAB anpassen */
        @media (max-width: 768px) {
            #booking-fab {
                bottom: 80px; /* Platz für Session-Button */
                right: 16px;
                width: 48px;
                height: 48px;
            }
            #booking-fab svg {
                width: 20px;
                height: 20px;
            }
            .fab-label {
                display: none; /* Kein Label auf Mobile */
            }
        }

        /* v1.5.3: Button minimum heights aligned to 44px touch target (WCAG 2.1 AA) */
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:.35rem;border-radius:999px;font-weight:600;transition:all .25s ease;cursor:pointer;border:none;min-height:44px;}
        .btn:focus{outline:none;}
        .btn:focus-visible{outline:3px solid var(--accent1);outline-offset:4px;}
        .btn-sm{font-size:.85rem;padding:.55rem 1rem;}
        .btn-lg{font-size:.95rem;padding:.85rem 1.5rem;min-height:48px;}
        .btn-block{width:100%;}
        .btn-primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;}
        .btn-primary:hover{filter:brightness(1.05);box-shadow:0 18px 32px -18px rgba(0,47,108,0.65);}
        .btn-secondary{background:transparent;border:1px solid var(--border);color:var(--fg);}
        .btn-secondary:hover{border-color:var(--accent1);color:var(--accent1);box-shadow:0 0 0 3px rgba(0,47,108,0.12);}
        .btn-ghost{background:transparent;color:var(--muted);}
        .btn-ghost:hover{color:var(--accent1);}
        .panel-note{display:flex;align-items:flex-start;gap:.75rem;font-size:.85rem;color:var(--muted);background:rgba(0,47,108,0.05);border-radius:14px;padding:.9rem 1.1rem;border:1px solid rgba(0,47,108,0.1);}
        .panel-note::before{content:'i';display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:rgba(0,47,108,0.12);color:var(--accent1);font-weight:700;flex-shrink:0;}
        .theme-dark .panel-note{background:rgba(148,163,184,0.08);border-color:rgba(148,163,184,0.16);color:#e2e8f0;}
        .theme-dark .panel-note::before{background:rgba(99,102,241,0.2);color:var(--accent2);}
        .panel-body{display:flex;flex-direction:column;gap:1.25rem;}
        .panel-section{display:flex;flex-direction:column;gap:1rem;padding:1.25rem 1.35rem 1.5rem;border-radius:18px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.7)0%,rgba(244,247,252,0.85)100%);}
        .theme-dark .panel-section{background:rgba(15,23,42,0.55);border-color:rgba(148,163,184,0.12);}
        .panel-section[data-tone="blue"] .section-heading h3{color:var(--accent1);}
        .panel-section[data-tone="gold"] .section-heading h3{color:var(--mlp-gold);}
        .panel-section[data-tone="teal"] .section-heading h3{color:#3aa8a2;}
        .panel-section[data-tone="slate"] .section-heading h3{color:#4c65a8;}
        .section-heading{display:flex;flex-direction:column;gap:.35rem;}
        .section-heading h3{margin:0;font-size:1.2rem;font-weight:700;color:var(--fg);}
        .section-heading .section-subtitle{font-size:.75rem;font-weight:600;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;}
        .section-eyebrow{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:700;}
        .section-grid{display:grid;gap:1rem;}
        .section-grid--two{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
        .section-stack{display:flex;flex-direction:column;gap:1rem;}
        .mlp-input{display:flex;flex-direction:column;gap:.55rem;}
        .mlp-input label{font-size:.85rem;font-weight:600;color:var(--muted);}
        .mlp-range-group{gap:0.4rem;}
        .range-meta{display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;color:var(--muted);margin-bottom:0.25rem;}
        .range-value{font-weight:600;color:var(--accent1);}
        .input-frame{display:flex;align-items:center;gap:.6rem;background:var(--input-bg);border:1px solid var(--input-border);border-radius:12px;padding:0 1rem;height:48px;transition:border-color .25s ease,box-shadow .25s ease;}
        .mlp-input-field{flex:1;border:none;background:transparent;color:var(--fg);font-size:1rem;font-weight:600;outline:none;}
        .mlp-input-field::-webkit-outer-spin-button,.mlp-input-field::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
        .mlp-input-field[type=number]{-moz-appearance:textfield;appearance: textfield;}
        .input-prefix,.input-suffix{font-size:.9rem;font-weight:600;color:var(--muted);}
        .input-frame:focus-within{border-color:var(--accent1);box-shadow:0 0 0 3px rgba(0,47,108,0.18);}
        .theme-dark .input-frame{background:rgba(15,23,42,0.9);border-color:rgba(148,163,184,0.18);}
        .theme-dark .input-frame:focus-within{border-color:var(--accent1);box-shadow:0 0 0 3px rgba(63,103,190,0.35);}
        .theme-dark .input-prefix,.theme-dark .input-suffix{color:#cbd5f5;}
        .label-highlight{color:var(--accent1);font-weight:700;}
        .mlp-range{width:100%;height:6px;border-radius:999px;background:linear-gradient(90deg,rgba(0,47,108,0.15),rgba(189,161,119,0.15));outline:none;-webkit-appearance:none;appearance:none;}
        .mlp-range::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));border:none;box-shadow:0 8px 18px rgba(0,47,108,0.25);cursor:pointer;}
        .mlp-range::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));border:none;box-shadow:0 8px 18px rgba(0,47,108,0.25);cursor:pointer;}
        .mlp-range::-webkit-slider-runnable-track{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));}
        .mlp-range::-moz-range-track{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));}
        .section-note{font-size:.8rem;color:var(--muted);background:rgba(0,47,108,0.05);padding:.75rem 1rem;border-radius:12px;text-align:center;}
        .theme-dark .section-note{background:rgba(148,163,184,0.12);color:#e2e8f0;}
        .booking-type-group{display:flex;flex-wrap:wrap;gap:.55rem;justify-content:center;}
        .booking-toolbar{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;font-size:.8rem;color:var(--muted);}
        .booking-toolbar label{font-weight:600;color:var(--muted);}
        .select-field{width:100%;background:var(--input-bg);border:1px solid var(--input-border);border-radius:12px;padding:.6rem .9rem;color:var(--fg);font-size:.9rem;transition:border-color .25s ease,box-shadow .25s ease;outline:none;}
        .select-field:focus{border-color:var(--accent1);box-shadow:0 0 0 3px rgba(0,47,108,0.18);}
        .theme-dark .select-field{background:rgba(15,23,42,0.9);border-color:rgba(148,163,184,0.18);color:#f1f5f9;}
        .link-danger{color:#ef4444;font-weight:600;}
        .link-danger:hover{color:#dc2626;}
        .print-area{margin-top:.5rem;}
        .print-area .print-btn{display:inline-flex;align-items:center;justify-content:center;gap:.75rem;border-radius:16px;padding:.9rem 1.2rem;}
        .print-area .print-btn svg{width:20px;height:20px;}
        /* Panels/Borders auf Theme heben */
        .theme-light .bg-gray-800 { background-color: var(--card) !important; }
        .theme-light .bg-gray-900 { background-color: var(--bg) !important; }
        .theme-light .border-gray-700 { border-color: var(--border) !important; }
        .theme-light .text-white { color: var(--fg) !important; }
        .theme-light .text-gray-400 { color: var(--muted) !important; }

        /* ═══════════════════════════════════════════════════════
           v2.0 Global Component Classes
           ═══════════════════════════════════════════════════════ */

        /* ── Buttons ── */
        .mlp-btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-family: var(--font-family); font-size: 14px; font-weight: 600;
            padding: 10px 20px; border-radius: var(--radius-sm); border: none;
            cursor: pointer; transition: all 0.2s ease; text-decoration: none;
            line-height: 1.2;
        }
        .mlp-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .mlp-btn-primary {
            background: var(--mlp-primary); color: var(--mlp-text-light);
        }
        .mlp-btn-primary:hover:not(:disabled) { background: #024a72; box-shadow: var(--shadow-subtle); }
        .mlp-btn-primary:active:not(:disabled) { background: #02334f; }
        .mlp-btn-secondary {
            background: var(--mlp-secondary); color: var(--fg);
        }
        .mlp-btn-secondary:hover:not(:disabled) { background: #aea69a; }
        .mlp-btn-tertiary {
            background: transparent; color: var(--mlp-primary);
            border: 1px solid var(--border);
        }
        .mlp-btn-tertiary:hover:not(:disabled) { background: rgba(3,61,93,0.06); border-color: var(--mlp-primary); }
        .mlp-btn-danger {
            background: var(--mlp-error); color: var(--mlp-text-light);
        }
        .mlp-btn-danger:hover:not(:disabled) { background: #A1223A; }

        /* ── Input Fields v2 ── */
        .mlp-input-field-v2 {
            width: 100%; padding: 10px 14px; font-size: 14px; font-family: var(--font-family);
            background: var(--input-bg); color: var(--fg);
            border: 1px solid var(--input-border); border-radius: var(--radius-sm);
            outline: none; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .mlp-input-field-v2:focus {
            border-color: var(--mlp-primary);
            box-shadow: 0 0 0 3px rgba(3,61,93,0.15);
        }
        .mlp-input-field-v2::placeholder { color: var(--muted); }

        /* ── Slider ── */
        .mlp-slider {
            -webkit-appearance: none; appearance: none; width: 100%;
            height: 6px; border-radius: 3px; background: var(--mlp-secondary);
            outline: none;
        }
        .mlp-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--mlp-primary); cursor: pointer;
            border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .mlp-slider::-moz-range-thumb {
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--mlp-primary); cursor: pointer;
            border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* ── Cards ── */
        .mlp-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: var(--space-sm);
        }
        .mlp-card--elevated {
            border: none; box-shadow: var(--shadow-elevated);
        }

        /* ── Glassmorphism (inspiriert von Antigravity) ── */
        .mlp-glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(190, 182, 170, 0.3);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 24px rgba(3, 61, 93, 0.08);
        }
        .theme-dark .mlp-glass {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.15);
        }
        /* Fallback für schwache Geräte */
        @media (prefers-reduced-motion: reduce) {
            .mlp-glass { backdrop-filter: none; -webkit-backdrop-filter: none; background: var(--card); }
        }

        /* ── Modal-Basis ── */
        .mlp-modal-overlay {
            position: fixed; inset: 0; z-index: 60;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            padding: var(--space-md);
        }
        .mlp-modal-overlay[style*="flex"], .mlp-modal-overlay.active { display: flex; }
        .mlp-modal-content {
            background: var(--mlp-bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-modal);
            display: flex; flex-direction: column;
            max-height: 90vh; width: 100%;
            overflow: hidden;
        }
        .theme-dark .mlp-modal-content {
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
        }
        /* Modal document panels: theme-aware background */
        .modal [role="document"] {
            background: var(--bg);
            color: var(--fg);
        }
        /* Modal close buttons: theme-aware hover */
        .modal [role="document"] > button[aria-label]:first-of-type {
            color: var(--muted);
        }
        .modal [role="document"] > button[aria-label]:first-of-type:hover {
            color: var(--fg);
        }

        /* ── Dark-Theme Overrides für Erklärer-Modals ── */
        /* Tailwind gray text classes → readable on dark backgrounds */
        .theme-dark .modal .text-gray-700 { color: #e5e7eb !important; }
        .theme-dark .modal .text-gray-600 { color: #d1d5db !important; }
        .theme-dark .modal .text-gray-500 { color: #9ca3af !important; }
        .theme-dark .modal .text-gray-400 { color: #9ca3af !important; }
        .theme-dark .modal .text-gray-300 { color: #d1d5db !important; }
        /* Tailwind gray backgrounds → dark equivalents */
        .theme-dark .modal .bg-gray-50 { background-color: var(--card) !important; }
        .theme-dark .modal .bg-gray-200 { background-color: #374151 !important; }
        /* Tailwind gray borders → dark equivalents */
        .theme-dark .modal .border-gray-200 { border-color: var(--border) !important; }
        .theme-dark .modal .border-gray-100 { border-color: var(--border) !important; }
        .theme-dark .modal .divide-gray-100 > * + * { border-color: var(--border) !important; }
        /* Tailwind hover states */
        .theme-dark .modal .hover\:bg-gray-300:hover { background-color: #4b5563 !important; }
        .theme-dark .modal .hover\:bg-gray-100:hover { background-color: rgba(255,255,255,0.05) !important; }
        /* Tailwind semantic text colors: slightly brighter for dark bg */
        .theme-dark .modal .text-green-600 { color: #34d399 !important; }
        .theme-dark .modal .text-red-600 { color: #f87171 !important; }
        .theme-dark .modal .text-blue-600 { color: #60a5fa !important; }
        /* Anleihen-Modal: Hardcoded inline styles → dark-aware via attribute selectors */
        .theme-dark #anleihen-modal [style*="color: #2B2B2B"] { color: var(--fg) !important; }
        .theme-dark #anleihen-modal [style*="color: #717171"] { color: var(--muted) !important; }
        .theme-dark #anleihen-modal [style*="color: #033D5D"] { color: #7db8d4 !important; }
        .theme-dark #anleihen-modal [style*="background: #F8F8F8"] { background: var(--card) !important; }
        .theme-dark #anleihen-modal [style*="background: rgba(190,182,170,0.12)"] { background: rgba(190,182,170,0.06) !important; }
        .theme-dark #anleihen-modal [style*="background: rgba(71,161,144,0.06)"] { background: rgba(71,161,144,0.1) !important; }
        .theme-dark #anleihen-modal [style*="background: rgba(3,61,93,0.04)"] { background: rgba(3,61,93,0.12) !important; }
        .theme-dark #anleihen-modal [style*="background: rgba(3,61,93,0.06)"] { background: rgba(3,61,93,0.15) !important; }
        .theme-dark #anleihen-modal [style*="border: 1px solid #BEB6AA"] { border-color: var(--border) !important; }
        .theme-dark #anleihen-modal [style*="border-left: 4px solid #BEB6AA"] { border-left-color: var(--border) !important; }
        .theme-dark #anleihen-modal [style*="background: white"] { background: var(--card) !important; }
        /* SVG elements in Anleihen: fill/stroke via presentational attributes */
        .theme-dark #anleihen-modal rect[fill="#F8F8F8"] { fill: var(--card); }
        .theme-dark #anleihen-modal rect[fill="white"],
        .theme-dark #anleihen-modal rect[stroke="#BEB6AA"] { fill: var(--card); stroke: var(--border); }
        /* Anleihen inactive tab buttons in dark mode */
        .theme-dark #anleihen-modal [style*="background: var(--card)"][style*="color: var(--fg)"] {
            border-color: var(--border) !important;
        }
        /* SoRR/Cost-Average/Kriegskasse: colored result cards & lesson boxes */
        .theme-dark .modal .bg-white { background-color: var(--bg) !important; }
        .theme-dark .modal .bg-green-50 { background-color: rgba(19,133,62,0.1) !important; }
        .theme-dark .modal .bg-blue-50 { background-color: rgba(3,61,93,0.15) !important; }
        .theme-dark .modal .bg-red-50 { background-color: rgba(193,41,61,0.1) !important; }
        .theme-dark .modal .bg-yellow-50 { background-color: rgba(227,105,30,0.1) !important; }
        .theme-dark .modal .bg-blue-100 { background-color: rgba(3,61,93,0.25) !important; }
        .theme-dark .modal .border-green-200 { border-color: rgba(19,133,62,0.3) !important; }
        .theme-dark .modal .border-blue-200 { border-color: rgba(3,61,93,0.3) !important; }
        .theme-dark .modal .border-red-200 { border-color: rgba(193,41,61,0.3) !important; }
        .theme-dark .modal .border-yellow-400 { border-color: rgba(227,105,30,0.5) !important; }
        .theme-dark .modal .text-green-700 { color: #34d399 !important; }
        .theme-dark .modal .text-blue-700 { color: #60a5fa !important; }
        .theme-dark .modal .text-blue-800 { color: #93c5fd !important; }
        .theme-dark .modal .text-red-700 { color: #f87171 !important; }
        .theme-dark .modal .text-yellow-600 { color: #fbbf24 !important; }
        .theme-dark .modal .text-yellow-700 { color: #fcd34d !important; }
        .theme-dark .modal .text-yellow-800 { color: #fde68a !important; }

        .mlp-modal-header {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .mlp-modal-header h2 {
            font-size: var(--font-size-h3); font-weight: 700;
            color: var(--mlp-primary); margin: 0;
        }
        .theme-dark .mlp-modal-header h2 { color: var(--mlp-text-light); }
        .mlp-modal-body {
            flex: 1; overflow-y: auto; padding: var(--space-md);
        }
        .mlp-modal-footer {
            padding: var(--space-sm) var(--space-md);
            border-top: 1px solid var(--border);
            display: flex; gap: var(--space-xs); justify-content: flex-end;
            flex-shrink: 0;
        }
        .mlp-modal-close {
            background: none; border: none; cursor: pointer;
            color: var(--muted); font-size: 24px; line-height: 1;
            padding: 4px; border-radius: var(--radius-sm);
            transition: color 0.2s, background 0.2s;
        }
        .mlp-modal-close:hover { color: var(--fg); background: rgba(0,0,0,0.05); }
        .theme-dark .mlp-modal-close:hover { background: rgba(255,255,255,0.1); }
        @media (max-height: 800px) {
            .mlp-modal-content { max-height: 95vh; }
            .mlp-modal-body { padding: var(--space-sm); }
        }

        /* ── Subtle Link (Erklärer-Trigger) ── */
        .mlp-link-subtle {
            color: var(--mlp-primary); font-weight: 600; font-size: 14px;
            text-decoration: none; padding: 8px 0;
            border: none; background: none; cursor: pointer;
            transition: color 0.2s; display: inline-flex; align-items: center; gap: 4px;
        }
        .mlp-link-subtle:hover { color: var(--mlp-accent); }
        .mlp-link-subtle::after { content: " \2192"; transition: transform 0.2s; display: inline-block; }
        .mlp-link-subtle:hover::after { transform: translateX(4px); }
        .theme-dark .mlp-link-subtle { color: var(--mlp-accent); }
        .theme-dark .mlp-link-subtle:hover { color: var(--mlp-text-light); }

        /* ── Session Dialog Inputs ── */
        .mlp-session-input {
            width: 100%; padding: 8px 16px; font-size: 14px;
            background: var(--gray-800); color: white;
            border: 1px solid var(--gray-700); border-radius: var(--radius-md);
            outline: none; transition: border-color 0.2s;
        }
        .mlp-session-input:focus { border-color: var(--mlp-accent); }
        .mlp-session-input::placeholder { color: var(--gray-500); }

        /* ═══════════════════════════════════════════════════════
           v2.0 Global Smooth Transitions
           Premium-feel: alles reagiert geschmeidig auf Interaktion
           ═══════════════════════════════════════════════════════ */

        /* Buttons & Links — sanfter Hover/Active */
        button, a, [role="button"], .mlp-btn, .depot-erklaerer-btn, .basin-inline-btn {
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease,
                        box-shadow 0.2s ease, transform 0.15s ease, opacity 0.2s ease;
        }

        /* Inputs — sanfter Focus-Ring */
        input, select, textarea, .mlp-input-field, .mlp-input-field-v2, .input-frame {
            transition: border-color 0.25s ease, box-shadow 0.25s ease;
        }

        /* Cards & Panels — Hover-Elevation */
        .mlp-card, .mlp-glass, .planning-panel, .account-basin {
            transition: box-shadow 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
        }

        /* Tooltip & Popover fade */
        [class*="tooltip"], .fab-label {
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        /* Erklärer-Buttons im Depot — sanfter Hover */
        .depot-erklaerer-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .depot-erklaerer-btn:active {
            transform: scale(0.97);
        }

        /* Flow-Values & Labels — sanftere Positionsänderungen */
        .flow-value, .flow-label {
            transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1), left 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease;
        }

        /* Basin-Hover: subtile Elevation statt hartem Border-Change */
        button.account-basin:hover {
            transform: translateY(-2px);
        }
        button.account-basin:active {
            transform: translateY(0);
        }

        /* Schutzschirm sanfter */
        .schutzschirm {
            transition: opacity 0.5s ease, fill 0.5s ease, stroke 0.5s ease;
        }

        /* Reduced motion: alle Animationen aus */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Flow labels/pills harmonisieren */
        .flow-label { color: var(--muted); }
        /* v2.0: .flow-value base now uses theme vars (--bg, --muted, --border) */
        .theme-light .flow-value { background-color: rgba(255,255,255,0.85); border-color: var(--border); color: var(--fg); }

        /* Mini Theme Toggle (Header) */
        /* -------- Light Theme Polish & Overrides -------- */
        /* Inputs & selects */
        .theme-light input[type="number"],
        .theme-light input[type="text"],
        .theme-light input[type="range"],
        .theme-light select,
        .theme-light textarea {
          background: #ffffff !important;
          color: #111827 !important;
          border-color: var(--border) !important;
        }
        .theme-light .text-gray-300 { color: #374151 !important; }

        /* v1.7.3: App heading - Design Guide compliant */
        .app-heading {
            color: #ffffff;  /* Dark mode: white */
        }
        .app-subheading {
            color: #9ca3af;  /* Dark mode: gray-400 */
        }
        .theme-light .app-heading {
            color: var(--mlp-primary);
        }
        .theme-light .app-subheading {
            color: var(--muted);
        }

        /* Panels / cards / modals */
        .theme-light .account-basin {
          background-color: var(--card) !important;
          border-color: var(--border) !important;
          box-shadow: 0 8px 18px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.05) !important;
        }
        .theme-light .modal .bg-gray-800 { background-color: #ffffff !important; }

        /* Badges / helper boxes */
        .theme-light .limit-line span { background: #ffffff !important; color: #111827 !important; }

        /* Flow animation color on light */
        .theme-light .flow-path-animation { stroke: white; opacity: .5; }

        /* Mask strokes (define visible river area) */
        .flow-mask-stroke {
          fill: none;
          stroke: #ffffff;
          stroke-linecap: round;
          stroke-linejoin: round;
          pointer-events: none;
          shape-rendering: geometricPrecision;
        }

        /* Ensure text colors in headings/labels are dark enough */
        .theme-light h1, .theme-light h2, .theme-light h3, .theme-light label, .theme-light p { color: #111827; }
        .theme-light .text-blue-400, .theme-light .text-green-400, .theme-light .text-red-400, .theme-light .text-yellow-300 { filter: saturate(.95); }

        /* ===== UI Polish ===== */
        /* Smooth theme transitions */
        body, .account-basin, input, select, textarea, .flow-value, .flow-label {
          transition: background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
        }

        /* Light header text overrides (keeps markup unchanged) */
        .theme-light h1.text-white { color: var(--fg) !important; }
        .theme-light p.text-gray-400 { color: var(--muted) !important; }

        /* Inputs focus ring tuned to MLP blue */
        .theme-light input:focus, .theme-light select:focus, .theme-light textarea:focus {
          outline: none;
          border-color: var(--mlp-blue) !important;
          box-shadow: 0 0 0 3px rgba(0,47,108,.15);
        }

        /* Primary action hover gentle for light */
        .theme-light .bg-purple-600:hover { filter: brightness(1.05); }

        /* Print button styling */
        .print-btn {
          transition: all .25s ease;
          border: 1px solid var(--border);
          background: transparent;
          color: var(--fg);
        }
        .print-btn:hover {
          border-color: var(--accent1);
          color: var(--accent1);
        }
        .theme-dark .print-btn {
          background: rgba(148, 163, 184, 0.08);
          border-color: rgba(148, 163, 184, 0.2);
          color: #f1f5f9;
        }
        .theme-light .print-btn {
          background: linear-gradient(135deg, rgba(0, 47, 108, 0.9), rgba(189, 161, 119, 0.9));
          border-color: transparent;
          color: #ffffff;
        }
        .theme-light .print-btn:hover {
          filter: brightness(1.05);
        }

        /* Cards subtle separation in light */
        .theme-light .bg-gray-800 {
          box-shadow: 0 10px 24px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04) !important;
        }

        /* Section dividers lighter in light */
        .theme-light hr.border-gray-700 { border-color: #e5e7eb !important; }

        /* Flow pill font weight slightly lower in light */
        .theme-light .flow-value { font-weight: 500; }
        .theme-light .flow-value {
          box-shadow: 0 1px 2px rgba(0,0,0,.06);
        }

        /* --- Ensure body flips to light despite Tailwind classes --- */
        .theme-light.bg-gray-900 { background-color: var(--bg) !important; }
        .theme-light.text-white  { color: var(--fg) !important; }

        /* --- Extra MLP accents in Light --- */
        /* Primary action becomes MLP blue in light */
        .theme-light .bg-purple-600 { background-color: var(--mlp-blue) !important; }
        .theme-light .hover\:bg-purple-700:hover { background-color: #003a84 !important; }

        /* Headings and section titles in MLP blue, yellow accents in MLP gold */
        .theme-light h1, .theme-light h2, .theme-light h3,
        .theme-light .section-title { color: var(--mlp-blue) !important; }
        .theme-light .text-yellow-300 { color: var(--mlp-gold) !important; }

        /* Light theme info badges and pills with MLP tint */
        .theme-light .flow-value { border-color: #d5e0ee !important; }

        /* ===== MODERN RANGE SLIDER (v1.5.0) ===== */
        input[type="range"],
        .mlp-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right,
                var(--mlp-blue, #002f6c) 0%,
                var(--mlp-blue, #002f6c) 50%,
                rgba(100, 116, 139, 0.3) 50%,
                rgba(100, 116, 139, 0.3) 100%);
            outline: none;
            transition: opacity 0.2s;
            cursor: pointer;
        }

        input[type="range"]:hover {
            opacity: 0.9;
        }

        /* v1.5.3: Focus indicator for keyboard navigation */
        input[type="range"]:focus-visible {
            outline: 3px solid var(--accent1, #033D5D);
            outline-offset: 4px;
            border-radius: 6px;
        }

        /* Webkit (Chrome, Safari, Edge) - Thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--mlp-blue, #002f6c);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            margin-top: -7px; /* Centers thumb on track (20px thumb - 6px track)/2 */
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 47, 108, 0.4);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.05);
        }

        /* Firefox - Thumb */
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--mlp-blue, #002f6c);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 47, 108, 0.4);
        }

        input[type="range"]::-moz-range-thumb:active {
            transform: scale(1.05);
        }

        /* Firefox - Track */
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: transparent;
        }

        /* Light Theme Overrides */
        .theme-light input[type="range"] {
            background: linear-gradient(to right,
                var(--mlp-blue) 0%,
                var(--mlp-blue) 50%,
                #e5e7eb 50%,
                #e5e7eb 100%) !important;
        }

        .theme-light input[type="range"]::-webkit-slider-thumb {
            background: var(--mlp-blue);
            border-color: #f8fafc;
        }

        /* ===== RISK TOGGLE & FUND BLOCKS (v1.5.1+) ===== */

        /* Risk Toggle Component - Infinity/Figure-8 Design */
        .risk-toggle {
            position: relative;
            width: 64px;
            height: 32px;
            background: #1f2937;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4px;
        }

        .risk-toggle:hover {
            background: #2d3748;
        }

        /* Invisible buttons for click handling */
        .risk-btn {
            position: absolute;
            width: 50%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
            border: none;
            background: transparent;
        }

        .risk-btn:first-of-type {
            left: 0;
        }

        .risk-btn:last-of-type {
            right: 0;
        }

        /* End dots (circles) */
        .risk-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .risk-dot.conservative {
            background: var(--mlp-primary);
            box-shadow: 0 0 8px rgba(3, 61, 93, 0.4);
        }

        .risk-dot.aggressive {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        /* Sliding handle */
        .risk-toggle::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ffffff, #e5e7eb);
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.1);
            z-index: 3;
        }

        /* Move handle to right when aggressive is active */
        .risk-toggle.aggressive::before {
            left: 36px;
            background: linear-gradient(135deg, #fca5a5, #ef4444);
        }

        .risk-toggle.conservative::before {
            background: linear-gradient(135deg, #47A190, var(--mlp-primary));
        }

        /* Highlight active dot */
        .risk-toggle.conservative .risk-dot.conservative {
            transform: scale(1.3);
            box-shadow: 0 0 12px rgba(3, 61, 93, 0.8);
        }

        .risk-toggle.aggressive .risk-dot.aggressive {
            transform: scale(1.3);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.8);
        }

        /* v1.9.0: Fonds-Autocomplete Dropdown */
        .fonds-autocomplete-wrap { position: relative; }
        /* v1.9.3: Global dropdown — fixed positioniert, nicht mehr vom scroll-container geclippt */
        #fonds-dropdown-global {
            position: fixed;
            z-index: 200;
            max-height: 220px; overflow-y: auto;
            background: #1f2937; border: 1px solid #374151; border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4); display: none;
        }
        #fonds-dropdown-global.open { display: block; }
        .fonds-ac-item {
            padding: 8px 12px; cursor: pointer; display: flex;
            align-items: center; gap: 8px; font-size: 13px;
            border-bottom: 1px solid rgba(55,65,81,0.5);
        }
        .fonds-ac-item:last-child { border-bottom: none; }
        .fonds-ac-item:hover, .fonds-ac-item.active { background: rgba(59,130,246,0.15); }
        .fonds-ac-badge {
            display: inline-block; padding: 1px 6px; border-radius: 4px;
            font-size: 10px; font-weight: 700; letter-spacing: 0.3px; flex-shrink: 0;
        }
        .fonds-ac-badge.blau { background: rgba(3,61,93,0.25); color: #60a5fa; }
        .fonds-ac-badge.rot { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .fonds-ac-kategorie { font-size: 11px; color: #9ca3af; margin-left: auto; flex-shrink: 0; }
        .fonds-ac-wkn { font-size: 11px; color: #6b7280; font-family: ui-monospace, monospace; }
        .depot-item-badge {
            display: inline-block; padding: 1px 6px; border-radius: 4px;
            font-size: 10px; font-weight: 700; letter-spacing: 0.3px;
        }
        .depot-item-badge.blau { background: rgba(3,61,93,0.25); color: #60a5fa; }
        .depot-item-badge.rot { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .depot-item-badge.custom { background: rgba(156,163,175,0.2); color: #9ca3af; }
        .theme-light #fonds-dropdown-global { background: #ffffff; border-color: #BEB6AA; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .theme-light .fonds-ac-item:hover, .theme-light .fonds-ac-item.active { background: rgba(3,61,93,0.08); }
        .theme-light .fonds-ac-badge.blau { background: rgba(3,61,93,0.12); color: #033D5D; }
        .theme-light .fonds-ac-badge.rot { background: rgba(193,41,61,0.1); color: #C1293D; }
        .theme-light .fonds-ac-kategorie { color: #717171; }
        .theme-light .fonds-ac-wkn { color: #717171; }
        .theme-light .depot-item-badge.blau { background: rgba(3,61,93,0.12); color: #033D5D; }
        .theme-light .depot-item-badge.rot { background: rgba(193,41,61,0.1); color: #C1293D; }

        /* v1.9.2: Erklärer-Buttons — edel, gleichmäßig verteilt */
        .depot-erklaerer-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .depot-erklaerer-btn {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            padding: 8px 6px;
            border-radius: 6px;
            border: 1px solid rgba(156,163,175,0.25);
            background: rgba(255,255,255,0.04);
            color: #b0b8c4;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            line-height: 1.3;
        }
        .depot-erklaerer-btn:hover {
            border-color: #47A190;
            color: #ffffff;
            background: rgba(71,161,144,0.12);
            box-shadow: 0 1px 4px rgba(71,161,144,0.15);
        }
        .theme-light .depot-erklaerer-btn {
            color: #4b5563;
            border-color: #BEB6AA;
            background: rgba(3,61,93,0.03);
        }
        .theme-light .depot-erklaerer-btn:hover {
            color: #033D5D;
            border-color: #033D5D;
            background: rgba(3,61,93,0.08);
            box-shadow: 0 1px 4px rgba(3,61,93,0.12);
        }

        /* v1.9.2: Prognose-Section kompakt */
        .prognose-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .prognose-grid .prognose-full { grid-column: 1 / -1; }
        .prognose-field label {
            font-size: 12px;
            color: #9ca3af;
            display: block;
            margin-bottom: 4px;
        }
        .theme-light .prognose-field label { color: #717171; }
        .prognose-input {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(55,65,81,0.5);
            border: 1px solid rgba(156,163,175,0.2);
            border-radius: 6px;
            padding: 6px 10px;
            transition: border-color 0.15s ease;
        }
        .prognose-input:focus-within {
            border-color: #47A190;
        }
        .prognose-input input {
            flex: 1;
            background: transparent;
            color: #ffffff;
            outline: none;
            font-size: 14px;
            min-width: 0;
        }
        .prognose-input .unit {
            font-size: 12px;
            color: #6b7280;
            flex-shrink: 0;
        }
        .theme-light .prognose-input {
            background: #ffffff;
            border-color: #BEB6AA;
        }
        .theme-light .prognose-input input { color: #2B2B2B; }
        .prognose-slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .prognose-slider-row input[type="range"] { flex: 1; }
        .prognose-slider-row .slider-value {
            font-size: 13px;
            font-weight: 700;
            color: #ffffff;
            min-width: 60px;
            text-align: right;
            white-space: nowrap;
        }
        .theme-light .prognose-slider-row .slider-value { color: #2B2B2B; }
        .prognose-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 7px 14px;
            border-radius: 6px;
            border: 1px solid #033D5D;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            color: #60a5fa;
        }
        .prognose-btn:hover {
            background: rgba(3,61,93,0.15);
            color: #93c5fd;
        }
        .theme-light .prognose-btn {
            color: #033D5D;
            border-color: #033D5D;
        }
        .theme-light .prognose-btn:hover {
            background: rgba(3,61,93,0.08);
        }
        .prognose-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
            padding: 6px 8px;
            background: rgba(17,24,39,0.5);
            border-radius: 4px;
            border-left: 2px solid #BEB6AA;
        }
        .theme-light .prognose-hint {
            background: #f9fafb;
            color: #717171;
        }

        /* Fund Blocks in Depot Basin */
        .depot-basin-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
            padding: 8px;
        }

        .fund-blocks {
            display: grid;
            grid-template-columns: repeat(3, auto);
            gap: 4px;
            align-items: center;
            justify-items: center;
            min-width: 40px;
        }

        .fund-block {
            /* Dynamic squares: width = height, set inline based on allocation */
            border-radius: 8px;
            cursor: help;
            animation: fundPulse 3s ease-in-out infinite;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        @keyframes fundPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.15);
            }
        }

        /* v1.6.2: Pulse animation for crash highlight */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.02);
                opacity: 0.95;
            }
        }

        .fund-block:nth-child(2) {
            animation-delay: 0.5s;
        }

        .fund-block:nth-child(3) {
            animation-delay: 1s;
        }

        .fund-block:nth-child(4) {
            animation-delay: 1.5s;
        }

        .fund-block:nth-child(5) {
            animation-delay: 2s;
        }

        .depot-info {
            text-align: center;
            flex: 1;
        }

        /* Light theme overrides */
        .theme-light .risk-toggle {
            background: #e5e7eb;
        }

        .theme-light input[type="range"]::-moz-range-thumb {
            background: var(--mlp-blue);
            border-color: #f8fafc;
        }

        #rendite-info .text-xs { font-size: 0.7rem; }
    /* --- Print helpers for embedded images --- */
    #printable-report img { max-width: 100%; height: auto; display: block; margin: 10px auto; }
    #printable-report h1, #printable-report h2, #printable-report h3 { color: #000 !important; }
    #printable-report .muted { color: #333 !important; font-size: 12px; }
        .booking-type-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 16px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            background-color: rgba(59, 130, 246, 0.15);
            color: #dbeafe;
            outline: none;
        }
        .booking-type-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 18px -10px rgba(15, 23, 42, 0.35);
        }
        .booking-type-btn svg {
            width: 22px;
            height: 22px;
            pointer-events: none;
        }
        .booking-type-btn:focus-visible {
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.6);
        }
        .booking-type-btn-active {
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.35);
            border-color: rgba(96, 165, 250, 0.65) !important;
            transform: translateY(-1px);
        }
        .booking-calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.5rem;
        }
        .booking-day {
            position: relative;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 0.35rem 0.3rem 0.5rem;
            min-height: 64px;
            background-color: rgba(17, 24, 39, 0.6);
            cursor: pointer;
            transition: border-color 0.2s ease, transform 0.15s ease;
        }
        .booking-day:hover {
            transform: translateY(-1px);
            border-color: rgba(96, 165, 250, 0.7);
        }
        .booking-day.has-booking {
            border-color: rgba(96, 165, 250, 0.8);
            background-color: rgba(37, 99, 235, 0.12);
        }
        .booking-day--overflow{background-color:rgba(189,161,119,0.12);border-color:rgba(189,161,119,0.45);} .booking-day--overflow .booking-day-number{color:var(--accent1);}
        .booking-day-number {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
        }
        .booking-day-content {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.35rem;
        }
        .booking-entry-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            border: 1px solid transparent;
            background-color: rgba(255, 255, 255, 0.04);
            color: #d1d5db;
            transition: transform 0.15s ease, border-color 0.2s ease, color 0.2s ease;
        }
        .booking-entry-btn svg {
            width: 0.9rem;
            height: 0.9rem;
        }
        .booking-entry-btn:hover {
            transform: scale(1.05);
            border-color: rgba(239, 68, 68, 0.6);
            color: #fca5a5;
        }
        .booking-calendar .booking-day-header {
            cursor: default;
            background: transparent;
            border: none;
            min-height: auto;
            padding: 0;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
        }
        .booking-day-empty {
            pointer-events: none;
            cursor: default;
            border: none;
            background: transparent;
            min-height: 0;
            padding: 0;
        }
        .booking-hint-strong {
            color: #bfdbfe;
        }
        .theme-light .booking-type-btn {
            background-color: rgba(15, 47, 85, 0.08);
            color: #0f2f55;
            border-color: rgba(15, 47, 85, 0.12);
        }
        .theme-light .booking-day {
            background-color: rgba(249, 250, 251, 0.9);
            border-color: #d1d5db;
        }
        .theme-light .booking-day:hover {
            border-color: rgba(15, 47, 85, 0.55);
        }
        .theme-light .booking-day.has-booking {
            background-color: rgba(214, 226, 247, 0.9);
        }
        .theme-light .booking-day--overflow{background-color:rgba(240,233,222,0.9);border-color:rgba(189,161,119,0.45);} .theme-light .booking-day--overflow .booking-day-number{color:#7b5a30;}
        .theme-light .booking-day-number {
            color: #4b5563;
        }
        .theme-light .booking-entry-btn {
            background-color: rgba(15, 47, 85, 0.05);
            color: #0f2f55;
        }
        .theme-light .booking-entry-btn:hover {
            border-color: rgba(193, 50, 74, 0.6);
            color: #c1324a;
        }
        .print-booking-entry {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .print-booking-entry svg {
            width: 16px;
            height: 16px;
        }
        .print-booking-icon {
            display: inline-flex;
            align-items: center;
        }
        .print-booking-entry + .print-booking-entry {
            margin-top: 4px;
        }
        #printable-report .print-table-bookings td {
            vertical-align: top;
        }

        /* === v1.7.3: BOOKING TIMELINE === */
        .booking-timeline-container {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 12px;
            padding: 16px 24px;
            margin-top: 24px;
        }
        .booking-timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .booking-timeline-edit-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #9ca3af;
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .booking-timeline-edit-btn:hover {
            background: rgba(55, 65, 81, 0.8);
            color: #e5e7eb;
            border-color: rgba(107, 114, 128, 0.6);
        }
        .booking-timeline {
            position: relative;
            padding: 20px 0 40px 0;
            min-height: 80px;
        }
        .booking-timeline-line {
            position: absolute;
            top: 50%;
            left: 24px;
            right: 24px;
            height: 2px;
            background: rgba(107, 114, 128, 0.4);
            transform: translateY(-50%);
        }
        .booking-timeline-markers {
            position: relative;
            display: flex;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 1;
        }
        .booking-timeline-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .booking-timeline-marker:hover {
            transform: translateY(-2px);
        }
        .booking-timeline-marker:hover .booking-timeline-dot {
            transform: scale(1.3);
            box-shadow: 0 0 12px currentColor;
        }
        .booking-timeline-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid currentColor;
            background: var(--gray-900, #111827);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 8px;
        }
        .booking-timeline-day {
            font-size: 0.7rem;
            font-weight: 700;
            color: #9ca3af;
            margin-bottom: 4px;
        }
        .booking-timeline-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
        }
        .booking-timeline-icon svg {
            width: 100%;
            height: 100%;
        }
        .booking-timeline-label {
            font-size: 0.65rem;
            font-weight: 500;
            color: #6b7280;
            white-space: nowrap;
            text-align: center;
            max-width: 70px;
        }
        .booking-timeline-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #6b7280;
        }
        /* Light Theme */
        .theme-light .booking-timeline-container {
            background: rgba(249, 250, 251, 0.8);
            border-color: rgba(209, 213, 219, 0.8);
        }
        .theme-light .booking-timeline-edit-btn {
            background: rgba(243, 244, 246, 0.8);
            border-color: rgba(209, 213, 219, 0.8);
            color: #4b5563;
        }
        .theme-light .booking-timeline-edit-btn:hover {
            background: rgba(229, 231, 235, 0.9);
            color: #1f2937;
        }
        .theme-light .booking-timeline-line {
            background: rgba(209, 213, 219, 0.8);
        }
        .theme-light .booking-timeline-dot {
            background: #fff;
        }
        .theme-light .booking-timeline-day {
            color: #4b5563;
        }
        .theme-light .booking-timeline-label {
            color: #6b7280;
        }

        /* === MOBILE OPTIMIZATIONS === */

        /* Mobile Warning Overlay */
        #mobile-warning {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(8px);
            z-index: 50;
            padding: 2rem;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #mobile-warning .warning-content {
            max-width: 400px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 2px solid #374151;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        #mobile-warning .warning-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        #mobile-warning h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #f59e0b;
        }

        #mobile-warning p {
            color: #d1d5db;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        #mobile-warning .btn-mobile {
            background: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background 0.2s;
        }

        #mobile-warning .btn-mobile:hover {
            background: #4338ca;
        }

        @media (max-width: 768px) {
            #mobile-warning {
                display: flex;
            }

            /* Session button fixed on mobile */
            #session-button-container {
                position: fixed !important;
                top: 1rem !important;
                left: 1rem !important;
                z-index: 100 !important;
            }

            /* Smaller switch in mobile menu */
            #session-dropdown .switch {
                width: 48px;
                height: 28px;
            }

            #session-dropdown .switch .slider:before {
                height: 20px;
                width: 20px;
                left: 4px;
                bottom: 4px;
            }

            #session-dropdown input:checked + .slider:before {
                transform: translateX(20px);
            }

            /* Touch optimization */
            button, .account-basin, .control-chip {
                -webkit-tap-highlight-color: rgba(3, 61, 93, 0.3);
                touch-action: manipulation;
            }

            /* Larger touch targets */
            .account-basin {
                min-height: 80px;
            }

            /* Modal optimization */
            .modal-content {
                max-height: 85vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Sidebar full width on mobile */
            aside {
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Hide flowchart on very small screens */
            @media (max-width: 480px) {
                #flow-container {
                    min-height: 400px !important;
                }
            }
        }
    </style>
</head>
<body class="theme-light p-4 lg:p-8 overflow-x-hidden" id="theme-root">

    <a class="skip-link" href="#main-content">Zum Hauptinhalt springen</a>

    <main id="main-content" class="max-w-screen-2xl mx-auto" tabindex="-1">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-2 app-heading" style="letter-spacing: -0.02em;">Der Flow</h1>
            <p class="text-md md:text-lg app-subheading font-light" style="letter-spacing: 0.04em;">Vom Einkommen zum Investment</p>
        </header>

        <!-- v1.4.0: Sidebar entfernt - Controls in Modals/FAB integriert -->
        <div class="w-full">
            <!-- v1.4.0: Control Bar (Top Right) -->
            <div id="control-bar" class="fixed top-4 right-4 z-50 flex items-center gap-2">
                <!-- Theme Toggle -->
                <label class="control-chip control-chip--toggle" title="Darstellung wechseln">
                    <input type="checkbox" id="theme-switch" aria-label="Theme umschalten (Hell/Dunkel)" />
                    <span class="chip-icon" aria-hidden="true">
                        <svg class="icon icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="4" />
                            <path d="M12 2v2" />
                            <path d="M12 20v2" />
                            <path d="M4.93 4.93l1.42 1.42" />
                            <path d="M17.65 17.65l1.42 1.42" />
                            <path d="M2 12h2" />
                            <path d="M20 12h2" />
                            <path d="M4.93 19.07l1.42-1.42" />
                            <path d="M17.65 6.35l1.42-1.42" />
                        </svg>
                        <svg class="icon icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79z" />
                        </svg>
                    </span>
                </label>

                <!-- Variant Toggle -->
                <label class="control-chip control-chip--variant" title="Variante A/B umschalten">
                    <input type="checkbox" id="variant-switch" aria-label="Variante A/B umschalten">
                    <span class="chip-pair" aria-hidden="true">
                        <span id="variante-a-label" class="chip-state chip-state--active">A</span>
                        <span id="variante-b-label" class="chip-state">B</span>
                    </span>
                </label>

                <!-- Consultation Toggle -->
                <div class="control-chip control-chip--consultation" title="Beratung">
                    <button id="consult-toggle-btn" class="chip-button" type="button" aria-label="Beratung starten">
                        <svg class="icon icon-mlp" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="10" cy="12" r="5.5" stroke="currentColor" stroke-width="1.6" fill="none" />
                            <path d="M10 8.5v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                            <path d="M18 7h3v10h-3z" fill="currentColor" />
                        </svg>
                    </button>
                    <button id="consult-next-btn" class="chip-button hidden" type="button" aria-label="Weiter zur naechsten Beratungsphase" title="Weiter zur naechsten Beratungsphase">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14" />
                            <path d="M13 6l6 6-6 6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- v1.4.0: Hidden input fields for global inputs reference -->
            <div style="display: none;">
                <input type="number" id="income" value="3000">
                <input type="number" id="konsumMin" value="100">
                <input type="number" id="konsumLeftover" value="250">
                <input type="number" id="tagesgeldCurrent" value="4800">
                <input type="number" id="tagesgeldLimit" value="5000">
                <input type="number" id="depotCurrent-hidden" value="0">
                <input type="number" id="anlagezeitraum-hidden" value="15" min="1" max="40">
                <input type="number" id="rendite-hidden" value="7.0" step="0.1">
            </div>

            <div id="flow-container" class="w-full relative min-h-[1150px]">
                <!-- Mobile Warning Overlay -->
                <div id="mobile-warning" class="no-print">
                    <div class="warning-content">
                        <div class="warning-icon">📱</div>
                        <h3>Desktop empfohlen</h3>
                        <p>
                            Die Flowchart-Visualisierung ist für größere Bildschirme optimiert.
                            <br><br>
                            <strong>Verfügbar auf Mobile:</strong><br>
                            ✓ Eingaben & Berechnungen<br>
                            ✓ Export-Funktionen (PDF, CSV, JSON, Excel)<br>
                            ✓ Session-Verwaltung
                        </p>
                        <button onclick="document.getElementById('mobile-warning').style.display='none'" class="btn-mobile">
                            Verstanden
                        </button>
                    </div>
                </div>
                <svg id="flow-svg" class="flow-svg">
                    <defs>
                      <linearGradient id="flow-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#033D5D" />
                        <stop offset="100%" stop-color="#033D5D" />
                      </linearGradient>
                      <filter id="flow-glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="3" result="blur"/>
                        <feMerge>
                          <feMergeNode in="blur"/>
                          <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                      </filter>
                      <mask id="flow-mask" maskUnits="userSpaceOnUse">
                        <rect x="0" y="0" width="100%" height="100%" fill="black"></rect>
                        <path id="flow-path-1-mask" class="flow-mask-stroke"></path>
                        <path id="flow-path-2-mask" class="flow-mask-stroke"></path>
                        <path id="konsum-tagesgeld-flow-mask" class="flow-mask-stroke"></path>
                        <path id="tagesgeld-depot-flow-mask" class="flow-mask-stroke"></path>
                        <path id="fixkosten-depot-flow-mask" class="flow-mask-stroke"></path>
                        <path id="vermieterkonto-einkommen-flow-mask" class="flow-mask-stroke"></path>
                        <path id="fixkosten-vermieterkonto-flow-mask" class="flow-mask-stroke"></path>
                      </mask>
                    </defs>
                    <g id="flow-visuals" mask="url(#flow-mask)">
                      <!-- Deficitline ganz hinten (erstes Element = hinterste Ebene) -->
                      <path id="fixkosten-vermieterkonto-flow-erase" class="flow-erase"></path>
                      <path id="fixkosten-vermieterkonto-flow" class="flow-path"></path><path id="fixkosten-vermieterkonto-flow-anim" class="flow-path-animation"></path><g id="fixkosten-vermieterkonto-flow-dot"></g>
                      <!-- Normale Flows -->
                      <path id="flow-path-1-erase" class="flow-erase"></path>
                      <path id="flow-path-1" class="flow-path"></path><path id="flow-path-1-anim" class="flow-path-animation"></path><g id="flow-path-1-dot"></g>
                      <path id="flow-path-2-erase" class="flow-erase"></path>
                      <path id="flow-path-2" class="flow-path"></path><path id="flow-path-2-anim" class="flow-path-animation"></path><g id="flow-path-2-dot"></g>
                      <path id="konsum-tagesgeld-flow-erase" class="flow-erase"></path>
                      <path id="konsum-tagesgeld-flow" class="flow-path"></path><path id="konsum-tagesgeld-flow-anim" class="flow-path-animation"></path><g id="konsum-tagesgeld-flow-dot"></g>
                      <path id="tagesgeld-depot-flow-erase" class="flow-erase"></path>
                      <path id="tagesgeld-depot-flow" class="flow-path"></path><path id="tagesgeld-depot-flow-anim" class="flow-path-animation"></path><g id="tagesgeld-depot-flow-dot"></g>
                      <path id="fixkosten-depot-flow-erase" class="flow-erase"></path>
                      <path id="fixkosten-depot-flow" class="flow-path"></path><path id="fixkosten-depot-flow-anim" class="flow-path-animation"></path><g id="fixkosten-depot-flow-dot"></g>
                      <!-- Vermieterkonto positive Flow -->
                      <path id="vermieterkonto-einkommen-flow-erase" class="flow-erase"></path>
                      <path id="vermieterkonto-einkommen-flow" class="flow-path"></path><path id="vermieterkonto-einkommen-flow-anim" class="flow-path-animation"></path><g id="vermieterkonto-einkommen-flow-dot"></g>
                    </g>
                    <path id="schutzschirm-path" class="schutzschirm"></path>
                </svg>

                <!-- v1.6.1 Level 2: Hover-Tooltip (compact, visual connection) -->
                <div id="schutzschild-tooltip" class="schutzschild-tooltip">
                    <div class="schutzschild-tooltip-puffer">
                        <span class="schutzschild-tooltip-icon">🛡️</span>
                        <span id="tooltip-puffer-text" class="schutzschild-tooltip-puffer-text">Puffer: 4 M</span>
                    </div>
                </div>

                <!-- SVG connection line: Tagesgeld → THROUGH Tooltip → Shield (line goes OVER tooltip, making it look like it passes through) -->
                <svg id="tooltip-connection-svg" style="position: absolute; pointer-events: none; z-index: 115; display: none;">
                    <path id="tagesgeld-tooltip-line" class="tooltip-connection-line" stroke="rgba(16, 185, 129, 0.9)" fill="none" />
                </svg>

                <!-- Horizontal Gradient Zones für visuelle Ebenen-Trennung -->
                <div id="gradient-zone-1" class="gradient-zone gradient-zone-1" style="top: 0; height: 240px;"></div>
                <div id="gradient-zone-2" class="gradient-zone gradient-zone-2" style="top: 240px; height: 480px;"></div>
                <div id="gradient-zone-3" class="gradient-zone gradient-zone-3" style="top: 720px; height: 240px;"></div>
                <div id="gradient-zone-4" class="gradient-zone gradient-zone-4" style="top: 960px; height: 300px;"></div>

                <div id="einkommen-basin" class="account-basin account-basin--editable"></div>
                <button id="fixkosten-basin" class="account-basin cursor-pointer" type="button" aria-controls="fixkosten-modal" aria-haspopup="dialog" onclick="openFixkostenModal()"></button>
                <div id="konsum-basin" class="account-basin account-basin--editable"></div>
                <div id="tagesgeld-basin" class="account-basin account-basin--editable"></div>
                <button id="depot-basin" class="account-basin cursor-pointer" type="button" aria-controls="depot-modal" aria-haspopup="dialog" onclick="updateRenditeSuggestions(parseInt(document.getElementById('anlagezeitraum').value, 10)); openModal('depot-modal');"></button>
                <button id="vermieterkonto-basin" class="account-basin cursor-pointer" type="button" aria-controls="vermieterkonto-modal" aria-haspopup="dialog" onclick="loadVermieterkontoData(); openModal('vermieterkonto-modal')" style="height: 100px;"></button>
                <button id="immobilien-basin" class="account-basin cursor-pointer" type="button" aria-controls="immobilien-modal" aria-haspopup="dialog" onclick="openModal('immobilien-modal')"></button>
            </div>

            <!-- v1.7.3: Buchungs-Timeline -->
            <div id="booking-timeline-container" class="booking-timeline-container mt-6 no-print">
                <div class="booking-timeline-header">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-semibold text-gray-400">📅 Buchungsablauf im Monat</span>
                    </div>
                    <button onclick="openBookingModal()" class="booking-timeline-edit-btn" title="Buchungskalender bearbeiten">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Bearbeiten
                    </button>
                </div>
                <div id="booking-timeline" class="booking-timeline">
                    <!-- Timeline wird dynamisch befüllt -->
                    <div class="booking-timeline-empty">
                        <span class="text-gray-500 text-sm">Keine Buchungen geplant</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="printable-report"></div>

    <!-- Modals -->

    <div id="prognose-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-[60]" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="prognose-modal-title" aria-describedby="prognose-summary">
        <div class="w-full max-w-3xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('prognose-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-900 text-2xl transition-colors" aria-label="Prognose schließen">&times;</button>
            <h3 id="prognose-modal-title" class="text-xl font-bold mb-4">Prognose: Vermögensentwicklung</h3>
            <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                <canvas id="prognose-chart"></canvas>
            </div>
            <div id="prognose-summary" class="mt-4 text-center"></div>
        </div>
    </div>
    </div>

    <div id="fixkosten-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="fixkosten-modal-title">
        <div class="w-full max-w-2xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('fixkosten-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-900 text-2xl transition-colors" aria-label="Fixkostenfenster schließen">&times;</button>
            <h3 id="fixkosten-modal-title" class="text-xl font-bold mb-4">Fixkosten &amp; Sparpläne</h3>
            <div id="fixkosten-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            <button type="button" onclick="addFixkostenItem()" class="mlp-btn mlp-btn-tertiary mt-4 text-sm px-3 py-1">+ Posten hinzufügen</button>
            <hr class="my-4" style="border-color: var(--mlp-secondary);">
            <div class="flex justify-between items-center">
                <p class="text-lg">Monatliche Gesamtkosten:</p>
                <p id="modal-total" class="text-2xl font-bold" style="color: var(--mlp-error);">? 0</p>
            </div>
            <button type="button" onclick="saveFixkosten()" class="mlp-btn mlp-btn-primary mt-6 w-full py-2 px-4">Speichern &amp; Schließen</button>
        </div>
    </div>

    <div id="depot-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="depot-modal-title" aria-describedby="depot-modal-description">
        <div class="w-full max-w-2xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('depot-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-900 text-2xl transition-colors" aria-label="Depotfenster schließen">&times;</button>
            <h3 id="depot-modal-title" class="text-xl font-bold mb-4">Depot-Aufteilung</h3>
            <p id="depot-modal-description" class="text-sm -mt-3 mb-4" style="color: var(--muted);">Lege fest, wie neue Investments verteilt werden.</p>

            <!-- v1.9.2: Erklärer-Buttons — edel, gleichmäßig verteilt -->
            <div class="depot-erklaerer-row">
                <button type="button" onclick="openCostAverageModal()" class="depot-erklaerer-btn">Cost-Average</button>
                <button type="button" onclick="openSoRRModal()" class="depot-erklaerer-btn">SoRR-Risiko</button>
                <button type="button" onclick="openAnleihenModal()" class="depot-erklaerer-btn">Aktien &amp; Anleihen</button>
                <button type="button" onclick="openMsciRenditedreieck()" class="depot-erklaerer-btn">MSCI Renditedreieck</button>
            </div>

            <div id="depot-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            <!-- v1.9.3: Dropdown jetzt im Body (siehe Ende der Modals) wegen transform-Bug -->
            <button type="button" onclick="addDepotItem()" style="margin-top:10px; font-size:12px; font-weight:600; padding:5px 12px; border-radius:5px; border:1px dashed rgba(156,163,175,0.3); background:transparent; color:#9ca3af; cursor:pointer; transition:all 0.15s;">+ Fonds hinzufügen</button>
            <div style="display:flex; justify-content:space-between; align-items:baseline; margin-top:16px; padding-top:12px; border-top:1px solid rgba(156,163,175,0.12);">
                <span style="font-size:13px; color:#9ca3af;">Gesamt-Verteilung</span>
                <p id="depot-total" class="text-2xl font-bold">100 %</p>
            </div>
            <p id="depot-warning" class="text-center mt-1" style="font-size:12px; min-height:18px; color: var(--mlp-warning);"></p>

            <!-- Prognose Section (v1.9.2 redesign) -->
            <hr class="my-4" style="border-color: var(--mlp-secondary);">
            <h4 style="font-size:14px; font-weight:700; margin-bottom:12px; color:#b0b8c4; letter-spacing:0.5px; text-transform:uppercase;">Prognose</h4>

            <div class="prognose-grid">
                <div class="prognose-field">
                    <label for="depotCurrent">Depotstand</label>
                    <div class="prognose-input">
                        <span class="unit">&euro;</span>
                        <input type="number" id="depotCurrent" value="25000" inputmode="decimal" placeholder="25.000">
                    </div>
                </div>
                <div class="prognose-field">
                    <label for="rendite">Rendite p.a.</label>
                    <div class="prognose-input">
                        <input type="number" id="rendite" step="0.1" value="7" inputmode="decimal" placeholder="7">
                        <span class="unit">%</span>
                    </div>
                    <div id="rendite-info" class="prognose-hint"></div>
                </div>
                <div class="prognose-field prognose-full">
                    <label for="anlagezeitraum">Anlagezeitraum</label>
                    <div class="prognose-slider-row">
                        <input type="range" id="anlagezeitraum" min="1" max="30" value="15" class="mlp-range">
                        <span id="anlagezeitraum-label" class="slider-value">15 Jahre</span>
                    </div>
                </div>
                <div class="prognose-full">
                    <button type="button" onclick="showProjection();" class="prognose-btn">
                        <svg style="width:16px;height:16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        Prognose anzeigen
                    </button>
                </div>
            </div>

            <div style="margin-top:12px; padding-top:10px; border-top:1px solid rgba(156,163,175,0.12);">
                <button id="depot-save-button" type="button" onclick="saveDepot()" style="width:100%; padding:8px 16px; border-radius:6px; border:1px solid #47A190; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; background:rgba(71,161,144,0.1); color:#47A190;">Speichern &amp; Schließen</button>
            </div>
        </div>
    </div>

    <!-- MSCI Renditedreieck Modal -->
    <div id="msci-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="msci-modal-title">
        <div class="w-full h-full max-w-7xl max-h-screen relative flex flex-col" role="document" tabindex="-1">
            <div class="flex justify-between items-center mb-3">
                <h3 id="msci-modal-title" class="text-2xl font-bold text-white">MSCI World Renditedreieck</h3>
                <button type="button" onclick="closeMsciRenditedreieck()" class="text-gray-400 hover:text-gray-900 text-3xl transition-colors" aria-label="MSCI Renditedreieck schließen">&times;</button>
            </div>

            <div class="flex-1 bg-white rounded-lg overflow-hidden relative cursor-zoom-in" id="msci-container" onclick="toggleMsciZoom(event)">
                <img id="msci-image" src="assets/msci_renditedreieck.png" alt="MSCI World Renditedreieck" class="w-full h-full object-contain transition-transform duration-300">
            </div>
            <p class="text-sm text-gray-400 text-center mt-3">Klicke auf das Bild zum Zoomen</p>
        </div>
    </div>

    <!-- v1.6.2: Cost-Average-Effekt Erklärer Modal -->
    <div id="cost-average-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-8 z-[60]" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="cost-average-title">
        <div class="w-full max-w-5xl rounded-xl shadow-2xl p-8 relative" role="document" tabindex="-1" style="max-height: 90vh; overflow-y: auto;">
            <button type="button" onclick="closeCostAverageModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-900 text-3xl transition-colors" aria-label="Cost-Average Erklärer schließen">&times;</button>

            <!-- Phase 1: Vergleichsansicht -->
            <div id="ca-phase-1">
                <h2 id="cost-average-title" class="text-3xl font-bold mb-4" style="color: var(--mlp-corporate-blue);">Warum volatile Kurse bei Sparraten BESSER sind</h2>
                <p class="text-lg text-gray-700 mb-4">Vergleich zweier Kursverläufe - Einzahlung: 1.200 € pro Jahr!</p>

                <!-- v1.7.1: Edit-Mode Controls -->
                <div class="flex gap-2 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <button id="edit-mode-toggle-btn" onclick="toggleEditMode()"
                            class="px-4 py-2 rounded-lg font-semibold transition-all text-sm"
                            style="background: var(--mlp-corporate-blue); color: white;">
                        📝 Bearbeitungsmodus
                    </button>
                    <button id="save-course-btn" onclick="saveCourseData()"
                            class="px-4 py-2 rounded-lg font-semibold transition-all text-sm"
                            style="background: #10b981; color: white; display: none;">
                        💾 Speichern & Neuberechnen
                    </button>
                    <button onclick="resetToDefaultCourse()"
                            class="px-4 py-2 rounded-lg font-semibold transition-all text-sm"
                            style="background: #6b7280; color: white;">
                        🔄 Zurücksetzen
                    </button>
                    <span id="edit-mode-hint" class="ml-auto text-sm text-gray-500 self-center italic" style="display: none;">
                        💡 Ziehe die Datenpunkte mit der Maus nach oben/unten
                    </span>
                </div>

                <!-- Side-by-Side Comparison -->
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <!-- Kurs A: Stabil -->
                    <div id="ca-box-a" class="p-6 rounded-lg cursor-pointer transition-all hover:shadow-xl" style="background: rgba(3, 61, 93, 0.05); border: 2px solid var(--mlp-corporate-blue);">
                        <h3 class="text-xl font-bold mb-4" style="color: var(--mlp-corporate-blue);">📈 Kurs A: Stabil steigend</h3>

                        <!-- Chart A -->
                        <div class="bg-white p-4 rounded-lg mb-4" style="border: 1px solid var(--mlp-titanium);">
                            <canvas id="ca-chart-a" style="max-height: 250px;"></canvas>
                        </div>

                        <!-- Share Bars Container A -->
                        <div id="ca-share-bars-a" class="space-y-2 mb-4" style="min-height: 200px;">
                            <!-- Will be populated dynamically during animation -->
                        </div>

                        <!-- Counters A -->
                        <div class="space-y-3 p-4 bg-white rounded-lg" style="border: 1px solid var(--mlp-titanium);">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Jahr:</span>
                                <span id="ca-month-a" class="text-lg font-bold" style="color: var(--mlp-corporate-blue);">0 / 10</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Investiert:</span>
                                <span id="ca-invested-a" class="text-lg font-bold" style="color: var(--mlp-corporate-blue);">0 €</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Anteile gesamt:</span>
                                <span id="ca-shares-a" class="text-lg font-bold" style="color: var(--mlp-corporate-blue);">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Kurs B: Volatil -->
                    <div id="ca-box-b" class="p-6 rounded-lg cursor-pointer transition-all hover:shadow-xl" style="background: rgba(193, 41, 61, 0.05); border: 2px solid #C1293D;">
                        <h3 class="text-xl font-bold mb-4" style="color: #C1293D;">📉📈 Kurs B: Volatil mit CRASH</h3>

                        <!-- Chart B -->
                        <div class="bg-white p-4 rounded-lg mb-4" style="border: 1px solid var(--mlp-titanium);">
                            <canvas id="ca-chart-b" style="max-height: 250px;"></canvas>
                        </div>

                        <!-- Share Bars Container B -->
                        <div id="ca-share-bars-b" class="space-y-2 mb-4" style="min-height: 200px;">
                            <!-- Will be populated dynamically during animation -->
                        </div>

                        <!-- Counters B -->
                        <div class="space-y-3 p-4 bg-white rounded-lg" style="border: 1px solid var(--mlp-titanium);">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Jahr:</span>
                                <span id="ca-month-b" class="text-lg font-bold" style="color: #C1293D;">0 / 10</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Investiert:</span>
                                <span id="ca-invested-b" class="text-lg font-bold" style="color: #C1293D;">0 €</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Anteile gesamt:</span>
                                <span id="ca-shares-b" class="text-lg font-bold" style="color: #C1293D;">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instruction Text (replaces button) -->
                <div class="text-center text-gray-600 mb-4">
                    <p class="text-lg">👆 <strong>Klicken Sie auf einen der beiden Kurse</strong>, um die Animation zu starten</p>
                </div>
            </div>

            <!-- Phase 2: Ergebnis (initially hidden, click anywhere to close) -->
            <div id="ca-phase-3" class="cursor-pointer" style="display: none;" onclick="closeCostAverageModal()">
                <h2 class="text-3xl font-bold mb-6" style="color: var(--mlp-corporate-blue);">⚡ Überraschendes Ergebnis!</h2>

                <div class="grid grid-cols-2 gap-8 mb-8">
                    <!-- Kurs A Ergebnis -->
                    <div class="p-8 rounded-lg" style="background: rgba(3, 61, 93, 0.1); border: 2px solid var(--mlp-corporate-blue);">
                        <h3 class="text-2xl font-bold mb-4" style="color: var(--mlp-corporate-blue);">Kurs A (stabil)</h3>
                        <div class="space-y-3">
                            <p class="text-gray-700"><span class="font-semibold">Investiert:</span> 12.000 €</p>
                            <p class="text-gray-700"><span class="font-semibold">Anteile:</span> <span id="ca-result-shares-a">7.856,90</span></p>
                            <p class="text-gray-700"><span class="font-semibold">Kurs im Jahr 10:</span> <span id="ca-result-endprice-a">18,90 €</span></p>
                            <p class="text-gray-700"><span class="font-semibold">Endwert:</span> <span id="ca-result-value-a">148.495,35 €</span></p>
                            <hr style="border-color: var(--mlp-titanium);">
                            <p class="text-2xl font-bold" style="color: var(--color-success);">Gewinn: <span id="ca-result-profit-a">28.495,35 €</span></p>
                            <p class="text-lg text-gray-600">Rendite: <span id="ca-result-return-a">3,8%</span></p>
                        </div>
                    </div>

                    <!-- Kurs B Ergebnis -->
                    <div class="p-8 rounded-lg" style="background: rgba(193, 41, 61, 0.1); border: 2px solid #C1293D;">
                        <h3 class="text-2xl font-bold mb-4" style="color: #C1293D;">Kurs B (volatil) ✅</h3>
                        <div class="space-y-3">
                            <p class="text-gray-700"><span class="font-semibold">Investiert:</span> 12.000 €</p>
                            <p class="text-gray-700"><span class="font-semibold">Anteile:</span> <span id="ca-result-shares-b">23.733,33</span></p>
                            <p class="text-gray-700"><span class="font-semibold">Kurs im Jahr 10:</span> <span id="ca-result-endprice-b">10,50 €</span></p>
                            <p class="text-gray-700"><span class="font-semibold">Endwert:</span> <span id="ca-result-value-b">249.200,00 €</span></p>
                            <hr style="border-color: var(--mlp-titanium);">
                            <p class="text-2xl font-bold" style="color: var(--color-success);">Gewinn: <span id="ca-result-profit-b">129.200,00 €</span></p>
                            <p class="text-lg text-gray-600">Rendite: <span id="ca-result-return-b">13,0%</span></p>
                        </div>
                    </div>
                </div>

                <!-- Crash Insight Box -->
                <div class="p-8 rounded-lg mb-6" style="background: linear-gradient(135deg, #C1293D 0%, #E3691E 100%); color: white;">
                    <h3 class="text-2xl font-bold mb-4">💥 Der Crash-Vorteil:</h3>
                    <p class="text-xl leading-relaxed mb-4">Haben Sie gesehen? <strong>Jahr 2: Crash auf 2,00 €</strong> - und das war <strong>die beste Kaufgelegenheit</strong>!</p>
                    <div class="bg-white bg-opacity-20 p-4 rounded-lg mb-4">
                        <p class="text-lg">🛒 <strong>600 Anteile</strong> für 1.200 € beim Crash (Jahr 2)</p>
                        <p class="text-lg">🛒 Nur <strong>92 Anteile</strong> für 1.200 € bei Kurs A</p>
                    </div>
                    <p class="text-xl leading-relaxed"><strong>Bei Sparraten WOLLEN Sie Crashes</strong> - Sie kaufen dann im Ausverkauf! 🎉</p>
                </div>

                <!-- General Insight Box -->
                <div class="p-8 rounded-lg mb-8" style="background: linear-gradient(135deg, #033D5D 0%, #47A190 100%); color: white;">
                    <h3 class="text-2xl font-bold mb-4">💡 Die Strategie:</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-lg font-bold mb-2">📈 Einmalanlagen (z.B. 50.000 € Erbe):</p>
                            <p class="text-lg opacity-90">→ Stabile Fonds (blau) wählen</p>
                            <p class="text-base opacity-75">Grund: Crash würde sofort viel Geld vernichten</p>
                        </div>
                        <div>
                            <p class="text-lg font-bold mb-2">💰 Sparraten (z.B. monatlich 1.200 €):</p>
                            <p class="text-lg opacity-90">→ Volatile Fonds (rot) wählen</p>
                            <p class="text-base opacity-75">Grund: Crashes sind Chancen - Sie kaufen günstig nach!</p>
                        </div>
                    </div>
                </div>

                <!-- Instruction to close -->
                <div class="text-center text-gray-600 py-4">
                    <p class="text-lg">👆 <strong>Klicken Sie irgendwo, um zurückzukehren</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- v1.6.3: Kriegskasse Erklärer Modal -->
    <div id="kriegskasse-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-8 z-[60]" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="kriegskasse-title">
        <div class="w-full max-w-7xl rounded-xl shadow-2xl p-8 relative" role="document" tabindex="-1" style="max-height: 90vh; overflow-y: auto;">
            <button type="button" onclick="closeKriegskasseModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-900 text-3xl transition-colors" aria-label="Kriegskasse Erklärer schließen">&times;</button>

            <!-- Phase 1: Intro -->
            <div id="kriegskasse-phase-1">
                <h2 id="kriegskasse-title" class="text-3xl font-bold mb-6" style="color: var(--mlp-corporate-blue);">💰 Die Kriegskasse: Schutz UND Chance!</h2>
                <p class="text-lg text-gray-700 mb-8">Drei Szenarien im Crash: Panikverkauf vs. Durchhalten vs. Aktiv Nachkaufen</p>

                <!-- Combined Chart with Toggle -->
                <div class="bg-white p-6 rounded-lg mb-6" style="border: 2px solid var(--mlp-titanium);">
                    <!-- Toggle Switch -->
                    <div class="flex justify-end mb-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <span class="text-sm font-semibold text-gray-700">Tagesgeld-Zufluss (6.000€/Jahr)</span>
                            <div class="relative">
                                <input type="checkbox" id="kriegskasse-inflow-toggle" class="sr-only peer" checked>
                                <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                            </div>
                        </label>
                    </div>
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="kriegskasse-chart-combined"></canvas>
                    </div>
                </div>

                <!-- 3-Column Timelines & Controls -->
                <div class="grid grid-cols-3 gap-6 mb-8">
                    <!-- Scenario A: WITHOUT Tagesgeld -->
                    <div id="kriegskasse-box-a" class="p-6 rounded-lg cursor-pointer transition-all hover:shadow-xl" style="background: rgba(193, 41, 61, 0.05); border: 2px solid #C1293D;">
                        <h3 class="text-xl font-bold mb-4" style="color: #C1293D;">❌ Ohne Reserve</h3>

                        <!-- Timeline A -->
                        <div class="space-y-2 mb-4" id="kriegskasse-timeline-a" style="min-height: 140px;">
                            <div class="text-sm text-gray-500">Klick zum Start...</div>
                        </div>

                        <!-- Counter -->
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Jahr:</span>
                            <span id="kriegskasse-year-a">0 / 10</span>
                        </div>
                    </div>

                    <!-- Scenario B: WITH Tagesgeld (Hold) -->
                    <div id="kriegskasse-box-b" class="p-6 rounded-lg cursor-pointer transition-all hover:shadow-xl" style="background: rgba(3, 61, 93, 0.05); border: 2px solid var(--mlp-corporate-blue);">
                        <h3 class="text-xl font-bold mb-4" style="color: var(--mlp-corporate-blue);">✅ Mit Reserve (Halten)</h3>

                        <!-- Timeline B -->
                        <div class="space-y-2 mb-4" id="kriegskasse-timeline-b" style="min-height: 140px;">
                            <div class="text-sm text-gray-500">Klick zum Start...</div>
                        </div>

                        <!-- Counter -->
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Jahr:</span>
                            <span id="kriegskasse-year-b">0 / 10</span>
                        </div>
                    </div>

                    <!-- Scenario C: WITH Tagesgeld (Active Buy) -->
                    <div id="kriegskasse-box-c" class="p-6 rounded-lg cursor-pointer transition-all hover:shadow-xl" style="background: rgba(166, 168, 171, 0.05); border: 2px solid var(--mlp-titanium);">
                        <h3 class="text-xl font-bold mb-4" style="color: var(--mlp-titanium);">🚀 Mit Reserve + Nachkauf</h3>

                        <!-- Timeline C -->
                        <div class="space-y-2 mb-4" id="kriegskasse-timeline-c" style="min-height: 140px;">
                            <div class="text-sm text-gray-500">Klick zum Start...</div>
                        </div>

                        <!-- Counter -->
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Jahr:</span>
                            <span id="kriegskasse-year-c">0 / 10</span>
                        </div>
                    </div>
                </div>

                <div class="text-center text-gray-600 mb-4">
                    <p class="text-lg">👆 <strong>Klicken Sie auf ein Szenario</strong>, um die Animation zu starten</p>
                </div>
            </div>

            <!-- Phase 2: Ergebnis -->
            <div id="kriegskasse-phase-2" class="cursor-pointer" style="display: none;" onclick="closeKriegskasseModal()">
                <h2 class="text-3xl font-bold mb-6" style="color: var(--mlp-corporate-blue);">⚡ Der Kriegskasse-Effekt!</h2>

                <div class="grid grid-cols-3 gap-6 mb-8">
                    <!-- Scenario A Result -->
                    <div class="p-6 rounded-lg" style="background: rgba(193, 41, 61, 0.1); border: 2px solid #C1293D;">
                        <h3 class="text-xl font-bold mb-3" style="color: #C1293D;">Ohne Reserve ❌</h3>
                        <div class="space-y-2 text-sm">
                            <p class="text-gray-700"><span class="font-semibold">Start:</span> 10.000 €</p>
                            <p class="text-gray-700"><span class="font-semibold">Verkauft (J2):</span> <span id="kriegskasse-result-sold-a">2.000 €</span></p>
                            <p class="text-gray-700"><span class="font-semibold">Re-Entry (J5):</span> <span id="kriegskasse-result-reentry-a">10,5 €</span></p>
                            <hr style="border-color: var(--mlp-titanium);">
                            <p class="text-xl font-bold" style="color: #C1293D;">Endwert: <span id="kriegskasse-result-value-a">8.400 €</span></p>
                            <p class="text-base text-gray-600"><span id="kriegskasse-result-loss-a">-1.600 €</span></p>
                        </div>
                    </div>

                    <!-- Scenario B Result -->
                    <div class="p-6 rounded-lg" style="background: rgba(3, 61, 93, 0.1); border: 2px solid var(--mlp-corporate-blue);">
                        <h3 class="text-xl font-bold mb-3" style="color: var(--mlp-corporate-blue);">Mit Reserve (Halten) ✅</h3>
                        <div class="space-y-2 text-sm">
                            <p class="text-gray-700"><span class="font-semibold">Start:</span> 10.000 €</p>
                            <p class="text-gray-700"><span class="font-semibold">Crash:</span> Durchgehalten! 🛡️</p>
                            <p class="text-gray-700"><span class="font-semibold">Tagesgeld:</span> Für Leben genutzt</p>
                            <hr style="border-color: var(--mlp-titanium);">
                            <p class="text-xl font-bold" style="color: var(--color-success);">Endwert: <span id="kriegskasse-result-value-b">10.500 €</span></p>
                            <p class="text-base text-gray-600"><span id="kriegskasse-result-profit-b">+500 €</span></p>
                        </div>
                    </div>

                    <!-- Scenario C Result -->
                    <div class="p-6 rounded-lg" style="background: rgba(166, 168, 171, 0.1); border: 2px solid var(--mlp-titanium);">
                        <h3 class="text-xl font-bold mb-3" style="color: var(--mlp-titanium);">Mit Reserve + Nachkauf 🚀</h3>
                        <div class="space-y-2 text-sm">
                            <p class="text-gray-700"><span class="font-semibold">Start:</span> 10.000 €</p>
                            <p class="text-gray-700"><span class="font-semibold">Nachkauf (J2):</span> <span id="kriegskasse-result-buy-c">12.000 €</span></p>
                            <p class="text-gray-700"><span class="font-semibold">TG wieder voll:</span> Jahr 4</p>
                            <hr style="border-color: var(--mlp-titanium);">
                            <p class="text-xl font-bold" style="color: var(--color-success);">Endwert: <span id="kriegskasse-result-value-c">17.325 €</span></p>
                            <p class="text-base text-gray-600"><span id="kriegskasse-result-profit-c">+7.325 €</span></p>
                        </div>
                    </div>
                </div>

                <!-- Insight Box -->
                <div class="p-8 rounded-lg mb-8" style="background: linear-gradient(135deg, #E3691E 0%, #C1293D 100%); color: white;">
                    <h3 class="text-2xl font-bold mb-4">🚀 Die Kriegskasse macht's möglich:</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-lg font-bold mb-2">❌ Ohne Reserve:</p>
                            <p class="text-base opacity-90">→ Panikverkauf im Crash (-80%)</p>
                            <p class="text-base opacity-90">→ Zu später Wiedereinstieg</p>
                            <p class="text-base opacity-75 mt-2"><strong>Ergebnis: -1.600 € Verlust</strong></p>
                        </div>
                        <div>
                            <p class="text-lg font-bold mb-2">✅ Mit Reserve (Halten):</p>
                            <p class="text-base opacity-90">→ Durchhalten dank Tagesgeld</p>
                            <p class="text-base opacity-90">→ Volle Erholung mitgenommen</p>
                            <p class="text-base opacity-75 mt-2"><strong>Ergebnis: +500 € Gewinn</strong></p>
                        </div>
                        <div>
                            <p class="text-lg font-bold mb-2">🚀 Mit Reserve + Nachkauf:</p>
                            <p class="text-base opacity-90">→ 12.000 € aus Tagesgeld im Crash nachgekauft (Preis: 2 €)</p>
                            <p class="text-base opacity-90">→ 2 Jahre keine Sparrate (Tagesgeld wieder auffüllen)</p>
                            <p class="text-base opacity-90">→ Massiv mehr Anteile zu Billigpreisen</p>
                            <p class="text-base opacity-75 mt-2"><strong>Ergebnis: +7.325 € Gewinn - <span id="kriegskasse-difference-c">6.825 € mehr</span> als Halten!</strong></p>
                        </div>
                    </div>
                </div>

                <!-- Instruction to close -->
                <div class="text-center text-gray-600 py-4">
                    <p class="text-base">👆 <strong>Klicken Sie irgendwo, um zurückzukehren</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- v1.7.2: Sequence of Returns Risk (SoRR) Simulator Modal -->
    <div id="sorr-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-8 z-[60]" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="sorr-title">
        <div class="w-full max-w-7xl rounded-xl shadow-2xl p-8 relative overflow-y-auto" role="document" tabindex="-1" style="max-height: 95vh;">
            <button type="button" onclick="closeSoRRModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-900 text-3xl transition-colors z-10" aria-label="SoRR Simulator schließen">&times;</button>

            <h2 id="sorr-title" class="text-3xl font-bold mb-2" style="color: var(--mlp-corporate-blue);">
                ⚠️ Sequence of Returns Risk
            </h2>
            <p class="text-lg text-gray-700 mb-6">
                Warum die Reihenfolge der Renditen in der Entnahmephase entscheidend ist.
                <span class="text-sm text-gray-500 block mt-1">Datenbasis: MSCI World (2005–2024)</span>
            </p>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

                <!-- LEFT COLUMN: Controls & Data Table -->
                <div class="lg:col-span-4 space-y-6">

                    <!-- Parameter Controls -->
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            Parameter
                        </h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Startkapital</label>
                                <div class="relative">
                                    <input type="number" id="sorr-initial-capital" value="500000" oninput="updateSoRRWithdrawalRate()"
                                           class="mlp-input-field-v2">
                                    <span class="absolute right-3 top-2 text-gray-400">€</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jährliche Entnahme (Start)</label>
                                <div class="relative">
                                    <input type="number" id="sorr-annual-withdrawal" value="20000" oninput="updateSoRRWithdrawalRate()"
                                           class="mlp-input-field-v2">
                                    <span class="absolute right-3 top-2 text-gray-400">€</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span id="sorr-withdrawal-rate">4.0</span>% Entnahmerate
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dynamik der Entnahme</label>
                                <div class="relative">
                                    <input type="number" id="sorr-inflation" value="2.0" step="0.1"
                                           class="mlp-input-field-v2">
                                    <span class="absolute right-3 top-2 text-gray-400">% p.a.</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Inflationsanpassung der Entnahmen</p>
                            </div>

                            <button onclick="runSoRRSimulation()"
                                    class="mlp-btn mlp-btn-primary w-full py-2 px-4">
                                🔄 Neu berechnen
                            </button>
                        </div>
                    </div>

                    <!-- Renditen-Tabelle (sortierbar) -->
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">MSCI World Renditen</h3>
                            <span id="sorr-avg-return" class="text-xs bg-blue-100 text-blue-800 py-1 px-2 rounded-full font-semibold">
                                Ø 9.50% p.a.
                            </span>
                        </div>
                        <div class="overflow-y-auto max-h-[400px]">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-200 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-300" onclick="sortSoRRTable('year')">
                                            <div class="flex items-center gap-1">
                                                Jahr
                                                <svg id="sorr-sort-icon-year" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                        <th class="px-4 py-2 text-right cursor-pointer hover:bg-gray-300" onclick="sortSoRRTable('return')">
                                            <div class="flex justify-end items-center gap-1">
                                                Rendite
                                                <svg id="sorr-sort-icon-return" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="sorr-returns-table" class="divide-y divide-gray-100">
                                    <!-- Will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- RIGHT COLUMN: Visualization -->
                <div class="lg:col-span-8 space-y-6">

                    <!-- Chart Container -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 id="sorr-chart-title" class="text-lg font-semibold">Vermögensentwicklung</h3>
                            <button id="sorr-compare-btn" onclick="toggleSoRRCompare()" class="mlp-btn mlp-btn-tertiary text-xs py-2 px-4">
                                Alle Szenarien vergleichen
                            </button>
                        </div>
                        <p id="sorr-chart-subtitle" class="text-sm text-gray-500 mb-6">
                            Sortiere die Tabelle links, um das Szenario zu wechseln.
                        </p>
                        <div style="position: relative; height: 450px;">
                            <canvas id="sorr-chart"></canvas>
                        </div>
                    </div>

                    <!-- Result Cards -->
                    <div id="sorr-result-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="sorr-card-history" class="p-4 rounded-lg border border-green-200 bg-green-50">
                            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Historisch (2005-2024)</h4>
                            <div id="sorr-result-history" class="text-2xl font-bold mt-1 text-green-700">500.000 €</div>
                            <div id="sorr-duration-history" class="text-xs text-gray-600 mt-1 font-medium">Endlos</div>
                            <p class="text-xs text-gray-500 mt-2">Startet schwach (2008 Crash), endet stark.</p>
                        </div>
                        <div id="sorr-card-reverse" class="p-4 rounded-lg border border-blue-200 bg-blue-50">
                            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Best-First (2009→2008)</h4>
                            <div id="sorr-result-reverse" class="text-2xl font-bold mt-1 text-blue-700">500.000 €</div>
                            <div id="sorr-duration-reverse" class="text-xs text-gray-600 mt-1 font-medium">Endlos</div>
                            <p class="text-xs text-gray-500 mt-2">Startet stark (2009, 2019...), endet mit dem Crash (2008, 2022...).</p>
                        </div>
                        <div id="sorr-card-worst" class="p-4 rounded-lg border border-red-200 bg-red-50">
                            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Worst-First</h4>
                            <div id="sorr-result-worst" class="text-2xl font-bold mt-1 text-red-700">500.000 €</div>
                            <div id="sorr-duration-worst" class="text-xs text-gray-600 mt-1 font-medium">Endlos</div>
                            <p class="text-xs text-gray-500 mt-2">-40% Crash direkt im ersten Jahr!</p>
                        </div>
                    </div>

                    <!-- Lesson Box -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-md">
                        <div class="flex gap-3">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-yellow-800 mb-1">Wie managed man dieses Risiko intelligent?</p>
                                <p class="text-sm text-yellow-700">
                                    Obwohl in allen Szenarien die Summe der Renditen identisch ist, entscheidet die <strong>Reihenfolge</strong> über "Reichtum" oder "Pleite".
                                    In der Entnahmephase wiegen frühe Verluste <strong>doppelt schwer</strong>, da sich das entnommene Geld nie wieder erholen kann.
                                    <br><br>
                                    <strong>Lösung:</strong> Liquiditätsreserve (Tagesgeld/Festgeld) für 2-3 Jahre Entnahmen → Ermöglicht, Crashs auszusitzen ohne verkaufen zu müssen!
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- v1.7.8: Slider-Styling für Anleihen-Modal -->
    <style>
        /* v2.0: Smooth tab transitions */
        #anleihen-modal [id^="anleihen-tab-"] {
            transition: opacity 0.25s ease;
        }
        #anleihen-modal [id^="anleihen-tab-btn-"] {
            transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
        }

        #anleihen-modal input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--mlp-secondary);
            outline: none;
        }
        #anleihen-modal input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--mlp-primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #anleihen-modal input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--mlp-primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #anleihen-modal input[type="range"]::-moz-range-track {
            height: 6px;
            border-radius: 3px;
            background: var(--mlp-secondary);
        }
    </style>

    <!-- v1.7.8: Aktien & Anleihen Erklärer Modal -->
    <div id="anleihen-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-8 z-[60]" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="anleihen-title">
        <div class="w-full max-w-7xl rounded-xl shadow-2xl p-8 relative overflow-y-auto" role="document" tabindex="-1" style="max-height: 95vh;">
            <button type="button" onclick="closeAnleihenModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-900 text-3xl transition-colors z-10" aria-label="Aktien & Anleihen Modal schließen">&times;</button>

            <h2 id="anleihen-title" class="text-3xl font-bold mb-2" style="color: var(--mlp-corporate-blue);">
                📊 Aktien & Anleihen
            </h2>
            <p class="text-lg mb-6" style="color: #2B2B2B;">
                Warum Aktien langfristig mehr Rendite bringen müssen als Anleihen.
            </p>

            <!-- Tab-Navigation -->
            <div class="flex gap-2 mb-6">
                <button id="anleihen-tab-btn-duration" onclick="switchAnleihenTab('duration')"
                    class="px-4 py-2 rounded-lg font-semibold text-sm" style="background: var(--mlp-primary); color: white;">
                    Zinssensitivität
                </button>
                <button id="anleihen-tab-btn-seesaw" onclick="switchAnleihenTab('seesaw')"
                    class="px-4 py-2 rounded-lg font-semibold text-sm" style="background: var(--card); color: var(--fg); border: 1px solid var(--border);">
                    Inverse Beziehung
                </button>
                <button id="anleihen-tab-btn-spread" onclick="switchAnleihenTab('spread')"
                    class="px-4 py-2 rounded-lg font-semibold text-sm" style="background: var(--card); color: var(--fg); border: 1px solid var(--border);">
                    Equity Premium
                </button>
            </div>

            <!-- Tab 1: Zinssensitivität (Duration) -->
            <div id="anleihen-tab-duration">
                <div class="grid grid-cols-12 gap-6">
                    <!-- Left: Inputs (4 cols) -->
                    <div class="col-span-4 space-y-4">
                        <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wide" style="color: #033D5D;">Anleihe-Parameter</h3>

                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1" style="color: #2B2B2B;">Kupon (Zinssatz)</label>
                                <div class="relative">
                                    <input type="number" id="anleihen-kupon" value="3.0" step="0.5" min="0" max="15"
                                        class="w-full p-2 rounded-md focus:outline-none" style="border: 1px solid #BEB6AA; color: #2B2B2B;"
                                        onchange="updateDurationChart()">
                                    <span class="absolute right-3 top-2" style="color: #717171;">% p.a.</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1" style="color: #2B2B2B;">Restlaufzeit</label>
                                <div class="relative">
                                    <input type="number" id="anleihen-laufzeit" value="10" step="1" min="1" max="30"
                                        class="w-full p-2 rounded-md focus:outline-none" style="border: 1px solid #BEB6AA; color: #2B2B2B;"
                                        onchange="updateDurationChart()">
                                    <span class="absolute right-3 top-2" style="color: #717171;">Jahre</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1" style="color: #2B2B2B;">Nennwert</label>
                                <div class="relative">
                                    <input type="number" id="anleihen-nennwert" value="10000" step="1000" min="1000"
                                        class="w-full p-2 rounded-md focus:outline-none" style="border: 1px solid #BEB6AA; color: #2B2B2B;"
                                        onchange="updateDurationChart()">
                                    <span class="absolute right-3 top-2" style="color: #717171;">€</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wide" style="color: #033D5D;">Zinsänderung</h3>
                            <label class="block text-sm font-medium mb-1" style="color: #2B2B2B;">
                                Marktzins ändert sich um: <span id="anleihen-zinsdelta-display" class="font-bold" style="color: #033D5D;">+1.0%</span>
                            </label>
                            <input type="range" id="anleihen-zinsdelta" min="-3" max="3" step="0.5" value="1.0"
                                class="w-full" style="accent-color: #033D5D;"
                                oninput="var v=parseFloat(this.value); document.getElementById('anleihen-zinsdelta-display').textContent = (v>=0?'+':'')+v.toFixed(1)+'%'; updateDurationChart();">
                            <div class="flex justify-between text-xs mt-1" style="color: #717171;">
                                <span>-3.0%</span>
                                <span>0</span>
                                <span>+3.0%</span>
                            </div>
                        </div>

                        <!-- Ergebnis-Card -->
                        <div id="anleihen-duration-result" class="p-4 rounded-lg" style="background: rgba(3,61,93,0.06); border: 1px solid rgba(3,61,93,0.2);">
                            <div class="text-sm font-semibold mb-1" style="color: #033D5D;">Aktueller Kurs</div>
                            <div id="anleihen-kurs-wert" class="text-2xl font-bold" style="color: #033D5D;">10.000 €</div>
                            <div id="anleihen-kurs-prozent" class="text-sm" style="color: #47A190;">100,00% vom Nennwert</div>
                        </div>
                    </div>

                    <!-- Right: Chart (8 cols) -->
                    <div class="col-span-8">
                        <div class="bg-white rounded-lg p-4" style="height: 420px; border: 1px solid #BEB6AA; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                            <canvas id="anleihen-duration-chart"></canvas>
                        </div>
                        <p class="text-xs mt-2 text-center" style="color: #717171;">
                            Kursänderung der Anleihe bei Zinsänderung — je kürzer die Restlaufzeit, desto geringer die Schwankung (Pull-to-Par)
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Inverse Beziehung (Füllstands-Visualisierung) -->
            <div id="anleihen-tab-seesaw" style="display: none;">
                <div class="grid grid-cols-12 gap-6">
                    <!-- Left: Controls (4 cols) -->
                    <div class="col-span-4 space-y-4">
                        <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wide" style="color: #033D5D;">Marktzins</h3>
                            <label class="block text-sm font-medium mb-1" style="color: #2B2B2B;">
                                Aktueller Marktzins: <span id="anleihen-marktzins-display" class="font-bold" style="color: #033D5D;">3.0%</span>
                            </label>
                            <input type="range" id="anleihen-marktzins" min="0" max="5" step="0.25" value="3.0"
                                class="w-full" style="accent-color: #033D5D;"
                                oninput="document.getElementById('anleihen-marktzins-display').textContent = this.value + '%'; updateSeesawVis();">
                            <div class="flex justify-between text-xs mt-1" style="color: #717171;">
                                <span>0%</span>
                                <span>5%</span>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wide" style="color: #033D5D;">Anleihe-Daten</h3>
                            <p class="text-sm mb-1" style="color: #2B2B2B;">Kupon: <span id="seesaw-kupon" class="font-semibold">3.0%</span></p>
                            <p class="text-sm mb-1" style="color: #2B2B2B;">Laufzeit: <span id="seesaw-laufzeit" class="font-semibold">10 Jahre</span></p>
                            <p class="text-xs mt-2" style="color: #717171;">(Übernommen aus Tab 1)</p>
                        </div>

                        <!-- Kurs-Anzeige -->
                        <div id="seesaw-result" class="p-4 rounded-lg" style="background: rgba(3,61,93,0.06); border: 1px solid rgba(3,61,93,0.2);">
                            <div class="text-sm font-semibold mb-1" style="color: #033D5D;">Anleihekurs</div>
                            <div id="seesaw-kurs-wert" class="text-2xl font-bold" style="color: #033D5D;">100,00%</div>
                            <div id="seesaw-kurs-euro" class="text-sm" style="color: #47A190;">10.000 €</div>
                        </div>
                    </div>

                    <!-- Right: Füllstands-Visualisierung (8 cols) -->
                    <div class="col-span-8">
                        <div class="p-8 rounded-lg" style="background: #FFFFFF; border: 1px solid #BEB6AA; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">

                            <!-- Zwei Tanks nebeneinander -->
                            <div class="flex items-end justify-center gap-16">

                                <!-- Tank Links: Marktzins -->
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-semibold mb-2 uppercase tracking-wide" style="color: #BEB6AA;">Marktzins</div>
                                    <div class="relative" style="width: 120px; height: 280px; border: 2px solid #BEB6AA; border-radius: 8px; background: #F8F8F8; overflow: hidden;">
                                        <!-- Füllstand -->
                                        <div id="seesaw-tank-zins" style="position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, #BEB6AA, #d4cfc7); border-radius: 0 0 6px 6px; transition: height 0.5s ease-out;"></div>
                                        <!-- Wert-Label -->
                                        <div id="seesaw-tank-zins-label" class="absolute inset-0 flex items-center justify-center text-xl font-bold" style="color: #033D5D; text-shadow: 0 1px 2px rgba(255,255,255,0.8);">3.0%</div>
                                    </div>
                                    <!-- Skala-Markierungen -->
                                    <div class="flex justify-between w-full mt-1 text-xs" style="color: #717171;">
                                        <span>0%</span>
                                        <span>5%</span>
                                    </div>
                                </div>

                                <!-- Verbindungs-Indikator -->
                                <div class="flex flex-col items-center gap-2 self-center">
                                    <svg width="80" height="48" viewBox="0 0 80 48">
                                        <!-- Pfeil links nach rechts oben -->
                                        <path d="M 8,36 C 30,36 50,12 72,12" fill="none" stroke="#47A190" stroke-width="2.5" stroke-dasharray="5 3">
                                            <animate attributeName="stroke-dashoffset" values="0;-16" dur="1s" repeatCount="indefinite"/>
                                        </path>
                                        <polygon points="72,12 62,8 64,16" fill="#47A190"/>
                                        <!-- Pfeil rechts nach links unten -->
                                        <path d="M 72,36 C 50,36 30,12 8,12" fill="none" stroke="#47A190" stroke-width="2.5" stroke-dasharray="5 3">
                                            <animate attributeName="stroke-dashoffset" values="0;-16" dur="1s" repeatCount="indefinite"/>
                                        </path>
                                        <polygon points="8,12 18,8 16,16" fill="#47A190"/>
                                    </svg>
                                    <div class="text-xs font-semibold text-center" style="color: #47A190;">invers<br>gekoppelt</div>
                                </div>

                                <!-- Tank Rechts: Anleihekurs -->
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-semibold mb-2 uppercase tracking-wide" style="color: #033D5D;">Anleihekurs</div>
                                    <div class="relative" style="width: 120px; height: 280px; border: 2px solid #033D5D; border-radius: 8px; background: #F8F8F8; overflow: hidden;">
                                        <!-- Füllstand -->
                                        <div id="seesaw-tank-kurs" style="position: absolute; bottom: 0; left: 0; right: 0; height: 50%; background: linear-gradient(to top, #033D5D, #0a5a8a); border-radius: 0 0 6px 6px; transition: height 0.5s ease-out;"></div>
                                        <!-- Wert-Label -->
                                        <div id="seesaw-tank-kurs-label" class="absolute inset-0 flex items-center justify-center text-xl font-bold" style="color: #033D5D; text-shadow: 0 1px 2px rgba(255,255,255,0.8);">100%</div>
                                        <!-- Par-Linie (100% = 50% in 80-120 range) -->
                                        <div id="seesaw-par-dash" style="position: absolute; bottom: 50%; left: -4px; right: -4px; height: 0; border-top: 2px dashed #BEB6AA;"></div>
                                        <div id="seesaw-par-line" style="position: absolute; bottom: 50%; right: -36px; font-size: 10px; color: #717171; font-weight: 600;">100%</div>
                                    </div>
                                    <!-- Skala -->
                                    <div class="flex justify-between w-full mt-1 text-xs" style="color: #717171;">
                                        <span>80%</span>
                                        <span>120%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamischer Erklärtext -->
                            <div id="seesaw-explain" class="mt-6 p-4 rounded-lg text-center" style="background: var(--card); border: 1px solid var(--border);">
                                <p class="text-sm" style="color: #2B2B2B;" id="seesaw-explain-text">
                                    Bei gleichem Marktzins wie Kupon steht die Anleihe <strong>genau bei Par</strong> (100%). Bewegen Sie den Regler, um die inverse Beziehung zu erleben.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Equity Risk Premium -->
            <div id="anleihen-tab-spread" style="display: none;">

                <!-- Interaktive Kapitalfluss-Erklärung -->
                <div class="grid grid-cols-12 gap-6">
                    <!-- Left: Slider + Ergebnis (4 cols) -->
                    <div class="col-span-4 space-y-4">
                        <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wide" style="color: #033D5D;">Unternehmens-Rendite</h3>
                            <label class="block text-sm font-medium mb-1" style="color: #2B2B2B;">
                                Das Unternehmen erwirtschaftet: <span id="equity-rendite-display" class="font-bold" style="color: #033D5D;">8%</span>
                            </label>
                            <input type="range" id="equity-rendite-slider" min="0" max="15" step="0.5" value="8"
                                class="w-full" style="accent-color: #033D5D;"
                                oninput="updateEquityFlow();">
                            <div class="flex justify-between text-xs mt-1" style="color: #717171;">
                                <span>0%</span>
                                <span>15%</span>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                            <h3 class="text-sm font-semibold mb-3 uppercase tracking-wide" style="color: #033D5D;">Anleihe-Kosten</h3>
                            <label class="block text-sm font-medium mb-1" style="color: #2B2B2B;">
                                Zinsen an Anleihegläubiger: <span id="equity-zins-display" class="font-bold" style="color: #BEB6AA;">3%</span>
                            </label>
                            <input type="range" id="equity-zins-slider" min="0" max="10" step="0.5" value="3"
                                class="w-full" style="accent-color: #BEB6AA;"
                                oninput="updateEquityFlow();">
                            <div class="flex justify-between text-xs mt-1" style="color: #717171;">
                                <span>0%</span>
                                <span>10%</span>
                            </div>
                        </div>

                        <!-- Ergebnis -->
                        <div id="equity-result-card" class="p-4 rounded-lg" style="background: rgba(71,161,144,0.08); border: 1px solid rgba(71,161,144,0.3);">
                            <div class="text-sm font-semibold mb-1" id="equity-result-label" style="color: #47A190;">Gewinn der Aktionäre</div>
                            <div id="equity-result-value" class="text-2xl font-bold" style="color: #033D5D;">+5,0%</div>
                            <div id="equity-result-text" class="text-sm" style="color: #47A190;">Equity Risk Premium</div>
                        </div>

                        <!-- Fazit-Box -->
                        <div id="equity-fazit" class="p-3 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                            <p class="text-xs" style="color: #2B2B2B;" id="equity-fazit-text">
                                <strong>Ergebnis:</strong> Das Unternehmen verdient 5% mehr als es für das geliehene Geld zahlt. Dieser Überschuss steigert den Unternehmenswert und gehört den Aktionären.
                            </p>
                        </div>
                    </div>

                    <!-- Right: Visualisierung (8 cols) -->
                    <div class="col-span-8 flex items-center justify-center">
                        <svg id="equity-flow-svg" viewBox="0 0 560 400" class="w-full" style="max-width: 560px;">
                            <!-- Unternehmen (Zentrum) -->
                            <rect x="190" y="130" width="180" height="80" rx="12" fill="#033D5D" stroke="#022a40" stroke-width="2"/>
                            <text x="280" y="162" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Unternehmen</text>
                            <text x="280" y="182" text-anchor="middle" fill="#8ec5e0" font-size="12" id="equity-company-text">erwirtschaftet 8%</text>

                            <!-- Anleihegläubiger (Links) — Titanium -->
                            <rect x="10" y="10" width="150" height="60" rx="10" fill="#BEB6AA" stroke="#a89e90" stroke-width="2"/>
                            <text x="85" y="35" text-anchor="middle" fill="#2B2B2B" font-size="12" font-weight="bold">Anleihegläubiger</text>
                            <text x="85" y="52" text-anchor="middle" fill="#5a5349" font-size="11">(Fremdkapital)</text>

                            <!-- Pfeil-Marker -->
                            <defs>
                                <marker id="arrow-titanium" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#BEB6AA"/>
                                </marker>
                                <marker id="arrow-mlp" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#033D5D"/>
                                </marker>
                                <marker id="arrow-tuerkis" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#47A190"/>
                                </marker>
                                <marker id="arrow-warn" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#C1293D"/>
                                </marker>
                            </defs>

                            <!-- Pfeil: Gläubiger verleihen Geld → Unternehmen -->
                            <path d="M 135,70 C 135,100 210,100 210,130" fill="none" stroke="#033D5D" stroke-width="2.5" stroke-dasharray="6 3" marker-end="url(#arrow-mlp)"/>
                            <text x="145" y="100" fill="#033D5D" font-size="10" font-weight="600">verleiht Geld</text>

                            <!-- Pfeil: Unternehmen zahlt Zinsen → Gläubiger -->
                            <path d="M 190,150 C 140,150 85,110 85,70" fill="none" stroke="#BEB6AA" stroke-width="3" marker-end="url(#arrow-titanium)">
                                <animate attributeName="stroke-dasharray" values="0 200;200 0" dur="2s" repeatCount="indefinite"/>
                            </path>
                            <rect x="75" y="102" width="70" height="22" rx="4" fill="white" stroke="#BEB6AA" stroke-width="1"/>
                            <text x="110" y="117" text-anchor="middle" fill="#8a8179" font-size="12" font-weight="bold" id="equity-zins-flow">3% Zinsen</text>
                            <text x="110" y="90" text-anchor="middle" fill="#8a8179" font-size="9">„Miete" für Geld</text>

                            <!-- Aktionäre (Rechts) — Türkis -->
                            <rect x="400" y="10" width="150" height="60" rx="10" fill="#47A190" stroke="#3a8474" stroke-width="2" id="equity-aktionaer-box"/>
                            <text x="475" y="35" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Aktionäre</text>
                            <text x="475" y="52" text-anchor="middle" fill="#c5e8e0" font-size="11">(Eigenkapital)</text>

                            <!-- Pfeil: Unternehmen → Aktionäre (Gewinn) -->
                            <path d="M 350,150 C 400,150 475,110 475,70" fill="none" stroke="#47A190" stroke-width="3" id="equity-profit-arrow" marker-end="url(#arrow-tuerkis)">
                                <animate attributeName="stroke-dasharray" values="0 200;200 0" dur="2s" repeatCount="indefinite"/>
                            </path>
                            <rect x="385" y="102" width="85" height="22" rx="4" fill="white" stroke="#47A190" stroke-width="1" id="equity-profit-bg"/>
                            <text x="428" y="117" text-anchor="middle" fill="#3a8474" font-size="12" font-weight="bold" id="equity-profit-flow">+5% Gewinn</text>
                            <text x="428" y="90" text-anchor="middle" fill="#3a8474" font-size="9" id="equity-profit-label">Wertsteigerung</text>

                            <!-- Balken-Vergleich unten -->
                            <text x="280" y="250" text-anchor="middle" fill="#2B2B2B" font-size="12" font-weight="bold">Aufteilung der Unternehmensrendite</text>

                            <!-- Balken: Gesamt-Rendite -->
                            <rect x="80" y="268" width="400" height="30" rx="6" fill="#F8F8F8" stroke="#BEB6AA" stroke-width="1"/>

                            <!-- Balken: Zinskosten (Titanium) -->
                            <rect x="80" y="268" rx="6" height="30" fill="#BEB6AA" id="equity-bar-zins" width="150"/>
                            <text y="288" fill="white" font-size="11" font-weight="bold" id="equity-bar-zins-text" x="155" text-anchor="middle">3%</text>

                            <!-- Balken: Gewinn (Türkis) -->
                            <rect y="268" height="30" fill="#47A190" id="equity-bar-gewinn" x="230" width="250" rx="0"/>
                            <text y="288" fill="white" font-size="11" font-weight="bold" id="equity-bar-gewinn-text" x="355" text-anchor="middle">5%</text>

                            <!-- Labels unter Balken -->
                            <text x="155" y="315" text-anchor="middle" fill="#8a8179" font-size="10" id="equity-bar-label-zins">Zinsen (Anleihe)</text>
                            <text x="355" y="315" text-anchor="middle" fill="#3a8474" font-size="10" id="equity-bar-label-gewinn">Aktionärsgewinn</text>

                            <!-- Warnung bei Verlust -->
                            <g id="equity-warning" style="display: none;">
                                <rect x="130" y="335" width="300" height="36" rx="8" fill="#fef2f2" stroke="#C1293D" stroke-width="1.5"/>
                                <text x="280" y="350" text-anchor="middle" fill="#C1293D" font-size="11" font-weight="bold" id="equity-warning-text">Unternehmen kann Zinsen nicht bedienen!</text>
                                <text x="280" y="365" text-anchor="middle" fill="#C1293D" font-size="10">Insolvenzgefahr</text>
                            </g>
                        </svg>
                    </div>
                </div>

                <!-- Drei Erklärsäulen -->
                <div class="mt-6 grid grid-cols-3 gap-4">
                    <div class="p-4 rounded-lg" style="background: rgba(190,182,170,0.12); border: 1px solid #BEB6AA;">
                        <p class="font-semibold mb-1 text-sm" style="color: #033D5D;">1. Anleihe = „Miete" für Geld</p>
                        <p class="text-xs" style="color: #2B2B2B;">Das Unternehmen gibt eine Anleihe heraus und verspricht, regelmäßig Zinsen zu zahlen. Wie ein Mieter, der Miete für eine Wohnung zahlt — nur hier ist es Miete für geliehenes Kapital.</p>
                    </div>
                    <div class="p-4 rounded-lg" style="background: rgba(71,161,144,0.06); border: 1px solid rgba(71,161,144,0.3);">
                        <p class="font-semibold mb-1 text-sm" style="color: #033D5D;">2. Gewinne > Miete = Wachstum</p>
                        <p class="text-xs" style="color: #2B2B2B;">Das Unternehmen investiert das Geld in Projekte und Produkte. Die Gewinne daraus müssen höher sein als die Zinszahlungen — sonst lohnt sich das Geschäft nicht. Der Überschuss steigert den Unternehmenswert.</p>
                    </div>
                    <div class="p-4 rounded-lg" style="background: rgba(3,61,93,0.04); border: 1px solid rgba(3,61,93,0.15);">
                        <p class="font-semibold mb-1 text-sm" style="color: #033D5D;">3. Aktionäre profitieren vom Rest</p>
                        <p class="text-xs" style="color: #2B2B2B;">Erst werden die Anleihegläubiger bezahlt (Priorität!). Was übrig bleibt, gehört den Aktionären. Dafür tragen sie das volle Risiko — und verlangen deshalb langfristig eine höhere Rendite als Anleihen bieten.</p>
                    </div>
                </div>
            </div>

            <!-- Lesson Box (immer sichtbar) -->
            <div class="mt-6 p-4 rounded-lg" style="background: rgba(3,61,93,0.04); border-left: 4px solid var(--border);">
                <p class="text-sm" style="color: #2B2B2B;">
                    <strong style="color: #033D5D;">Merke:</strong> Eine Anleihe ist nur dann „sicher", wenn der Emittent zahlungsfähig bleibt
                    und man die Laufzeit aussitzt. Die Schwankungen dazwischen sind lediglich Opportunitätskosten des Marktes.
                </p>
            </div>
        </div>
    </div>

    <!-- Immobilien Modal -->
    <div id="immobilien-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="immobilien-modal-title" aria-describedby="immobilien-modal-description">
        <div class="w-full max-w-3xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('immobilien-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-900 text-2xl transition-colors" aria-label="Immobilienfenster schließen">&times;</button>
            <h3 id="immobilien-modal-title" class="text-xl font-bold mb-4">Immobilien-Verwaltung</h3>
            <p id="immobilien-modal-description" class="text-sm text-gray-600 -mt-3 mb-4">Verwalte deine Immobilien, Einnahmen und Ausgaben.</p>

            <!-- Anzahl Immobilien -->
            <div class="mb-4 p-4 rounded-lg flex items-center gap-4" style="background: var(--card); border: 1px solid var(--border);">
                <label class="text-sm whitespace-nowrap" style="color: var(--muted);">Anzahl Immobilien</label>
                <input type="number" id="immo-anzahl" value="1" min="0" max="99" class="w-20 mlp-input-field-v2 text-center" inputmode="numeric">
            </div>

            <!-- Grid für 2 Kategorien -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Vermögen (Immobilienwert) -->
                <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                    <h4 class="text-lg font-bold mb-3" style="color: var(--mlp-success);">Vermögen</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Immobilienwert</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-wert" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="Wert der Immobilie">
                                <span style="color: var(--muted);">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Wertsteigerung (optional)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-wertsteigerung" value="0" step="0.1" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="z.B. 2.0">
                                <span style="color: var(--muted);">% p.a.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verbindlichkeiten -->
                <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                    <h4 class="text-lg font-bold mb-3" style="color: var(--mlp-error);">Verbindlichkeiten</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Restdarlehen (aktuell)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-darlehen" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="Aktuelle Restschuld">
                                <span style="color: var(--muted);">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Ursprüngliches Darlehen</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-darlehen-original" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="Darlehensbetrag bei Aufnahme">
                                <span style="color: var(--muted);">€</span>
                            </div>
                            <p class="text-xs mt-1" style="color: var(--muted);">Für korrekte Ratenberechnung (Annuität bleibt konstant)</p>
                        </div>
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Zinssatz (optional)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-zinssatz" value="0" step="0.1" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="z.B. 3.5">
                                <span style="color: var(--muted);">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Tilgungssatz (optional)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-tilgungssatz" value="0" step="0.1" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="z.B. 2.0">
                                <span style="color: var(--muted);">%</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Zusammenfassung -->
            <div class="mt-6 p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                <div class="text-center">
                    <p class="text-sm mb-2" style="color: var(--muted);">Nettovermögen (Wert - Darlehen)</p>
                    <p id="immo-nettovermoegen" class="text-3xl font-bold" style="color: var(--mlp-success);">0 €</p>
                </div>
            </div>

            <!-- Berechnete Darlehensrate anzeigen -->
            <div id="immo-rate-berechnet-display" class="mt-6 p-4 rounded-lg hidden" style="background: rgba(3,61,93,0.06); border: 1px solid var(--mlp-primary);">
                <h4 class="text-sm font-semibold mb-2" style="color: var(--mlp-primary);">📊 Berechnete monatliche Darlehensrate</h4>
                <p class="text-2xl font-bold" style="color: var(--fg);"><span id="immo-rate-berechnet-wert">0 €</span></p>
                <p class="text-xs mt-1" style="color: var(--muted);">
                    Zinsen: <span id="immo-rate-zinsen">0 €</span> | Tilgung: <span id="immo-rate-tilgung">0 €</span>
                </p>
                <p class="text-xs mt-2" style="color: var(--mlp-primary);">💡 Diese Rate wird automatisch ins Vermieterkonto übertragen.</p>
            </div>

            <!-- Tilgungsplan Slider -->
            <div id="immo-tilgungsplan-section" class="mt-6 p-4 rounded-lg hidden" style="background: var(--card); border: 1px solid var(--border);">
                <h4 class="text-lg font-bold mb-3" style="color: var(--mlp-primary);">📈 Tilgungsplan & Vermögensaufbau</h4>

                <div class="mb-4">
                    <label class="text-sm block mb-2" style="color: var(--muted);">
                        Zeitraum: <span id="immo-tilgungsplan-jahre" class="font-bold" style="color: var(--fg);">10</span> Jahre
                    </label>
                    <input type="range" id="immo-tilgungsplan-slider" min="0" max="20" value="10" step="1" class="w-full mlp-slider">
                    <div class="flex justify-between text-xs" style="color: var(--muted);">
                        <span>0 Jahre</span>
                        <span>20 Jahre</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div class="text-center">
                        <p class="text-xs" style="color: var(--muted);">Restschuld</p>
                        <p id="immo-tilgungsplan-restschuld" class="text-lg font-bold" style="color: var(--mlp-error);">0 €</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs" style="color: var(--muted);">Gezahlte Zinsen</p>
                        <p id="immo-tilgungsplan-zinsen" class="text-lg font-bold" style="color: var(--mlp-warning);">0 €</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs" style="color: var(--muted);">Eigenkapital</p>
                        <p id="immo-tilgungsplan-eigenkapital" class="text-lg font-bold" style="color: var(--mlp-success);">0 €</p>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <p class="text-xs" style="color: var(--muted);">Immobilienwert (mit Wertsteigerung)</p>
                    <p id="immo-tilgungsplan-wert" class="text-xl font-bold" style="color: var(--mlp-primary);">0 €</p>
                </div>
            </div>

            <div class="mt-4 p-3 rounded-lg" style="background: rgba(3,61,93,0.04); border-left: 4px solid var(--border);">
                <p class="text-sm" style="color: var(--fg);">💡 <strong style="color: var(--mlp-primary);">Tipp:</strong> Einnahmen und Ausgaben werden im <strong>Vermieterkonto</strong> verwaltet.</p>
            </div>

            <button type="button" onclick="saveImmobilien()" class="mlp-btn mlp-btn-primary mt-6 w-full py-2 px-4">Speichern &amp; Schließen</button>
        </div>
    </div>

    <!-- Vermieterkonto Modal -->
    <div id="vermieterkonto-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="vermieterkonto-modal-title">
        <div class="w-full max-w-2xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('vermieterkonto-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-900 text-2xl transition-colors" aria-label="Vermieterkonto schließen">&times;</button>
            <h3 id="vermieterkonto-modal-title" class="text-xl font-bold mb-4">Vermieterkonto</h3>
            <p class="text-sm -mt-3 mb-4" style="color: var(--muted);">Alle Einnahmen und Ausgaben deiner Immobilien laufen über dieses kostenlose Konto.</p>

            <!-- Grid für 2 Kategorien -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Monatliche Einnahmen -->
                <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                    <h4 class="text-lg font-bold mb-3" style="color: var(--mlp-success);">Monatliche Einnahmen</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Mieteinnahmen</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-miete" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="Monatliche Miete">
                                <span style="color: var(--muted);">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Sonstige Einnahmen</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-sonstige-einnahmen" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="z.B. Stellplatz, Garage">
                                <span style="color: var(--muted);">€</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monatliche Ausgaben -->
                <div class="p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                    <h4 class="text-lg font-bold mb-3" style="color: var(--mlp-error);">Monatliche Ausgaben</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Darlehensrate</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-rate" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="Monatliche Rate">
                                <span style="color: var(--muted);">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Instandhaltung</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-instandhaltung" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="Rücklagen">
                                <span style="color: var(--muted);">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm block mb-1" style="color: var(--muted);">Steuern & Nebenkosten</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-steuern" value="0" class="flex-1 mlp-input-field-v2" inputmode="decimal" placeholder="Grundsteuer, Versicherung">
                                <span style="color: var(--muted);">€</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Zusammenfassung -->
            <div class="mt-6 p-4 rounded-lg" style="background: var(--card); border: 1px solid var(--border);">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm" style="color: var(--muted);">Einnahmen</p>
                        <p id="vk-einnahmen-total" class="text-xl font-bold" style="color: var(--mlp-success);">0 €</p>
                    </div>
                    <div>
                        <p class="text-sm" style="color: var(--muted);">Ausgaben</p>
                        <p id="vk-ausgaben-total" class="text-xl font-bold" style="color: var(--mlp-error);">0 €</p>
                    </div>
                    <div>
                        <p class="text-sm" style="color: var(--muted);">Monatlicher Saldo</p>
                        <p id="vk-saldo" class="text-2xl font-bold" style="color: var(--mlp-primary);">0 €</p>
                    </div>
                </div>
            </div>

            <button type="button" onclick="saveVermieterkonto()" class="mlp-btn mlp-btn-primary mt-6 w-full py-2 px-4">Speichern &amp; Schließen</button>
        </div>
    </div>

    <!-- Fonds-Dropdown: MUSS außerhalb aller Modals liegen (position:fixed + transform-Bug) -->
    <div id="fonds-dropdown-global" class="fonds-autocomplete-list"></div>

    <script>
    // ===== SESSION MANAGEMENT SYSTEM (v1.2.0) =====
    // Implements DSGVO-compliant session-based data storage

    const SESSION_STORAGE_KEY = 'mlp_current_session';
    const INACTIVITY_WARNING_MS = 30 * 60 * 1000; // 30 minutes
    const INACTIVITY_TIMEOUT_MS = 60 * 60 * 1000; // 60 minutes

    let sessionInactivityWarningTimer = null;
    let sessionInactivityTimeoutTimer = null;
    let sessionStartTime = null;
    let sessionTimerInterval = null;

    // Generate unique session ID: YYYYMMDD-HHMM-XXXX
    function generateSessionId() {
        const now = new Date();
        const date = now.toISOString().slice(0, 10).replace(/-/g, '');
        const time = now.toTimeString().slice(0, 5).replace(':', '');
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `${date}-${time}-${random}`;
    }

    // Get current session data
    function getCurrentSession() {
        try {
            const raw = sessionStorage.getItem(SESSION_STORAGE_KEY);
            return raw ? JSON.parse(raw) : null;
        } catch (e) {
            console.warn('Failed to load session:', e);
            return null;
        }
    }

    // Save session data
    function saveSession(session) {
        try {
            session.letzteAktivitaet = new Date().toISOString();
            sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(session));
            resetInactivityTimers();
        } catch (e) {
            console.error('Failed to save session:', e);
        }
    }

    // Start new session
    function startSession(kundenKuerzel = null, berater = null) {
        const sessionId = generateSessionId();
        const now = new Date().toISOString();

        const session = {
            id: sessionId,
            kundenKuerzel: kundenKuerzel || null,
            berater: berater || null,
            startzeit: now,
            letzteAktivitaet: now,
            status: 'aktiv',
            // v1.7.2: Track which educational modules were discussed
            erklaererBesucht: {
                costAverage: false,
                sorr: false,
                anleihen: false
            }
        };

        sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(session));
        sessionStartTime = new Date();

        // Start session timer
        updateSessionInfoBar();
        startSessionTimer();
        resetInactivityTimers();

        // Start auto-export timer (v1.3.6)
        startAutoExport();

        // Hide session start dialog
        closeModal('session-start-dialog');

        console.log(`📋 Session gestartet: ${sessionId}`);
        return session;
    }

    // v1.7.2: Mark educational module as visited
    function markErklaererBesucht(module) {
        const session = getCurrentSession();
        if (!session) return;

        if (!session.erklaererBesucht) {
            session.erklaererBesucht = { costAverage: false, sorr: false };
        }

        session.erklaererBesucht[module] = true;
        saveSession(session);
        console.log(`✅ Erklärer besucht: ${module}`);

        // Update UI immediately
        updateSessionInfoBar();
    }

    // v1.7.2: Check if module was visited
    function wasErklaererBesucht(module) {
        const session = getCurrentSession();
        return session?.erklaererBesucht?.[module] || false;
    }

    // End session and clear all data
    function endSession(exportFirst = false) {
        const session = getCurrentSession();

        if (exportFirst) {
            // Export session as JSON before ending
            exportAsJSON(false);
        }

        // Stop auto-export timer (v1.3.6)
        stopAutoExport();

        // Clear all session storage
        sessionStorage.clear();

        if (session) {
            console.log(`🗑️ Session gelöscht: ${session.id} am ${new Date().toISOString()}`);
        }

        // Stop timers
        if (sessionTimerInterval) {
            clearInterval(sessionTimerInterval);
            sessionTimerInterval = null;
        }
        clearInactivityTimers();

        // Reload to show session start dialog
        window.location.reload();
    }

    // Update session button and dropdown
    function updateSessionInfoBar() {
        const session = getCurrentSession();
        if (!session) return;

        const buttonContainer = getEl('session-button-container');
        if (!buttonContainer) return;

        const sessionIdEl = getEl('session-id-display');
        const kundenKuerzelEl = getEl('session-kunden-display');
        const timerEl = getEl('session-timer');

        if (sessionIdEl) sessionIdEl.textContent = session.id;
        if (kundenKuerzelEl) {
            kundenKuerzelEl.textContent = session.kundenKuerzel || 'Keine Angabe';
        }

        // v1.7.2: Update educational modules status icons
        const caIcon = getEl('erklaerer-ca-icon');
        const sorrIcon = getEl('erklaerer-sorr-icon');

        if (caIcon) {
            caIcon.textContent = wasErklaererBesucht('costAverage') ? '✅' : '⭕';
            caIcon.className = wasErklaererBesucht('costAverage') ? 'text-green-400' : 'text-gray-600';
        }

        if (sorrIcon) {
            sorrIcon.textContent = wasErklaererBesucht('sorr') ? '✅' : '⭕';
            sorrIcon.className = wasErklaererBesucht('sorr') ? 'text-green-400' : 'text-gray-600';
        }

        const anleihenIcon = getEl('erklaerer-anleihen-icon');
        if (anleihenIcon) {
            anleihenIcon.textContent = wasErklaererBesucht('anleihen') ? '✅' : '⭕';
            anleihenIcon.className = wasErklaererBesucht('anleihen') ? 'text-green-400' : 'text-gray-600';
        }

        buttonContainer.style.display = 'block';
    }

    // Toggle session dropdown menu
    function toggleSessionMenu() {
        const dropdown = getEl('session-dropdown');
        const chevron = getEl('session-menu-chevron');

        if (!dropdown) return;

        const isOpen = dropdown.style.display === 'block';

        if (isOpen) {
            dropdown.style.display = 'none';
            if (chevron) chevron.style.transform = 'rotate(0deg)';
        } else {
            dropdown.style.display = 'block';
            if (chevron) chevron.style.transform = 'rotate(180deg)';
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const buttonContainer = getEl('session-button-container');
        const dropdown = getEl('session-dropdown');
        const chevron = getEl('session-menu-chevron');

        if (!buttonContainer || !dropdown) return;

        // If click is outside the button container and dropdown is open
        if (!buttonContainer.contains(e.target) && dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
            if (chevron) chevron.style.transform = 'rotate(0deg)';
        }
    });

    // Start session duration timer
    function startSessionTimer() {
        if (sessionTimerInterval) {
            clearInterval(sessionTimerInterval);
        }

        sessionTimerInterval = setInterval(() => {
            const session = getCurrentSession();
            if (!session) return;

            const start = new Date(session.startzeit);
            const now = new Date();
            const diffMs = now - start;
            const diffMins = Math.floor(diffMs / 60000);

            const timerEl = getEl('session-timer');
            if (timerEl) {
                if (diffMins < 60) {
                    timerEl.textContent = `${diffMins} Min.`;
                } else {
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    timerEl.textContent = `${hours}h ${mins}m`;
                }
            }
        }, 30000); // Update every 30 seconds
    }

    // Reset inactivity timers
    function resetInactivityTimers() {
        clearInactivityTimers();

        // Warning after 30 min
        sessionInactivityWarningTimer = setTimeout(() => {
            showInactivityWarning();
        }, INACTIVITY_WARNING_MS);

        // Auto-end after 60 min
        sessionInactivityTimeoutTimer = setTimeout(() => {
            showInactivityTimeout();
        }, INACTIVITY_TIMEOUT_MS);
    }

    // Clear inactivity timers
    function clearInactivityTimers() {
        if (sessionInactivityWarningTimer) {
            clearTimeout(sessionInactivityWarningTimer);
            sessionInactivityWarningTimer = null;
        }
        if (sessionInactivityTimeoutTimer) {
            clearTimeout(sessionInactivityTimeoutTimer);
            sessionInactivityTimeoutTimer = null;
        }
    }

    // Show inactivity warning
    function showInactivityWarning() {
        const toast = document.createElement('div');
        toast.id = 'inactivity-warning-toast';
        toast.className = 'fixed bottom-4 right-4 bg-yellow-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 max-w-md';
        toast.innerHTML = `
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div>
                    <p class="font-bold mb-1">Beratung noch aktiv?</p>
                    <p class="text-sm mb-3">Daten werden bei weiterer Inaktivität nach 60 Min. automatisch gelöscht.</p>
                    <button onclick="confirmSessionActive()" class="bg-white text-yellow-600 px-4 py-2 rounded font-bold hover:bg-yellow-50">
                        Ich bin noch da
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(toast);
    }

    // Confirm session is still active
    function confirmSessionActive() {
        const toast = getEl('inactivity-warning-toast');
        if (toast) toast.remove();

        const session = getCurrentSession();
        if (session) {
            saveSession(session);
        }

        // Reset inactivity timers so user gets another 30 minutes
        resetInactivityTimers();
    }

    // Show inactivity timeout dialog
    function showInactivityTimeout() {
        if (confirm('Die Beratung wurde wegen Inaktivität beendet. Alle Daten werden gelöscht.\n\nMöchten Sie die Daten vor dem Löschen exportieren?')) {
            endSession(true);
        } else {
            endSession(false);
        }
    }

    // Show session start dialog
    function showSessionStartDialog() {
        openModal('session-start-dialog');

        // Check if privacy notice was previously acknowledged
        const privacyAcknowledged = localStorage.getItem('mlp-privacy-acknowledged') === 'true';
        const privacyBox = getEl('privacy-notice-box');
        if (privacyBox) {
            privacyBox.style.display = privacyAcknowledged ? 'none' : 'block';
        }
    }

    // Show session recovery dialog
    function showSessionRecoveryDialog(session) {
        const dialog = getEl('session-recovery-dialog');
        if (!dialog) return;

        const sessionInfo = getEl('recovery-session-info');
        if (sessionInfo) {
            const start = new Date(session.startzeit);
            const now = new Date();
            const diffMins = Math.floor((now - start) / 60000);

            sessionInfo.innerHTML = `
                <p class="mb-2"><strong>Session-ID:</strong> ${session.id}</p>
                <p class="mb-2"><strong>Kunde:</strong> ${session.kundenKuerzel || 'Keine Angabe'}</p>
                <p><strong>Gestartet:</strong> vor ${diffMins} Min.</p>
            `;
        }

        openModal('session-recovery-dialog');
    }

    // Continue existing session
    function continueSession() {
        const session = getCurrentSession();
        if (session) {
            sessionStartTime = new Date(session.startzeit);
            updateSessionInfoBar();
            startSessionTimer();
            resetInactivityTimers();
            closeModal('session-recovery-dialog');
            console.log(`▶️ Session fortgesetzt: ${session.id}`);
        }
    }

    // Start new session (discard old one)
    function startNewSessionAndDiscard() {
        sessionStorage.clear();
        closeModal('session-recovery-dialog');
        showSessionStartDialog();
    }

    // Show session end confirmation dialog
    function showSessionEndDialog() {
        const session = getCurrentSession();
        if (!session) return;

        const dialog = getEl('session-end-dialog');
        if (!dialog) return;

        openModal('session-end-dialog');
    }

    // Prevent tab close without confirmation
    let allowReloadWithoutWarning = false;
    window.addEventListener('beforeunload', (e) => {
        // Skip warning if we're reloading after import
        if (allowReloadWithoutWarning) {
            return;
        }

        const session = getCurrentSession();
        if (session && session.status !== 'exportiert') {
            e.preventDefault();
            e.returnValue = 'Beratung beenden? Daten gehen verloren!';
        }
    });

    // Track user activity
    function trackActivity() {
        const session = getCurrentSession();
        if (session) {
            saveSession(session);
        }
    }

    // Attach activity listeners
    ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, trackActivity, { passive: true, once: false });
    });

    // Start session from dialog with user input
    function startSessionFromDialog() {
        const kundenKuerzel = getEl('session-kunden-kuerzel')?.value.trim() || null;
        const berater = getEl('session-berater')?.value.trim() || null;

        // Save privacy acknowledgment if checkbox is checked
        const privacyCheckbox = getEl('privacy-understood-checkbox');
        if (privacyCheckbox && privacyCheckbox.checked) {
            localStorage.setItem('mlp-privacy-acknowledged', 'true');
        }

        startSession(kundenKuerzel, berater);
    }

    // ===== END SESSION MANAGEMENT SYSTEM =====

    // ===== EXPORT FUNCTIONS (v1.3.0) =====

    // Export all session data as CSV
    function exportAsCSV() {
        const session = getCurrentSession();
        if (!session) {
            alert('Keine Session gefunden!');
            return;
        }

        // Check if inputs are initialized
        if (typeof inputs === 'undefined') {
            console.error('Export failed: inputs not initialized');
            alert('Export-Fehler: Bitte warten Sie, bis die Seite vollständig geladen ist.');
            return;
        }

        // Collect all data
        const income = parseFloat(inputs.income?.value) || 0;
        const konsumMin = parseFloat(inputs.konsumMin?.value) || 0;
        const konsumLeftover = parseFloat(inputs.konsumLeftover?.value) || 0;
        const tagesgeldCurrent = parseFloat(inputs.tagesgeldCurrent?.value) || 0;
        const tagesgeldLimit = parseFloat(inputs.tagesgeldLimit?.value) || 0;
        const depotCurrent = parseFloat(inputs.depotCurrent?.value) || 0;
        const anlagezeitraum = parseInt(inputs.anlagezeitraum?.value, 10) || 15;
        const rendite = parseFloat(inputs.rendite?.value) || 0;

        // Build CSV content
        const BOM = '\uFEFF'; // UTF-8 BOM for Excel compatibility
        let csv = '';

        // Header with session metadata
        csv += `# Beratungsprotokoll - MLP Vermögensmanagement\n`;
        csv += `# Session-ID: ${session.id}\n`;
        csv += `# Kunde: ${session.kundenKuerzel || 'N/A'}\n`;
        csv += `# Berater: ${session.berater || 'N/A'}\n`;
        csv += `# Datum: ${new Date(session.startzeit).toLocaleDateString('de-DE')}\n`;
        csv += `# Exportiert am: ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}\n`;
        csv += `# Variante: ${currentVariant}\n`;
        csv += `\n`;

        // Data section
        csv += `Kategorie;Beschreibung;Betrag (EUR);Intervall;Ziel\n`;

        // Einkommen
        csv += `Einkommen;Haupteinkommen;${income};monatlich;einkommen\n`;

        // Fixkosten & Sparpläne
        fixkostenItems.forEach(item => {
            const monthlyAmount = getMonthlyAmount(item);
            const kategorie = item.target === 'depot' ? 'Sparplan' : 'Fixkosten';
            const intervall = item.interval === 'monthly' ? 'monatlich' :
                             item.interval === 'quarterly' ? 'vierteljährlich' : 'jährlich';
            csv += `${kategorie};${item.name};${monthlyAmount};${intervall};${item.target}\n`;
        });

        // Konsum
        csv += `Konsum;Mindestbetrag;${konsumMin};monatlich;konsum\n`;
        csv += `Konsum;Überschuss;${konsumLeftover};monatlich;konsum\n`;

        // Tagesgeld
        csv += `Tagesgeld;Aktueller Stand;${tagesgeldCurrent};einmalig;tagesgeld\n`;
        csv += `Tagesgeld;Sparziel;${tagesgeldLimit};einmalig;tagesgeld\n`;

        // Depot
        csv += `Depot;Aktueller Stand;${depotCurrent};einmalig;depot\n`;
        csv += `Depot;Anlagezeitraum (Jahre);${anlagezeitraum};-;depot\n`;
        csv += `Depot;Erwartete Rendite (%);${rendite};jährlich;depot\n`;

        // Depot-Allocation
        csv += `\n# Depot-Aufteilung\n`;
        csv += `Fonds/ETF;Allocation (%)\n`;
        depotItems.forEach(item => {
            csv += `${item.name};${item.allocation}\n`;
        });

        // Immobilien
        if (immobilienData && immobilienData.length > 0) {
            csv += `\n# Immobilien\n`;
            csv += `Objekt;Wert (EUR);Darlehen (EUR);Zinssatz (%);Tilgungssatz (%);Mieteinnahmen (EUR);Kosten (EUR)\n`;
            immobilienData.forEach(immo => {
                csv += `${immo.objekt || 'Immobilie'};${immo.wert || 0};${immo.darlehen || 0};${immo.zinssatz || 0};${immo.tilgungssatz || 0};${immo.mieteinnahmen || 0};${immo.kosten || 0}\n`;
            });
        }

        // Vermieterkonto
        const vermieterData = getVermieterkontoData();
        if (vermieterData) {
            csv += `\n# Vermieterkonto\n`;
            csv += `Beschreibung;Betrag (EUR)\n`;
            csv += `Mieteinnahmen (netto);${vermieterData.mieteinnahmenNetto}\n`;
            csv += `Darlehenszinsen;${vermieterData.darlehenszinsen}\n`;
            csv += `Tilgung;${vermieterData.tilgung}\n`;
            csv += `Nebenkosten & Instandhaltung;${vermieterData.nebenkostenInstand}\n`;
            csv += `Gesamt-Ausgaben;${vermieterData.gesamtAusgaben}\n`;
            csv += `Saldo (monatlich);${vermieterData.saldo}\n`;
        }

        // Buchungsplaner
        if (typeof bookingPlan !== 'undefined' && bookingPlan && Object.keys(bookingPlan).length > 0) {
            csv += `\n# Buchungsplaner (Transaktionstermine)\n`;
            csv += `Tag;Beschreibung\n`;

            Object.keys(bookingPlan).forEach(month => {
                const monthData = bookingPlan[month];
                if (monthData && typeof monthData === 'object') {
                    Object.keys(monthData).forEach(day => {
                        const bookings = monthData[day];
                        if (Array.isArray(bookings)) {
                            bookings.forEach(bookingTypeId => {
                                const bookingType = bookingTypeLookup[bookingTypeId];
                                if (bookingType) {
                                    const description = getActiveBookingDescription(bookingType);
                                    csv += `${day};${description}\n`;
                                }
                            });
                        }
                    });
                }
            });
        }

        // Create download
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8' });
        const filename = `Beratung_${session.kundenKuerzel || session.id}_${new Date().toISOString().slice(0, 10)}.csv`;
        downloadFile(blob, filename);

        console.log('📄 CSV-Export erstellt:', filename);
    }

    // ===== EXCEL EXPORT (v1.7.0) =====
    function exportAsExcel() {
        const session = getCurrentSession();
        if (!session) {
            alert('Keine Session gefunden!');
            return;
        }

        // Check if inputs are initialized
        if (typeof inputs === 'undefined') {
            console.error('Export failed: inputs not initialized');
            alert('Export-Fehler: Bitte warten Sie, bis die Seite vollständig geladen ist.');
            return;
        }

        try {
            // Create a new workbook
            const wb = XLSX.utils.book_new();

            // Sheet 1: Übersicht (Session-Daten)
            const overviewData = createOverviewSheet(session);
            const ws1 = XLSX.utils.aoa_to_sheet(overviewData);
            applyOverviewFormatting(ws1, overviewData);
            XLSX.utils.book_append_sheet(wb, ws1, "Übersicht");

            // Sheet 2: Cashflow-Analyse
            const cashflowData = createCashflowSheet();
            const ws2 = XLSX.utils.aoa_to_sheet(cashflowData);
            applyCashflowFormatting(ws2, cashflowData);
            XLSX.utils.book_append_sheet(wb, ws2, "Cashflow");

            // Sheet 3: Immobilien (if exists)
            if (immobilienData && immobilienData.length > 0) {
                const immobilienSheet = createImmobilienSheet();
                const ws3 = XLSX.utils.aoa_to_sheet(immobilienSheet);
                applyImmobilienFormatting(ws3, immobilienSheet);
                XLSX.utils.book_append_sheet(wb, ws3, "Immobilien");
            }

            // Sheet 4: Depot-Allocation
            if (depotItems && depotItems.length > 0) {
                const depotData = createDepotSheet();
                const ws4 = XLSX.utils.aoa_to_sheet(depotData);
                applyDepotFormatting(ws4, depotData);
                XLSX.utils.book_append_sheet(wb, ws4, "Depot");
            }

            // Generate Excel file
            const filename = `Beratung_${session.kundenKuerzel || session.id}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, filename);

            console.log('📊 Excel-Export erstellt:', filename);
        } catch (error) {
            console.error('Excel-Export Fehler:', error);
            alert('Fehler beim Excel-Export: ' + error.message);
        }
    }

    // Create Overview Sheet Data
    function createOverviewSheet(session) {
        const income = parseFloat(inputs.income?.value) || 0;
        const konsumMin = parseFloat(inputs.konsumMin?.value) || 0;
        const konsumLeftover = parseFloat(inputs.konsumLeftover?.value) || 0;
        const tagesgeldCurrent = parseFloat(inputs.tagesgeldCurrent?.value) || 0;
        const tagesgeldLimit = parseFloat(inputs.tagesgeldLimit?.value) || 0;
        const depotCurrent = parseFloat(inputs.depotCurrent?.value) || 0;
        const anlagezeitraum = parseInt(inputs.anlagezeitraum?.value, 10) || 15;
        const rendite = parseFloat(inputs.rendite?.value) || 0;

        const data = [
            ['MLP FINANZBERATUNG SE'],
            ['Beratungsprotokoll - Vermögensmanagement'],
            [],
            ['Session-Informationen'],
            ['Session-ID', session.id],
            ['Kunde', session.kundenKuerzel || 'N/A'],
            ['Berater', session.berater || 'N/A'],
            ['Datum', new Date(session.startzeit).toLocaleDateString('de-DE')],
            ['Exportiert am', new Date().toLocaleString('de-DE')],
            ['Variante', currentVariant],
            [],
            ['BASISDATEN'],
            ['Kategorie', 'Wert', 'Einheit'],
            ['Haupteinkommen', income, '€ / Monat'],
            ['Konsum (Minimum)', konsumMin, '€ / Monat'],
            ['Konsum (Überschuss)', konsumLeftover, '€ / Monat'],
            ['Tagesgeld (aktuell)', tagesgeldCurrent, '€'],
            ['Tagesgeld (Sparziel)', tagesgeldLimit, '€'],
            ['Depot (aktuell)', depotCurrent, '€'],
            ['Anlagezeitraum', anlagezeitraum, 'Jahre'],
            ['Erwartete Rendite', rendite, '% p.a.'],
            [],
            ['FIXKOSTEN & SPARPLÄNE'],
            ['Beschreibung', 'Betrag', 'Intervall', 'Ziel']
        ];

        // Add Fixkosten items
        fixkostenItems.forEach(item => {
            const monthlyAmount = getMonthlyAmount(item);
            const intervall = item.interval === 'monthly' ? 'monatlich' :
                             item.interval === 'quarterly' ? 'vierteljährlich' : 'jährlich';
            data.push([item.name, monthlyAmount, intervall, item.target]);
        });

        return data;
    }

    // Create Cashflow Sheet
    function createCashflowSheet() {
        const income = parseFloat(inputs.income?.value) || 0;
        const konsumMin = parseFloat(inputs.konsumMin?.value) || 0;
        const konsumLeftover = parseFloat(inputs.konsumLeftover?.value) || 0;

        // Calculate flows
        let totalFixkosten = 0;
        let totalSparplan = 0;

        fixkostenItems.forEach(item => {
            const monthlyAmount = getMonthlyAmount(item);
            if (item.target === 'depot') {
                totalSparplan += monthlyAmount;
            } else {
                totalFixkosten += monthlyAmount;
            }
        });

        const totalKonsum = konsumMin + konsumLeftover;
        const totalAusgaben = totalFixkosten + totalKonsum + totalSparplan;
        const saldo = income - totalAusgaben;

        const data = [
            ['CASHFLOW-ANALYSE'],
            ['Monatliche Ein- und Ausgaben'],
            [],
            ['EINNAHMEN'],
            ['Beschreibung', 'Betrag (€)'],
            ['Haupteinkommen', income],
            [],
            ['AUSGABEN'],
            ['Kategorie', 'Betrag (€)'],
            ['Fixkosten', totalFixkosten],
            ['Konsum', totalKonsum],
            ['  - Mindestbetrag', konsumMin],
            ['  - Überschuss', konsumLeftover],
            ['Sparpläne (Depot)', totalSparplan],
            [],
            ['ZUSAMMENFASSUNG'],
            ['Position', 'Betrag (€)'],
            ['Gesamt-Einnahmen', income],
            ['Gesamt-Ausgaben', totalAusgaben],
            ['Saldo', saldo]
        ];

        return data;
    }

    // Create Immobilien Sheet
    function createImmobilienSheet() {
        const data = [
            ['IMMOBILIEN-ÜBERSICHT'],
            [],
            ['Objekt', 'Wert (€)', 'Darlehen (€)', 'Eigenkapital (€)', 'Zinssatz (%)', 'Tilgungssatz (%)', 'Mieteinnahmen (€)', 'Kosten (€)', 'Netto-Cashflow (€)']
        ];

        immobilienData.forEach(immo => {
            const eigenkapital = (immo.wert || 0) - (immo.darlehen || 0);
            const zinsen = (immo.darlehen || 0) * (immo.zinssatz || 0) / 100 / 12;
            const tilgung = (immo.darlehen || 0) * (immo.tilgungssatz || 0) / 100 / 12;
            const nettoCashflow = (immo.mieteinnahmen || 0) - (immo.kosten || 0) - zinsen - tilgung;

            data.push([
                immo.objekt || 'Immobilie',
                immo.wert || 0,
                immo.darlehen || 0,
                eigenkapital,
                immo.zinssatz || 0,
                immo.tilgungssatz || 0,
                immo.mieteinnahmen || 0,
                immo.kosten || 0,
                nettoCashflow
            ]);
        });

        // Add Tilgungsplan section
        data.push([]);
        data.push(['TILGUNGSPLAN']);
        data.push(['Jahr', 'Restschuld (€)', 'Zinsen (€)', 'Tilgung (€)', 'Rate (€)', 'Wertsteigerung (€)', 'Eigenkapital (€)']);

        // Calculate for first property (example)
        if (immobilienData.length > 0) {
            const immo = immobilienData[0];
            let restschuld = immo.darlehen || 0;
            const wertsteigerungRate = (immo.wertsteigerung || 0) / 100;
            let immobilienwert = immo.wert || 0;

            for (let jahr = 1; jahr <= 30 && restschuld > 0; jahr++) {
                const jahresZinsen = restschuld * (immo.zinssatz || 0) / 100;
                const jahresTilgung = restschuld * (immo.tilgungssatz || 0) / 100;
                const jahresRate = jahresZinsen + jahresTilgung;

                immobilienwert *= (1 + wertsteigerungRate);
                const eigenkapital = immobilienwert - restschuld;

                data.push([
                    jahr,
                    Math.round(restschuld),
                    Math.round(jahresZinsen),
                    Math.round(jahresTilgung),
                    Math.round(jahresRate),
                    Math.round(immobilienwert),
                    Math.round(eigenkapital)
                ]);

                restschuld -= jahresTilgung;
                if (restschuld < 0) restschuld = 0;
            }
        }

        return data;
    }

    // Create Depot Sheet
    function createDepotSheet() {
        const data = [
            ['DEPOT-ALLOKATION'],
            [],
            ['Fonds/ETF', 'Allocation (%)']
        ];

        depotItems.forEach(item => {
            data.push([item.name, item.allocation]);
        });

        // Add total check
        const totalAllocation = depotItems.reduce((sum, item) => sum + item.allocation, 0);
        data.push([]);
        data.push(['GESAMT', totalAllocation]);

        return data;
    }

    // Apply formatting to Overview sheet
    function applyOverviewFormatting(ws, data) {
        const range = XLSX.utils.decode_range(ws['!ref']);

        // Set column widths
        ws['!cols'] = [
            { wch: 30 },  // Column A
            { wch: 20 },  // Column B
            { wch: 15 }   // Column C
        ];

        // Apply styles (note: SheetJS community edition has limited styling)
        // For full styling, would need SheetJS Pro

        // Merge title cells
        if (!ws['!merges']) ws['!merges'] = [];
        ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }); // Title row
        ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 2 } }); // Subtitle row
    }

    // Apply formatting to Cashflow sheet
    function applyCashflowFormatting(ws, data) {
        ws['!cols'] = [
            { wch: 30 },  // Column A
            { wch: 15 }   // Column B
        ];

        if (!ws['!merges']) ws['!merges'] = [];
        ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }); // Title
    }

    // Apply formatting to Immobilien sheet
    function applyImmobilienFormatting(ws, data) {
        ws['!cols'] = [
            { wch: 20 },  // Objekt
            { wch: 12 },  // Wert
            { wch: 12 },  // Darlehen
            { wch: 12 },  // Eigenkapital
            { wch: 12 },  // Zinssatz
            { wch: 12 },  // Tilgungssatz
            { wch: 15 },  // Mieteinnahmen
            { wch: 12 },  // Kosten
            { wch: 15 }   // Netto-Cashflow
        ];
    }

    // Apply formatting to Depot sheet
    function applyDepotFormatting(ws, data) {
        ws['!cols'] = [
            { wch: 40 },  // Fonds/ETF
            { wch: 15 }   // Allocation
        ];
    }

    // ===== AUTO-EXPORT SYSTEM (v1.3.7) =====
    let autoExportInterval = null;
    let lastAutoExportTime = null;
    let autoExportDirectoryHandle = null; // File System Access API handle
    let useFileSystemAPI = false;

    // IndexedDB for persisting directory handle
    const DB_NAME = 'mlp-auto-export-db';
    const DB_VERSION = 1;
    const STORE_NAME = 'directory-handles';
    const HANDLE_KEY = 'auto-export-directory';

    // Open IndexedDB
    function openHandleDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
        });
    }

    // Save directory handle to IndexedDB
    async function saveDirectoryHandle(handle) {
        try {
            const db = await openHandleDB();
            const transaction = db.transaction(STORE_NAME, 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(handle, HANDLE_KEY);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log('✅ Directory Handle in IndexedDB gespeichert');
                    resolve(true);
                };
                transaction.onerror = () => reject(transaction.error);
            });
        } catch (err) {
            console.error('Fehler beim Speichern des Handles:', err);
            return false;
        }
    }

    // Load directory handle from IndexedDB
    async function loadDirectoryHandle() {
        try {
            const db = await openHandleDB();
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(HANDLE_KEY);

            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const handle = request.result;
                    if (handle) {
                        console.log('📂 Directory Handle aus IndexedDB geladen');
                        resolve(handle);
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        } catch (err) {
            console.error('Fehler beim Laden des Handles:', err);
            return null;
        }
    }

    // Verify permission for directory handle
    async function verifyHandlePermission(handle, requestIfNeeded = false) {
        const permission = await handle.queryPermission({ mode: 'readwrite' });
        if (permission === 'granted') {
            return true;
        }

        // Only request permission if explicitly requested (requires user gesture)
        if (requestIfNeeded) {
            try {
                const requestResult = await handle.requestPermission({ mode: 'readwrite' });
                return requestResult === 'granted';
            } catch (err) {
                // Permission request failed (likely no user gesture)
                return false;
            }
        }

        return false;
    }

    // Check if File System Access API is available
    function checkFileSystemAPISupport() {
        return 'showDirectoryPicker' in window;
    }

    // Request directory access from user
    async function selectAutoExportDirectory() {
        if (!checkFileSystemAPISupport()) {
            alert('Ihr Browser unterstützt keine direkte Ordner-Speicherung.\n\nBitte nutzen Sie Chrome oder Edge (Version 86+) für diese Funktion.\n\nFallback: Dateien werden in den Download-Ordner gespeichert.');
            return false;
        }

        try {
            // Show directory picker
            const dirHandle = await window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            });

            // Request permission
            const permission = await dirHandle.requestPermission({ mode: 'readwrite' });

            if (permission !== 'granted') {
                alert('Ordner-Zugriff wurde verweigert. Auto-Export verwendet Download-Ordner.');
                return false;
            }

            // Store handle in memory AND IndexedDB
            autoExportDirectoryHandle = dirHandle;

            // Save to IndexedDB (persistent across reloads!)
            await saveDirectoryHandle(dirHandle);

            // Save preference to localStorage (as backup indicator)
            localStorage.setItem('mlp-auto-export-dir-name', dirHandle.name);
            localStorage.setItem('mlp-use-filesystem-api', 'true');
            useFileSystemAPI = true;

            console.log('✅ Auto-Export-Ordner ausgewählt:', dirHandle.name);
            updateAutoExportFolderDisplay();

            showToast(`Auto-Export-Ordner eingerichtet: ${dirHandle.name}\n\nEin Test-Export wird erstellt...`, 'success', 4000);

            // Trigger immediate test export to verify it works
            setTimeout(() => {
                exportAsJSON(true);
            }, 500);

            return true;
        } catch (err) {
            if (err.name === 'AbortError') {
                console.log('Ordner-Auswahl abgebrochen');
            } else {
                console.error('Fehler bei Ordner-Auswahl:', err);
                alert('Fehler beim Einrichten des Auto-Export-Ordners.');
            }
            return false;
        }
    }

    // Restore directory handle on page load
    async function restoreAutoExportDirectory() {
        const useFSAPI = localStorage.getItem('mlp-use-filesystem-api') === 'true';

        if (!useFSAPI || !checkFileSystemAPISupport()) {
            useFileSystemAPI = false;
            updateAutoExportFolderDisplay();
            return;
        }

        try {
            // Load handle from IndexedDB
            const savedHandle = await loadDirectoryHandle();

            if (!savedHandle) {
                console.log('⚠️ Kein Handle in IndexedDB gefunden');
                useFileSystemAPI = true;
                updateAutoExportFolderDisplay();
                return;
            }

            // Verify permission
            const hasPermission = await verifyHandlePermission(savedHandle);

            if (hasPermission) {
                // Success! Handle restored and permission granted
                autoExportDirectoryHandle = savedHandle;
                useFileSystemAPI = true;
                console.log('✅ Directory Handle wiederhergestellt:', savedHandle.name);
                showToast(`Auto-Export-Ordner wiederhergestellt: ${savedHandle.name}`, 'success', 3000);
            } else {
                // Permission denied
                console.log('❌ Permission verweigert für gespeicherten Ordner');
                useFileSystemAPI = true; // Keep trying, will fallback to downloads
            }

            updateAutoExportFolderDisplay();
        } catch (err) {
            console.error('Fehler beim Wiederherstellen des Handles:', err);
            useFileSystemAPI = false;
            updateAutoExportFolderDisplay();
        }
    }

    // Update folder display in UI
    function updateAutoExportFolderDisplay() {
        const folderDisplayEl = document.getElementById('auto-export-folder-display');
        if (!folderDisplayEl) return;

        if (useFileSystemAPI && autoExportDirectoryHandle) {
            folderDisplayEl.innerHTML = `<span class="text-green-400">📁 ${autoExportDirectoryHandle.name}</span>`;
        } else if (useFileSystemAPI) {
            const savedName = localStorage.getItem('mlp-auto-export-dir-name');
            if (savedName) {
                folderDisplayEl.innerHTML = `<span class="text-yellow-400">📁 ${savedName} (reaktivieren)</span>`;
            } else {
                folderDisplayEl.innerHTML = `<span class="text-gray-400">📁 Nicht konfiguriert</span>`;
            }
        } else {
            folderDisplayEl.innerHTML = `<span class="text-gray-400">📥 Download-Ordner</span>`;
        }
    }

    // Write file to selected directory using File System Access API
    async function writeToDirectory(filename, blob) {
        if (!autoExportDirectoryHandle) {
            // Can't show picker automatically (needs user gesture)
            // Return false to trigger fallback to download
            console.warn('⚠️ Kein Ordner-Handle verfügbar. Bitte "Ordner auswählen" klicken.');

            // Show user a hint (only once per session)
            if (!sessionStorage.getItem('folder-hint-shown')) {
                sessionStorage.setItem('folder-hint-shown', 'true');
                setTimeout(() => {
                    showToast('💡 Tipp: Klicke im Session-Menü auf "Ordner auswählen" für direkte Speicherung', 'info', 5000);
                }, 1000);
            }

            return false;
        }

        try {
            // Create/overwrite file in directory
            const fileHandle = await autoExportDirectoryHandle.getFileHandle(filename, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(blob);
            await writable.close();

            console.log(`✅ Datei gespeichert: ${autoExportDirectoryHandle.name}/${filename}`);
            return true;
        } catch (err) {
            console.error('Fehler beim Speichern:', err);

            // If permission was revoked, reset
            if (err.name === 'NotAllowedError') {
                autoExportDirectoryHandle = null;
                localStorage.removeItem('mlp-use-filesystem-api');
                useFileSystemAPI = false;
                updateAutoExportFolderDisplay();
            }

            return false;
        }
    }

    // Generate auto-export filename: {DATUM}_{KÜRZEL}_{UHRZEIT}_{SESSION-ID}.json
    function generateAutoExportFilename() {
        const session = getCurrentSession();
        if (!session) return null;

        const now = new Date();

        // DATUM: YYYY-MM-DD
        const datum = now.toISOString().slice(0, 10);

        // KÜRZEL: from session or "ANON"
        const kuerzel = session.kundenKuerzel || 'ANON';

        // UHRZEIT: HHMM
        const stunden = String(now.getHours()).padStart(2, '0');
        const minuten = String(now.getMinutes()).padStart(2, '0');
        const uhrzeit = stunden + minuten;

        // SESSION-ID: first 4 chars
        const sessionId = session.id.substring(0, 8).toUpperCase();

        return `${datum}_${kuerzel}_${uhrzeit}_SES-${sessionId}.json`;
    }

    // Export all session data as JSON (used for manual and auto-export)
    function exportAsJSON(isAutoExport = false) {
        const session = getCurrentSession();
        if (!session) {
            if (!isAutoExport) alert('Keine Session gefunden!');
            return;
        }

        // Check if inputs are initialized
        if (typeof inputs === 'undefined') {
            console.error('Export failed: inputs not initialized');
            if (!isAutoExport) alert('Export-Fehler: Bitte warten Sie, bis die Seite vollständig geladen ist.');
            return;
        }

        // Collect ALL application data for complete session backup
        const exportData = {
            // Format version for future compatibility
            version: '1.3.7',
            exportType: 'FULL_SESSION_BACKUP',

            // LLM Prompt for generating consultation protocol
            llmPrompt: `Du bist ein professioneller Finanzberater bei MLP. Erstelle aus den folgenden Session-Daten ein strukturiertes, professionelles Gesprächsprotokoll für die Kundendokumentation.

**Aufgabe:**
Erstelle ein Beratungsprotokoll im MLP-Stil mit folgender Struktur:

1. **Kopfdaten**
   - Session-ID, Datum, Berater, Kunde
   - Beratungsdauer

2. **Ist-Situation (Einnahmen)**
   - Monatliches Einkommen
   - Sonstige Einnahmen (falls vorhanden)

3. **Ausgabenstruktur**
   - Fixkosten (detailliert auflisten)
   - Lebenshaltungskosten
   - Kontenmodell (Variante A oder B?)

4. **Vermögenssituation**
   - Tagesgeld (aktuell, Ziel)
   - Depot (aktuell, Sparplan, Allocation, Renditeerwartung)
   - Immobilien (falls vorhanden: Wert, Darlehen, Cashflow)
   - Vermieterkonto (falls vorhanden: Einnahmen/Ausgaben)

5. **Finanzplanung**
   - Monatliche Sparrate
   - Anlagehorizont
   - Buchungsplan (Transaktionstermine)

6. **Empfehlungen**
   - Basierend auf den Daten: Was läuft gut? Wo gibt es Optimierungspotenzial?
   - Nächste Schritte

**Tonalität:**
- Professionell, aber verständlich
- Faktenbasiert
- Positive Formulierungen
- Konkrete Zahlen nennen

**Format:** Markdown mit klaren Überschriften und Bullet-Points.

Die Daten findest du in diesem JSON unter den Feldern: session, settings, inputs, fixkostenItems, depotItems, immobilienData, vermieterkontoData, buchungsplan.`,

            // Session metadata
            session: {
                id: session.id,
                kundenKuerzel: session.kundenKuerzel,
                berater: session.berater,
                startzeit: session.startzeit,
                letzteAktivitaet: session.letzteAktivitaet,
                exportiert: new Date().toISOString(),
                status: session.status
            },

            // Application settings (for UI state restoration)
            settings: {
                currentVariant: currentVariant,
                consultationMode: consultationMode,
                consultationStep: consultationStep,
                theme: localStorage.getItem('vd_theme') || 'light'
            },

            // All financial input data
            inputs: {
                income: parseFloat(inputs.income?.value) || 0,
                konsumMin: parseFloat(inputs.konsumMin?.value) || 0,
                konsumLeftover: parseFloat(inputs.konsumLeftover?.value) || 0,
                tagesgeldCurrent: parseFloat(inputs.tagesgeldCurrent?.value) || 0,
                tagesgeldLimit: parseFloat(inputs.tagesgeldLimit?.value) || 0,
                depotCurrent: parseFloat(inputs.depotCurrent?.value) || 0,
                anlagezeitraum: parseInt(inputs.anlagezeitraum?.value, 10) || 15,
                rendite: parseFloat(inputs.rendite?.value) || 0
            },

            // Structured data arrays
            fixkostenItems: fixkostenItems || [],
            depotItems: depotItems || [],
            immobilienData: immobilienData || [],

            // Vermieterkonto (complete structure)
            vermieterkontoData: (function() {
                try {
                    const saved = sessionStorage.getItem('vermieterkontoData');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    return null;
                }
            })(),

            // Buchungsplan (transaction scheduler)
            buchungsplan: (typeof bookingPlan !== 'undefined') ? bookingPlan : {},

            // Raw sessionStorage snapshot (for complete restoration)
            sessionStorageSnapshot: {
                mlp_current_session: sessionStorage.getItem('mlp_current_session'),
                mlp_booking_plan_v1: sessionStorage.getItem('mlp_booking_plan_v1'),
                immobilienData: sessionStorage.getItem('immobilienData'),
                vermieterkontoData: sessionStorage.getItem('vermieterkontoData')
            }
        };

        // Create pretty-printed JSON
        const json = JSON.stringify(exportData, null, 2);
        const blob = new Blob([json], { type: 'application/json;charset=utf-8' });

        // Use auto-export filename format or fallback to old format
        const filename = isAutoExport
            ? generateAutoExportFilename()
            : `Session-Backup_${session.kundenKuerzel || session.id}_${new Date().toISOString().slice(0, 10)}.json`;

        // Try File System API for auto-export, fallback to download
        if (isAutoExport && useFileSystemAPI) {
            writeToDirectory(filename, blob).then(success => {
                if (success) {
                    lastAutoExportTime = Date.now();
                    updateAutoExportStatus();
                    console.log('🔄 Auto-Export (File System API):', filename);
                } else {
                    // Fallback to download
                    downloadFile(blob, filename);
                    lastAutoExportTime = Date.now();
                    updateAutoExportStatus();
                    console.log('🔄 Auto-Export (Download fallback):', filename);
                }
            }).catch(err => {
                console.error('Auto-Export Fehler:', err);
                // Fallback to download on error
                downloadFile(blob, filename);
                lastAutoExportTime = Date.now();
                updateAutoExportStatus();
            });
        } else {
            // Manual export or File System API not available
            downloadFile(blob, filename);

            // Update last export time
            if (isAutoExport) {
                lastAutoExportTime = Date.now();
                updateAutoExportStatus();
                console.log('🔄 Auto-Export erstellt:', filename);
            } else {
                console.log('📄 JSON-Backup erstellt:', filename);
                console.log('💾 Vollständiges Session-Backup - kann für Re-Import verwendet werden');
            }
        }
    }

    // Start auto-export timer (runs every 2 minutes)
    // Check if auto-save is enabled
    function isAutoSaveEnabled() {
        // Default: OFF (manual save only)
        const enabled = localStorage.getItem('mlp-auto-save-enabled');
        return enabled === 'true';
    }

    // Save auto-save preference
    function setAutoSaveEnabled(enabled) {
        localStorage.setItem('mlp-auto-save-enabled', enabled ? 'true' : 'false');
        console.log(`🔄 Auto-Save ${enabled ? 'aktiviert' : 'deaktiviert'}`);
    }

    function startAutoExport() {
        // Only start if auto-save is enabled
        if (!isAutoSaveEnabled()) {
            console.log('⏸️ Auto-Export nicht gestartet (manueller Modus)');
            return;
        }

        // Clear existing timer
        if (autoExportInterval) {
            clearInterval(autoExportInterval);
        }

        // First export after 30 seconds (give user time to enter data)
        setTimeout(() => {
            if (isAutoSaveEnabled()) {
                exportAsJSON(true);
            }
        }, 30000);

        // Then export every 2 minutes (120000ms)
        autoExportInterval = setInterval(() => {
            if (isAutoSaveEnabled()) {
                exportAsJSON(true);
            }
        }, 120000);

        console.log('✅ Auto-Export aktiviert (alle 2 Min., erster Export in 30 Sek.)');
    }

    // Stop auto-export timer
    function stopAutoExport() {
        if (autoExportInterval) {
            clearInterval(autoExportInterval);
            autoExportInterval = null;
            console.log('⏹️ Auto-Export gestoppt');
        }
    }

    // Toggle auto-save on/off
    function toggleAutoSave(enabled) {
        setAutoSaveEnabled(enabled);

        if (enabled) {
            startAutoExport();
            showToast('Automatische Speicherung aktiviert (alle 2 Min.)', 'success', 3000);
        } else {
            stopAutoExport();
            showToast('Automatische Speicherung deaktiviert', 'info', 3000);
        }

        // Update UI
        updateAutoSaveUI();
    }

    // Update auto-save UI elements
    function updateAutoSaveUI() {
        const toggle = document.getElementById('auto-save-toggle');
        const intervalInfo = document.getElementById('auto-save-interval-info');
        const enabled = isAutoSaveEnabled();

        if (toggle) {
            toggle.checked = enabled;
        }

        if (intervalInfo) {
            if (enabled) {
                intervalInfo.textContent = 'Automatisch alle 2 Minuten';
                intervalInfo.classList.remove('text-gray-500');
                intervalInfo.classList.add('text-green-500');
            } else {
                intervalInfo.textContent = 'Manueller Speichermodus';
                intervalInfo.classList.remove('text-green-500');
                intervalInfo.classList.add('text-gray-500');
            }
        }
    }

    // Update auto-export status display
    function updateAutoExportStatus() {
        const statusEl = document.getElementById('auto-export-status');
        if (!statusEl) return;

        if (!lastAutoExportTime) {
            statusEl.innerHTML = '<span class="text-yellow-400">⏳ Wartet auf ersten Export...</span>';
            return;
        }

        const secondsAgo = Math.floor((Date.now() - lastAutoExportTime) / 1000);

        if (secondsAgo < 60) {
            statusEl.innerHTML = `<span class="text-green-400">🟢 Vor ${secondsAgo} Sek.</span>`;
        } else {
            const minutesAgo = Math.floor(secondsAgo / 60);
            statusEl.innerHTML = `<span class="text-green-400">🟢 Vor ${minutesAgo} Min.</span>`;
        }
    }

    // Update status display every 5 seconds
    setInterval(() => {
        updateAutoExportStatus();
    }, 5000);

    // Import session from JSON backup file
    function importSessionBackup() {
        // Create file input element
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const backup = JSON.parse(text);

                // Validate backup format
                if (!backup.version || backup.exportType !== 'FULL_SESSION_BACKUP') {
                    showToast('Ungültiges Backup-Format! Bitte wähle eine gültige Session-Backup-Datei.', 'error', 5000);
                    return;
                }

                // Show confirmation modal (keep the existing modal from screenshot)
                const confirmed = confirm(
                    `Session-Backup importieren?\n\n` +
                    `Session-ID: ${backup.session?.id || 'Unbekannt'}\n` +
                    `Kunde: ${backup.session?.kundenKuerzel || 'N/A'}\n` +
                    `Berater: ${backup.session?.berater || 'N/A'}\n` +
                    `Exportiert: ${backup.session?.exportiert ? new Date(backup.session.exportiert).toLocaleString('de-DE') : 'N/A'}\n\n` +
                    `Alle aktuellen Daten werden überschrieben!`
                );

                if (!confirmed) return;

                // Restore sessionStorage
                if (backup.sessionStorageSnapshot) {
                    Object.keys(backup.sessionStorageSnapshot).forEach(key => {
                        const value = backup.sessionStorageSnapshot[key];
                        if (value) {
                            sessionStorage.setItem(key, value);
                        }
                    });
                }

                // Restore input field values AND persist to sessionStorage for reload
                if (backup.inputs) {
                    // Persist to sessionStorage (to survive reload)
                    sessionStorage.setItem('mlp_inputs', JSON.stringify(backup.inputs));

                    // Set values (will be overwritten by reload, but needed for consistency)
                    if (inputs.income) inputs.income.value = backup.inputs.income || 0;
                    if (inputs.konsumMin) inputs.konsumMin.value = backup.inputs.konsumMin || 0;
                    if (inputs.konsumLeftover) inputs.konsumLeftover.value = backup.inputs.konsumLeftover || 0;
                    if (inputs.tagesgeldCurrent) inputs.tagesgeldCurrent.value = backup.inputs.tagesgeldCurrent || 0;
                    if (inputs.tagesgeldLimit) inputs.tagesgeldLimit.value = backup.inputs.tagesgeldLimit || 0;
                    if (inputs.depotCurrent) inputs.depotCurrent.value = backup.inputs.depotCurrent || 0;
                    if (inputs.anlagezeitraum) inputs.anlagezeitraum.value = backup.inputs.anlagezeitraum || 15;
                    if (inputs.rendite) inputs.rendite.value = backup.inputs.rendite || 7;
                }

                // Restore global variables AND persist to sessionStorage for reload
                if (backup.fixkostenItems) {
                    fixkostenItems = backup.fixkostenItems;
                    // Persist to survive reload
                    sessionStorage.setItem('mlp_fixkostenItems', JSON.stringify(backup.fixkostenItems));
                }
                if (backup.depotItems) {
                    // Migration: Add 'risk' property to old data (v1.5.1+)
                    depotItems = backup.depotItems.map(item => {
                        if (!item.risk) {
                            item.risk = 'conservative'; // Default for backward compatibility
                        }
                        return item;
                    });
                    // Persist to survive reload
                    sessionStorage.setItem('mlp_depotItems', JSON.stringify(depotItems));
                }
                if (backup.immobilienData) {
                    immobilienData = backup.immobilienData;
                    // Already persisted via sessionStorageSnapshot
                }
                if (backup.buchungsplan && typeof bookingPlan !== 'undefined') {
                    bookingPlan = backup.buchungsplan;
                    saveBookingPlan(); // This already saves to sessionStorage
                }

                // Restore UI settings
                if (backup.settings) {
                    if (backup.settings.currentVariant) {
                        currentVariant = backup.settings.currentVariant;
                    }
                    if (typeof backup.settings.consultationMode !== 'undefined') {
                        consultationMode = backup.settings.consultationMode;
                    }
                    if (typeof backup.settings.consultationStep !== 'undefined') {
                        consultationStep = backup.settings.consultationStep;
                    }
                    if (backup.settings.theme) {
                        localStorage.setItem('theme', backup.settings.theme);
                        loadTheme();
                    }
                }

                console.log('✅ Session-Backup erfolgreich importiert:', backup.session?.id);

                // Set flag to skip recovery dialog after reload
                sessionStorage.setItem('skipRecoveryDialog', 'true');

                // Show success toast and reload automatically after 2 seconds
                showToast(
                    `Session-Backup erfolgreich importiert! Seite wird neu geladen...`,
                    'success',
                    2000
                );

                // Reload page automatically after toast (without confirmation)
                setTimeout(() => {
                    allowReloadWithoutWarning = true;
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('Import-Fehler:', error);
                showToast(`Fehler beim Importieren: ${error.message}`, 'error', 6000);
            }
        };

        // Trigger file picker
        input.click();
    }

    // Helper function to download files
    function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ===== END EXPORT FUNCTIONS =====

    let currentVariant = sessionStorage.getItem('mlp_current_variant') || 'A';
    
    const BOOKING_DAYS = 31;
    const BOOKING_KEY = "0";
    const bookingTypes = [
        {
            id: 'salary_to_fix',
            label: 'Einkommen → Fixkosten',
            labelB: 'Einkommen → Konsum',
            description: 'Einkommen landet auf dem Fixkostenkonto.',
            descriptionB: 'Einkommen landet auf dem Konsumkonto.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3.5" y="6.5" width="7.5" height="11" rx="2"></rect><path d="M6.5 9.5h2"></path><path d="M6.5 12h1.6"></path><circle cx="16.5" cy="12" r="3"></circle><path d="M11 12h3.5"></path><path d="M14.5 10l2 2-2 2"></path></svg>`,
            accent: '#34d399',
            border: 'rgba(16, 185, 129, 0.65)',
            dayBackground: 'rgba(16, 185, 129, 0.18)',
            badgeBackground: 'rgba(16, 185, 129, 0.18)',
            badgeColor: '#34d399'
        },
        {
            id: 'standing_to_konsum',
            label: 'Fixkosten → Konsum',
            labelB: 'Konsum → Fixkosten',
            description: 'Regelmäßiger Übertrag vom Fixkostenkonto auf das Konsumkonto.',
            descriptionB: 'Regelmäßiger Übertrag vom Konsumkonto auf das Fixkostenkonto.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M7 8h8a4 4 0 0 1 4 4v0"></path><path d="M17 10l2 2-2 2"></path><path d="M17 14h-8a4 4 0 0 1-4-4v0"></path><path d="M7 16l-2-2 2-2"></path></svg>`,
            iconB: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8h-8a4 4 0 0 0-4 4v0"></path><path d="M7 10l-2 2 2 2"></path><path d="M7 14h8a4 4 0 0 0 4-4v0"></path><path d="M17 16l2-2-2-2"></path></svg>`,
            accent: '#60a5fa',
            border: 'rgba(96, 165, 250, 0.6)',
            dayBackground: 'rgba(59, 130, 246, 0.16)',
            badgeBackground: 'rgba(59, 130, 246, 0.16)',
            badgeColor: '#60a5fa'
        },
        {
            id: 'sparplan',
            label: 'Fixkosten → Sparplan',
            description: 'Sparrate wird in den Depot-Sparplan investiert.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 16l4-5 3 2 5-6"></path><path d="M15.5 6.5h3v3"></path><path d="M6 18v2"></path><path d="M11 15v5"></path><path d="M16 17v3"></path></svg>`,
            accent: '#c084fc',
            border: 'rgba(168, 85, 247, 0.6)',
            dayBackground: 'rgba(168, 85, 247, 0.16)',
            badgeBackground: 'rgba(168, 85, 247, 0.18)',
            badgeColor: '#c084fc'
        },
        {
            id: 'konsum_to_tagesgeld',
            label: 'Konsum → Tagesgeld',
            description: 'Restbetrag wird auf das Tagesgeld geschoben.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="3"></circle><path d="M12 11v7"></path><path d="M9 15l3 3 3-3"></path><path d="M6 20h12"></path></svg>`,
            accent: '#facc15',
            border: 'rgba(250, 204, 21, 0.6)',
            dayBackground: 'rgba(250, 204, 21, 0.14)',
            badgeBackground: 'rgba(250, 204, 21, 0.18)',
            badgeColor: '#facc15'
        },
        {
            id: 'tagesgeld_to_depot',
            label: 'Tagesgeld → Depot',
            description: 'Überschüsse vom Tagesgeld fließen ins Depot.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 17h14"></path><path d="M8 17v-4"></path><path d="M12 17v-7"></path><path d="M16 17v-2"></path><path d="M12 5l-3 3h2v4h2V8h2z"></path></svg>`,
            accent: '#f97316',
            border: 'rgba(249, 115, 22, 0.6)',
            dayBackground: 'rgba(249, 115, 22, 0.16)',
            badgeBackground: 'rgba(249, 115, 22, 0.18)',
            badgeColor: '#f97316'
        }
    ];
    function getActiveBookingLabel(type) {
        if (!type) return '';
        if (currentVariant === 'B' && type.labelB) return type.labelB;
        return type.label || '';
    }

    function getActiveBookingDescription(type) {
        if (!type) return '';
        if (currentVariant === 'B' && type.descriptionB) return type.descriptionB;
        return type.description || getActiveBookingLabel(type);
    }

    function getActiveBookingIcon(type) {
        if (!type) return '';
        if (currentVariant === 'B' && type.iconB) return type.iconB;
        return type.icon || '';
    }

const bookingTypeLookup = {};
    bookingTypes.forEach((type, index) => {
        bookingTypeLookup[type.id] = Object.assign({ order: index }, type);
    });
    const bookingStorageKey = 'mlp_booking_plan_v1';
    let bookingPlan = loadBookingPlan() || createDefaultBookingPlan();
    let selectedBookingMonth = String(determineInitialBookingMonth(bookingPlan));
    let selectedBookingTypeId = bookingTypes.length ? bookingTypes[0].id : null;
    let bookingTypeButtonsEl = null;
    let bookingCalendarEl = null;
    let bookingHintEl = null;
    let bookingClearMonthBtn = null;

    function loadBookingPlan() {
        try {
            const raw = sessionStorage.getItem(bookingStorageKey);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            return (parsed && typeof parsed === 'object') ? parsed : null;
        } catch (err) {
            console.warn('Buchungsplan konnte nicht geladen werden.', err);
            return null;
        }
    }

    function saveBookingPlan() {
        pruneEmptyMonths();
        try {
            sessionStorage.setItem(bookingStorageKey, JSON.stringify(bookingPlan));
        } catch (err) {
            console.warn('Buchungsplan konnte nicht gespeichert werden.', err);
        }
    }

    function pruneEmptyMonths() {
        Object.keys(bookingPlan).forEach(key => {
            const monthPlan = bookingPlan[key];
            if (!monthPlan || !Object.keys(monthPlan).length) {
                delete bookingPlan[key];
            }
        });
    }

    function createDefaultBookingPlan() {
        return {
            [BOOKING_KEY]: {
                '1': ['salary_to_fix'],
                '3': ['standing_to_konsum'],
                '15': ['sparplan'],
                '27': ['konsum_to_tagesgeld'],
                '28': ['tagesgeld_to_depot']
            }
        };
    }

    function determineInitialBookingMonth(plan) {
        if (plan && hasEntriesForMonth(BOOKING_KEY, plan)) return BOOKING_KEY;
        const keys = plan ? Object.keys(plan) : [];
        return keys.length ? keys[0] : BOOKING_KEY;
    }

    function hasEntriesForMonth(month, plan = bookingPlan) {
        const monthPlan = plan[String(month)];
        return !!(monthPlan && Object.keys(monthPlan).length);
    }

    function ensureMonthPlan(month) {
        const key = String(month);
        if (!bookingPlan[key]) bookingPlan[key] = {};
        return bookingPlan[key];
    }

    function renderBookingTypeButtons() {
        if (!bookingTypeButtonsEl) return;
        bookingTypeButtonsEl.innerHTML = '';
        bookingTypes.forEach(type => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'booking-type-btn';
            if (type.badgeBackground) btn.style.backgroundColor = type.badgeBackground;
            if (type.border) btn.style.borderColor = type.border;
            if (type.badgeColor) btn.style.color = type.badgeColor;
            const iconMarkup = getActiveBookingIcon(type);
            const activeLabel = getActiveBookingLabel(type);
            const activeDesc = getActiveBookingDescription(type);
            // Icon-only, compact and clean
            btn.innerHTML = iconMarkup;
            const tooltip = activeDesc || activeLabel || type.id;
            btn.title = tooltip;
            btn.setAttribute('aria-label', tooltip);
            btn.setAttribute('aria-pressed', selectedBookingTypeId === type.id ? 'true' : 'false');
            if (selectedBookingTypeId === type.id) btn.classList.add('booking-type-btn-active');
            btn.addEventListener('click', () => handleBookingTypeSelect(type.id));
            bookingTypeButtonsEl.appendChild(btn);
        });
    }

    function handleBookingTypeSelect(typeId) {
        if (selectedBookingTypeId === typeId) return;
        selectedBookingTypeId = typeId;
        renderBookingTypeButtons();
        updateBookingHint();
    }

    function renderBookingCalendar() {
        if (!bookingCalendarEl) return;
        bookingCalendarEl.innerHTML = '';
        const monthPlan = ensureMonthPlan(selectedBookingMonth);
        for (let day = 1; day <= BOOKING_DAYS; day++) {
            const dayKey = String(day);
            const entries = Array.isArray(monthPlan[dayKey]) ? monthPlan[dayKey] : [];
            const cell = document.createElement('div');
            cell.className = 'booking-day';
            if (day >= 29) cell.classList.add('booking-day--overflow');
            cell.dataset.day = dayKey;
            cell.setAttribute('role', 'button');
            cell.setAttribute('tabindex', '0');
            cell.addEventListener('click', () => toggleDayBooking(day));
            cell.addEventListener('keydown', evt => {
                if (evt.key === 'Enter' || evt.key === ' ') {
                    evt.preventDefault();
                    toggleDayBooking(day);
                }
            });
            const number = document.createElement('div');
            number.className = 'booking-day-number';
            number.textContent = String(day);
            cell.appendChild(number);
            const content = document.createElement('div');
            content.className = 'booking-day-content';
            cell.appendChild(content);
            if (entries.length) {
                cell.classList.add('has-booking');
                const dominant = getBookingType(entries[0]);
                if (dominant && dominant.dayBackground) cell.style.backgroundColor = dominant.dayBackground;
                if (dominant && dominant.border) cell.style.borderColor = dominant.border;
            } else {
                cell.style.backgroundColor = '';
                cell.style.borderColor = '';
            }
            entries.slice().sort((a, b) => getTypeOrder(a) - getTypeOrder(b)).forEach(typeId => {
                const type = getBookingType(typeId);
                if (!type) return;
                const iconBtn = document.createElement('button');
                iconBtn.type = 'button';
                iconBtn.className = 'booking-entry-btn';
                const entryIcon = getActiveBookingIcon(type) || type.icon || '';
                const entryLabel = getActiveBookingLabel(type) || type.label || '';
                iconBtn.innerHTML = entryIcon;
                const removeTooltip = entryLabel ? `${entryLabel} entfernen` : 'Aktion entfernen';
                iconBtn.title = removeTooltip;
                iconBtn.setAttribute('aria-label', entryLabel ? `${entryLabel} am Tag ${day} entfernen` : `Aktion am Tag ${day} entfernen`);
                if (type.badgeBackground) iconBtn.style.backgroundColor = type.badgeBackground;
                if (type.badgeColor) iconBtn.style.color = type.badgeColor;
                iconBtn.addEventListener('click', evt => {
                    evt.stopPropagation();
                    removeBookingFromDay(day, typeId);
                });
                content.appendChild(iconBtn);
            });
            bookingCalendarEl.appendChild(cell);
        }
        updateClearButtonState();
    }

    function getTypeOrder(typeId) {
        const type = getBookingType(typeId);
        return typeof type?.order === 'number' ? type.order : Number.MAX_SAFE_INTEGER;
    }

    function toggleDayBooking(day) {
        if (!selectedBookingTypeId) {
            updateBookingHint('Waehle zuerst einen Buchungstyp.');
            return;
        }
        const type = getBookingType(selectedBookingTypeId);
        if (!type) return;
        const monthPlan = ensureMonthPlan(selectedBookingMonth);
        const key = String(day);
        let items = monthPlan[key];
        if (!Array.isArray(items)) {
            items = [];
            monthPlan[key] = items;
        }
        const idx = items.indexOf(selectedBookingTypeId);
        if (idx >= 0) {
            items.splice(idx, 1);
        } else {
            items.push(selectedBookingTypeId);
            items.sort((a, b) => getTypeOrder(a) - getTypeOrder(b));
        }
        if (!items.length) delete monthPlan[key];
        saveBookingPlan();
        renderBookingCalendar();
        updateBookingHint();
        renderBookingTimeline(); // v1.7.3
    }

    function removeBookingFromDay(day, typeId) {
        const monthPlan = bookingPlan[String(selectedBookingMonth)];
        if (!monthPlan) return;
        const key = String(day);
        const items = monthPlan[key];
        if (!Array.isArray(items)) return;
        const idx = items.indexOf(typeId);
        if (idx >= 0) items.splice(idx, 1);
        if (!items.length) delete monthPlan[key];
        saveBookingPlan();
        renderBookingCalendar();
        updateBookingHint();
        renderBookingTimeline(); // v1.7.3
    }

    function updateBookingHint(message) {
        if (!bookingHintEl) return;
        if (message) {
            bookingHintEl.textContent = message;
            return;
        }
        if (!selectedBookingTypeId) {
            bookingHintEl.textContent = 'Waehle einen Buchungstyp und klicke auf den passenden Tag.';
            return;
        }
        const type = getBookingType(selectedBookingTypeId);
        const activeLabel = getActiveBookingLabel(type);
        bookingHintEl.innerHTML = `Aktiver Typ: <span class="booking-hint-strong">${activeLabel || ''}</span>. Klicke auf einen Tag, um ihn hinzufuegen oder zu entfernen.`;
    }

    function clearCurrentMonthPlan() {
        const key = String(selectedBookingMonth);
        if (bookingPlan[key]) {
            bookingPlan[key] = {};
            saveBookingPlan();
            renderBookingCalendar();
            updateBookingHint();
            renderBookingTimeline(); // v1.7.3
        }
    }

    function updateClearButtonState() {
        if (!bookingClearMonthBtn) return;
        const hasEntries = hasEntriesForMonth(selectedBookingMonth);
        bookingClearMonthBtn.disabled = !hasEntries;
        bookingClearMonthBtn.classList.toggle('opacity-50', !hasEntries);
        bookingClearMonthBtn.classList.toggle('cursor-not-allowed', !hasEntries);
    }

    function getBookingType(typeId) {
        return bookingTypeLookup[typeId];
    }

    // v1.7.3: Timeline Labels - selbsterklärende Pfeil-Notation
    function getTimelineLabel(type) {
        if (!type) return '';
        const labels = {
            'salary_to_fix': currentVariant === 'B' ? 'Gehalt' : 'Gehalt',
            'standing_to_konsum': currentVariant === 'B' ? 'Kons → Fix' : 'Fix → Kons',
            'sparplan': 'Fix → Depot',
            'konsum_to_tagesgeld': 'Kons → TG',
            'tagesgeld_to_depot': 'TG → Depot'
        };
        return labels[type.id] || type.label || '';
    }

    // v1.7.3: Render Timeline under Flow
    function renderBookingTimeline() {
        const container = getEl('booking-timeline');
        if (!container) return;

        const monthPlan = bookingPlan[selectedBookingMonth] || bookingPlan[BOOKING_KEY] || {};

        // Collect all bookings with their days
        const bookings = [];
        Object.keys(monthPlan).forEach(day => {
            const dayNum = parseInt(day, 10);
            if (isNaN(dayNum) || dayNum < 1 || dayNum > 31) return;

            const entries = monthPlan[day];
            if (!Array.isArray(entries)) return;

            entries.forEach(typeId => {
                const type = getBookingType(typeId);
                if (type) {
                    bookings.push({ day: dayNum, type });
                }
            });
        });

        // Sort by day
        bookings.sort((a, b) => a.day - b.day);

        // Empty state
        if (bookings.length === 0) {
            container.innerHTML = `
                <div class="booking-timeline-empty">
                    <span class="text-gray-500 text-sm">Keine Buchungen geplant - </span>
                    <button onclick="openBookingModal()" class="text-sm ml-1 underline" style="color: var(--mlp-primary); cursor: pointer;">
                        Jetzt planen
                    </button>
                </div>
            `;
            return;
        }

        // Calculate positions (days 1-31 mapped to 2-98% to align with line)
        const getPosition = (day) => 2 + ((day - 1) / 30) * 96;

        // Build timeline HTML
        let markersHTML = bookings.map(b => {
            const pos = getPosition(b.day);
            const label = getTimelineLabel(b.type);
            const icon = getActiveBookingIcon(b.type);

            return `
                <div class="booking-timeline-marker"
                     style="position: absolute; left: ${pos}%; transform: translateX(-50%); color: ${b.type.accent};"
                     onclick="openBookingModalToDay(${b.day})"
                     title="${getActiveBookingLabel(b.type)}">
                    <div class="booking-timeline-day">${b.day}.</div>
                    <div class="booking-timeline-dot" style="background: ${b.type.accent}; border-color: ${b.type.accent};"></div>
                    <div class="booking-timeline-icon" style="color: ${b.type.accent};">${icon}</div>
                    <div class="booking-timeline-label">${label}</div>
                </div>
            `;
        }).join('');

        container.innerHTML = `
            <div class="booking-timeline-line"></div>
            <div class="booking-timeline-markers" style="position: relative; height: 100px;">
                ${markersHTML}
            </div>
        `;
    }

    // v1.7.3: Open booking modal and scroll to specific day
    function openBookingModalToDay(day) {
        openBookingModal();
        // After modal opens, highlight the day
        setTimeout(() => {
            const dayEl = document.querySelector(`.booking-day[data-day="${day}"]`);
            if (dayEl) {
                dayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                dayEl.style.boxShadow = '0 0 0 3px rgba(96, 165, 250, 0.6)';
                setTimeout(() => { dayEl.style.boxShadow = ''; }, 2000);
            }
        }, 300);
    }

    function setupBookingPlanner() {
        bookingTypeButtonsEl = getEl('booking-type-buttons');
        bookingCalendarEl = getEl('booking-calendar');
        bookingHintEl = getEl('booking-hint');
        bookingClearMonthBtn = getEl('booking-clear-month');
        if (!bookingTypeButtonsEl || !bookingCalendarEl) return;
        renderBookingTypeButtons();
        renderBookingCalendar();
        updateBookingHint();
        if (bookingClearMonthBtn) {
            bookingClearMonthBtn.addEventListener('click', clearCurrentMonthPlan);
        }
    }

// Load from sessionStorage if available (for import restoration)
    let fixkostenItems = (() => {
        try {
            const saved = sessionStorage.getItem('mlp_fixkostenItems');
            if (saved) {
                console.log('✅ fixkostenItems aus sessionStorage geladen');
                return JSON.parse(saved);
            }
        } catch (e) {
            console.error('Fehler beim Laden von fixkostenItems aus sessionStorage:', e);
        }
        // Default values
        return [
            { name: 'Miete', amount: 850, interval: 'monthly', target: 'fixkosten' },
            { name: 'Strom', amount: 60, interval: 'monthly', target: 'fixkosten' },
            { name: 'Kommunikation (Handy/Netz)', amount: 40, interval: 'monthly', target: 'fixkosten' },
            { name: 'Mobilität (Auto/Ticket)', amount: 150, interval: 'monthly', target: 'fixkosten' },
            { name: 'Versicherungen', amount: 180, interval: 'quarterly', target: 'fixkosten' },
            { name: 'Sport/Hobbies', amount: 50, interval: 'monthly', target: 'fixkosten' },
            { name: 'Vorsorge (z.B. BU)', amount: 70, interval: 'monthly', target: 'fixkosten' },
            { name: 'Sparplan Depot', amount: 250, interval: 'monthly', target: 'depot' },
        ];
    })();

    // ╔══════════════════════════════════════════════════════════════════╗
    // ║  FONDSLISTE ROT/BLAU — HIER EDITIEREN (v1.9.0)                ║
    // ║  Einfach Zeilen hinzufuegen/entfernen/aendern.                 ║
    // ║  Format: { wkn, name, kategorie, farbe }                      ║
    // ║  farbe: 'blau' = Strategie/Kern, 'rot' = Markt/Idee           ║
    // ╚══════════════════════════════════════════════════════════════════╝
    var MLP_FONDS_DB = [
        // === BLAU: Kapitalreserve ===
        { wkn: '847809', name: 'Basis-Fonds I Nachhaltig', kategorie: 'Kapitalreserve', farbe: 'blau' },
        { wkn: '979952', name: 'Renten Strategie K', kategorie: 'Kapitalreserve', farbe: 'blau' },
        { wkn: 'A0MUWS', name: 'ZinsPlus', kategorie: 'Kapitalreserve', farbe: 'blau' },
        { wkn: 'A2P9FU', name: 'Flossbach von Storch - Bond Defensive', kategorie: 'Kapitalreserve Plus', farbe: 'blau' },
        // === BLAU: VV Defensiv ===
        { wkn: 'A0LBPU', name: 'Allianz Multi Asset Risk Control', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: 'A0YFQ9', name: 'BKC Treuhand Portfolio', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: '974515', name: 'DWS Concept DJE Alpha Renten Global', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: 'A1JUU9', name: 'EB - Multi Asset Conservative', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: 'A0M43U', name: 'Flossbach von Storch - Multi Asset - Defensive', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: 'A2H61M', name: 'Invesco Pan European High Income Fund', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: 'A2JFHW', name: 'Lazard Patrimoine SRI', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: 'A2JJ1S', name: 'ODDO BHF Polaris Moderate', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: 'A1W76Y', name: 'PIMCO Strategic Income Fund', kategorie: 'VV Defensiv', farbe: 'blau' },
        { wkn: '214466', name: 'Sauren Global Defensiv', kategorie: 'VV Defensiv', farbe: 'blau' },
        // === BLAU: VV Ausgewogen ===
        { wkn: 'A2DR2M', name: 'ACATIS Value Event Fonds', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: 'A1J24Q', name: 'Allianz Income and Growth', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: '987852', name: 'Arete PRIME VALUES Growth', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: 'A12GMF', name: 'FERI Core Strategy Balanced', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: 'A3ERNP', name: 'GANE Value Event Fund', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: '975745', name: 'MEAG EuroBalance', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: 'A0M003', name: 'ODDO BHF Polaris Flexible', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: 'A0MN91', name: 'Phaidros Funds - Balanced', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: '930920', name: 'Sauren Global Balanced', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        { wkn: 'A1CVCD', name: 'X of the Best - ausgewogen', kategorie: 'VV Ausgewogen', farbe: 'blau' },
        // === BLAU: VV Dynamisch ===
        { wkn: 'A3CUB5', name: 'Allianz Better World Dynamic', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: 'A12HQR', name: 'Arabesque Global ESG Flexible Allocation', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: '986855', name: 'BL Global 75', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: 'DWS17J', name: 'DWS ESG Dynamic Opportunities', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: 'A12GMG', name: 'FERI Core Strategy Dynamic', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: '847811', name: 'FMM-Fonds (DJE)', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: 'A0M430', name: 'Flossbach von Storch - Multiple Opportunities', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: 'A1W5Y6', name: 'JPM Total Emerging Markets Income', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: 'A2ANEB', name: 'MFS Prudent Capital', kategorie: 'VV Dynamisch', farbe: 'blau' },
        { wkn: '930921', name: 'Sauren Global Opportunities', kategorie: 'VV Dynamisch', farbe: 'blau' },
        // === BLAU: MLP Classic ===
        { wkn: 'A0EAWB', name: 'Dynamic Global Balance', kategorie: 'MLP Classic', farbe: 'blau' },
        // === ROT: Titan Aktien ===
        { wkn: 'A0LF01', name: 'Fidelity Funds - Germany', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A2PKNU', name: 'Eleva European Selection Fund', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '750443', name: 'Pictet - Quest Europe Sustainable Equities', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '989229', name: 'Janus Henderson Pan Europ. Small Comp.', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '986838', name: 'AB SICAV - American Growth Portf.', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '988149', name: 'Robeco Asia-Pacific Equities', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A2PKR1', name: 'FERI Sustainable Quality', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A1H6XK', name: 'Morgan Stanley - Global Opport.', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '591135', name: 'Nordea Global Stable Equity', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '984734', name: 'terrAssisi Aktien I AMI', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '974968', name: 'OekoWorld OekoVision Classic', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A0Q5MC', name: 'X of the Best - dynamisch', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A2PK9Q', name: 'Janus Henderson Global Small Comp.', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A4039Q', name: 'Triodos Pioneer Impact Fund', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A2DKZV', name: 'Guinness Global Equity Income', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: '973045', name: 'Schroder ISF Asian Opportunities', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A0LHAL', name: 'FSSA Greater China Growth Fund', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A1C9ED', name: 'Nomura India Equity Fund', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A0NDKJ', name: 'Robeco QI EM Active Equities', kategorie: 'Titan Aktien', farbe: 'rot' },
        { wkn: 'A1C9QD', name: 'Schroder ISF Frontier Markets Equity', kategorie: 'Titan Aktien', farbe: 'rot' },
        // === ROT: Titan Branchen ===
        { wkn: '986932', name: 'BGF World Mining Fund', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: '974119', name: 'BGF World Gold Fund', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A0BL36', name: 'BGF World Healthscience Fund', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: '921800', name: 'Fidelity Funds - Global Technology', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A2DMRL', name: 'FS Exponential Technologies', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A141Q9', name: 'Pictet - Robotics', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A0MWAL', name: 'DNB Fund Renewable Energy', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A0RCVV', name: 'Vontobel - Global Environmental Change', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A2QBUQ', name: 'Robeco Sustainable Water', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A2PGYQ', name: 'Wellington Enduring Infrastructure Assets', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A0QZ7T', name: 'Pictet - Timber', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'LB6B0M', name: 'LBBW Sicher Leben', kategorie: 'Titan Branchen', farbe: 'rot' },
        { wkn: 'A0MP0Q', name: 'Janus Henderson Global Property Equities', kategorie: 'Titan Branchen', farbe: 'rot' },
        // === ROT: Titan Anleihen ===
        { wkn: '848105', name: 'Ampega Rendite Rentenfonds', kategorie: 'Titan Anleihen', farbe: 'rot' },
        { wkn: 'A0X758', name: 'ACATIS IfK Value Renten', kategorie: 'Titan Anleihen', farbe: 'rot' },
        { wkn: 'A2DW8B', name: 'T. Rowe Price - Diversified Income Bond', kategorie: 'Titan Anleihen', farbe: 'rot' },
        { wkn: 'A2PXFB', name: 'Schroder ISF Sustainable Euro Credit', kategorie: 'Titan Anleihen', farbe: 'rot' },
        { wkn: 'DWS04F', name: 'DWS Invest Euro High Yield Corporates', kategorie: 'Titan Anleihen', farbe: 'rot' },
        // === ROT: Spezialitaeten ===
        { wkn: 'DWSK01', name: 'DWS Concept Kaldemorgen', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: 'A2H6V0', name: 'OptoFlex', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: 'A2QD6P', name: 'EuroEquityFlex', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: 'A12E0S', name: 'US EquityFlex', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: 'A2JKK0', name: 'Vontobel Fund - Commodity', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: 'A0M67Q', name: 'DJE - Gold & Stabilitaetsfonds', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: 'A0NEKK', name: 'HansaGold', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: 'A1H72F', name: 'ACATIS Datini Valueflex Fonds', kategorie: 'Spezialitaeten', farbe: 'rot' },
        { wkn: '633596', name: 'Morgan Stanley - Global Convertible Bond', kategorie: 'Spezialitaeten', farbe: 'rot' },
        // === ROT: ETF ===
        { wkn: 'A0RGEL', name: 'iShares EUR Government Bond 0-1yr', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'DBX0VA', name: 'Xtrackers Target Mat Sept 2027', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'DBX1DA', name: 'Xtrackers DAX UCITS ETF', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A1T8FS', name: 'Vanguard FTSE Dev. Europe ETF', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'DBX1EU', name: 'Xtrackers Euro Stoxx 50 UCITS ETF', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A0YEDG', name: 'iShares Core S&P 500 UCITS ETF', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A3DXEB', name: 'AXA IM Nasdaq 100 UCITS ETF', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A0RPWH', name: 'iShares Core MSCI World UCITS ETF', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A2JDDJ', name: 'iShares Edge MSCI World Value Factor', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A2PZBH', name: 'UBS MSCI World Socially Responsible', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A1C1H5', name: 'iShares MSCI EM Asia UCITS ETF', kategorie: 'ETF', farbe: 'rot' },
        { wkn: 'A113FF', name: 'Xtrackers MSCI World Energy ETF', kategorie: 'ETF', farbe: 'rot' }
    ];

    let depotItems = (() => {
        try {
            const saved = sessionStorage.getItem('mlp_depotItems');
            if (saved) {
                console.log('✅ depotItems aus sessionStorage geladen');
                const items = JSON.parse(saved);
                // Migration: Add 'risk' property to old data (v1.5.1+)
                return items.map(item => {
                    if (!item.risk) {
                        item.risk = 'conservative'; // Default for backward compatibility
                    }
                    return item;
                });
            }
        } catch (e) {
            console.error('Fehler beim Laden von depotItems aus sessionStorage:', e);
        }
        // Default values (with risk property for v1.5.1+)
        return [
            { name: 'MSCI World ETF', allocation: 70, color: '#3b82f6', risk: 'conservative' },
            { name: 'Emerging Markets ETF', allocation: 30, color: '#8b5cf6', risk: 'aggressive' }
        ];
    })();
    let prognoseChartInstance = null;
    // Beratungsansicht state
    let consultationMode = false;      // off by default
    let consultationStep = 0;          // 0..6 per variant (Step 6: Immobilien)
    let allowDepotStream = true;       // normal mode shows depot stream

    // ===== DEBOUNCE UTILITY (v1.4.0) =====
    /**
     * Debounce function - delays execution until after wait time
     * @param {Function} func - Function to debounce
     * @param {number} wait - Wait time in ms
     */
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Debounced calculateProjection (v1.4.0 - Auto-Prognose)
    const debouncedProjection = debounce(calculateProjection, 300);

    // Debounced calculateAndUpdate (v1.5.0 - Performance Optimization)
    const debouncedCalculateAndUpdate = debounce(calculateAndUpdate, 150);

    // Debounced renderFixkostenList (v1.5.0 - Performance Optimization)
    const debouncedRenderFixkostenList = debounce(function() {
        // Will be defined after renderFixkostenList is available
        if (typeof renderFixkostenList === 'function') {
            renderFixkostenList();
        }
    }, 150);

    // Debounced renderDepotList (v1.5.0 - Performance Optimization)
    const debouncedRenderDepotList = debounce(function() {
        if (typeof renderDepotList === 'function') {
            renderDepotList();
        }
    }, 150);

    function setConsultationMode(on) {
      consultationMode = !!on;
      consultationStep = on ? 1 : 0;
      allowDepotStream = !on; // only enable depot stream at step 5 in consultation
      applyConsultationVisibility();
      calculateAndUpdate();

      // Update old sidebar buttons
      const nextBtn = getEl('consult-next-btn');
      const toggleBtn = getEl('consult-toggle-btn');
      const consultChip = toggleBtn ? toggleBtn.closest('.control-chip--consultation') : null;
      if (on) {
        if (nextBtn) nextBtn.classList.remove('hidden');
        if (toggleBtn) { toggleBtn.setAttribute('aria-label', 'Beratung beenden'); toggleBtn.setAttribute('title', 'Beratung beenden'); }
        if (consultChip) consultChip.classList.add('is-active');
      } else {
        if (nextBtn) nextBtn.classList.add('hidden');
        if (toggleBtn) { toggleBtn.setAttribute('aria-label', 'Beratung starten'); toggleBtn.setAttribute('title', 'Beratung starten'); }
        if (consultChip) consultChip.classList.remove('is-active');
      }

      // Update Control Bar buttons (v1.4.0)
      const nextBtnBar = getEl('consult-next-btn-bar');
      const toggleBtnBar = getEl('consult-toggle-btn-bar');
      const consultBarItem = toggleBtnBar ? toggleBtnBar.closest('.control-bar-item--consultation') : null;
      if (on) {
        if (nextBtnBar) nextBtnBar.classList.remove('hidden');
        if (toggleBtnBar) { toggleBtnBar.setAttribute('aria-label', 'Beratung beenden'); toggleBtnBar.setAttribute('title', 'Beratung beenden'); }
        if (consultBarItem) consultBarItem.classList.add('is-active');
      } else {
        if (nextBtnBar) nextBtnBar.classList.add('hidden');
        if (toggleBtnBar) { toggleBtnBar.setAttribute('aria-label', 'Beratung starten'); toggleBtnBar.setAttribute('title', 'Beratung starten'); }
        if (consultBarItem) consultBarItem.classList.remove('is-active');
      }
    }

    function nextConsultationStep() {
      if (!consultationMode) return;
      consultationStep = Math.min(6, consultationStep + 1);
      if (consultationStep === 5) allowDepotStream = true; // enable depot stream at step 5
      applyConsultationVisibility();
      calculateAndUpdate();
    }

    function isVisible(el) {
      return el && el.offsetParent !== null; // hidden via CSS class will report null
    }

    function show(el, on) {
      if (!el) return;
      if (on) el.classList.remove('hidden'); else el.classList.add('hidden');
    }

    function applyConsultationVisibility() {
      const secIncome = getEl('sec-income');
      const secKonsum = getEl('sec-konsum');
      const secTG     = getEl('sec-tagesgeld');
      const secProg   = getEl('sec-prognose');

      // Gradient zones
      const zone1 = getEl('gradient-zone-1');
      const zone2 = getEl('gradient-zone-2');
      const zone3 = getEl('gradient-zone-3');
      const zone4 = getEl('gradient-zone-4');

      // Default: all visible (normal mode)
      if (!consultationMode) {
        [secIncome, secKonsum, secTG, secProg].forEach(el => show(el, true));
        // all basins visible
        for (const key in basins) show(basins[key], true);
        // all zones visible
        [zone1, zone2, zone3, zone4].forEach(el => show(el, true));
        return;
      }

      const A = (currentVariant === 'A');
      // Step visibility by variant
      if (A) {
        show(secIncome, true);
        show(secKonsum, consultationStep >= 2);
        show(secTG,     consultationStep >= 3);
        show(secProg,   consultationStep >= 4);

        // Step 1: Nur Einkommen
        show(basins.einkommen, true);
        show(basins.fixkosten, consultationStep >= 2);
        show(basins.konsum, consultationStep >= 3);
        show(basins.tagesgeld, consultationStep >= 4);
        show(basins.depot, consultationStep >= 5);
        show(basins.immobilien, consultationStep >= 6); // Step 6: Immobilien
        show(basins.vermieterkonto, consultationStep >= 6); // Step 6: Vermieterkonto (zusammen mit Immobilien)

        // Gradient zones
        show(zone1, true); // Einkommen immer sichtbar
        show(zone2, consultationStep >= 2); // Girokonten ab Step 2
        show(zone3, consultationStep >= 4); // Liquidität ab Step 4
        show(zone4, consultationStep >= 5); // Vermögensaufbau ab Step 5
      } else {
        show(secIncome, true);
        show(secKonsum, consultationStep >= 2); // B: konsum ab step 2 (wie Fixkosten in A)
        show(secTG,     consultationStep >= 3);
        show(secProg,   consultationStep >= 4);

        show(basins.einkommen, true);
        show(basins.konsum, consultationStep >= 2); // Step 2: Konsum (wie Fixkosten in A)
        show(basins.fixkosten, consultationStep >= 3); // Step 3: Fixkosten
        show(basins.tagesgeld, consultationStep >= 4); // Step 4: Tagesgeld
        show(basins.depot, consultationStep >= 5); // Step 5: Depot
        show(basins.immobilien, consultationStep >= 6); // Step 6: Immobilien
        show(basins.vermieterkonto, consultationStep >= 6); // Step 6: Vermieterkonto (zusammen mit Immobilien)

        // Gradient zones (Variante B)
        show(zone1, true); // Einkommen immer sichtbar
        show(zone2, consultationStep >= 2); // Konsum/Fixkosten ab Step 2
        show(zone3, consultationStep >= 4); // Liquidität ab Step 4
        show(zone4, consultationStep >= 5); // Vermögensaufbau ab Step 5
      }
    }
    
    // Interpret historische Minimum/Maximum-Renditen als ca. 5. und 90. Perzentil einer Normalverteilung.
    const GAUSSIAN_LOWER_Q = 0.05;
    const GAUSSIAN_UPPER_Q = 0.9;

    // v1.5.4: Layout Constants (extracted from magic numbers for maintainability)
    const LAYOUT = {
        HORIZONTAL_GAP: 100,      // Abstand zwischen Basins horizontal (px)
        VERTICAL_GAP: 240,        // Abstand zwischen Ebenen (px)
        DEPOT_WIDTH: 440,         // Breite Depot-Basin (px)
        VERMIETERKONTO_HEIGHT: 100, // Höhe Vermieterkonto-Basin (px)
        MIN_FLOW_WIDTH: 10,       // Minimale Flow-Breite (px)
        MAX_FLOW_WIDTH: 45        // Maximale Flow-Breite (px)
    };

    const roundToDecimal = (value, digits = 1) => {
        const factor = Math.pow(10, digits);
        return Math.round((Number(value) || 0) * factor) / factor;
    };

    const clamp = (value, min, max) => {
        if (!Number.isFinite(value)) return value;
        if (Number.isFinite(min) && value < min) return min;
        if (Number.isFinite(max) && value > max) return max;
        return value;
    };

    function inverseStandardNormal(p) {
        if (p <= 0 || p >= 1) throw new RangeError('p must be in (0,1)');
        const a = [-39.6968302866538, 220.946098424521, -275.928510446969, 138.357751867269, -30.6647980661472, 2.50662827745924];
        const b = [-54.4760987982241, 161.585836858041, -155.698979859887, 66.8013118877197, -13.2806815528857];
        const c = [-0.00778489400243029, -0.322396458041136, -2.40075827716184, -2.54973253934373, 4.37466414146497, 2.93816398269878];
        const d = [0.00778469570904146, 0.32246712907004, 2.445134137143, 3.75440866190742];
        const plow = 0.02425;
        const phigh = 1 - plow;
        let q, r;
        if (p < plow) {
            q = Math.sqrt(-2 * Math.log(p));
            return (((((c[0] * q + c[1]) * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) /
                   ((((d[0] * q + d[1]) * q + d[2]) * q + d[3]) * q + 1);
        }
        if (phigh < p) {
            q = Math.sqrt(-2 * Math.log(1 - p));
            return -(((((c[0] * q + c[1]) * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) /
                    ((((d[0] * q + d[1]) * q + d[2]) * q + d[3]) * q + 1);
        }
        q = p - 0.5;
        r = q * q;
        return (((((a[0] * r + a[1]) * r + a[2]) * r + a[3]) * r + a[4]) * r + a[5]) * q /
               (((((b[0] * r + b[1]) * r + b[2]) * r + b[3]) * r + b[4]) * r + 1);
    }

    function buildRenditeStat(min, max) {
        const cleanMin = Number(min);
        const cleanMax = Number(max);
        if (!Number.isFinite(cleanMin) || !Number.isFinite(cleanMax)) {
            return { min: roundToDecimal(min), max: roundToDecimal(max), mean: roundToDecimal((Number(min) + Number(max)) / 2) };
        }
        const zLow = inverseStandardNormal(GAUSSIAN_LOWER_Q);
        const zHigh = inverseStandardNormal(GAUSSIAN_UPPER_Q);
        const range = cleanMax - cleanMin;
        let mean = (cleanMin + cleanMax) / 2;
        if (Number.isFinite(range) && range > 0 && Number.isFinite(zHigh - zLow)) {
            const sigma = range / (zHigh - zLow);
            const candidate = cleanMin - zLow * sigma;
            if (Number.isFinite(candidate)) {
                mean = candidate;
            }
        }
        const clampedMean = clamp(mean, cleanMin, cleanMax);
        return {
            min: roundToDecimal(cleanMin),
            max: roundToDecimal(cleanMax),
            mean: roundToDecimal(clampedMean)
        };
    }

    const renditeData = {
        1: buildRenditeStat(-40, 50),
        5: buildRenditeStat(-12, 32),
        10: buildRenditeStat(-1.5, 19),
        15: buildRenditeStat(3, 15),
        20: buildRenditeStat(4, 13),
        25: buildRenditeStat(5, 12),
        30: buildRenditeStat(6, 11)
    };
    // === Load fine-grained min/max returns from TXT (MLP Renditedreieck) ===
    // File: data/rendite_extreme_generated.txt
    // Format (tab/whitespace):
    // Anlagezeitraum (Jahre)    Minimale Rendite (%)   Maximale Rendite (%)
    // 1   -42.2   51.7
    let renditeExtremes = null;

    async function loadRenditeExtremes() {
    try {
        const res = await fetch('data/rendite_extreme_generated.txt', { cache: 'no-store' });
        if (!res.ok) throw new Error('not found');
        const txt = await res.text();
        renditeExtremes = parseRenditeExtremesTSV(txt);
        // refresh UI for current slider value
        const jahre = parseInt(inputs.anlagezeitraum.value, 10);
        updateRenditeSuggestions(jahre);
    } catch (e) {
        console.warn('Rendite-Extremwerte nicht geladen, nutze Fallback.', e);
        renditeExtremes = null;
    }
    }

    function parseRenditeExtremesTSV(tsv) {
    const map = {};
    tsv.split(/\r?\n/).forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (!/^\d+/.test(trimmed)) return; // skip header
        const parts = trimmed.split(/\t|\s+/).filter(Boolean);
        if (parts.length < 3) return;
        const years = parseInt(parts[0], 10);
        const min = parseFloat(String(parts[1]).replace(',', '.'));
        const max = parseFloat(String(parts[2]).replace(',', '.'));
        if (Number.isFinite(years) && Number.isFinite(min) && Number.isFinite(max)) {
                map[years] = buildRenditeStat(min, max);
        }
    });
    return map;
    }

    let inputs, basins, flowContainer, flowSvg; // Declare globally, assign in DOMContentLoaded
    const getEl = (id) => document.getElementById(id);
    const formatCurrency = (val) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val);
    const formatCompact = (val) => { const a = Math.abs(val); const s = val < 0 ? '-' : ''; if (a >= 1000000) return s + (a / 1000000).toFixed(1).replace('.', ',') + 'M'; if (a >= 1000) return s + Math.round(a / 1000) + 'k'; return val.toString(); };
    const getMonthlyAmount = (item) => { const a = item.amount || 0; switch (item.interval) { case 'quarterly': return a / 3; case 'annually': return a / 12; default: return a; } };

function renderBasin(element, title, value, icon, subtext = '', { current = 0, min = 0, limit = Infinity, minScaleBase = null } = {}, specialContent = '') {
    // Fill height is only meaningful when a real capacity limit is provided
    const fillPercent = (limit > 0 && limit !== Infinity)
      ? Math.min(100, (current / limit) * 100)
      : 0;

    // The yellow minimum line can be scaled against an explicit base (minScaleBase),
    // falling back to the same limit if none provided. This allows Konsumkonto to
    // scale its Min-Linie gegen den monatlichen Überschuss statt gegen das Kartenlimit.
    const baseForMin = (minScaleBase != null && isFinite(minScaleBase) && minScaleBase > 0)
      ? minScaleBase
      : ((limit > 0 && limit !== Infinity) ? limit : null);
    const minPercent = baseForMin ? Math.min(100, (min / baseForMin) * 100) : 0;

    // Check if element is editable (v1.4.0)
    const isEditable = element.classList.contains('account-basin--editable');
    const editIcon = isEditable ? `
        <div class="basin-edit-indicator">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        </div>
    ` : '';

    element.innerHTML = `
        <div class="absolute inset-0 bg-sky-500/30 rounded-lg transition-all duration-500" style="height: ${fillPercent}%; top: auto; bottom: 0;"></div>
        ${min > 0 ? `<div class="limit-line bg-yellow-500/70 border-t-2 border-dashed border-yellow-400" style="bottom: ${minPercent}%;"><span class="text-yellow-300">Min</span></div>` : ''}
        ${limit > 0 && limit !== Infinity ? `<div class="limit-line bg-green-500/70" style="bottom: 100%;"><span class="text-green-300">Max</span></div>` : ''}
        ${limit > 0 && limit !== Infinity && /Tagesgeldkonto/i.test(title) ? `<div class="absolute top-1 right-2 text-xs text-gray-400">Sparziel: ${new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(limit)}</div>` : ''}
        ${editIcon}
        <div class="relative z-10 flex flex-col items-center justify-center h-full">
          ${specialContent || icon}
          <p class="font-bold">${title}</p>
          <p class="text-lg font-mono">${value}</p>
          ${subtext ? `<p class="text-xs text-gray-400 mt-1">${subtext}</p>` : ''}
        </div>
    `;
    }

    let _devDragMode = false;
    function positionCascade() {
        if (_devDragMode) return;
        if (!flowContainer) return;
        const containerWidth = flowContainer.clientWidth;
        const h_gap_side = LAYOUT.HORIZONTAL_GAP;  // v1.5.4: Use named constant
        const v_gap = LAYOUT.VERTICAL_GAP;
        const depotWidth = LAYOUT.DEPOT_WIDTH;
        const immoWidth = 220;
        const gapBetweenDepotImmo = 50; // Erhöht von 30 auf 50 für klarere Trennung

        // Größen setzen
        basins.depot.style.width = `${depotWidth}px`;
        if (basins.immobilien) {
            basins.immobilien.style.width = `${immoWidth}px`;
        }
        if (basins.vermieterkonto) {
            basins.vermieterkonto.style.width = `${immoWidth}px`;
            basins.vermieterkonto.style.height = '100px'; // Kompakter als normale Basins
        }

        // === NEUE ZENTRIERUNG: Immobilien & Depot bilden Außenrahmen ===
        // Berechne Gesamtbreite des Außenrahmens
        const outerFrameWidth = immoWidth + gapBetweenDepotImmo + depotWidth; // 220 + 50 + 440 = 710px
        const vermieterkontoOffset = 140; // Vertikaler Abstand zwischen Vermieterkonto und Immobilien (erhöht von 90 auf 140)

        // Linker Rand des Außenrahmens (zentriert im Container)
        const outerFrameLeft = (containerWidth - outerFrameWidth) / 2;

        // Neuer Mittelpunkt X: Mitte zwischen Immobilien-Links und Depot-Rechts
        const newCenterX = outerFrameLeft + outerFrameWidth / 2;

        // === GIROKONTO-BEREICH: Ausrichtung an Depot & Immobilien ===
        const giroBasinWidth = 200; // Standard Basin-Breite

        // Berechne Positionen basierend auf Depot & Immobilien:
        // 1. Fixkostenkonto: Mitte über rechtem Rand des Depot-Basins
        const depotRightEdge = outerFrameLeft + immoWidth + gapBetweenDepotImmo + depotWidth;
        const giroLeft3 = depotRightEdge - (giroBasinWidth / 2); // Mitte über rechtem Depot-Rand

        // 2. Vermieterkonto: Mitte über linkem Rand des Immobilien-Basins
        const immobilienLeftEdge = outerFrameLeft;
        const giroLeft1 = immobilienLeftEdge - (giroBasinWidth / 2); // Mitte über linkem Immobilien-Rand

        // 3. Konsumkonto: Mittig zwischen rechtem Rand Vermieterkonto und linkem Rand Fixkosten
        const vermieterkontoRightEdge = giroLeft1 + giroBasinWidth;
        const fixkostenLeftEdge = giroLeft3;
        const giroLeft2 = (vermieterkontoRightEdge + fixkostenLeftEdge) / 2 - (giroBasinWidth / 2);

        // Höhen-Differenz: Vermieterkonto ist 100px, normale Basins sind größer (~150px?)
        // Um Untergrenze anzugleichen: Vermieterkonto muss TIEFER positioniert werden
        const normalBasinHeight = basins.konsum ? basins.konsum.offsetHeight : 150;
        const vermieterkontoHeight = LAYOUT.VERMIETERKONTO_HEIGHT;  // v1.5.4: Use named constant
        const heightDiff = normalBasinHeight - vermieterkontoHeight; // Differenz ausgleichen

        let positions;
        if (currentVariant === 'B') {
            // Variante B: Offsets direkt von newCenterX (einziger Referenzpunkt!)
            // Ermittelt per Drag-Tool bei containerWidth ~1510, newCenterX ~755
            positions = {
                einkommen:      { top: 0,              left: newCenterX - basins.einkommen.offsetWidth / 2 },
                konsum:         { top: v_gap,          left: newCenterX - 395 },
                fixkosten:      { top: v_gap * 2,      left: newCenterX + 181 },
                vermieterkonto: { top: v_gap * 2 + 280, left: newCenterX + 173 },
                tagesgeld:      { top: v_gap * 3,      left: newCenterX - 251 },
                depot:          { top: v_gap * 4,      left: outerFrameLeft },
                immobilien:     { top: v_gap * 4,      left: outerFrameLeft + depotWidth + gapBetweenDepotImmo },
            };
        } else { // Variante A
            // Variante A (Fixkosten-first): Einkommen -> Fixkosten -> (Konsum + Vermieterkonto) -> Tagesgeld -> Depot
            // Ebene 1: Fixkosten
            // Ebene 2: Konsum + Vermieterkonto (beide UNTERKANTE bündig!)
            positions = {
                einkommen:      { top: 0,          left: newCenterX - basins.einkommen.offsetWidth / 2 },
                fixkosten:      { top: v_gap,      left: giroLeft3 }, // Rechts (weiter rechts!)
                // Ebene 2: UNTERKANTEN bündig (Vermieterkonto tiefer wegen kleinerer Höhe)
                vermieterkonto: { top: v_gap * 2 + heightDiff,  left: giroLeft1 }, // Links, tiefer!
                konsum:         { top: v_gap * 2,  left: giroLeft2 }, // Mitte
                tagesgeld:      { top: v_gap * 3,  left: newCenterX - basins.tagesgeld.offsetWidth / 2 + 40 },
                depot:          { top: v_gap * 4.0, left: outerFrameLeft + immoWidth + gapBetweenDepotImmo },
                immobilien:     { top: v_gap * 4.0, left: outerFrameLeft },
            };
        }

        // Positionen anwenden
        for (const key in basins) {
            if (basins[key]) {
                basins[key].style.top = `${positions[key].top}px`;
                basins[key].style.left = `${positions[key].left}px`;
            }
        }
    }

    function attachFlowDot(pathId, radius = 4, speedSec = 3) {
        const dotGroupId = `${pathId}-dot`;
        let g = document.getElementById(dotGroupId);
        if (!g) {
            g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('id', dotGroupId);
            document.getElementById('flow-svg').appendChild(g);
        }
        // Clear existing content
        g.innerHTML = '';
        // Create circle + animateMotion referencing the path
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('class', 'flow-dot');
        circle.setAttribute('r', String(radius));
        const animateMotion = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
        animateMotion.setAttribute('dur', `${Math.max(1.2, speedSec)}s`);
        animateMotion.setAttribute('repeatCount', 'indefinite');
        const mpath = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
        mpath.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', `#${pathId}`);
        animateMotion.appendChild(mpath);
        circle.appendChild(animateMotion);
        g.appendChild(circle);
    }

    function drawFlow(pathId, fromBasin, toBasin, value, maxFlowValue, labelText = '', flowOpacity = 1.0) {
        if (!fromBasin || !toBasin) return;
        const path = getEl(pathId), pathAnim = getEl(`${pathId}-anim`);
        const fromRect = fromBasin.getBoundingClientRect(), toRect = toBasin.getBoundingClientRect(), containerRect = flowContainer.getBoundingClientRect();
        let fromX = fromRect.left - containerRect.left + fromRect.width / 2;
        let fromY = fromRect.bottom - containerRect.top;
        const toX = toRect.left - containerRect.left + toRect.width / 2;
        const toY = toRect.top - containerRect.top;
        const minWidth = LAYOUT.MIN_FLOW_WIDTH, maxWidth = LAYOUT.MAX_FLOW_WIDTH;  // v1.5.4: Use named constants
        const normalizedValue = Math.max(0, value) / maxFlowValue;
        const strokeWidth = minWidth + normalizedValue * (maxWidth - minWidth);
        path.style.strokeWidth = `${value > 0 ? Math.max(minWidth, strokeWidth) : 0}px`;
        // Nur für spezielle Flows (z.B. Deficitline) opacity setzen, sonst CSS-Animation überschreiben
        if (flowOpacity !== 1.0) {
            path.style.opacity = flowOpacity; // Opacity für dezente Flows
        } else {
            path.style.opacity = ''; // CSS-Default verwenden (für Animationen)
        }

        let pathData;
        // REPLACED BLOCK: custom anchor, curve, and offsets for each flow
        // --- BEGIN NEW BLOCK ---
        const EXIT_OFFSET_Y = 8; // slightly deeper anchor, hides seams better
        const CURVE_MAIN = 70;   // smaller curve radius for tighter, calmer streams
        const CURVE_SHORT = 55;  // short bends for side-to-side connections

        if (pathId === 'fixkosten-depot-flow') {
            if (typeof currentVariant !== 'undefined' && currentVariant === 'B') {
                // Var B: Fixkosten abgehend UNTEN LINKS → Depot ankommend OBEN RECHTS
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.25; // exit BOTTOM LEFT
                fromY -= EXIT_OFFSET_Y;
                const toDepotX = toRect.left - containerRect.left + toRect.width * 0.75; // enter TOP RIGHT
                pathData = `M ${fromX},${fromY} C ${fromX},${fromY + 70} ${toDepotX},${toY - 70} ${toDepotX},${toY}`;
            } else {
                // Var A: From right side of fixkosten into right half of depot
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.75;
                const toDepotX = toRect.left - containerRect.left + toRect.width * 0.75;
                fromY -= EXIT_OFFSET_Y;
                pathData = `M ${fromX},${fromY} C ${fromX},${fromY + 70} ${toDepotX},${toY - 70} ${toDepotX},${toY}`;
            }
        } else if (pathId === 'tagesgeld-depot-flow') {
            if (typeof currentVariant !== 'undefined' && currentVariant === 'B') {
                // Var B: Tagesgeld → Depot ankommend OBEN MITTE
                const toDepotX = toRect.left - containerRect.left + toRect.width * 0.50; // enter TOP CENTER
                fromY -= EXIT_OFFSET_Y;
                pathData = `M ${fromX},${fromY} C ${fromX},${fromY + 55} ${toDepotX},${toY - 55} ${toDepotX},${toY}`;
            } else {
                // Var A: From center of tagesgeld into left half of depot
                const toDepotX = toRect.left - containerRect.left + (toRect.width * 0.25);
                fromY -= EXIT_OFFSET_Y;
                pathData = `M ${fromX},${fromY} C ${fromX},${fromY + 55} ${toDepotX},${toY - 55} ${toDepotX},${toY}`;
            }
        } else if (pathId === 'konsum-tagesgeld-flow') {
            // Überschuss-Stream aus dem Konsumkonto:
            //  • Variante B: unten links aus dem Konsumkonto starten (verhindert Kreuzungen)
            //  • Variante A: unten rechts aus dem Konsumkonto starten (spiegelbildlich zur Anordnung)
            if (typeof currentVariant !== 'undefined' && currentVariant === 'B') {
                // bottom-left anchor on Konsum → Tagesgeld (zentral) mit kurzer, ruhiger Kurve
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.20;
                fromY -= EXIT_OFFSET_Y;
                const c1x = fromX - 40, c1y = fromY + CURVE_SHORT;
                const c2x = toX - 20,  c2y = toY - CURVE_SHORT;
                pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toX},${toY}`;
            } else {
                // Variante A: bottom-right anchor (spiegelbildlich), kurze, sanfte Biegung
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.80;
                fromY -= EXIT_OFFSET_Y;
                const c1x = fromX + 40, c1y = fromY + CURVE_SHORT;
                const c2x = toX + 20,  c2y = toY - CURVE_SHORT;
                pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toX},${toY}`;
            }
        // --- BEGIN NEW BLOCK ---
        } else if (pathId === 'flow-path-2' && typeof currentVariant !== 'undefined' && currentVariant === 'A') {
            // Dauerauftrag: from left side of Fixkosten (right column) to right side of Konsum (left column)
            const R = 65; // curve radius
            fromX = fromRect.left - containerRect.left + fromRect.width * 0.20; // exit left
            fromY -= EXIT_OFFSET_Y;
            const toKonsumX = toRect.left - containerRect.left + toRect.width * 0.80; // enter right
            pathData = `M ${fromX},${fromY} C ${fromX - R},${fromY + R} ${toKonsumX + R},${toY - R} ${toKonsumX},${toY}`;
        } else if (pathId === 'flow-path-2' && typeof currentVariant !== 'undefined' && currentVariant === 'B') {
            // Dauerauftrag Var B: Konsum (center) → Fixkosten (rechts), ankommend OBEN MITTE
            const R = 65;
            fromX = fromRect.left - containerRect.left + fromRect.width * 0.80; // exit right
            fromY -= EXIT_OFFSET_Y;
            const toMidX = toRect.left - containerRect.left + toRect.width * 0.50; // enter TOP CENTER
            pathData = `M ${fromX},${fromY} C ${fromX + R},${fromY + R} ${toMidX},${toY - R} ${toMidX},${toY}`;
        } else if (pathId === 'vermieterkonto-einkommen-flow') {
            // Flow von Vermieterkonto HOCH zum Einkommen (Mieteinnahmen fließen ins Einkommen)
            // Mäandernder organischer Flow wie alle anderen (kein Stilbruch!)
            // Start: Rechts-Oben am Vermieterkonto (damit es schön zur Seite mäandert)
            fromX = fromRect.left - containerRect.left + fromRect.width * 0.75; // Rechts (75%)
            fromY = fromRect.top - containerRect.top; // Oberkante

            // Ziel: Links-Unten am Einkommen (Andockpunkt NICHT in der Mitte wo Hauptflow abgeht!)
            const toEinkommenX = toRect.left - containerRect.left + toRect.width * 0.25; // Links (25%)
            const toEinkommenY = toRect.bottom - containerRect.top; // Unterkante

            // Mäandernde S-Kurve wie andere Flows (organisch, nicht linear!)
            const dx = toEinkommenX - fromX;
            const dy = toEinkommenY - fromY;

            // Zwei Kontrollpunkte für organische Kurve (erst nach rechts/oben, dann zurück nach links)
            const c1x = fromX + 60; // Erst nach rechts schwingen
            const c1y = fromY + dy * 0.35; // 35% des Weges nach oben
            const c2x = toEinkommenX - 50; // Dann zurück nach links zum Ziel
            const c2y = toEinkommenY - dy * 0.25; // 75% des Weges (nah am Ziel)

            pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toEinkommenX},${toEinkommenY}`;
        } else if (pathId === 'fixkosten-vermieterkonto-flow') {
            // Bidirektionaler Flow zwischen Vermieterkonto und Fixkosten/Konsum
            // Richtung wird durch fromBasin/toBasin bestimmt

            // Prüfe ob Vermieterkonto der Startpunkt ist (positiver Saldo)
            const isPositiveFlow = fromBasin.id === 'vermieterkonto-basin';

            if (isPositiveFlow) {
                if (typeof currentVariant !== 'undefined' && currentVariant === 'B') {
                    // Var B positiv: Vermieterkonto (unten) MITTE OBEN → Fixkosten (oben) MITTE UNTEN
                    fromX = fromRect.left - containerRect.left + fromRect.width * 0.50;
                    fromY = fromRect.top - containerRect.top;

                    const toTargetX = toRect.left - containerRect.left + toRect.width * 0.50;
                    const toTargetY = toRect.bottom - containerRect.top;

                    const dy = toTargetY - fromY;
                    pathData = `M ${fromX},${fromY} C ${fromX},${fromY + dy * 0.4} ${toTargetX},${toTargetY - dy * 0.4} ${toTargetX},${toTargetY}`;
                } else {
                    // Var A positiv: Vermieterkonto → Fixkosten/Konsum
                    // Start: Oberkante Mitte vom Vermieterkonto
                    fromX = fromRect.left - containerRect.left + fromRect.width * 0.5;
                    fromY = fromRect.top - containerRect.top;

                    // Ziel: Linke Seite Mitte vom Ziel-Basin (Fixkosten oder Konsum)
                    const toTargetX = toRect.left - containerRect.left + toRect.width * 0.10;
                    const toTargetY = toRect.top - containerRect.top + toRect.height * 0.5;

                    // Umgekehrte mäandernde Kurve (nach oben und rechts)
                    const c1x = fromX - 40; // Nach links schwingen
                    const c1y = fromY - 60;
                    const c2x = toTargetX - 60; // Nach links vorbei
                    const c2y = toTargetY - (toTargetY - fromY) * 0.3;

                    pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toTargetX},${toTargetY}`;
                }
            } else {
                // Negativ: Fixkosten → Vermieterkonto (Deckung)
                if (typeof currentVariant !== 'undefined' && currentVariant === 'B') {
                    // Var B: Fixkosten direkt ÜBER Vermieterkonto → abgehend MITTE UNTEN, ankommend MITTE OBEN
                    fromX = fromRect.left - containerRect.left + fromRect.width * 0.50;
                    fromY = fromRect.bottom - containerRect.top;

                    const toVermX = toRect.left - containerRect.left + toRect.width * 0.50;
                    const toVermY = toRect.top - containerRect.top;

                    const dy = toVermY - fromY;
                    pathData = `M ${fromX},${fromY} C ${fromX},${fromY + dy * 0.4} ${toVermX},${toVermY - dy * 0.4} ${toVermX},${toVermY}`;
                } else {
                    // Var A: Start: Linker Rand vom Fixkostenkonto (10%)
                    fromX = fromRect.left - containerRect.left + fromRect.width * 0.10;
                    fromY = fromRect.top - containerRect.top + fromRect.height * 0.5;

                    // Ziel: Oberkante Mitte vom Vermieterkonto
                    const toVermX = toRect.left - containerRect.left + toRect.width * 0.5;
                    const toVermY = toRect.top - containerRect.top;

                    // Mäandernde Kurve (nach links und unten)
                    const c1x = fromX - 60; // Nach links schwingen
                    const c1y = fromY + (toVermY - fromY) * 0.3;
                    const c2x = toVermX - 40; // Zurück zur Mitte
                    const c2y = toVermY - 60;

                    pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toVermX},${toVermY}`;
                }
            }
        } else {
            // Default smooth S-curve between centers
            fromY -= EXIT_OFFSET_Y;
            pathData = `M ${fromX},${fromY} C ${fromX},${fromY + CURVE_MAIN} ${toX},${toY - CURVE_MAIN} ${toX},${toY}`;
        }
        // --- END NEW BLOCK ---
        path.setAttribute('d', pathData);
        pathAnim.setAttribute('d', pathData);
        // Reset inline opacity to allow CSS to control animation visibility
        pathAnim.style.opacity = '';

        // Update mask stroke to define visible river area
        const pathMask = getEl(`${pathId}-mask`);
        if (pathMask) {
            pathMask.setAttribute('d', pathData);
            const maskWidth = Math.max(0, parseFloat(path.style.strokeWidth || "0") + 2);
            pathMask.style.strokeWidth = `${maskWidth}px`;
        }

        // Eraser path covers any legacy underlay (stroke slightly wider than main)
        const pathErase = getEl(`${pathId}-erase`);
        if (pathErase) {
            pathErase.setAttribute('d', pathData);
            const eraseWidth = Math.max(0, parseFloat(path.style.strokeWidth || "0") + 40); // extra wide to fully cover any underlay, even at tight bends
            pathErase.style.strokeWidth = `${eraseWidth}px`;
        }

        // Add/update moving dot for direction cue
        const radius = Math.max(2, Math.min(5, parseFloat(path.style.strokeWidth) / 6));
        const speed = 6 + Math.max(0, (parseFloat(path.style.strokeWidth) - 10) / 8); // overall slower, more uniform
        attachFlowDot(pathId, radius, speed);
        
        const valueLabelId = `${pathId}-value`, textLabelId = `${pathId}-text`;
        let valueLabel = getEl(valueLabelId), textLabel = getEl(textLabelId);
        if (!valueLabel) { valueLabel = document.createElement('div'); valueLabel.className = 'flow-value'; valueLabel.id = valueLabelId; flowContainer.appendChild(valueLabel); }
        if (labelText && !textLabel) { textLabel = document.createElement('div'); textLabel.className = 'flow-label'; textLabel.id = textLabelId; flowContainer.appendChild(textLabel); }
        
        valueLabel.textContent = formatCurrency(value);
        if(textLabel) textLabel.textContent = labelText;

        // Spezielle Label-Positionierung für Vermieterkonto-Flows (näher am Vermieterkonto)
        let labelPosition = 0.5; // Standard: 50% (Mitte)
        if (pathId === 'vermieterkonto-einkommen-flow') {
            labelPosition = 0.35; // 35% - näher am Vermieterkonto (Start)
        } else if (pathId === 'fixkosten-vermieterkonto-flow') {
            labelPosition = 0.67; // 67% - im ersten Drittel vom Vermieterkonto aus (= letztes Drittel vom Start)
        }

        const midPoint = path.getPointAtLength(path.getTotalLength() * labelPosition);
        valueLabel.style.left = `${midPoint.x}px`; valueLabel.style.top = `${midPoint.y}px`;
        if (textLabel) {
            textLabel.style.left = `${midPoint.x}px`;
            textLabel.style.top  = `${midPoint.y - 22}px`; // closer spacing above the amount pill
        }
        path.classList.toggle('active', value > 0);
        valueLabel.style.display = (value > 0) ? 'block' : 'none';
        if(textLabel) textLabel.style.display = (value > 0) ? 'block' : 'none';
    }

    function hideFlow(pathId) {
        const path      = getEl(pathId);
        const pathAnim  = getEl(`${pathId}-anim`);
        const valueLbl  = getEl(`${pathId}-value`);
        const textLbl   = getEl(`${pathId}-text`);
        const pathErase = getEl(`${pathId}-erase`);
        const pathMask  = getEl(`${pathId}-mask`);
        const dotGroup  = getEl(`${pathId}-dot`);
        if (path) {
            path.classList.remove('active');
            path.style.strokeWidth = '0px';
        }
        if (pathAnim) {
            pathAnim.style.opacity = '0';
        }
        if (valueLbl) valueLbl.style.display = 'none';
        if (textLbl)  textLbl.style.display  = 'none';
        if (pathErase) pathErase.style.strokeWidth = '0px';
        if (pathMask)  pathMask.style.strokeWidth  = '0px';
        if (dotGroup)  dotGroup.innerHTML = '';
    }

    function drawConnectionLine(lineId, fromBasin, toBasin) {
        // Zeichnet eine gestrichelte vertikale Verbindungslinie (kein Flow, nur Visualisierung)
        if (!fromBasin || !toBasin) return;

        let line = getEl(lineId);
        if (!line) {
            line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.id = lineId;
            line.setAttribute('stroke', '#60a5fa'); // blue-400
            line.setAttribute('stroke-width', '1.5'); // Reduziert von 2 auf 1.5
            line.setAttribute('stroke-dasharray', '8,4'); // gestrichelt
            line.setAttribute('fill', 'none');
            line.setAttribute('opacity', '0.25'); // Reduziert von 0.5 auf 0.25 für dezentere Darstellung
            flowSvg.appendChild(line);
        }

        const fromRect = fromBasin.getBoundingClientRect();
        const toRect = toBasin.getBoundingClientRect();
        const containerRect = flowContainer.getBoundingClientRect();

        // Vertikale Linie von der Mitte des oberen Basins zur Mitte des unteren Basins
        const centerX = fromRect.left - containerRect.left + fromRect.width / 2;
        const fromY = fromRect.bottom - containerRect.top;
        const toY = toRect.top - containerRect.top;

        const pathData = `M ${centerX},${fromY} L ${centerX},${toY}`;
        line.setAttribute('d', pathData);
    }

    function drawSchutzschirm(fromBasin, toBasin) {
        if (!fromBasin || !toBasin) return;
        const path = getEl('schutzschirm-path');
        const toRect = toBasin.getBoundingClientRect(), containerRect = flowContainer.getBoundingClientRect();
        const toLeftX = toRect.left - containerRect.left, toRightX = toRect.right - containerRect.left, toY = toRect.top - containerRect.top;
        const controlX = toLeftX + toRect.width / 2;
        const controlY = toY - 80;
        const pathData = `M ${toLeftX}, ${toY} Q ${controlX}, ${controlY} ${toRightX}, ${toY}`;
        path.setAttribute('d', pathData);
    }

    // ===== v1.6.1: SCHUTZSCHILD INFO-BADGE FUNCTIONS =====

    /**
     * Update Schutzschild Info-Badge (v1.6.1 Redesigned)
     * Calculation: Tagesgeld / (Einkommen - Alle Sparraten)
     */
    function updateSchutzschildBadge(tagesgeldAmount, data) {
        const badge = getEl('schutzschild-badge');
        if (!badge) return;

        // Calculate: Einkommen - Alle Sparraten
        const income = inputs.income ? parseFloat(inputs.income.value) || 0 : 0;
        const depotSparplanTotal = data && data.depotSparplanTotal ? data.depotSparplanTotal : 0;

        // Monthly available = Einkommen - Sparraten
        const monthlyAvailable = income - depotSparplanTotal;

        // Calculate buffer in months: Tagesgeld / (Einkommen - Sparraten)
        const pufferMonths = monthlyAvailable > 0 && tagesgeldAmount > 0
            ? Math.floor(tagesgeldAmount / monthlyAvailable)
            : 0;

        // Update content
        const monthsEl = getEl('schutzschild-puffer-months');
        const amountEl = getEl('schutzschild-puffer-amount');

        if (monthsEl) {
            monthsEl.textContent = pufferMonths >= 1
                ? `Puffer: ${pufferMonths} M`
                : `<1 M`;
        }
        if (amountEl) {
            amountEl.textContent = `(${formatCurrency(tagesgeldAmount)})`;
        }

        // Remove all color classes
        badge.classList.remove('schutzschild-badge--green', 'schutzschild-badge--yellow', 'schutzschild-badge--red');

        // Apply color coding
        let colorClass = '';
        let shieldColor = '';
        let shieldStroke = '';

        if (pufferMonths >= 3) {
            colorClass = 'schutzschild-badge--green';
            shieldColor = 'rgba(16, 185, 129, 0.15)';
            shieldStroke = 'rgba(16, 185, 129, 0.4)';
        } else if (pufferMonths >= 1) {
            colorClass = 'schutzschild-badge--yellow';
            shieldColor = 'rgba(251, 191, 36, 0.15)';
            shieldStroke = 'rgba(251, 191, 36, 0.4)';
        } else {
            colorClass = 'schutzschild-badge--red';
            shieldColor = 'rgba(239, 68, 68, 0.15)';
            shieldStroke = 'rgba(239, 68, 68, 0.4)';
        }

        badge.classList.add(colorClass);

        // Update shield SVG colors
        const shield = getEl('schutzschirm-path');
        if (shield && shield.style.opacity !== '0') {
            shield.style.fill = shieldColor;
            shield.style.stroke = shieldStroke;
        }

        // Position badge on the RIGHT side, next to shield (higher)
        const depotBasin = basins.depot;
        if (depotBasin) {
            const depotRect = depotBasin.getBoundingClientRect();
            const containerRect = flowContainer.getBoundingClientRect();

            const badgeX = (depotRect.right - containerRect.left) + 16; // 16px right of depot
            const badgeY = (depotRect.top - containerRect.top) - 40; // Higher - next to shield arc

            badge.style.left = `${badgeX}px`;
            badge.style.top = `${badgeY}px`;
        }

        // v1.6.1 Level 2: Update tooltip content
        updateTooltipContent(tagesgeldAmount, pufferMonths);
    }

    // Click handler for shield - will trigger Level 3 Demo later
    function initSchutzschildClickHandler() {
        const shield = getEl('schutzschirm-path');

        if (shield) {
            shield.style.pointerEvents = 'auto'; // Enable clicks
            shield.style.cursor = 'pointer';

            shield.addEventListener('click', function(e) {
                e.stopPropagation();
                // TODO: Level 3 - Start 5-second demo animation
                console.log('Shield clicked - Level 3 Demo will go here');
            });
        }
    }

    // v1.6.1 Level 2: Hover-Tooltip functionality with visual connections
    function initSchutzschildTooltip() {
        const shield = getEl('schutzschirm-path');
        const tooltip = getEl('schutzschild-tooltip');
        const connectionSvg = getEl('tooltip-connection-svg');

        if (shield && tooltip && connectionSvg) {
            // Show tooltip and connections on hover + start shield pulsing
            shield.addEventListener('mouseenter', function() {
                // Update tooltip content FIRST
                updateTooltipOnHover();

                tooltip.classList.add('schutzschild-tooltip--visible');
                connectionSvg.style.display = 'block';
                positionTooltip();
                startShieldPulsing(); // Start continuous pulsing
            });

            // Hide tooltip on mouse leave + stop shield pulsing
            shield.addEventListener('mouseleave', function() {
                tooltip.classList.remove('schutzschild-tooltip--visible');
                connectionSvg.style.display = 'none';
                stopShieldPulsing(); // Stop pulsing
            });

            // Keep visible when hovering over tooltip
            tooltip.addEventListener('mouseenter', function() {
                tooltip.classList.add('schutzschild-tooltip--visible');
                connectionSvg.style.display = 'block';
                startShieldPulsing(); // Keep pulsing
            });

            // Hide when leaving tooltip
            tooltip.addEventListener('mouseleave', function() {
                tooltip.classList.remove('schutzschild-tooltip--visible');
                connectionSvg.style.display = 'none';
                stopShieldPulsing(); // Stop pulsing
            });
        }
    }

    function updateTooltipOnHover() {
        const pufferMonths = calculatePufferMonths();
        const tooltipText = getEl('tooltip-puffer-text');
        const tooltip = getEl('schutzschild-tooltip');

        console.log('Puffer Monate berechnet:', pufferMonths); // Debug

        if (tooltipText) {
            const monthsText = pufferMonths >= 1 ? `${pufferMonths} M` : '<1 M';
            tooltipText.textContent = `Puffer: ${monthsText}`;
        }

        // Update tooltip color
        if (tooltip) {
            tooltip.classList.remove('schutzschild-tooltip--green', 'schutzschild-tooltip--yellow', 'schutzschild-tooltip--red');

            if (pufferMonths >= 3) {
                tooltip.classList.add('schutzschild-tooltip--green');
            } else if (pufferMonths >= 1) {
                tooltip.classList.add('schutzschild-tooltip--yellow');
            } else {
                tooltip.classList.add('schutzschild-tooltip--red');
            }
        }

        // Update connection line color
        const tagesgeldLine = getEl('tagesgeld-tooltip-line');
        if (tagesgeldLine) {
            let lineColor = '';
            if (pufferMonths >= 3) {
                lineColor = 'rgba(16, 185, 129, 0.9)';
            } else if (pufferMonths >= 1) {
                lineColor = 'rgba(251, 191, 36, 0.9)';
            } else {
                lineColor = 'rgba(239, 68, 68, 0.9)';
            }
            tagesgeldLine.setAttribute('stroke', lineColor);
        }
    }

    function startShieldPulsing() {
        const shield = getEl('schutzschirm-path');
        if (!shield) return;

        // Get current puffer months from tooltip
        const pufferMonths = calculatePufferMonths();

        // Remove any existing impact classes
        shield.classList.remove('shield--impact-green', 'shield--impact-yellow', 'shield--impact-red');

        // Add appropriate impact flash based on puffer months (Enterprise-style)
        if (pufferMonths >= 3) {
            shield.classList.add('shield--impact-green'); // Slow green flash
        } else if (pufferMonths >= 1) {
            shield.classList.add('shield--impact-yellow'); // Medium yellow flash
        } else {
            shield.classList.add('shield--impact-red'); // Fast red flash (warning)
        }
    }

    function stopShieldPulsing() {
        const shield = getEl('schutzschirm-path');
        if (!shield) return;

        shield.classList.remove('shield--impact-green', 'shield--impact-yellow', 'shield--impact-red');
    }

    function calculatePufferMonths() {
        // Get values from input fields in modals (NOT from basins!)
        // 1. Tagesgeld: "Aktueller Stand" from Tagesgeld modal
        const tagesgeldAmount = inputs.tagesgeldCurrent ? parseFloat(inputs.tagesgeldCurrent.value) || 0 : 0;

        // 2. Einkommen from Einkommen field
        const einkommen = inputs.income ? parseFloat(inputs.income.value) || 0 : 0;

        // 3. Depot Sparrate from Fixkosten modal (items with target='depot')
        const depotSparrate = fixkostenItems
            .filter(i => i.target === 'depot')
            .reduce((sum, i) => sum + getMonthlyAmount(i), 0);

        console.log('Tagesgeld:', tagesgeldAmount, 'Einkommen:', einkommen, 'Sparrate:', depotSparrate); // Debug

        // Calculation: Einkommen - Alle Sparraten
        const monthlyAvailable = einkommen - depotSparrate;

        if (monthlyAvailable <= 0 || tagesgeldAmount <= 0) {
            console.log('Ungültige Werte - monthlyAvailable:', monthlyAvailable, 'tagesgeld:', tagesgeldAmount);
            return 0; // Kein verfügbares Einkommen oder kein Tagesgeld
        }

        // Puffer in Monaten = Tagesgeld / (Einkommen - Sparraten)
        const months = Math.floor(tagesgeldAmount / monthlyAvailable);
        console.log('Berechnete Monate:', months);
        return months;
    }

    function positionTooltip() {
        const tooltip = getEl('schutzschild-tooltip');
        const tagesgeldBasin = basins.tagesgeld;
        const depotBasin = basins.depot;

        if (tooltip && tagesgeldBasin && depotBasin) {
            const tagesgeldRect = tagesgeldBasin.getBoundingClientRect();
            const depotRect = depotBasin.getBoundingClientRect();
            const containerRect = flowContainer.getBoundingClientRect();

            // Position tooltip HIGHER - between Tagesgeld and Shield (clear of depot)
            const tooltipX = (tagesgeldRect.right - containerRect.left) + 24; // 24px right of tagesgeld
            const tooltipY = (depotRect.top - containerRect.top) - 110; // Higher position, clear of depot

            tooltip.style.left = `${tooltipX}px`;
            tooltip.style.top = `${tooltipY}px`;

            // Draw connection lines
            drawTooltipConnections();
        }
    }

    // ===== FLOW-LINE HELPER (v1.6.1) =====
    // Einfache Syntax: "element-id.position -> element-id.position"
    // Positionen: top, bottom, left, right, center, top-left, top-right, bottom-left, bottom-right

    function getElementPosition(elementId, position) {
        const element = getEl(elementId) || basins[elementId.replace('-basin', '')];
        if (!element) {
            console.error(`Element nicht gefunden: ${elementId}`);
            return null;
        }

        const rect = element.getBoundingClientRect();
        const containerRect = flowContainer.getBoundingClientRect();

        // Relative coordinates zum Flow-Container
        const x = rect.left - containerRect.left;
        const y = rect.top - containerRect.top;
        const w = rect.width;
        const h = rect.height;

        const positions = {
            'center': { x: x + w / 2, y: y + h / 2 },
            'top': { x: x + w / 2, y: y },
            'bottom': { x: x + w / 2, y: y + h },
            'left': { x: x, y: y + h / 2 },
            'right': { x: x + w, y: y + h / 2 },
            'top-left': { x: x, y: y },
            'top-right': { x: x + w, y: y },
            'bottom-left': { x: x, y: y + h },
            'bottom-right': { x: x + w, y: y + h }
        };

        return positions[position] || positions['center'];
    }

    function drawFlowLine(pathElement, fromSpec, toSpec) {
        // Parse: "element-id.position -> element-id.position"
        const [fromPart, toPart] = fromSpec.includes('->')
            ? fromSpec.split('->').map(s => s.trim())
            : [fromSpec, toSpec];

        const [fromElement, fromPos] = fromPart.split('.');
        const [toElement, toPos] = toPart.split('.');

        const start = getElementPosition(fromElement.trim(), fromPos.trim());
        const end = getElementPosition(toElement.trim(), toPos.trim());

        if (!start || !end) {
            console.error(`Flow-Line konnte nicht gezeichnet werden: ${fromSpec} -> ${toSpec}`);
            return;
        }

        pathElement.setAttribute('d', `M ${start.x} ${start.y} L ${end.x} ${end.y}`);
    }

    function drawTooltipConnections() {
        const connectionSvg = getEl('tooltip-connection-svg');
        const tooltip = getEl('schutzschild-tooltip');

        if (!connectionSvg || !tooltip) return;

        const containerRect = flowContainer.getBoundingClientRect();

        // Set SVG size to cover the whole container
        connectionSvg.setAttribute('width', containerRect.width);
        connectionSvg.setAttribute('height', containerRect.height);
        connectionSvg.style.left = '0';
        connectionSvg.style.top = '0';

        // Draw Flow-Line using new syntax: Tagesgeld rechts -> Tooltip top-left
        const tagesgeldLine = getEl('tagesgeld-tooltip-line');
        if (tagesgeldLine) {
            drawFlowLine(tagesgeldLine, "tagesgeld-basin.right", "schutzschild-tooltip.top-left");
        }

        // Hide the second line (not needed anymore)
        const shieldLine = getEl('tooltip-shield-line');
        if (shieldLine) {
            shieldLine.setAttribute('d', '');
        }
    }

    function updateTooltipContent(tagesgeldAmount, pufferMonths) {
        const tooltip = getEl('schutzschild-tooltip');
        const tooltipText = getEl('tooltip-puffer-text');

        if (tooltipText) {
            const monthsText = pufferMonths >= 1
                ? `${pufferMonths} M`
                : '<1 M';
            tooltipText.textContent = `Puffer: ${monthsText}`;
        }

        // Apply color coding to tooltip and connection lines
        if (tooltip) {
            tooltip.classList.remove('schutzschild-tooltip--green', 'schutzschild-tooltip--yellow', 'schutzschild-tooltip--red');

            let colorClass = '';
            let lineColor = '';

            if (pufferMonths >= 3) {
                colorClass = 'schutzschild-tooltip--green';
                lineColor = 'rgba(16, 185, 129, 0.9)';
            } else if (pufferMonths >= 1) {
                colorClass = 'schutzschild-tooltip--yellow';
                lineColor = 'rgba(251, 191, 36, 0.9)';
            } else {
                colorClass = 'schutzschild-tooltip--red';
                lineColor = 'rgba(239, 68, 68, 0.9)';
            }

            tooltip.classList.add(colorClass);

            // Update connection line colors (both dashed, organic style)
            const tagesgeldLine = getEl('tagesgeld-tooltip-line');
            const shieldLine = getEl('tooltip-shield-line');

            if (tagesgeldLine) {
                tagesgeldLine.setAttribute('stroke', lineColor);
            }
            if (shieldLine) {
                shieldLine.setAttribute('stroke', lineColor);
            }
        }
    }

    // ===== INLINE EDITOR FUNCTIONS (v1.4.0) =====

    /**
     * Open inline editor for a specific basin
     * @param {Event} event - Click event (to stop propagation)
     * @param {string} basinType - 'einkommen', 'konsum', 'tagesgeld'
     */
    function openInlineEditor(event, basinType) {
        // Stop event propagation to prevent immediate close
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        const basin = basins[basinType];
        if (!basin) return;

        // Prevent opening if already editing
        if (basin.querySelector('.basin-inline-editor')) return;

        let editorHTML = '';

        switch (basinType) {
            case 'einkommen':
                editorHTML = `
                    <div class="basin-inline-editor">
                        <div class="basin-inline-label">Nettoeinkommen</div>
                        <input type="number"
                               class="basin-inline-input"
                               id="inline-income"
                               value="${inputs.income ? inputs.income.value : 3000}"
                               placeholder="3000"
                               inputmode="decimal"
                               step="100"
                               min="0"
                               max="1000000">
                        <div class="basin-inline-hint">Enter zum Speichern • Esc zum Abbrechen</div>
                        <div class="basin-inline-buttons">
                            <button class="basin-inline-btn" onclick="closeInlineEditor('${basinType}')">Abbrechen</button>
                            <button class="basin-inline-btn basin-inline-btn--primary" onclick="saveInlineEditor('${basinType}')">Speichern</button>
                        </div>
                    </div>
                `;
                break;

            case 'konsum':
                editorHTML = `
                    <div class="basin-inline-editor">
                        <div class="basin-inline-label">Konsumkonto</div>
                        <div class="basin-inline-grid">
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Mindestbestand</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-konsum-min"
                                       value="${inputs.konsumMin ? inputs.konsumMin.value : 100}"
                                       placeholder="100"
                                       inputmode="decimal"
                                       step="50"
                                       min="0">
                            </div>
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Überschuss</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-konsum-leftover"
                                       value="${inputs.konsumLeftover ? inputs.konsumLeftover.value : 250}"
                                       placeholder="250"
                                       inputmode="decimal"
                                       step="50"
                                       min="0">
                            </div>
                        </div>
                        <div class="basin-inline-hint">Enter zum Speichern • Esc zum Abbrechen</div>
                        <div class="basin-inline-buttons">
                            <button class="basin-inline-btn" onclick="closeInlineEditor('${basinType}')">Abbrechen</button>
                            <button class="basin-inline-btn basin-inline-btn--primary" onclick="saveInlineEditor('${basinType}')">Speichern</button>
                        </div>
                    </div>
                `;
                break;

            case 'tagesgeld':
                editorHTML = `
                    <div class="basin-inline-editor">
                        <div class="basin-inline-label">Tagesgeldkonto</div>
                        <div class="basin-inline-grid">
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Aktueller Stand</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-tagesgeld-current"
                                       value="${inputs.tagesgeldCurrent ? inputs.tagesgeldCurrent.value : 4800}"
                                       placeholder="4800"
                                       inputmode="decimal"
                                       step="100"
                                       min="0">
                            </div>
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Sparziel</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-tagesgeld-limit"
                                       value="${inputs.tagesgeldLimit ? inputs.tagesgeldLimit.value : 5000}"
                                       placeholder="5000"
                                       inputmode="decimal"
                                       step="100"
                                       min="0">
                            </div>
                        </div>

                        <!-- v1.6.3: Kriegskasse Info-Button -->
                        <button onclick="closeInlineEditor('${basinType}'); openKriegskasseModal();" class="mt-3 w-full px-3 py-2 bg-gradient-to-br from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-sm font-semibold rounded-md shadow-md transition-colors flex items-center justify-center gap-2" title="Warum ist eine Investitionsreserve wichtig?">
                            <span>Warum Tagesgeld?</span>
                        </button>

                        <div class="basin-inline-hint">Enter zum Speichern • Esc zum Abbrechen</div>
                        <div class="basin-inline-buttons">
                            <button class="basin-inline-btn" onclick="closeInlineEditor('${basinType}')">Abbrechen</button>
                            <button class="basin-inline-btn basin-inline-btn--primary" onclick="saveInlineEditor('${basinType}')">Speichern</button>
                        </div>
                    </div>
                `;
                break;
        }

        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'basin-inline-backdrop';
        backdrop.dataset.basinType = basinType;
        backdrop.addEventListener('click', () => closeInlineEditor(basinType));
        document.body.appendChild(backdrop);

        // Insert editor overlay into body (not basin)
        document.body.insertAdjacentHTML('beforeend', editorHTML);

        // Get editor element
        const editor = document.body.querySelector('.basin-inline-editor:last-child');
        if (!editor) return;

        // Store basin type on editor for cleanup
        editor.dataset.basinType = basinType;

        // Prevent clicks inside editor from closing it
        editor.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Focus first input
        const firstInput = editor.querySelector('.basin-inline-input');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }

        // Add keyboard handlers
        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveInlineEditor(basinType);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeInlineEditor(basinType);
            }
        });
    }

    /**
     * Validate and clamp numeric input to safe ranges
     */
    function validateAmount(value, min = 0, max = 1000000) {
        let num = parseFloat(value);
        if (!Number.isFinite(num)) return min;
        return Math.max(min, Math.min(max, num));
    }

    /**
     * Close inline editor without saving
     */
    function closeInlineEditor(basinType) {
        // Find editor and backdrop by data attribute
        const editor = document.querySelector(`.basin-inline-editor[data-basin-type="${basinType}"]`);
        const backdrop = document.querySelector(`.basin-inline-backdrop[data-basin-type="${basinType}"]`);

        if (editor) {
            editor.style.animation = 'smoothFadeOut 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards';
            setTimeout(() => editor.remove(), 250);
        }

        if (backdrop) {
            backdrop.style.animation = 'backdropFadeOut 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards';
            setTimeout(() => backdrop.remove(), 250);
        }
    }

    /**
     * Save inline editor values and update
     */
    function saveInlineEditor(basinType) {
        const basin = basins[basinType];
        if (!basin) return;

        switch (basinType) {
            case 'einkommen':
                const incomeInput = getEl('inline-income');
                if (incomeInput && inputs.income) {
                    inputs.income.value = validateAmount(incomeInput.value, 0, 1000000);
                }
                break;

            case 'konsum':
                const konsumMinInput = getEl('inline-konsum-min');
                const konsumLeftoverInput = getEl('inline-konsum-leftover');
                if (konsumMinInput && inputs.konsumMin) {
                    inputs.konsumMin.value = validateAmount(konsumMinInput.value, 0, 500000);
                }
                if (konsumLeftoverInput && inputs.konsumLeftover) {
                    inputs.konsumLeftover.value = validateAmount(konsumLeftoverInput.value, 0, 100000);
                }
                break;

            case 'tagesgeld':
                const tagesgeldCurrentInput = getEl('inline-tagesgeld-current');
                const tagesgeldLimitInput = getEl('inline-tagesgeld-limit');
                if (tagesgeldCurrentInput && inputs.tagesgeldCurrent) {
                    inputs.tagesgeldCurrent.value = validateAmount(tagesgeldCurrentInput.value, 0, 1000000);
                }
                if (tagesgeldLimitInput && inputs.tagesgeldLimit) {
                    inputs.tagesgeldLimit.value = validateAmount(tagesgeldLimitInput.value, 0, 1000000);
                }
                break;
        }

        // Close editor and recalculate
        closeInlineEditor(basinType);
        calculateAndUpdate();
    }

    // Add fadeOut animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeOutScale {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    `;
    document.head.appendChild(style);

    // ===== END INLINE EDITOR =====

    // ===== BOOKING MODAL (v1.4.0) =====

    /**
     * Open booking modal
     */
    function openBookingModal() {
        const modal = getEl('booking-modal');
        const modalBody = getEl('booking-modal-body');

        if (!modal || !modalBody) {
            console.error('❌ Modal or modalBody not found');
            return;
        }

        // Generate booking content directly in modal (v1.4.0: no sidebar)
        modalBody.innerHTML = `
            <div class="booking-section">
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px;">Buchungstyp wählen</h3>
                    <div class="booking-types" id="booking-type-buttons"></div>
                </div>
                <div class="booking-calendar" id="booking-calendar"></div>
                <div class="booking-hint" id="booking-hint" style="margin-top: 16px;"></div>
            </div>
        `;

        // Re-initialize booking planner with new modal elements
        setupBookingPlanner();

        // Show modal
        modal.classList.add('active');

        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    /**
     * Close booking modal
     */
    function closeBookingModal() {
        const modal = getEl('booking-modal');
        const modalBody = getEl('booking-modal-body');
        const bookingSection = getEl('sec-booking-plan');
        const sidebarContainer = document.querySelector('.panel-body'); // Original location

        if (!modal) return;

        // Move content back to sidebar (if needed for future use)
        if (bookingSection && sidebarContainer) {
            // Keep in modal for now, can be moved back if sidebar is restored
        }

        // Hide modal
        modal.classList.remove('active');

        // Restore body scroll
        document.body.style.overflow = '';
    }

    // ===== END BOOKING MODAL =====

    /**
     * Calculate all financial data (pure calculation, no rendering)
     * @returns {Object} All calculated financial values
     */
    function calculateFinancialData() {
        // Vermieterkonto-Daten holen
        const vermieterData = getVermieterkontoData();

        // Basiswerte
        const income = parseFloat(inputs.income?.value) || 0;
        const konsumMin = parseFloat(inputs.konsumMin?.value) || 0;
        const konsumLeftover = parseFloat(inputs.konsumLeftover?.value) || 0;
        const tagesgeldCurrent = parseFloat(inputs.tagesgeldCurrent?.value) || 0;
        const tagesgeldLimit = parseFloat(inputs.tagesgeldLimit?.value) || 0;

        // v1.5.2: Single-pass reduce for fixkostenItems (optimized from 2 filter passes)
        const { fixkostenTotal, depotTotal } = fixkostenItems.reduce((acc, item) => {
            const amount = getMonthlyAmount(item);
            if (item.target === 'fixkosten') {
                acc.fixkostenTotal += amount;
            } else if (item.target === 'depot') {
                acc.depotTotal += amount;
            }
            return acc;
        }, { fixkostenTotal: 0, depotTotal: 0 });

        let fixkostenOnlyTotal = fixkostenTotal;
        const depotSparplanTotal = depotTotal;

        // Vermieterkonto-Integration Variante A:
        // - Negativer Saldo: erhöht Fixkosten (Deckung)
        // - Positiver Saldo: reduziert Fixkosten (Miete senkt Abgänge)
        if (currentVariant === 'A') {
            if (vermieterData.saldo < 0) {
                fixkostenOnlyTotal += Math.abs(vermieterData.saldo);
            } else {
                fixkostenOnlyTotal = Math.max(0, fixkostenOnlyTotal - vermieterData.saldo);
            }
        } else {
            // Variante B: Negativer Saldo erhöht Fixkosten
            if (vermieterData.saldo < 0) {
                fixkostenOnlyTotal += Math.abs(vermieterData.saldo);
            }
        }

        const totalAbgang = fixkostenOnlyTotal + depotSparplanTotal;
        // Zufluss (Inflow) in das Konsumkonto zur Skalierung der Min-Linie
        const konsumInflow = (currentVariant === 'A')
          ? Math.max(0, income - totalAbgang)   // Variante A: nach Abzug aller Abgänge (Fix + Sparplan)
          : Math.max(0, income);                // Variante B: Einkommen geht direkt auf Konsum

        const { tagesgeldInflow, depotOverflow } = calculateOverflow(konsumLeftover, tagesgeldCurrent, tagesgeldLimit);
        const finalTagesgeld = tagesgeldCurrent + tagesgeldInflow;
        const totalDepotInflow = depotSparplanTotal + depotOverflow;

        let konsumValue;
        if(currentVariant === 'A') {
            konsumValue = income - totalAbgang;
        } else {
            // Variante B: Konsum wird bei positivem Vermieterkonto-Saldo erhöht
            konsumValue = income - totalAbgang;
            if (vermieterData.saldo > 0) {
                konsumValue += vermieterData.saldo;
            }
        }

        // Immobilien-Daten berechnen
        const gesamtwert = immobilienData.reduce((sum, immo) => sum + (immo.wert || 0), 0);
        const gesamtdarlehen = immobilienData.reduce((sum, immo) => sum + (immo.darlehen || 0), 0);
        const immoNettovermoegen = gesamtwert - gesamtdarlehen;
        const anzahlImmobilien = immobilienAnzahl;

        return {
            income,
            konsumMin,
            konsumLeftover,
            konsumInflow,
            konsumValue,
            tagesgeldCurrent,
            tagesgeldLimit,
            tagesgeldInflow,
            finalTagesgeld,
            fixkostenOnlyTotal,
            totalAbgang,
            depotSparplanTotal,
            depotOverflow,
            totalDepotInflow,
            vermieterData,
            gesamtwert,
            gesamtdarlehen,
            immoNettovermoegen,
            anzahlImmobilien
        };
    }

    /**
     * Render all basin elements with calculated data
     * @param {Object} data - Financial data from calculateFinancialData()
     */
    function renderAllBasins(data) {
        const {
            income,
            konsumMin,
            konsumLeftover,
            konsumInflow,
            konsumValue,
            finalTagesgeld,
            tagesgeldLimit,
            tagesgeldInflow,
            totalAbgang,
            vermieterData,
            gesamtwert,
            gesamtdarlehen,
            immoNettovermoegen,
            anzahlImmobilien
        } = data;

        renderBasin(basins.einkommen, 'Einkommen', formatCurrency(income), '<svg class="w-7 h-7 mb-1 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>');
        renderBasin(basins.fixkosten, 'Fixkostenkonto', formatCurrency(totalAbgang), '<svg class="w-7 h-7 mb-1 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', '(Klick zum Bearbeiten)');

        // Scale the yellow min line relative to the available monthly surplus (Überschuss).
        renderBasin(
            basins.konsum,
            'Konsumkonto',
            formatCurrency(konsumValue),
            '<svg class="w-7 h-7 mb-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>',
            `Überschuss: ${formatCurrency(konsumLeftover)}`,
            { current: konsumValue, min: konsumMin, limit: Infinity, minScaleBase: konsumInflow }
        );

        renderBasin(basins.tagesgeld, 'Tagesgeldkonto', formatCurrency(finalTagesgeld), '<svg class="w-7 h-7 mb-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>', `Zufluss: ${formatCurrency(tagesgeldInflow)}`, { current: finalTagesgeld, min: 0, limit: tagesgeldLimit });

        // Use custom renderDepotBasin instead of renderBasin for fund blocks visualization
        renderDepotBasin();

        // Vermieterkonto-Basin rendern
        renderBasin(
            basins.vermieterkonto,
            'Vermieterkonto',
            formatCurrency(vermieterData.saldo),
            '',
            `Ein: ${formatCurrency(vermieterData.einnahmen)} | Aus: ${formatCurrency(vermieterData.ausgaben)}`,
            {},
            createAccountSVG()
        );

        // Immobilien-Basin rendern (Equity Meter mit Fallback)
        try {
            if (gesamtwert > 0 || gesamtdarlehen > 0) {
                const eqPct = gesamtwert > 0 ? Math.max(0, Math.min(100, ((gesamtwert - gesamtdarlehen) / gesamtwert) * 100)) : 0;
                const nColor = immoNettovermoegen >= 0 ? '#13853E' : '#C1293D';
                const immoTitle = anzahlImmobilien > 1 ? '\u{1F3E0} ' + anzahlImmobilien + ' Immobilien' : '\u{1F3E0} Immobilie';
                basins.immobilien.innerHTML =
                    '<div class="relative z-10 flex flex-col items-center justify-center h-full w-full" style="padding:0 12px;">' +
                        '<p class="font-bold" style="font-size:14px;margin-bottom:4px;">' + immoTitle + '</p>' +
                        '<p class="font-mono font-bold" style="font-size:18px;color:' + nColor + ';">' + formatCurrency(immoNettovermoegen) + '</p>' +
                        '<p style="font-size:10px;color:#6b7280;margin-top:-2px;margin-bottom:4px;">Netto</p>' +
                        '<div style="width:100%;height:12px;border-radius:9999px;overflow:hidden;background:rgba(227,105,30,0.3);">' +
                            '<div style="height:100%;border-radius:9999px;width:' + eqPct + '%;background:#47A190;transition:width 0.5s;"></div>' +
                        '</div>' +
                        '<div style="display:flex;justify-content:space-between;width:100%;margin-top:4px;">' +
                            '<span style="font-size:10px;font-family:ui-monospace,monospace;color:#47A190;">' + formatCompact(gesamtwert) + '</span>' +
                            '<span style="font-size:10px;font-family:ui-monospace,monospace;color:#E3691E;">' + formatCompact(gesamtdarlehen) + '</span>' +
                        '</div>' +
                        '<div style="display:flex;justify-content:space-between;width:100%;">' +
                            '<span style="font-size:10px;color:#6b7280;">Wert</span>' +
                            '<span style="font-size:10px;color:#6b7280;">Darlehen</span>' +
                        '</div>' +
                    '</div>';
            } else {
                renderBasin(basins.immobilien, 'Immobilien', '', '', '(Klick zum Bearbeiten)', {}, createHouseSVG());
            }
        } catch (e) {
            console.error('Immobilien Basin render error:', e);
            renderBasin(basins.immobilien, 'Immobilien', formatCurrency(immoNettovermoegen), '', '', {}, createHouseSVG());
        }
    }

    /**
     * Update all flow visualizations based on calculated data
     * @param {Object} data - Financial data from calculateFinancialData()
     */
    function updateAllFlows(data) {
        const {
            income,
            konsumLeftover,
            totalAbgang,
            depotSparplanTotal,
            depotOverflow,
            vermieterData,
            finalTagesgeld,
            tagesgeldLimit
        } = data;

        const bothVisible = (a, b) => isVisible(a) && isVisible(b);

        // v1.5.2 FIX: Calculate actual maxFlow across all potential flows for proper scaling
        const maxFlow = Math.max(
            income || 0,
            Math.abs(income - totalAbgang) || 0,
            konsumLeftover || 0,
            depotSparplanTotal || 0,
            depotOverflow || 0,
            totalAbgang || 0,
            Math.abs(vermieterData?.saldo || 0),
            1 // Minimum to prevent division by zero
        );
        let show1 = false, show2 = false, showKTG = false, showTGDepot = false, showFixDepot = false;

        // === Flow visibility control (consultation-aware) ===
        if (currentVariant === 'A') {
                // A: Einkommen -> Fixkosten -> Konsum -> Tagesgeld -> Depot; Sparrate erst Step 5
                show1       = bothVisible(basins.einkommen,   basins.fixkosten);                                      // Step 1+
                show2       = bothVisible(basins.fixkosten, basins.konsum)   && (!consultationMode || consultationStep >= 2);
                showKTG     = bothVisible(basins.konsum,    basins.tagesgeld) && (!consultationMode || consultationStep >= 3);
                showTGDepot = bothVisible(basins.tagesgeld, basins.depot)     && (!consultationMode || consultationStep >= 4);
                showFixDepot= bothVisible(basins.fixkosten, basins.depot)     && (!consultationMode || (consultationMode && allowDepotStream === true)); // Step 5 in consultation

                if (show1)       drawFlow('flow-path-1', basins.einkommen,    basins.fixkosten, income, maxFlow);
                else             hideFlow('flow-path-1');

                if (show2)       drawFlow('flow-path-2', basins.fixkosten, basins.konsum, Math.max(0, income - totalAbgang), maxFlow, 'Dauerauftrag');
                else             hideFlow('flow-path-2');

                if (showKTG)     drawFlow('konsum-tagesgeld-flow', basins.konsum,    basins.tagesgeld, konsumLeftover, maxFlow);
                else             hideFlow('konsum-tagesgeld-flow');

                if (showTGDepot) drawFlow('tagesgeld-depot-flow', basins.tagesgeld,  basins.depot, depotOverflow, maxFlow);
                else             hideFlow('tagesgeld-depot-flow');

                if (showFixDepot)drawFlow('fixkosten-depot-flow', basins.fixkosten,  basins.depot, depotSparplanTotal, maxFlow, 'Sparrate');
                else             hideFlow('fixkosten-depot-flow');

            } else {
                // B: Einkommen -> Konsum -> Fixkosten -> Tagesgeld -> Depot; Sparrate erst Step 5
                show1       = bothVisible(basins.einkommen,   basins.konsum);                                        // Step 1+
                show2       = bothVisible(basins.konsum,   basins.fixkosten) && (!consultationMode || consultationStep >= 2);
                showKTG     = bothVisible(basins.konsum,   basins.tagesgeld) && (!consultationMode || consultationStep >= 3);
                showTGDepot = bothVisible(basins.tagesgeld,basins.depot)    && (!consultationMode || consultationStep >= 4);
                showFixDepot= bothVisible(basins.fixkosten,basins.depot)    && (!consultationMode || (consultationMode && allowDepotStream === true)); // Step 5 in consultation

                if (show1)       drawFlow('flow-path-1', basins.einkommen,  basins.konsum, income, maxFlow);
                else             hideFlow('flow-path-1');

                if (show2)       drawFlow('flow-path-2', basins.konsum,  basins.fixkosten, totalAbgang, maxFlow, 'Dauerauftrag');
                else             hideFlow('flow-path-2');

                if (showKTG)     drawFlow('konsum-tagesgeld-flow', basins.konsum,   basins.tagesgeld, konsumLeftover, maxFlow);
                else             hideFlow('konsum-tagesgeld-flow');

                if (showTGDepot) drawFlow('tagesgeld-depot-flow', basins.tagesgeld, basins.depot, depotOverflow, maxFlow);
                else             hideFlow('tagesgeld-depot-flow');

            if (showFixDepot)drawFlow('fixkosten-depot-flow', basins.fixkosten, basins.depot, depotSparplanTotal, maxFlow, 'Sparrate');
            else             hideFlow('fixkosten-depot-flow');
        }

        // === Vermieterkonto Flows ===
        const hasVermieterkontoCashflow = Math.abs(vermieterData.saldo) > 0;

        if (hasVermieterkontoCashflow) {
            if (vermieterData.saldo > 0) {
                // Positiv: Vermieterkonto → Fixkosten (Variante A) oder Konsum (Variante B)
                hideFlow('vermieterkonto-einkommen-flow');

                if (currentVariant === 'A') {
                    if (bothVisible(basins.vermieterkonto, basins.fixkosten)) {
                        drawFlow('fixkosten-vermieterkonto-flow', basins.vermieterkonto, basins.fixkosten, vermieterData.saldo, maxFlow, 'Miete', 0.3);
                    } else {
                        hideFlow('fixkosten-vermieterkonto-flow');
                    }
                } else {
                    if (bothVisible(basins.vermieterkonto, basins.konsum)) {
                        drawFlow('fixkosten-vermieterkonto-flow', basins.vermieterkonto, basins.konsum, vermieterData.saldo, maxFlow, 'Miete', 0.3);
                    } else {
                        hideFlow('fixkosten-vermieterkonto-flow');
                    }
                }
            } else {
                // Negativ: Fixkosten → Vermieterkonto (Deckung)
                hideFlow('vermieterkonto-einkommen-flow');
                if (bothVisible(basins.fixkosten, basins.vermieterkonto)) {
                    drawFlow('fixkosten-vermieterkonto-flow', basins.fixkosten, basins.vermieterkonto, Math.abs(vermieterData.saldo), maxFlow, 'Deckung', 1.0);
                    const deficitPath = getEl('fixkosten-vermieterkonto-flow');
                    if (deficitPath) deficitPath.style.filter = 'opacity(0.5)';
                } else {
                    hideFlow('fixkosten-vermieterkonto-flow');
                }
            }
        } else {
            hideFlow('vermieterkonto-einkommen-flow');
            hideFlow('fixkosten-vermieterkonto-flow');
        }

        // Visuelle Verbindung: Immobilien <-> Vermieterkonto
        const showImmoVermieterbindung = bothVisible(basins.immobilien, basins.vermieterkonto);
        if (showImmoVermieterbindung) {
            drawConnectionLine('immobilien-vermieterkonto-connection', basins.immobilien, basins.vermieterkonto);
        } else {
            hideFlow('immobilien-vermieterkonto-connection');
        }

        // Schutzschirm visualization
        drawSchutzschirm(basins.tagesgeld, basins.depot);
        const shield = getEl('schutzschirm-path');
        if (shield) {
            const liquidity = Math.max(0, finalTagesgeld);
            let strength = 0;
            if (isFinite(tagesgeldLimit) && tagesgeldLimit > 0) {
                strength = Math.min(1, liquidity / tagesgeldLimit);
            } else {
                strength = liquidity > 0 ? 1 : 0;
            }
            if (strength > 0) {
                const opacity = Math.max(0.25, 0.15 + 0.85 * strength);
                shield.style.opacity = String(opacity);
                shield.style.strokeWidth = `${2 + 2 * strength}px`;
            } else {
                shield.style.opacity = '0';
            }
        }

        // v1.6.1: Update Schutzschild Info-Badge
        updateSchutzschildBadge(finalTagesgeld, {
            vermieterkonto: vermieterData,
            depotSparplanTotal: depotSparplanTotal
        });
    }

    /**
     * Main update function - orchestrates calculation and rendering
     * v1.5.2: Refactored from monolithic calculateAndUpdate()
     */
    function calculateAndUpdate() {
        requestAnimationFrame(() => {
            positionCascade();

            // Safety: Check if all required basin elements exist
            if (!basins.einkommen || !basins.fixkosten || !basins.konsum ||
                !basins.tagesgeld || !basins.depot || !basins.vermieterkonto || !basins.immobilien) {
                console.error('[MLP ERROR] Basin elements not found. Cannot update visualization.');
                return;
            }

            // v1.5.2: Decomposed into three focused functions
            const data = calculateFinancialData();
            renderAllBasins(data);
            updateAllFlows(data);
        });
    }
    
    // --- Projection Logic ---
    function calculateProjection() {
        const initialDepot = parseFloat(inputs.depotCurrent.value) || 0;
        const years = parseInt(inputs.anlagezeitraum.value, 10);
        const depotSparplanTotal = fixkostenItems
            .filter(i => i.target === 'depot')
            .reduce((sum, i) => sum + getMonthlyAmount(i), 0);
        const tagesgeldCurrent = parseFloat(inputs.tagesgeldCurrent.value) || 0;
        const tagesgeldLimit = parseFloat(inputs.tagesgeldLimit.value) || 0;
        const konsumLeftover = parseFloat(inputs.konsumLeftover.value) || 0;
        const { depotOverflow } = calculateOverflow(konsumLeftover, tagesgeldCurrent, tagesgeldLimit);
        const monthlyInvestment = depotSparplanTotal + depotOverflow;

        const dataRangeRaw = (renditeExtremes && renditeExtremes[years]) || getRenditeDataForPeriod(years);
        const stats = dataRangeRaw ? (dataRangeRaw.mean === undefined ? buildRenditeStat(dataRangeRaw.min, dataRangeRaw.max) : dataRangeRaw) : null;

        const fallbackMin = stats ? stats.min : 0;
        const fallbackMax = stats ? stats.max : fallbackMin;
        const fallbackMean = stats ? stats.mean : (fallbackMin + fallbackMax) / 2;

        const selectedRendite = Number(inputs.rendite.value);
        const normalizedSelected = Number.isFinite(selectedRendite) ? clamp(selectedRendite, fallbackMin, fallbackMax) : fallbackMean;
        const returnAvg = normalizedSelected / 100;
        const returnMin = fallbackMin / 100;
        const returnMax = fallbackMax / 100;

        const dataAvg = calculateCompoundInterest(initialDepot, monthlyInvestment, years, returnAvg);
        const dataMin = calculateCompoundInterest(initialDepot, monthlyInvestment, years, returnMin);
        const dataMax = calculateCompoundInterest(initialDepot, monthlyInvestment, years, returnMax);

        displayProjectionChart({
            labels: dataAvg.labels,
            datasets: [
                { label: 'Pessimistisch', data: dataMin.capitalData, color: '#ef4444' },
                { label: 'Erwartet', data: dataAvg.capitalData, color: '#3b82f6' },
                { label: 'Optimistisch', data: dataMax.capitalData, color: '#22c55e' },
                { label: 'Einzahlungen', data: dataAvg.contributionsData, color: '#6b7280' }
            ]
        });
        const summaryEl = getEl('prognose-summary');
        if (summaryEl) {
            summaryEl.innerHTML = '<p>Nach <span class="font-bold">' + years + ' Jahren</span> könnte dein Vermögen zwischen <span class="font-bold" style="color: var(--mlp-error);">' + formatCurrency(dataMin.totalCapital) + '</span> und <span class="font-bold" style="color: var(--mlp-success);">' + formatCurrency(dataMax.totalCapital) + '</span> liegen.</p>' +
            '<p>Deine erwartete Prognose liegt bei <span class="font-bold text-lg" style="color: var(--mlp-primary);">' + formatCurrency(dataAvg.totalCapital) + '</span>, basierend auf ' + formatCurrency(dataAvg.totalContributions) + ' Einzahlungen.</p>';
        }
        // NICHT automatisch Modal öffnen (v1.4.0) - nur bei explizitem Button-Klick
    }

    // v1.4.0: Separate Funktion um Prognose zu berechnen UND Modal zu öffnen
    function showProjection() {
        calculateProjection();
        openModal('prognose-modal');
    }

    function calculateCompoundInterest(initial, monthly, years, annualRate) {
        const monthlyRate = annualRate / 12;
        let totalCapital = initial;
        let totalContributions = initial;
        const labels = ['Start'];
        const capitalData = [initial];
        const contributionsData = [initial];

        for (let i = 1; i <= years; i++) {
            for (let j = 0; j < 12; j++) {
                totalCapital = totalCapital * (1 + monthlyRate) + monthly;
                totalContributions += monthly;
            }
            labels.push(`Jahr ${i}`);
            capitalData.push(totalCapital);
            contributionsData.push(totalContributions);
        }
        return { labels, capitalData, contributionsData, totalCapital, totalContributions };
    }

    function displayProjectionChart({labels, datasets}) {
        const ctx = getEl('prognose-chart')?.getContext('2d');
        if (!ctx) {
            console.error('[MLP ERROR] Chart canvas not found');
            return;
        }

        // Safety: Check before destroying chart instance
        if (prognoseChartInstance) {
            prognoseChartInstance.destroy();
            prognoseChartInstance = null;
        }
        
        const chartDatasets = datasets.map(ds => {
            // Custom styling for pessimistic and optimistic
            if (ds.label === 'Pessimistisch') {
                return {
                    label: ds.label,
                    data: ds.data,
                    borderWidth: 1.5,                // dünner
                    borderColor: 'rgba(239,68,68,0.3)', // rot mit hoher Transparenz
                    borderDash: [6, 6],              // gestrichelt
                    pointRadius: 0,                  // keine Punkte
                    fill: false,
                    tension: 0.1
                };
            } else if (ds.label === 'Optimistisch') {
                return {
                    label: ds.label,
                    data: ds.data,
                    borderWidth: 1.5,                // dünner
                    borderColor: 'rgba(34,197,94,0.3)', // grün mit hoher Transparenz
                    borderDash: [6, 6],              // gestrichelt
                    pointRadius: 0,                  // keine Punkte
                    fill: false,
                    tension: 0.1
                };
            } else {
                // Erwartet (blue), Einzahlungen (gray dashed): unchanged
                return {
                    label: ds.label,
                    data: ds.data,
                    borderColor: ds.color,
                    borderDash: ds.label.includes('Einzahlungen') ? [5, 5] : [],
                    fill: false,
                    tension: 0.1
                };
            }
        });

        prognoseChartInstance = new Chart(ctx, {
            type: 'line', data: { labels: labels, datasets: chartDatasets },
            options: { responsive: true, plugins: { legend: { labels: { color: '#d1d5db' } }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatCurrency(c.raw)}` } } },
                scales: { x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: '#9ca3af', callback: (v) => formatCurrency(v) }, grid: { color: 'rgba(255,255,255,0.1)' } } }
            }
        });
    }

    // --- Other Helpers ---
    function setRendite(value) { inputs.rendite.value = value; }
    
    function getRenditeDataForPeriod(jahre) {
        const key = [1, 5, 10, 15, 20, 25, 30].reduce((prev, curr) => (Math.abs(curr - jahre) < Math.abs(prev - jahre) ? curr : prev));
        return renditeData[key];
    }

    function updateRenditeSuggestions(jahre) {
        let source = null;
        if (renditeExtremes && renditeExtremes[jahre]) {
            source = renditeExtremes[jahre];
        } else {
            source = getRenditeDataForPeriod(jahre);
        }
        if (!source) return;

        const stats = source.mean === undefined ? buildRenditeStat(source.min, source.max) : source;
        const infoEl = getEl('rendite-info');
        const mostLikely = roundToDecimal(stats.mean);

        // BUGFIX (PDF): NEVER overwrite user's input - only show suggestion
        // User must manually copy suggestion if they want it
        // Old behavior: inputs.rendite.value = mostLikely.toFixed(1); // ❌ REMOVED

        var colorStyle = function(v) { return v < 0 ? 'var(--mlp-error)' : (v < 3 ? 'var(--mlp-warning)' : 'var(--mlp-success)'); };
        var minSpan = '<span class="font-bold" style="color: ' + colorStyle(stats.min) + ';">' + stats.min + '%</span>';
        var maxSpan = '<span class="font-bold" style="color: ' + colorStyle(stats.max) + ';">' + stats.max + '%</span>';

        if (infoEl) {
            // Show suggestion with "empfohlen" hint, but don't auto-fill
            infoEl.innerHTML = 'Historische Spanne p.a.: ' + minSpan + ' bis ' + maxSpan + '<br><span class="font-bold" style="color: var(--mlp-primary);">Empfohlen (Normal): ' + mostLikely.toFixed(1) + '%</span>';
        }
    }

    function createGrowthChartSVG() { return `<svg viewBox="0 0 100 60" class="w-20 h-12 mb-1"><rect x="10" y="40" width="15" height="20" fill="#3b82f6" opacity="0.6"></rect><rect x="30" y="30" width="15" height="30" fill="#3b82f6" opacity="0.8"></rect><rect x="50" y="20" width="15" height="40" fill="#3b82f6"></rect><rect x="70" y="10" width="15" height="50" fill="#6366f1"></rect></svg>`; }

    // Häuschen-SVG für Immobilien-Basin (minimalistisches Design)
    function createHouseSVG() {
        return `<svg viewBox="0 0 100 100" class="w-16 h-16 mb-1">
            <!-- Dach -->
            <path d="M 10 50 L 50 20 L 90 50 Z" fill="#f59e0b" opacity="0.9"/>
            <!-- Haus -->
            <rect x="20" y="50" width="60" height="45" fill="#3b82f6" opacity="0.8"/>
            <!-- Tür -->
            <rect x="55" y="70" width="15" height="25" fill="#1e3a8a" opacity="0.9"/>
            <!-- Fenster links -->
            <rect x="30" y="60" width="12" height="12" fill="#fbbf24" opacity="0.7"/>
            <!-- Fenster rechts -->
            <rect x="58" y="60" width="12" height="12" fill="#fbbf24" opacity="0.7"/>
        </svg>`;
    }

    // SVG für Vermieterkonto (Verrechnungskonto-Icon)
    function createAccountSVG() {
        return `<svg viewBox="0 0 100 60" class="w-16 h-12 mb-1">
            <!-- Konto-Karte -->
            <rect x="10" y="15" width="80" height="30" rx="4" fill="#3b82f6" opacity="0.85" stroke="#60a5fa" stroke-width="2"/>
            <!-- Magnetstreifen -->
            <rect x="10" y="25" width="80" height="8" fill="#1e3a8a" opacity="0.9"/>
            <!-- Chip -->
            <rect x="20" y="35" width="12" height="10" rx="2" fill="#fbbf24" opacity="0.8"/>
            <!-- Flow-Pfeile (rein/raus) -->
            <path d="M 5 30 L 10 30" stroke="#10b981" stroke-width="2" opacity="0.7"/>
            <path d="M 90 30 L 95 30" stroke="#ef4444" stroke-width="2" opacity="0.7"/>
        </svg>`;
    }

    function calculateOverflow(inflow, current, limit) { if (limit <= 0) return { tagesgeldInflow: inflow, depotOverflow: 0 }; const potential = current + inflow; if (potential <= limit) return { tagesgeldInflow: inflow, depotOverflow: 0 }; const overflow = potential - limit; return { tagesgeldInflow: inflow - overflow, depotOverflow: overflow }; }
    const modalFocusableSelectors = 'a[href], area[href], button:not([disabled]), input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])';
    const modalFocusState = { activeModal: null, lastFocusedElement: null };

    function openModal(modalId) {
        const modal = getEl(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        console.log('Opening modal:', modalId);

        const activeElement = document.activeElement;
        modalFocusState.lastFocusedElement = (activeElement && typeof activeElement.focus === 'function') ? activeElement : null;

        modal.classList.add('modal-active');
        modal.removeAttribute('aria-hidden');
        modalFocusState.activeModal = modal;

        const mainRegion = getEl('main-content');
        if (mainRegion) mainRegion.setAttribute('aria-hidden', 'true');

        const focusable = getFocusableElements(modal);
        const focusTarget = modal.querySelector('[tabindex="-1"]') || focusable[0] || modal;
        window.requestAnimationFrame(() => {
            if (focusTarget && typeof focusTarget.focus === 'function') focusTarget.focus();
        });

        document.addEventListener('keydown', handleModalKeydown, true);
    }

    function closeModal(modalId) {
        const modal = getEl(modalId);
        if (!modal) return;

        modal.classList.remove('modal-active');
        modal.setAttribute('aria-hidden', 'true');

        if (modalFocusState.activeModal && modalFocusState.activeModal.id === modalId) {
            const mainRegion = getEl('main-content');
            if (mainRegion) mainRegion.removeAttribute('aria-hidden');

            document.removeEventListener('keydown', handleModalKeydown, true);
            modalFocusState.activeModal = null;

            const returnFocus = modalFocusState.lastFocusedElement;
            modalFocusState.lastFocusedElement = null;
            if (returnFocus && typeof returnFocus.focus === 'function') returnFocus.focus();
        }
    }

    function handleModalKeydown(event) {
        const modal = modalFocusState.activeModal;
        if (!modal) return;

        if (event.key === 'Escape') {
            event.preventDefault();
            closeModal(modal.id);
            return;
        }

        if (event.key !== 'Tab') return;

        const focusable = getFocusableElements(modal);
        if (!focusable.length) {
            event.preventDefault();
            const fallback = modal.querySelector('[tabindex="-1"]') || modal;
            if (fallback && typeof fallback.focus === 'function') fallback.focus();
            return;
        }

        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        const activeElement = document.activeElement;

        if (event.shiftKey) {
            if (activeElement === first) {
                event.preventDefault();
                last.focus();
            }
        } else if (activeElement === last) {
            event.preventDefault();
            first.focus();
        }
    }

    function getFocusableElements(modal) {
        return Array.from(modal.querySelectorAll(modalFocusableSelectors)).filter(isElementFocusable);
    }

    function isElementFocusable(el) {
        if (!el || el.hasAttribute('disabled')) return false;
        if (el.getAttribute('tabindex') === '-1') return false;
        if (el.getAttribute('aria-hidden') === 'true') return false;
        return isVisible(el);
    }

    // ===== v1.6.2: COST-AVERAGE-EFFEKT ERKLÄRER (REDESIGNED) =====

    // Kursdaten (aus Excel-Tool)
    const courseData = {
        A: [10.0, 13.0, 13.5, 16.0, 17.0, 16.0, 17.0, 16.5, 18.0, 18.9], // Stabil steigend
        B: [9.0, 10.0, 2.0, 5.0, 4.0, 6.0, 8.0, 4.0, 7.0, 11.0]  // Volatil schwankend mit CRASH (10 Jahre: J0-J9)
    };

    // v1.7.1: Default course data for reset functionality
    const defaultCourseData = {
        A: [10.0, 13.0, 13.5, 16.0, 17.0, 16.0, 17.0, 16.5, 18.0, 18.9],
        B: [9.0, 10.0, 2.0, 5.0, 4.0, 6.0, 8.0, 4.0, 7.0, 11.0]
    };

    let caChartA = null;
    let caChartB = null;
    let animationRunning = false;
    let currentMonth = 0; // Track current animation step
    let totalSharesA = 0;
    let totalSharesB = 0;
    let totalInvestedA = 0;
    let totalInvestedB = 0;

    // v1.7.1: Edit mode state
    let editModeEnabled = false;

    function openCostAverageModal() {
        // v1.7.2: Mark as visited for PDF inclusion
        markErklaererBesucht('costAverage');

        // Reset to Phase 1
        document.getElementById('ca-phase-1').style.display = 'block';
        document.getElementById('ca-phase-3').style.display = 'none';

        // Reset animation state
        currentMonth = 0;
        totalSharesA = 0;
        totalSharesB = 0;
        totalInvestedA = 0;
        totalInvestedB = 0;
        animationRunning = false;

        // Reset counters
        resetCounters();

        // Clear share bars
        document.getElementById('ca-share-bars-a').innerHTML = '';
        document.getElementById('ca-share-bars-b').innerHTML = '';

        // Initialize both charts
        initSideBySideCharts();

        // Add click handlers to boxes (instead of button)
        const boxA = document.getElementById('ca-box-a');
        const boxB = document.getElementById('ca-box-b');
        if (boxA) boxA.onclick = startCostAverageAnimation;
        if (boxB) boxB.onclick = startCostAverageAnimation;

        // Open modal
        openModal('cost-average-modal');
    }

    function closeCostAverageModal() {
        closeModal('cost-average-modal');
        // Destroy charts to free memory
        if (caChartA) { caChartA.destroy(); caChartA = null; }
        if (caChartB) { caChartB.destroy(); caChartB = null; }
    }

    function resetCounters() {
        ['a', 'b'].forEach(course => {
            document.getElementById(`ca-month-${course}`).textContent = '0 / 10';
            document.getElementById(`ca-invested-${course}`).textContent = '0 €';
            document.getElementById(`ca-shares-${course}`).textContent = '0';
        });
    }

    function initSideBySideCharts() {
        // Chart A (Stable)
        const ctxA = document.getElementById('ca-chart-a');
        if (ctxA) {
            if (caChartA) caChartA.destroy();

            caChartA = new Chart(ctxA, {
                type: 'line',
                data: {
                    labels: ['J1', 'J2', 'J3', 'J4', 'J5', 'J6', 'J7', 'J8', 'J9', 'J10'],
                    datasets: [{
                        label: 'Kurs A',
                        data: courseData.A,
                        borderColor: '#033D5D',
                        backgroundColor: 'rgba(3, 61, 93, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointRadius: editModeEnabled ? 8 : 4,
                        pointHoverRadius: editModeEnabled ? 10 : 6,
                        // v1.7.1: dragData plugin configuration
                        dragData: editModeEnabled
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Kurs: ${context.parsed.y.toFixed(2)} €`;
                                }
                            }
                        },
                        // v1.7.1: dragData plugin options
                        dragData: {
                            round: 2,
                            showTooltip: true,
                            dragX: false,
                            onDragStart: function(e, datasetIndex, index, value) {
                                // Show save button when drag starts
                                document.getElementById('save-course-btn').style.display = 'inline-block';
                            },
                            onDrag: function(e, datasetIndex, index, value) {
                                // Update courseData in real-time
                                courseData.A[index] = Math.max(0, Math.min(20, value));
                            },
                            onDragEnd: function(e, datasetIndex, index, value) {
                                // Clamp to 0-20 range
                                const clampedValue = Math.max(0, Math.min(20, value));
                                courseData.A[index] = clampedValue;
                                caChartA.data.datasets[0].data[index] = clampedValue;
                                caChartA.update();
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 20,
                            title: { display: true, text: 'Kurs in €' }
                        },
                        x: {
                            title: { display: true, text: 'Jahr' }
                        }
                    },
                    // v1.7.1: Change cursor when in edit mode
                    onHover: function(event, activeElements) {
                        event.native.target.style.cursor = editModeEnabled && activeElements.length ? 'grab' : 'pointer';
                    }
                }
            });
        }

        // Chart B (Volatile)
        const ctxB = document.getElementById('ca-chart-b');
        if (ctxB) {
            if (caChartB) caChartB.destroy();

            caChartB = new Chart(ctxB, {
                type: 'line',
                data: {
                    labels: ['J1', 'J2', 'J3', 'J4', 'J5', 'J6', 'J7', 'J8', 'J9', 'J10'],
                    datasets: [{
                        label: 'Kurs B',
                        data: courseData.B,
                        borderColor: '#C1293D',
                        backgroundColor: 'rgba(193, 41, 61, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointRadius: editModeEnabled ? 8 : 4,
                        pointHoverRadius: editModeEnabled ? 10 : 6,
                        // v1.7.1: dragData plugin configuration
                        dragData: editModeEnabled
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Kurs: ${context.parsed.y.toFixed(2)} €`;
                                }
                            }
                        },
                        // v1.7.1: dragData plugin options
                        dragData: {
                            round: 2,
                            showTooltip: true,
                            dragX: false,
                            onDragStart: function(e, datasetIndex, index, value) {
                                // Show save button when drag starts
                                document.getElementById('save-course-btn').style.display = 'inline-block';
                            },
                            onDrag: function(e, datasetIndex, index, value) {
                                // Update courseData in real-time
                                courseData.B[index] = Math.max(0, Math.min(20, value));
                            },
                            onDragEnd: function(e, datasetIndex, index, value) {
                                // Clamp to 0-20 range
                                const clampedValue = Math.max(0, Math.min(20, value));
                                courseData.B[index] = clampedValue;
                                caChartB.data.datasets[0].data[index] = clampedValue;
                                caChartB.update();
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 20,
                            title: { display: true, text: 'Kurs in €' }
                        },
                        x: {
                            title: { display: true, text: 'Jahr' }
                        }
                    },
                    // v1.7.1: Change cursor when in edit mode
                    onHover: function(event, activeElements) {
                        event.native.target.style.cursor = editModeEnabled && activeElements.length ? 'grab' : 'pointer';
                    }
                }
            });
        }
    }

    function startCostAverageAnimation() {
        // NEW: Click-by-click animation instead of automatic
        if (currentMonth >= 10) {
            // All months done, show results
            document.getElementById('ca-phase-1').style.display = 'none';
            document.getElementById('ca-phase-3').style.display = 'block';
            showResults();
            return;
        }

        currentMonth++;
        animateNextMonth(currentMonth);

        // Update button text
        const btn = document.getElementById('ca-start-btn');
        if (currentMonth < 10) {
            btn.textContent = `▶ Monat ${currentMonth + 1} starten`;
        } else {
            btn.textContent = '✅ Ergebnis anzeigen';
        }
    }

    function animateNextMonth(month) {
        const monthlyRate = 1200;

        // Course A
        const priceA = courseData.A[month - 1];
        const sharesBoughtA = monthlyRate / priceA;
        totalInvestedA += monthlyRate;
        totalSharesA += sharesBoughtA;

        // Course B
        const priceB = courseData.B[month - 1];
        const sharesBoughtB = monthlyRate / priceB;
        totalInvestedB += monthlyRate;
        totalSharesB += sharesBoughtB;

        // Update counters
        document.getElementById('ca-month-a').textContent = `${month} / 10`;
        document.getElementById('ca-invested-a').textContent = `${totalInvestedA.toLocaleString('de-DE')} €`;
        document.getElementById('ca-shares-a').textContent = totalSharesA.toFixed(0);

        document.getElementById('ca-month-b').textContent = `${month} / 10`;
        document.getElementById('ca-invested-b').textContent = `${totalInvestedB.toLocaleString('de-DE')} €`;
        document.getElementById('ca-shares-b').textContent = totalSharesB.toFixed(0);

        // Update share bars (fixed positions, not scrolling)
        updateShareBar('a', month, priceA, sharesBoughtA);
        updateShareBar('b', month, priceB, sharesBoughtB, month === 2); // Highlight crash month

        // Highlight current month in charts
        highlightMonthInCharts(month);
    }

    function updateShareBar(course, month, price, shares, isCrash = false) {
        const container = document.getElementById(`ca-share-bars-${course}`);
        if (!container) return;

        // Check if bar for this month already exists
        let bar = container.querySelector(`[data-month="${month}"]`);
        if (!bar) {
            // Create placeholder bars for all 10 years on first call
            if (container.children.length === 0) {
                for (let m = 1; m <= 10; m++) {
                    const placeholderBar = document.createElement('div');
                    placeholderBar.setAttribute('data-month', m);
                    placeholderBar.className = 'flex items-center gap-2 text-sm';
                    placeholderBar.style.opacity = '0.3';
                    placeholderBar.style.minHeight = '32px';

                    const color = course === 'a' ? '#033D5D' : '#C1293D';
                    placeholderBar.innerHTML = `
                        <span class="text-gray-400 w-16">J${m}:</span>
                        <div class="flex-1 bg-gray-100 rounded-full h-6"></div>
                        <span class="w-24 text-right text-gray-400">— 🛒</span>
                    `;
                    container.appendChild(placeholderBar);
                }
            }
            bar = container.querySelector(`[data-month="${month}"]`);
        }

        // Calculate bar width (relative to max possible shares ~600)
        const maxWidth = 100;
        const barWidth = Math.min((shares / 600) * maxWidth, maxWidth);

        const color = course === 'a' ? '#033D5D' : '#C1293D';

        // Update bar with actual data
        bar.style.opacity = '1';
        bar.style.minHeight = '32px';

        // Update bar HTML (NO crash background, just emoji highlight)
        bar.innerHTML = `
            <span class="text-gray-600 w-16">J${month}:</span>
            <div class="flex-1 bg-gray-200 rounded-full h-6 relative overflow-hidden">
                <div style="width: ${barWidth}%; background: ${color}; height: 100%; border-radius: 9999px; transition: width 0.5s ease;"></div>
            </div>
            <span class="w-24 text-right font-bold" style="color: ${color};">${shares.toFixed(0)} 🛒</span>
            ${isCrash ? '<span class="text-lg">💥</span>' : ''}
        `;
    }

    function highlightMonthInCharts(month) {
        // Highlight current month point in both charts
        if (caChartA && caChartA.data.datasets[0]) {
            // Reset all point radii
            caChartA.data.datasets[0].pointRadius = new Array(10).fill(4);
            caChartA.data.datasets[0].pointBackgroundColor = new Array(10).fill('#033D5D');

            // Highlight current month
            caChartA.data.datasets[0].pointRadius[month - 1] = 10;
            caChartA.data.datasets[0].pointBackgroundColor[month - 1] = '#47A190';
            caChartA.update();
        }

        if (caChartB && caChartB.data.datasets[0]) {
            // Reset all point radii
            caChartB.data.datasets[0].pointRadius = new Array(10).fill(4);
            caChartB.data.datasets[0].pointBackgroundColor = new Array(10).fill('#C1293D');

            // Highlight current month (extra emphasis on crash month)
            caChartB.data.datasets[0].pointRadius[month - 1] = month === 2 ? 12 : 10;
            caChartB.data.datasets[0].pointBackgroundColor[month - 1] = month === 2 ? '#E3691E' : '#47A190';
            caChartB.update();
        }
    }

    function showResults() {
        // Calculate results for both courses
        const results = {};
        ['A', 'B'].forEach(course => {
            const monthlyRate = 1200;
            const courseValues = courseData[course];
            const finalPrice = courseValues[courseValues.length - 1];
            let totalShares = 0;

            courseValues.forEach(price => {
                totalShares += monthlyRate / price;
            });

            const totalInvested = 12000;
            const endValue = totalShares * finalPrice;
            const profit = endValue - totalInvested;
            const returnPercent = ((profit / totalInvested) * 100).toFixed(1);

            results[course] = {
                shares: totalShares.toFixed(2),
                endPrice: finalPrice.toFixed(2),
                endValue: endValue.toFixed(2),
                profit: profit.toFixed(2),
                returnPercent
            };
        });

        // Update HTML
        document.getElementById('ca-result-shares-a').textContent = results.A.shares;
        document.getElementById('ca-result-endprice-a').textContent = `${results.A.endPrice} €`;
        document.getElementById('ca-result-value-a').textContent = `${parseFloat(results.A.endValue).toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €`;
        document.getElementById('ca-result-profit-a').textContent = `${parseFloat(results.A.profit).toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €`;
        document.getElementById('ca-result-return-a').textContent = `${results.A.returnPercent}%`;

        document.getElementById('ca-result-shares-b').textContent = results.B.shares;
        document.getElementById('ca-result-endprice-b').textContent = `${results.B.endPrice} €`;
        document.getElementById('ca-result-value-b').textContent = `${parseFloat(results.B.endValue).toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €`;
        document.getElementById('ca-result-profit-b').textContent = `${parseFloat(results.B.profit).toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €`;
        document.getElementById('ca-result-return-b').textContent = `${results.B.returnPercent}%`;
    }

    // ===== v1.7.1: EDIT MODE FUNCTIONS =====

    function toggleEditMode() {
        editModeEnabled = !editModeEnabled;

        const toggleBtn = document.getElementById('edit-mode-toggle-btn');
        const saveBtn = document.getElementById('save-course-btn');
        const hint = document.getElementById('edit-mode-hint');

        if (editModeEnabled) {
            // Enable edit mode
            toggleBtn.textContent = '🔒 Bearbeitung beenden';
            toggleBtn.style.background = '#ef4444'; // red
            hint.style.display = 'inline';

            // Reinit charts with drag enabled
            initSideBySideCharts();
        } else {
            // Disable edit mode
            toggleBtn.textContent = '📝 Bearbeitungsmodus';
            toggleBtn.style.background = 'var(--mlp-corporate-blue)';
            hint.style.display = 'none';
            saveBtn.style.display = 'none';

            // Reinit charts with drag disabled
            initSideBySideCharts();
        }
    }

    function saveCourseData() {
        // Validate all values are within range
        const validateRange = (arr) => arr.every(v => v >= 0 && v <= 20);

        if (!validateRange(courseData.A) || !validateRange(courseData.B)) {
            alert('Fehler: Alle Kurswerte müssen zwischen 0€ und 20€ liegen!');
            return;
        }

        // Reset animation to start fresh with new data
        currentMonth = 0;
        totalSharesA = 0;
        totalSharesB = 0;
        totalInvestedA = 0;
        totalInvestedB = 0;
        animationRunning = false;

        // Clear share bars
        document.getElementById('ca-share-bars-a').innerHTML = '';
        document.getElementById('ca-share-bars-b').innerHTML = '';

        // Reset counters
        resetCounters();

        // Reinit charts with new data
        initSideBySideCharts();

        // Hide save button
        document.getElementById('save-course-btn').style.display = 'none';

        // Show success message
        alert('✅ Kursverlauf gespeichert! Animation wurde zurückgesetzt.');

        console.log('📊 Course data saved:', {
            A: courseData.A,
            B: courseData.B
        });
    }

    function resetToDefaultCourse() {
        if (!confirm('Möchten Sie die Kursverläufe wirklich zurücksetzen?')) {
            return;
        }

        // Reset to default values
        courseData.A = [...defaultCourseData.A];
        courseData.B = [...defaultCourseData.B];

        // Reset animation
        currentMonth = 0;
        totalSharesA = 0;
        totalSharesB = 0;
        totalInvestedA = 0;
        totalInvestedB = 0;
        animationRunning = false;

        // Clear share bars
        document.getElementById('ca-share-bars-a').innerHTML = '';
        document.getElementById('ca-share-bars-b').innerHTML = '';

        // Reset counters
        resetCounters();

        // Reinit charts
        initSideBySideCharts();

        // Hide save button
        document.getElementById('save-course-btn').style.display = 'none';

        alert('✅ Kursverläufe wurden zurückgesetzt!');

        console.log('🔄 Course data reset to defaults');
    }

    // ===== END v1.7.1: EDIT MODE FUNCTIONS =====

    // ===== END COST-AVERAGE-EFFEKT ERKLÄRER =====

    // ===== v1.6.3: KRIEGSKASSE (INVESTITIONSRESERVE) ERKLÄRER =====

    // Market data: Reuse courseData.B (volatile with crash)
    // Year progression: [10, 2, 4, 6.5, 8, 10.5, 9, 11, 10, 10.5]
    // Crash at year 2: 10 → 2 (-80%), then recovery

    let kriegskasseChart = null;
    let kriegskasseCurrentYear = 0;
    let kriegskasseAnimRunning = false;
    let kriegskasseInflowEnabled = true; // Toggle for 6k/year inflow

    // Scenario A: WITHOUT Tagesgeld (panic sell + late re-entry) - All 40k in market
    let scenarioA = {
        portfolio: 40000, // All 40k invested (no reserve)
        tagesgeld: 0,     // No Tagesgeld reserve
        soldAt: null,     // Price when sold
        reentryAt: null,  // Price when re-entered
        cashFromSale: 0,  // Cash after panic sell
        timeline: []
    };

    // Scenario B: WITH Tagesgeld (hold through) - 10k market + 30k reserve
    let scenarioB = {
        portfolio: 10000,
        tagesgeld: 30000,
        tagesgeldInflow: 6000,  // 500€/month = 6000€/year
        timeline: []
    };

    // Scenario C: WITH Tagesgeld + Active buying in crash - 10k market + 30k reserve
    let scenarioC = {
        portfolio: 10000,       // Initial portfolio
        tagesgeld: 30000,       // Tagesgeld reserve
        tagesgeldInflow: 6000,  // 500€/month = 6000€/year
        boughtInCrash: false,   // Track if already bought
        crashBuyAmount: 0,      // Amount bought in crash
        timeline: []
    };

    function openKriegskasseModal() {
        // Reset to Phase 1
        document.getElementById('kriegskasse-phase-1').style.display = 'block';
        document.getElementById('kriegskasse-phase-2').style.display = 'none';

        // Reset animation state
        kriegskasseCurrentYear = 0;
        kriegskasseAnimRunning = false;

        // Reset scenarios
        scenarioA = {
            portfolio: 40000,
            tagesgeld: 0,
            soldAt: null,
            reentryAt: null,
            cashFromSale: 0,
            timeline: []
        };
        scenarioB = {
            portfolio: 10000,
            tagesgeld: 30000,
            tagesgeldInflow: 6000,
            timeline: []
        };
        scenarioC = {
            portfolio: 10000,
            tagesgeld: 30000,
            tagesgeldInflow: 6000,
            boughtInCrash: false,
            crashBuyAmount: 0,
            timeline: []
        };

        // Reset counters
        document.getElementById('kriegskasse-year-a').textContent = '0 / 9';
        document.getElementById('kriegskasse-year-b').textContent = '0 / 9';
        document.getElementById('kriegskasse-year-c').textContent = '0 / 9';

        // Clear timelines
        document.getElementById('kriegskasse-timeline-a').innerHTML = '<div class="text-xs text-gray-500">Klick zum Start...</div>';
        document.getElementById('kriegskasse-timeline-b').innerHTML = '<div class="text-xs text-gray-500">Klick zum Start...</div>';
        document.getElementById('kriegskasse-timeline-c').innerHTML = '<div class="text-xs text-gray-500">Klick zum Start...</div>';

        // Initialize all three charts
        initKriegskasseCharts();

        // Add click handlers to boxes
        const boxA = document.getElementById('kriegskasse-box-a');
        const boxB = document.getElementById('kriegskasse-box-b');
        const boxC = document.getElementById('kriegskasse-box-c');
        if (boxA) boxA.onclick = startKriegskasseAnimation;
        if (boxB) boxB.onclick = startKriegskasseAnimation;
        if (boxC) boxC.onclick = startKriegskasseAnimation;

        // Add toggle handler (remove old one first to prevent duplicates)
        const inflowToggle = document.getElementById('kriegskasse-inflow-toggle');
        if (inflowToggle) {
            // Remove any existing listener by cloning and replacing the element
            const newToggle = inflowToggle.cloneNode(true);
            inflowToggle.parentNode.replaceChild(newToggle, inflowToggle);

            newToggle.addEventListener('change', function() {
                kriegskasseInflowEnabled = this.checked;
                // Reset animation when toggled
                resetKriegskasseAnimation();
            });
        }

        // Open modal
        openModal('kriegskasse-modal');
    }

    function resetKriegskasseAnimation() {
        // Reset to initial state
        kriegskasseCurrentYear = 0;
        kriegskasseAnimRunning = false;

        // Reset scenarios
        scenarioA = {
            portfolio: 40000,
            tagesgeld: 0,
            soldAt: null,
            reentryAt: null,
            cashFromSale: 0,
            timeline: []
        };
        scenarioB = {
            portfolio: 10000,
            tagesgeld: 30000,
            tagesgeldInflow: kriegskasseInflowEnabled ? 6000 : 0,
            timeline: []
        };
        scenarioC = {
            portfolio: 10000,
            tagesgeld: 30000,
            tagesgeldInflow: kriegskasseInflowEnabled ? 6000 : 0,
            boughtInCrash: false,
            crashBuyAmount: 0,
            timeline: []
        };

        // Reset counters
        document.getElementById('kriegskasse-year-a').textContent = '0 / 9';
        document.getElementById('kriegskasse-year-b').textContent = '0 / 9';
        document.getElementById('kriegskasse-year-c').textContent = '0 / 9';

        // Clear timelines
        document.getElementById('kriegskasse-timeline-a').innerHTML = '<div class="text-xs text-gray-500">Klick zum Start...</div>';
        document.getElementById('kriegskasse-timeline-b').innerHTML = '<div class="text-xs text-gray-500">Klick zum Start...</div>';
        document.getElementById('kriegskasse-timeline-c').innerHTML = '<div class="text-xs text-gray-500">Klick zum Start...</div>';

        // Reinitialize chart
        initKriegskasseCharts();
    }

    function closeKriegskasseModal() {
        closeModal('kriegskasse-modal');
        // Destroy chart to free memory
        if (kriegskasseChart) { kriegskasseChart.destroy(); kriegskasseChart = null; }
    }

    function initKriegskasseCharts() {
        const ctx = document.getElementById('kriegskasse-chart-combined');
        if (ctx) {
            if (kriegskasseChart) kriegskasseChart.destroy();

            kriegskasseChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['J0', 'J1', 'J2', 'J3', 'J4', 'J5', 'J6', 'J7', 'J8', 'J9'],
                    datasets: [
                        {
                            label: 'Kursverlauf (Markt)',
                            data: [...courseData.B], // v1.7.1: Use dynamic courseData.B
                            borderColor: 'rgba(200, 200, 200, 0.5)',
                            backgroundColor: 'rgba(220, 220, 220, 0.15)',
                            tension: 0.3,
                            pointRadius: 3,
                            pointBackgroundColor: 'rgba(150, 150, 150, 0.6)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: true,
                            yAxisID: 'y2',
                            order: 10
                        },
                        {
                            label: 'Ohne Reserve (Panikverkauf)',
                            data: [40000, null, null, null, null, null, null, null, null, null],
                            borderColor: '#C1293D',
                            backgroundColor: 'rgba(193, 41, 61, 0.1)',
                            tension: 0.3,
                            pointRadius: Array(10).fill(5),
                            pointBackgroundColor: Array(10).fill('#C1293D'),
                            borderWidth: 3,
                            fill: false,
                            order: 1
                        },
                        {
                            label: 'Mit Reserve (Durchhalten)',
                            data: [40000, null, null, null, null, null, null, null, null, null],
                            borderColor: '#033D5D',
                            backgroundColor: 'rgba(3, 61, 93, 0.1)',
                            tension: 0.3,
                            pointRadius: Array(10).fill(5),
                            pointBackgroundColor: Array(10).fill('#033D5D'),
                            borderWidth: 3,
                            fill: false,
                            order: 2
                        },
                        {
                            label: 'Mit Reserve + Nachkauf',
                            data: [40000, null, null, null, null, null, null, null, null, null],
                            borderColor: '#A6A8AB',
                            backgroundColor: 'rgba(166, 168, 171, 0.1)',
                            tension: 0.3,
                            pointRadius: Array(10).fill(5),
                            pointBackgroundColor: Array(10).fill('#A6A8AB'),
                            borderWidth: 3,
                            fill: false,
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 13, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 0) {
                                            // Kursverlauf: Show as unit price
                                            label += context.parsed.y.toFixed(1) + ' € (Kurs)';
                                        } else {
                                            // Portfolio values
                                            label += context.parsed.y.toFixed(0) + ' €';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Jahr',
                                font: { size: 14, weight: 'bold' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Gesamtvermögen (€)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            max: 150000,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('de-DE') + ' €';
                                }
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Kursverlauf (€)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            max: 12,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + ' €';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }
    }

    function startKriegskasseAnimation() {
        if (kriegskasseCurrentYear > 9) {
            // Animation done, show results
            document.getElementById('kriegskasse-phase-1').style.display = 'none';
            document.getElementById('kriegskasse-phase-2').style.display = 'block';
            showKriegskasseResults();
            return;
        }

        animateKriegskasseYear(kriegskasseCurrentYear);

        // Update year counters
        document.getElementById('kriegskasse-year-a').textContent = `${kriegskasseCurrentYear} / 9`;
        document.getElementById('kriegskasse-year-b').textContent = `${kriegskasseCurrentYear} / 9`;
        document.getElementById('kriegskasse-year-c').textContent = `${kriegskasseCurrentYear} / 9`;

        kriegskasseCurrentYear++;
    }

    function animateKriegskasseYear(year) {
        const marketPrices = courseData.B; // [9, 10, 2, 5, 4, 6, 8, 4, 7, 9]
        const currentPrice = marketPrices[year];
        const initialPrice = marketPrices[0]; // 9

        // === SCENARIO A: WITHOUT Tagesgeld (All 40k in market, panic sell) ===
        let portfolioValueA = 0;
        let totalWealthA = 0;
        let eventTextA = '';

        if (year === 0) {
            // Year 0: 40k invested, 4444 shares @ 9€
            scenarioA.shares = scenarioA.portfolio / initialPrice;
            portfolioValueA = scenarioA.shares * currentPrice;
            totalWealthA = portfolioValueA + scenarioA.tagesgeld;
            eventTextA = `📊 Jahr ${year}: Start - Alles investiert: ${totalWealthA.toFixed(0)} €`;
            scenarioA.timeline.push(eventTextA);
        } else if (year === 1) {
            portfolioValueA = scenarioA.shares * currentPrice;
            totalWealthA = portfolioValueA + scenarioA.tagesgeld;
            eventTextA = `📊 Jahr ${year}: Markt bei ${currentPrice} € → ${totalWealthA.toFixed(0)} €`;
            scenarioA.timeline.push(eventTextA);
        } else if (year === 2) {
            // CRASH! Panic sell
            scenarioA.soldAt = currentPrice;
            scenarioA.cashFromSale = scenarioA.shares * currentPrice;
            scenarioA.shares = 0;
            totalWealthA = scenarioA.cashFromSale;
            eventTextA = `💥 Jahr ${year}: CRASH! Panik-Verkauf bei ${currentPrice} € → ${totalWealthA.toFixed(0)} € Cash`;
            scenarioA.timeline.push(eventTextA);
        } else if (year >= 3 && year <= 5) {
            totalWealthA = scenarioA.cashFromSale;
            eventTextA = `⏸️ Jahr ${year}: Außerhalb Markt → ${totalWealthA.toFixed(0)} € Cash`;
            scenarioA.timeline.push(eventTextA);
        } else if (year === 6) {
            // Re-entry too late
            scenarioA.reentryAt = currentPrice;
            scenarioA.shares = scenarioA.cashFromSale / currentPrice;
            portfolioValueA = scenarioA.shares * currentPrice;
            totalWealthA = portfolioValueA;
            eventTextA = `🔄 Jahr ${year}: Wiedereinstieg bei ${currentPrice} € (zu spät!)`;
            scenarioA.timeline.push(eventTextA);
        } else {
            portfolioValueA = scenarioA.shares * currentPrice;
            totalWealthA = portfolioValueA;
            eventTextA = `📈 Jahr ${year}: Markt ${currentPrice} € → ${totalWealthA.toFixed(0)} €`;
            scenarioA.timeline.push(eventTextA);
        }

        // === SCENARIO B: WITH Tagesgeld (10k market + 30k reserve, hold through) ===
        let portfolioValueB = 0;
        let totalWealthB = 0;
        let eventTextB = '';

        if (year === 0) {
            scenarioB.shares = scenarioB.portfolio / initialPrice;
            portfolioValueB = scenarioB.shares * currentPrice;
            totalWealthB = portfolioValueB + scenarioB.tagesgeld;
            eventTextB = `📊 Jahr ${year}: Start - Depot: ${portfolioValueB.toFixed(0)} € | TG: ${scenarioB.tagesgeld.toFixed(0)} €`;
        } else {
            // Add yearly inflow to Tagesgeld
            scenarioB.tagesgeld += scenarioB.tagesgeldInflow;

            // Check for overflow (> 30k)
            if (scenarioB.tagesgeld > 30000) {
                const overflow = scenarioB.tagesgeld - 30000;
                scenarioB.tagesgeld = 30000;
                // Buy shares with overflow
                const newShares = overflow / currentPrice;
                scenarioB.shares += newShares;
            }

            portfolioValueB = scenarioB.shares * currentPrice;
            totalWealthB = portfolioValueB + scenarioB.tagesgeld;

            if (year === 1) {
                eventTextB = `📊 Jahr ${year}: +6k TG → Depot: ${portfolioValueB.toFixed(0)} € | TG: ${scenarioB.tagesgeld.toFixed(0)} €`;
            } else if (year === 2) {
                eventTextB = `💥 Jahr ${year}: CRASH auf ${currentPrice} € - DURCHGEHALTEN! 🛡️`;
            } else {
                eventTextB = `📈 Jahr ${year}: Depot: ${portfolioValueB.toFixed(0)} € | TG: ${scenarioB.tagesgeld.toFixed(0)} € | Σ: ${totalWealthB.toFixed(0)} €`;
            }
        }
        scenarioB.timeline.push(eventTextB);

        // === SCENARIO C: WITH Tagesgeld + Active crash buying ===
        let portfolioValueC = 0;
        let totalWealthC = 0;
        let eventTextC = '';

        if (year === 0) {
            scenarioC.shares = scenarioC.portfolio / initialPrice;
            portfolioValueC = scenarioC.shares * currentPrice;
            totalWealthC = portfolioValueC + scenarioC.tagesgeld;
            eventTextC = `📊 Jahr ${year}: Start - Depot: ${portfolioValueC.toFixed(0)} € | TG: ${scenarioC.tagesgeld.toFixed(0)} €`;
        } else if (year === 1) {
            scenarioC.tagesgeld += scenarioC.tagesgeldInflow;
            if (scenarioC.tagesgeld > 30000) {
                const overflow = scenarioC.tagesgeld - 30000;
                scenarioC.tagesgeld = 30000;
                scenarioC.shares += overflow / currentPrice;
            }
            portfolioValueC = scenarioC.shares * currentPrice;
            totalWealthC = portfolioValueC + scenarioC.tagesgeld;
            eventTextC = `📊 Jahr ${year}: +6k TG → Depot: ${portfolioValueC.toFixed(0)} € | TG: ${scenarioC.tagesgeld.toFixed(0)} €`;
        } else if (year === 2) {
            // CRASH! Buy 12k from Tagesgeld
            if (!scenarioC.boughtInCrash) {
                scenarioC.crashBuyAmount = 12000;
                const boughtShares = scenarioC.crashBuyAmount / currentPrice;
                scenarioC.shares += boughtShares;
                scenarioC.tagesgeld -= scenarioC.crashBuyAmount;
                scenarioC.boughtInCrash = true;
                portfolioValueC = scenarioC.shares * currentPrice;
                totalWealthC = portfolioValueC + scenarioC.tagesgeld;
                eventTextC = `🚀 Jahr ${year}: CRASH! Nachkauf 12k bei ${currentPrice} € = ${boughtShares.toFixed(0)} Anteile!`;
            }
        } else if (year >= 3 && year <= 4) {
            // Refill Tagesgeld
            scenarioC.tagesgeld += scenarioC.tagesgeldInflow;
            portfolioValueC = scenarioC.shares * currentPrice;
            totalWealthC = portfolioValueC + scenarioC.tagesgeld;
            eventTextC = `💰 Jahr ${year}: TG auffüllen → TG: ${scenarioC.tagesgeld.toFixed(0)} € | Depot: ${portfolioValueC.toFixed(0)} €`;
        } else if (year === 5 || year === 6) {
            // Year 5-6: Normal with overflow
            scenarioC.tagesgeld += scenarioC.tagesgeldInflow;
            if (scenarioC.tagesgeld > 30000) {
                const overflow = scenarioC.tagesgeld - 30000;
                scenarioC.tagesgeld = 30000;
                scenarioC.shares += overflow / currentPrice;
            }
            portfolioValueC = scenarioC.shares * currentPrice;
            totalWealthC = portfolioValueC + scenarioC.tagesgeld;
            eventTextC = `📈 Jahr ${year}: Depot: ${portfolioValueC.toFixed(0)} € | TG: ${scenarioC.tagesgeld.toFixed(0)} € | Σ: ${totalWealthC.toFixed(0)} €`;
        } else if (year === 7) {
            // Year 7: Second crash buy opportunity!
            scenarioC.tagesgeld += scenarioC.tagesgeldInflow;
            const secondBuyAmount = 12000;
            const boughtShares = secondBuyAmount / currentPrice;
            scenarioC.shares += boughtShares;
            scenarioC.tagesgeld -= secondBuyAmount;
            portfolioValueC = scenarioC.shares * currentPrice;
            totalWealthC = portfolioValueC + scenarioC.tagesgeld;
            eventTextC = `🚀 Jahr ${year}: Nochmal 12k nachgekauft bei ${currentPrice} € = ${boughtShares.toFixed(0)} Anteile!`;
        } else {
            // Year 8+: Normal with overflow
            scenarioC.tagesgeld += scenarioC.tagesgeldInflow;
            if (scenarioC.tagesgeld > 30000) {
                const overflow = scenarioC.tagesgeld - 30000;
                scenarioC.tagesgeld = 30000;
                scenarioC.shares += overflow / currentPrice;
            }
            portfolioValueC = scenarioC.shares * currentPrice;
            totalWealthC = portfolioValueC + scenarioC.tagesgeld;
            eventTextC = `📈 Jahr ${year}: Depot: ${portfolioValueC.toFixed(0)} € | TG: ${scenarioC.tagesgeld.toFixed(0)} € | Σ: ${totalWealthC.toFixed(0)} €`;
        }
        scenarioC.timeline.push(eventTextC);

        // Update Combined Chart with TOTAL WEALTH (TG + Depot)
        if (kriegskasseChart && kriegskasseChart.data.datasets) {
            kriegskasseChart.data.datasets[1].data[year] = totalWealthA;
            kriegskasseChart.data.datasets[2].data[year] = totalWealthB;
            kriegskasseChart.data.datasets[3].data[year] = totalWealthC;

            // Reset all point sizes
            kriegskasseChart.data.datasets[1].pointRadius = Array(10).fill(5);
            kriegskasseChart.data.datasets[2].pointRadius = Array(10).fill(5);
            kriegskasseChart.data.datasets[3].pointRadius = Array(10).fill(5);

            // Highlight current year
            kriegskasseChart.data.datasets[1].pointRadius[year] = 10;
            kriegskasseChart.data.datasets[2].pointRadius[year] = 10;
            kriegskasseChart.data.datasets[3].pointRadius[year] = 10;

            // Highlight current year on Kursverlauf
            kriegskasseChart.data.datasets[0].pointRadius = Array(10).fill(3);
            kriegskasseChart.data.datasets[0].pointRadius[year] = 6;

            // Extra emphasis on crash year
            if (year === 2) {
                kriegskasseChart.data.datasets[1].pointRadius[year] = 12;
                kriegskasseChart.data.datasets[1].pointBackgroundColor[year] = '#E3691E';
                kriegskasseChart.data.datasets[2].pointRadius[year] = 12;
                kriegskasseChart.data.datasets[2].pointBackgroundColor[year] = '#E3691E';
                kriegskasseChart.data.datasets[3].pointRadius[year] = 14;
                kriegskasseChart.data.datasets[3].pointBackgroundColor[year] = '#47A190';
                kriegskasseChart.data.datasets[0].pointRadius[year] = 8;
            }

            kriegskasseChart.update();
        }

        // Update timeline displays
        updateKriegskasseTimeline('a', scenarioA.timeline);
        updateKriegskasseTimeline('b', scenarioB.timeline);
        updateKriegskasseTimeline('c', scenarioC.timeline);
    }

    function updateKriegskasseTimeline(scenario, timeline) {
        const container = document.getElementById(`kriegskasse-timeline-${scenario}`);
        if (!container) return;

        container.innerHTML = '';
        timeline.slice(-5).forEach(event => { // Show last 5 events
            const eventDiv = document.createElement('div');
            eventDiv.className = 'text-sm text-gray-700 py-1';
            eventDiv.textContent = event;
            container.appendChild(eventDiv);
        });
    }

    function showKriegskasseResults() {
        const marketPrices = courseData.B;
        const finalPrice = marketPrices[marketPrices.length - 1]; // 9
        const initialWealth = 40000; // All start with 40k

        // Scenario A: Final TOTAL wealth (Depot only, no Tagesgeld)
        const finalPortfolioA = scenarioA.shares * finalPrice;
        const finalWealthA = finalPortfolioA + scenarioA.tagesgeld; // 0 TG
        const resultA = finalWealthA - initialWealth;

        // Scenario B: Final TOTAL wealth (Depot + Tagesgeld)
        const finalPortfolioB = scenarioB.shares * finalPrice;
        const finalWealthB = finalPortfolioB + scenarioB.tagesgeld;
        const resultB = finalWealthB - initialWealth;

        // Scenario C: Final TOTAL wealth (Depot + Tagesgeld)
        const finalPortfolioC = scenarioC.shares * finalPrice;
        const finalWealthC = finalPortfolioC + scenarioC.tagesgeld;
        const resultC = finalWealthC - initialWealth;

        // Calculate differences
        const differenceC_vs_B = finalWealthC - finalWealthB;

        // Update HTML
        document.getElementById('kriegskasse-result-sold-a').textContent = `${scenarioA.cashFromSale.toFixed(0)} €`;
        document.getElementById('kriegskasse-result-reentry-a').textContent = `${scenarioA.reentryAt.toFixed(2)} €`;
        document.getElementById('kriegskasse-result-value-a').textContent = `${finalWealthA.toFixed(0)} €`;
        document.getElementById('kriegskasse-result-loss-a').textContent = `${resultA.toFixed(0)} €`;

        document.getElementById('kriegskasse-result-value-b').textContent = `${finalWealthB.toFixed(0)} €`;
        document.getElementById('kriegskasse-result-profit-b').textContent = `${resultB >= 0 ? '+' : ''}${resultB.toFixed(0)} €`;

        document.getElementById('kriegskasse-result-buy-c').textContent = `12000 €`;
        document.getElementById('kriegskasse-result-value-c').textContent = `${finalWealthC.toFixed(0)} €`;
        document.getElementById('kriegskasse-result-profit-c').textContent = `${resultC >= 0 ? '+' : ''}${resultC.toFixed(0)} €`;
        document.getElementById('kriegskasse-difference-c').textContent = `${differenceC_vs_B.toFixed(0)} € mehr`;
    }

    // ===== END KRIEGSKASSE ERKLÄRER =====

    // ===== v1.7.2: SEQUENCE OF RETURNS RISK (SoRR) SIMULATOR =====

    // MSCI World historical returns (2005-2024)
    const msciWorldReturns = [
        { year: 2005, return: 9.49 },
        { year: 2006, return: 20.07 },
        { year: 2007, return: 9.04 },
        { year: 2008, return: -40.71 },
        { year: 2009, return: 29.99 },
        { year: 2010, return: 11.76 },
        { year: 2011, return: -5.54 },
        { year: 2012, return: 15.83 },
        { year: 2013, return: 26.68 },
        { year: 2014, return: 4.94 },
        { year: 2015, return: -0.87 },
        { year: 2016, return: 7.51 },
        { year: 2017, return: 22.40 },
        { year: 2018, return: -8.71 },
        { year: 2019, return: 27.67 },
        { year: 2020, return: 15.90 },
        { year: 2021, return: 21.82 },
        { year: 2022, return: -18.14 },
        { year: 2023, return: 23.79 },
        { year: 2024, return: 18.67 }
    ];

    let sorrChart = null;
    let sorrSortConfig = { key: 'year', direction: 'ascending' };
    let sorrCurrentData = { history: [], reverse: [], worst: [] };
    let sorrShowAll = false;

    function openSoRRModal() {
        // v1.7.2: Mark as visited for PDF inclusion
        markErklaererBesucht('sorr');

        openModal('sorr-modal');

        // Initialize table
        renderSoRRTable();

        // Calculate average return
        const avgReturn = msciWorldReturns.reduce((sum, item) => sum + item.return, 0) / msciWorldReturns.length;
        document.getElementById('sorr-avg-return').textContent = `Ø ${avgReturn.toFixed(2)}% p.a.`;

        // Run initial simulation
        runSoRRSimulation();
    }

    function closeSoRRModal() {
        closeModal('sorr-modal');
        if (sorrChart) {
            sorrChart.destroy();
            sorrChart = null;
        }
    }

    function renderSoRRTable() {
        const tbody = document.getElementById('sorr-returns-table');
        tbody.innerHTML = '';

        const sortedData = sortSoRRData(msciWorldReturns, sorrSortConfig);

        sortedData.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-100';
            tr.innerHTML = `
                <td class="px-4 py-2 font-mono text-gray-600">${row.year}</td>
                <td class="px-4 py-2 text-right font-semibold ${row.return >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${row.return > 0 ? '+' : ''}${row.return.toFixed(2)} %
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function sortSoRRData(data, sortConfig) {
        const sorted = [...data];
        sorted.sort((a, b) => {
            if (a[sortConfig.key] < b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? -1 : 1;
            }
            if (a[sortConfig.key] > b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? 1 : -1;
            }
            return 0;
        });
        return sorted;
    }

    function sortSoRRTable(key) {
        // Toggle direction if same key
        if (sorrSortConfig.key === key) {
            sorrSortConfig.direction = sorrSortConfig.direction === 'ascending' ? 'descending' : 'ascending';
        } else {
            sorrSortConfig.key = key;
            sorrSortConfig.direction = 'ascending';
        }

        // Update icons
        const yearIcon = document.getElementById('sorr-sort-icon-year');
        const returnIcon = document.getElementById('sorr-sort-icon-return');

        yearIcon.className = 'w-4 h-4 text-gray-400';
        returnIcon.className = 'w-4 h-4 text-gray-400';

        if (key === 'year') {
            yearIcon.className = `w-4 h-4 text-blue-600`;
        } else {
            returnIcon.className = `w-4 h-4 text-blue-600`;
        }

        renderSoRRTable();

        // Bei Sortierungswechsel: Einzelansicht + Chart/Cards aktualisieren
        if (sorrShowAll) {
            sorrShowAll = false;
            var btn = document.getElementById('sorr-compare-btn');
            if (btn) {
                btn.className = 'mlp-btn mlp-btn-tertiary text-xs py-2 px-4';
                btn.textContent = 'Alle Szenarien vergleichen';
            }
        }
        if (sorrCurrentData.history.length > 0) {
            updateSoRRChart();
            updateSoRRResultCards();
        }
    }

    function simulatePortfolio(orderType) {
        const initialCapital = parseFloat(document.getElementById('sorr-initial-capital').value) || 500000;
        const annualWithdrawal = parseFloat(document.getElementById('sorr-annual-withdrawal').value) || 25000;
        const inflationRate = parseFloat(document.getElementById('sorr-inflation').value) || 2.0;

        let currentBalance = initialCapital;
        let currentWithdrawal = annualWithdrawal;
        let dataSequence = [...msciWorldReturns];

        // Manipulate sequence based on type
        if (orderType === 'reverse') {
            dataSequence.sort((a, b) => b.return - a.return); // Best-First: beste Rendite zuerst (absteigend)
        } else if (orderType === 'worst-first') {
            dataSequence.sort((a, b) => a.return - b.return); // Worst-First: schlechteste Rendite zuerst (aufsteigend)
        }
        // 'history' is default, no change needed

        const history = [];

        // Initial point
        history.push({
            period: 0,
            yearLabel: 'Start',
            balance: currentBalance,
            returnPct: 0,
            withdrawal: 0
        });

        dataSequence.forEach((item, index) => {
            // 1. Market Move
            const growth = currentBalance * (item.return / 100);
            let newBalance = currentBalance + growth;

            // 2. Withdrawal (End of Year)
            if (newBalance <= 0) {
                newBalance = 0;
            } else {
                newBalance -= currentWithdrawal;
                if (newBalance < 0) newBalance = 0;
            }

            history.push({
                period: index + 1,
                yearLabel: orderType === 'history' ? item.year : `Jahr ${index + 1}`,
                returnPct: item.return,
                balance: Math.round(newBalance),
                withdrawal: Math.round(currentWithdrawal)
            });

            // Prepare next year
            currentBalance = newBalance;
            currentWithdrawal = currentWithdrawal * (1 + inflationRate / 100);
        });

        return history;
    }

    function calculateDuration(portfolioHistory) {
        // Find the year when portfolio reaches zero (or return "Endlos" if it never does)
        for (let i = 0; i < portfolioHistory.length; i++) {
            if (portfolioHistory[i].balance <= 0) {
                return `${i} Jahre`;
            }
        }
        return 'Endlos';
    }

    function updateSoRRWithdrawalRate() {
        // Update withdrawal rate percentage when capital or withdrawal changes
        const capital = parseFloat(document.getElementById('sorr-initial-capital').value) || 500000;
        const withdrawal = parseFloat(document.getElementById('sorr-annual-withdrawal').value) || 20000;
        const rate = (withdrawal / capital * 100).toFixed(1);
        document.getElementById('sorr-withdrawal-rate').textContent = rate;
    }

    function runSoRRSimulation() {
        // Update withdrawal rate display
        updateSoRRWithdrawalRate();

        // Run simulations
        sorrCurrentData.history = simulatePortfolio('history');
        sorrCurrentData.reverse = simulatePortfolio('reverse');
        sorrCurrentData.worst = simulatePortfolio('worst-first');

        // Update result cards - balance
        const historyEnd = sorrCurrentData.history[sorrCurrentData.history.length - 1].balance;
        const reverseEnd = sorrCurrentData.reverse[sorrCurrentData.reverse.length - 1].balance;
        const worstEnd = sorrCurrentData.worst[sorrCurrentData.worst.length - 1].balance;

        document.getElementById('sorr-result-history').textContent = formatMoney(historyEnd);
        document.getElementById('sorr-result-reverse').textContent = formatMoney(reverseEnd);
        document.getElementById('sorr-result-worst').textContent = formatMoney(worstEnd);

        // Update result cards - duration
        document.getElementById('sorr-duration-history').textContent = calculateDuration(sorrCurrentData.history);
        document.getElementById('sorr-duration-reverse').textContent = calculateDuration(sorrCurrentData.reverse);
        document.getElementById('sorr-duration-worst').textContent = calculateDuration(sorrCurrentData.worst);

        // Update chart + cards visibility
        updateSoRRChart();
        updateSoRRResultCards();
    }

    function updateSoRRResultCards() {
        var cardHistory = document.getElementById('sorr-card-history');
        var cardReverse = document.getElementById('sorr-card-reverse');
        var cardWorst = document.getElementById('sorr-card-worst');
        var container = document.getElementById('sorr-result-cards');
        if (!cardHistory || !cardReverse || !cardWorst || !container) return;

        if (sorrShowAll) {
            // Alle 3 Cards nebeneinander
            container.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
            cardHistory.style.display = '';
            cardReverse.style.display = '';
            cardWorst.style.display = '';
        } else {
            // Nur die aktive Card, zentriert
            var active = getActiveSoRRScenario();
            container.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
            cardHistory.style.display = active === 'history' ? '' : 'none';
            cardReverse.style.display = active === 'reverse' ? '' : 'none';
            cardWorst.style.display = active === 'worst' ? '' : 'none';
        }
    }

    function getActiveSoRRScenario() {
        // Welches Szenario passt zur aktuellen Tabellen-Sortierung?
        if (sorrSortConfig.key === 'year' && sorrSortConfig.direction === 'ascending') return 'history';
        if (sorrSortConfig.key === 'year' && sorrSortConfig.direction === 'descending') return 'reverse';
        if (sorrSortConfig.key === 'return' && sorrSortConfig.direction === 'ascending') return 'worst';
        if (sorrSortConfig.key === 'return' && sorrSortConfig.direction === 'descending') return 'reverse';
        return 'history';
    }

    function toggleSoRRCompare() {
        sorrShowAll = !sorrShowAll;
        updateSoRRChart();
        updateSoRRResultCards();
        // Button-Style aktualisieren
        var btn = document.getElementById('sorr-compare-btn');
        if (btn) {
            if (sorrShowAll) {
                btn.className = 'mlp-btn mlp-btn-primary text-xs py-2 px-4';
                btn.textContent = 'Einzelansicht';
            } else {
                btn.className = 'mlp-btn mlp-btn-tertiary text-xs py-2 px-4';
                btn.textContent = 'Alle Szenarien vergleichen';
            }
        }
    }

    function updateSoRRChart() {
        const ctx = document.getElementById('sorr-chart');
        if (!ctx) return;

        // Prepare chart data
        const chartData = sorrCurrentData.history.map((item, index) => ({
            period: item.period,
            History: item.balance,
            Reverse: sorrCurrentData.reverse[index]?.balance || 0,
            Worst: sorrCurrentData.worst[index]?.balance || 0
        }));

        // Dataset-Definitionen
        const allDatasets = {
            history: {
                label: 'Historischer Verlauf (2005-2024)',
                data: chartData.map(d => d.History),
                borderColor: '#16a34a',
                backgroundColor: 'rgba(22, 163, 74, 0.15)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5
            },
            reverse: {
                label: 'Best-First (2009\u21922008)',
                data: chartData.map(d => d.Reverse),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.15)',
                borderWidth: 3,
                borderDash: [5, 5],
                tension: 0.3,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5
            },
            worst: {
                label: 'Schlechteste Jahre zuerst',
                data: chartData.map(d => d.Worst),
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.15)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5
            }
        };

        // Datasets auswählen
        var datasets;
        var titleEl = document.getElementById('sorr-chart-title');
        var subtitleEl = document.getElementById('sorr-chart-subtitle');
        if (sorrShowAll) {
            // Alle 3 Szenarien, kein Fill
            datasets = [
                Object.assign({}, allDatasets.history, { fill: false }),
                Object.assign({}, allDatasets.reverse, { fill: false }),
                Object.assign({}, allDatasets.worst, { fill: false, borderWidth: 2 })
            ];
            if (titleEl) titleEl.textContent = 'Vermögensentwicklung im Vergleich';
            if (subtitleEl) subtitleEl.textContent = 'Drei Szenarien mit identischer Durchschnittsrendite \u2013 nur die Reihenfolge unterscheidet sich!';
        } else {
            var active = getActiveSoRRScenario();
            datasets = [allDatasets[active]];
            var titles = { history: 'Historischer Verlauf (2005\u20132024)', reverse: 'Best-First (2009\u21922008)', worst: 'Schlechteste Jahre zuerst' };
            var subtitles = { history: 'Reihenfolge wie sie tats\u00e4chlich war: 2005, 2006, 2007...', reverse: 'Beste Renditen zuerst: Von den guten in die schlechten Jahre.', worst: 'Schlechteste Renditen zuerst: Crash direkt zu Beginn der Entnahme.' };
            if (titleEl) titleEl.textContent = titles[active];
            if (subtitleEl) subtitleEl.textContent = subtitles[active];
        }

        // Destroy previous chart
        if (sorrChart) {
            sorrChart.destroy();
        }

        // Create new chart
        sorrChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map(d => 'Jahr ' + d.period),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: sorrShowAll,
                        position: 'top',
                        labels: { padding: 20, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Verm\u00f6gen (\u20ac)' },
                        ticks: { callback: function(value) { return formatMoney(value); } }
                    },
                    x: {
                        title: { display: true, text: 'Jahre' }
                    }
                },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    function formatMoney(value) {
        return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: 'EUR',
            maximumFractionDigits: 0
        }).format(value);
    }

    // ===== END SoRR SIMULATOR =====

    // ===== AKTIEN & ANLEIHEN ERKLÄRER (v1.7.8) =====

    let anleihenDurationChart = null;
    let anleihenActiveTab = 'duration';

    function openAnleihenModal() {
        markErklaererBesucht('anleihen');
        openModal('anleihen-modal');
        anleihenActiveTab = 'duration';
        switchAnleihenTab('duration');
    }

    function closeAnleihenModal() {
        closeModal('anleihen-modal');
        if (anleihenDurationChart) { anleihenDurationChart.destroy(); anleihenDurationChart = null; }
    }

    function switchAnleihenTab(tab) {
        anleihenActiveTab = tab;
        var tabs = ['duration', 'seesaw', 'spread'];
        tabs.forEach(function(t) {
            var panel = document.getElementById('anleihen-tab-' + t);
            var btn = document.getElementById('anleihen-tab-btn-' + t);
            if (panel) {
                if (t === tab) {
                    panel.style.display = '';
                    panel.style.opacity = '0';
                    requestAnimationFrame(function() { panel.style.opacity = '1'; });
                } else {
                    panel.style.display = 'none';
                }
            }
            if (btn) {
                if (t === tab) {
                    btn.style.background = 'var(--mlp-primary, #033D5D)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'var(--card)';
                    btn.style.color = 'var(--fg)';
                    btn.style.border = '1px solid var(--border)';
                }
            }
        });

        if (tab === 'duration') {
            updateDurationChart();
        } else if (tab === 'seesaw') {
            // Sync parameters from Tab 1
            var kupon = parseFloat(document.getElementById('anleihen-kupon').value) || 3;
            var laufzeit = parseInt(document.getElementById('anleihen-laufzeit').value) || 10;
            document.getElementById('seesaw-kupon').textContent = kupon.toFixed(1) + '%';
            document.getElementById('seesaw-laufzeit').textContent = laufzeit + ' Jahre';
            updateSeesawVis();
        } else if (tab === 'spread') {
            updateEquityFlow();
        }
    }

    // Bond price calculation: PV = Σ(Kupon/(1+r)^t) + 100/(1+r)^n
    function calculateBondPrice(kuponRate, laufzeit, marktzins) {
        var pv = 0;
        for (var t = 1; t <= laufzeit; t++) {
            pv += kuponRate / Math.pow(1 + marktzins, t);
        }
        pv += 100 / Math.pow(1 + marktzins, laufzeit);
        return pv; // Returns price as % of par
    }

    // Duration sensitivity: price change at each remaining year when rates change by delta
    function calculateDurationSensitivity() {
        var kupon = parseFloat(document.getElementById('anleihen-kupon').value) || 3;
        var laufzeit = parseInt(document.getElementById('anleihen-laufzeit').value) || 10;
        var nennwert = parseFloat(document.getElementById('anleihen-nennwert').value) || 10000;
        var zinsDelta = parseFloat(document.getElementById('anleihen-zinsdelta').value);
        if (isNaN(zinsDelta)) zinsDelta = 1;

        var kuponRate = kupon / 100;
        var marktzinsBase = kupon / 100; // Base = Kupon → Kurs = 100%
        var marktzinsShocked = marktzinsBase + zinsDelta / 100;

        var labels = [];
        var changes = [];

        for (var remainingYears = laufzeit; remainingYears >= 1; remainingYears--) {
            var priceBase = calculateBondPrice(kuponRate * 100, remainingYears, marktzinsBase);
            var priceShocked = calculateBondPrice(kuponRate * 100, remainingYears, marktzinsShocked);
            var change = priceShocked - priceBase; // negative = price drop

            labels.push(remainingYears + (remainingYears === 1 ? ' Jahr' : ' Jahre'));
            changes.push(parseFloat(change.toFixed(2)));
        }

        // Update result card: show current price at shocked rate for full laufzeit
        var currentPrice = calculateBondPrice(kupon, laufzeit, marktzinsShocked);
        var kursEuro = (currentPrice / 100) * nennwert;
        document.getElementById('anleihen-kurs-wert').textContent = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(kursEuro);
        document.getElementById('anleihen-kurs-prozent').textContent = currentPrice.toFixed(2).replace('.', ',') + '% vom Nennwert';

        return { labels: labels, changes: changes };
    }

    function updateDurationChart() {
        var data = calculateDurationSensitivity();

        if (anleihenDurationChart) {
            anleihenDurationChart.destroy();
            anleihenDurationChart = null;
        }

        var ctx = document.getElementById('anleihen-duration-chart');
        if (!ctx) return;

        var zinsDelta = parseFloat(document.getElementById('anleihen-zinsdelta').value);
        if (isNaN(zinsDelta)) zinsDelta = 1;

        var titleText = zinsDelta === 0 ? 'Keine Zinsänderung (Kurs = Par)' :
            zinsDelta > 0 ? 'Kursänderung bei +' + zinsDelta.toFixed(1) + '% Zinsanstieg' :
            'Kursänderung bei ' + zinsDelta.toFixed(1) + '% Zinssenkung';

        anleihenDurationChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Kursänderung (%)',
                    data: data.changes,
                    backgroundColor: data.changes.map(function(v) {
                        return v < 0 ? 'rgba(3, 61, 93, 0.7)' : 'rgba(71, 161, 144, 0.7)';
                    }),
                    borderColor: data.changes.map(function(v) {
                        return v < 0 ? '#033D5D' : '#47A190';
                    }),
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: titleText,
                        font: { size: 14, weight: 'bold' },
                        color: '#033D5D'
                    },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Kursänderung: ' + context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Restlaufzeit', color: '#717171' },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'Kursänderung (%)', color: '#717171' },
                        grid: { color: 'rgba(190,182,170,0.3)' },
                        min: -25,
                        max: 25
                    }
                }
            }
        });
    }

    // Tab 2: Inverse Beziehung — Füllstands-Visualisierung
    function updateSeesawVis() {
        var marktzinsRaw = parseFloat(document.getElementById('anleihen-marktzins').value);
        var marktzins = isNaN(marktzinsRaw) ? 3 : marktzinsRaw;
        var kupon = parseFloat(document.getElementById('anleihen-kupon').value) || 3;
        var laufzeit = parseInt(document.getElementById('anleihen-laufzeit').value) || 10;
        var nennwert = parseFloat(document.getElementById('anleihen-nennwert').value) || 10000;

        // Calculate bond price
        var kursPercent = calculateBondPrice(kupon, laufzeit, marktzins / 100);
        var kursEuro = (kursPercent / 100) * nennwert;

        // Update result card
        document.getElementById('seesaw-kurs-wert').textContent = kursPercent.toFixed(2).replace('.', ',') + '%';
        document.getElementById('seesaw-kurs-euro').textContent = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(kursEuro);

        // Tank fill levels
        // Left tank: Marktzins 0-5% → 0-100% height
        var zinsFill = (marktzins / 5) * 100;
        document.getElementById('seesaw-tank-zins').style.height = zinsFill + '%';
        document.getElementById('seesaw-tank-zins-label').textContent = marktzins.toFixed(1) + '%';

        // Right tank: Kurs range 80%-120% → map to 0-100% height
        var kursFill = Math.max(0, Math.min(100, (kursPercent - 80) / 40 * 100));
        document.getElementById('seesaw-tank-kurs').style.height = kursFill + '%';
        document.getElementById('seesaw-tank-kurs-label').textContent = kursPercent.toFixed(0) + '%';

        // Par line position: 100% in 80-120 range = 50% from bottom
        var parLinePos = ((100 - 80) / 40) * 100; // = 50%

        // Update label color — white text when fill is behind it
        var kursLabel = document.getElementById('seesaw-tank-kurs-label');
        if (kursFill > 55) {
            kursLabel.style.color = 'white';
            kursLabel.style.textShadow = 'none';
        } else {
            kursLabel.style.color = '#033D5D';
            kursLabel.style.textShadow = '0 1px 2px rgba(255,255,255,0.8)';
        }

        var zinsLabel = document.getElementById('seesaw-tank-zins-label');
        if (zinsFill > 55) {
            zinsLabel.style.color = 'white';
            zinsLabel.style.textShadow = 'none';
        } else {
            zinsLabel.style.color = '#033D5D';
            zinsLabel.style.textShadow = '0 1px 2px rgba(255,255,255,0.8)';
        }

        // Dynamic explanation text
        var explainEl = document.getElementById('seesaw-explain-text');
        var diff = marktzins - kupon;
        if (Math.abs(diff) < 0.3) {
            explainEl.innerHTML = 'Marktzins und Kupon sind nahezu gleich. Die Anleihe steht <strong>bei Par</strong> (100%) — kein Grund, mehr oder weniger zu zahlen.';
        } else if (diff > 0) {
            explainEl.innerHTML = 'Der Marktzins liegt bei <strong>' + marktzins.toFixed(1) + '%</strong>, der Kupon nur bei ' + kupon.toFixed(1) + '%. Neue Anleihen bieten bessere Konditionen — warum sollte jemand Ihre ' + kupon.toFixed(1) + '%-Anleihe zum vollen Preis kaufen? <strong>Der Kurs sinkt auf ' + kursPercent.toFixed(1) + '%.</strong>';
        } else {
            explainEl.innerHTML = 'Der Marktzins liegt nur bei <strong>' + marktzins.toFixed(1) + '%</strong>, Ihr Kupon bei ' + kupon.toFixed(1) + '%. Ihre Anleihe zahlt mehr als der Markt — ein begehrtes Papier! <strong>Der Kurs steigt auf ' + kursPercent.toFixed(1) + '%.</strong>';
        }
    }

    // Tab 3: Equity Risk Premium — Kapitalfluss-Visualisierung
    function updateEquityFlow() {
        var rendite = parseFloat(document.getElementById('equity-rendite-slider').value) || 0;
        var zins = parseFloat(document.getElementById('equity-zins-slider').value) || 0;
        var spread = rendite - zins;

        // Update display labels
        document.getElementById('equity-rendite-display').textContent = rendite.toFixed(1) + '%';
        document.getElementById('equity-zins-display').textContent = zins.toFixed(1) + '%';

        // SVG texts
        document.getElementById('equity-company-text').textContent = 'erwirtschaftet ' + rendite.toFixed(1) + '%';
        document.getElementById('equity-zins-flow').textContent = zins.toFixed(1) + '% Zinsen';

        // Bars — total width = 400px for max 15%
        var barTotal = 400;
        var maxRate = 15;
        var zinsWidth = Math.max(0, (zins / maxRate) * barTotal);
        var gewinnWidth = Math.max(0, (spread / maxRate) * barTotal);

        var zinsBar = document.getElementById('equity-bar-zins');
        var gewinnBar = document.getElementById('equity-bar-gewinn');
        var zinsText = document.getElementById('equity-bar-zins-text');
        var gewinnText = document.getElementById('equity-bar-gewinn-text');

        zinsBar.setAttribute('width', zinsWidth);
        zinsText.setAttribute('x', 80 + zinsWidth / 2);
        zinsText.textContent = zins.toFixed(1) + '%';

        document.getElementById('equity-bar-label-zins').setAttribute('x', 80 + zinsWidth / 2);

        if (spread > 0) {
            gewinnBar.setAttribute('x', 80 + zinsWidth);
            gewinnBar.setAttribute('width', gewinnWidth);
            gewinnBar.setAttribute('fill', '#47A190');
            gewinnText.setAttribute('x', 80 + zinsWidth + gewinnWidth / 2);
            gewinnText.textContent = '+' + spread.toFixed(1) + '%';
            document.getElementById('equity-bar-label-gewinn').setAttribute('x', 80 + zinsWidth + gewinnWidth / 2);
            document.getElementById('equity-bar-label-gewinn').textContent = 'Aktionärsgewinn';
            document.getElementById('equity-bar-label-gewinn').setAttribute('fill', '#3a8474');
        } else if (spread < 0) {
            var lossWidth = Math.max(0, (Math.abs(spread) / maxRate) * barTotal);
            gewinnBar.setAttribute('x', 80 + zinsWidth - lossWidth);
            gewinnBar.setAttribute('width', lossWidth);
            gewinnBar.setAttribute('fill', '#C1293D');
            gewinnText.setAttribute('x', 80 + zinsWidth - lossWidth / 2);
            gewinnText.textContent = spread.toFixed(1) + '%';
            document.getElementById('equity-bar-label-gewinn').setAttribute('x', 80 + zinsWidth - lossWidth / 2);
            document.getElementById('equity-bar-label-gewinn').textContent = 'Verlust!';
            document.getElementById('equity-bar-label-gewinn').setAttribute('fill', '#C1293D');
        } else {
            gewinnBar.setAttribute('width', 0);
            gewinnText.textContent = '';
            document.getElementById('equity-bar-label-gewinn').textContent = '';
        }

        // Profit arrow & text
        var profitArrow = document.getElementById('equity-profit-arrow');
        var profitFlow = document.getElementById('equity-profit-flow');
        var profitLabel = document.getElementById('equity-profit-label');
        var profitBg = document.getElementById('equity-profit-bg');
        var aktionaerBox = document.getElementById('equity-aktionaer-box');

        if (spread > 0) {
            profitArrow.setAttribute('stroke', '#47A190');
            profitArrow.setAttribute('marker-end', 'url(#arrow-tuerkis)');
            profitFlow.textContent = '+' + spread.toFixed(1) + '% Gewinn';
            profitFlow.setAttribute('fill', '#3a8474');
            profitLabel.textContent = 'Wertsteigerung';
            profitLabel.setAttribute('fill', '#3a8474');
            profitBg.setAttribute('stroke', '#47A190');
            aktionaerBox.setAttribute('fill', '#47A190');
            aktionaerBox.setAttribute('stroke', '#3a8474');
        } else if (spread < 0) {
            profitArrow.setAttribute('stroke', '#C1293D');
            profitArrow.setAttribute('marker-end', 'url(#arrow-warn)');
            profitFlow.textContent = spread.toFixed(1) + '% Verlust';
            profitFlow.setAttribute('fill', '#C1293D');
            profitLabel.textContent = 'Substanzverlust';
            profitLabel.setAttribute('fill', '#C1293D');
            profitBg.setAttribute('stroke', '#C1293D');
            aktionaerBox.setAttribute('fill', '#C1293D');
            aktionaerBox.setAttribute('stroke', '#9e1f2f');
        } else {
            profitArrow.setAttribute('stroke', '#BEB6AA');
            profitFlow.textContent = '0% — Break Even';
            profitFlow.setAttribute('fill', '#717171');
            profitLabel.textContent = 'Kein Gewinn';
            profitLabel.setAttribute('fill', '#717171');
            profitBg.setAttribute('stroke', '#BEB6AA');
            aktionaerBox.setAttribute('fill', '#BEB6AA');
            aktionaerBox.setAttribute('stroke', '#a89e90');
        }

        // Result card
        var resultCard = document.getElementById('equity-result-card');
        var resultLabel = document.getElementById('equity-result-label');
        var resultValue = document.getElementById('equity-result-value');
        var resultText = document.getElementById('equity-result-text');

        if (spread > 0) {
            resultCard.style.background = 'rgba(71,161,144,0.08)';
            resultCard.style.border = '1px solid rgba(71,161,144,0.3)';
            resultLabel.textContent = 'Gewinn der Aktionäre';
            resultLabel.style.color = '#47A190';
            resultValue.textContent = '+' + spread.toFixed(1) + '%';
            resultValue.style.color = '#033D5D';
            resultText.textContent = 'Equity Risk Premium';
            resultText.style.color = '#47A190';
        } else if (spread < 0) {
            resultCard.style.background = 'rgba(193,41,61,0.06)';
            resultCard.style.border = '1px solid rgba(193,41,61,0.3)';
            resultLabel.textContent = 'Verlust der Aktionäre';
            resultLabel.style.color = '#C1293D';
            resultValue.textContent = spread.toFixed(1) + '%';
            resultValue.style.color = '#C1293D';
            resultText.textContent = 'Unternehmen verbrennt Kapital';
            resultText.style.color = '#C1293D';
        } else {
            resultCard.style.background = '#F8F8F8';
            resultCard.style.border = '1px solid #BEB6AA';
            resultLabel.textContent = 'Break Even';
            resultLabel.style.color = '#717171';
            resultValue.textContent = '±0%';
            resultValue.style.color = '#2B2B2B';
            resultText.textContent = 'Kein Mehrwert für Aktionäre';
            resultText.style.color = '#717171';
        }

        // Warning
        var warning = document.getElementById('equity-warning');
        warning.style.display = spread < 0 ? '' : 'none';

        // Fazit text
        var fazit = document.getElementById('equity-fazit');
        var fazitText = document.getElementById('equity-fazit-text');
        if (spread > 2) {
            fazit.style.background = '#F8F8F8';
            fazit.style.border = '1px solid #BEB6AA';
            fazitText.innerHTML = '<strong>Ergebnis:</strong> Das Unternehmen verdient ' + spread.toFixed(1) + '% mehr als es für das geliehene Geld zahlt. Dieser Überschuss steigert den Unternehmenswert und gehört den Aktionären.';
            fazitText.style.color = '#2B2B2B';
        } else if (spread > 0) {
            fazit.style.background = 'rgba(227,105,30,0.06)';
            fazit.style.border = '1px solid rgba(227,105,30,0.3)';
            fazitText.innerHTML = '<strong>Knapp:</strong> Der Spread von nur ' + spread.toFixed(1) + '% reicht kaum, um das höhere Risiko der Aktionäre zu kompensieren. Aktien wären hier wenig attraktiv.';
            fazitText.style.color = '#2B2B2B';
        } else if (spread === 0) {
            fazit.style.background = '#F8F8F8';
            fazit.style.border = '1px solid #BEB6AA';
            fazitText.innerHTML = '<strong>Break Even:</strong> Das Unternehmen verdient exakt so viel wie es an Zinsen zahlt. Für Aktionäre gibt es keinen Mehrwert — warum sollte jemand das Risiko tragen?';
            fazitText.style.color = '#717171';
        } else {
            fazit.style.background = 'rgba(193,41,61,0.06)';
            fazit.style.border = '1px solid rgba(193,41,61,0.3)';
            fazitText.innerHTML = '<strong>Achtung:</strong> Das Unternehmen verdient weniger als es an Zinsen zahlt. Es verliert ' + Math.abs(spread).toFixed(1) + '% pro Jahr an Substanz. Langfristig führt das zur Insolvenz — die Anleihe wird wertlos, die Aktie auch.';
            fazitText.style.color = '#C1293D';
        }
    }

    // ===== END AKTIEN & ANLEIHEN ERKLÄRER =====

    // Toast Notification System
    function showToast(message, type = 'success', duration = 4000) {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
            document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.style.cssText = `
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            max-width: 500px;
            font-size: 14px;
            line-height: 1.5;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
        `;
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>' :
                      type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>' :
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'}
                </svg>
                <span>${message}</span>
            </div>
        `;

        // Add animation styles if not already present
        if (!document.getElementById('toast-animations')) {
            const style = document.createElement('style');
            style.id = 'toast-animations';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Add toast to container
        toastContainer.appendChild(toast);

        // Remove toast on click
        toast.addEventListener('click', () => removeToast(toast));

        // Auto-remove after duration
        if (duration > 0) {
            setTimeout(() => removeToast(toast), duration);
        }

        return toast;
    }

    function removeToast(toast) {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }
    const fixkostenModal = { list: getEl('fixkosten-list'), total: getEl('modal-total') };

    function openFixkostenModal() {
        // Lade Vermieterkonto-Daten aus sessionStorage bevor Modal geöffnet wird
        const saved = sessionStorage.getItem('vermieterkontoData');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                Object.assign(vermieterkontoData, parsed);
            } catch (e) {
                console.error('Fehler beim Laden der Vermieterkonto-Daten:', e);
            }
        }
        openModal('fixkosten-modal');
        // Render list AFTER modal is opened to ensure DOM is ready
        renderFixkostenList();
    }

    function saveFixkosten() { calculateAndUpdate(); closeModal('fixkosten-modal'); }
    function renderFixkostenList() {
        fixkostenModal.list.innerHTML = '';
        let total = 0;

        // Vermieterkonto-Daten holen
        const vermieterData = getVermieterkontoData();

        // Automatische Zeile für Vermieterkonto (nur in Variante A)
        if (currentVariant === 'A' && vermieterData.saldo !== 0) {
            const autoItemEl = document.createElement('div');

            if (vermieterData.saldo < 0) {
                // Negativ: Zusätzliche Ausgabe (warnung)
                autoItemEl.className = 'grid grid-cols-12 gap-2 items-center p-2 rounded';
                autoItemEl.style.cssText = 'background: rgba(227,105,30,0.06); border: 1px solid var(--mlp-warning);';
                autoItemEl.innerHTML = '<div class="col-span-4 text-sm flex items-center gap-1" style="color: var(--mlp-warning);">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>' +
                        'Vermieterkonto-Deckung' +
                    '</div>' +
                    '<div class="col-span-2 font-bold" style="color: var(--mlp-warning);">' + formatCurrency(Math.abs(vermieterData.saldo)) + '</div>' +
                    '<div class="col-span-2 text-sm" style="color: var(--muted);">mtl.</div>' +
                    '<div class="col-span-3 text-sm" style="color: var(--muted);">automatisch</div>' +
                    '<div class="col-span-1"></div>';
                total += Math.abs(vermieterData.saldo);
            } else {
                // Positiv: Einsparung (grün)
                autoItemEl.className = 'grid grid-cols-12 gap-2 items-center p-2 rounded';
                autoItemEl.style.cssText = 'background: rgba(19,133,62,0.06); border: 1px solid var(--mlp-success);';
                autoItemEl.innerHTML = '<div class="col-span-4 text-sm flex items-center gap-1" style="color: var(--mlp-success);">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' +
                        'Mieteinnahmen' +
                    '</div>' +
                    '<div class="col-span-2 font-bold" style="color: var(--mlp-success);">-' + formatCurrency(vermieterData.saldo) + '</div>' +
                    '<div class="col-span-2 text-sm" style="color: var(--muted);">mtl.</div>' +
                    '<div class="col-span-3 text-sm" style="color: var(--muted);">automatisch</div>' +
                    '<div class="col-span-1"></div>';
                total -= vermieterData.saldo; // Reduziert die Fixkosten
            }

            fixkostenModal.list.appendChild(autoItemEl);
        }

        // Reguläre Fixkosten-Items
        fixkostenItems.forEach((item, index) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'grid grid-cols-12 gap-2 items-center';
            var intervalOptions = ['monthly','quarterly','annually'].map(function(i) {
                return '<option value="' + i + '" ' + (item.interval === i ? 'selected' : '') + '>' + (i==='monthly'?'mtl.':i==='quarterly'?'viertelj.':'jährl.') + '</option>';
            }).join('');
            itemEl.innerHTML = '<input type="text" value="' + (item.name || '').replace(/"/g, '&quot;') + '" onchange="updateFixkostenItem(' + index + ', \'name\', this.value)" placeholder="Posten" class="col-span-4 mlp-input-field-v2 p-1">' +
                '<input type="number" value="' + item.amount + '" onchange="updateFixkostenItem(' + index + ', \'amount\', this.value)" placeholder="Betrag" class="col-span-2 mlp-input-field-v2 p-1">' +
                '<select onchange="updateFixkostenItem(' + index + ', \'interval\', this.value)" class="col-span-2 mlp-input-field-v2 p-1">' + intervalOptions + '</select>' +
                '<select onchange="updateFixkostenItem(' + index + ', \'target\', this.value)" class="col-span-3 mlp-input-field-v2 p-1"><option value="fixkosten" ' + (item.target==='fixkosten'?'selected':'') + '>-> Fixkosten</option><option value="depot" ' + (item.target==='depot'?'selected':'') + '>-> Sparplan</option></select>' +
                '<button onclick="removeFixkostenItem(' + index + ')" class="col-span-1 text-xl" style="color: var(--mlp-error); cursor: pointer;" onmouseover="this.style.opacity=\'0.7\'" onmouseout="this.style.opacity=\'1\'">&times;</button>';
            fixkostenModal.list.appendChild(itemEl);
            total += getMonthlyAmount(item);
        });

        fixkostenModal.total.textContent = formatCurrency(total);
    }
function updateFixkostenItem(index, key, value) {
  // Normalize types per field
  if (key === 'amount') {
    value = parseFloat(value);
    if (!Number.isFinite(value)) value = 0;
    // Allow negative values (for additional income items)
    if (value < -1000000) value = -1000000; // min realistic amount (-1M EUR)
    if (value > 1000000) value = 1000000; // max realistic amount (1M EUR)
  }
  // Persist change in model
  if (fixkostenItems[index]) {
    fixkostenItems[index][key] = value;
  }
  // Re-render modal list & totals (debounced for performance)
  debouncedRenderFixkostenList();
}
    function addFixkostenItem() { fixkostenItems.push({ name: '', amount: 0, interval: 'monthly', target: 'fixkosten' }); renderFixkostenList(); }
    function removeFixkostenItem(index) { fixkostenItems.splice(index, 1); renderFixkostenList(); }
    const depotModal = { list: getEl('depot-list'), total: getEl('depot-total'), warning: getEl('depot-warning'), saveButton: getEl('depot-save-button') };
    function saveDepot() { if(checkDepotTotal()) { calculateAndUpdate(); closeModal('depot-modal'); } }

    // v1.9.0: Farb-Paletten fuer Rot/Blau
    var BLAU_FARBEN = ['#033D5D', '#1a5276', '#2471a3', '#2e86c1', '#3498db', '#5dade2', '#1b4f72', '#154360'];
    var ROT_FARBEN = ['#C1293D', '#e74c3c', '#cb4335', '#b03a2e', '#922b21', '#d35400', '#e67e22', '#dc7633'];
    var _blauIdx = 0;
    var _rotIdx = 0;

    function getFondsColor(farbe) {
        if (farbe === 'blau') {
            var c = BLAU_FARBEN[_blauIdx % BLAU_FARBEN.length];
            _blauIdx++;
            return c;
        } else if (farbe === 'rot') {
            var c = ROT_FARBEN[_rotIdx % ROT_FARBEN.length];
            _rotIdx++;
            return c;
        }
        return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
    }

    // v1.9.0: Fonds-Autocomplete Suche
    function searchFonds(query) {
        if (!query || query.length < 2) return [];
        var q = query.toLowerCase();
        return MLP_FONDS_DB.filter(function(f) {
            return f.name.toLowerCase().indexOf(q) !== -1 || f.wkn.toLowerCase().indexOf(q) !== -1;
        }).slice(0, 8);
    }

    // v1.9.0: Lookup Fonds-Info by name
    function lookupFonds(name) {
        if (!name) return null;
        var n = name.toLowerCase();
        for (var i = 0; i < MLP_FONDS_DB.length; i++) {
            if (MLP_FONDS_DB[i].name.toLowerCase() === n) return MLP_FONDS_DB[i];
        }
        return null;
    }

    // v1.9.0: Fonds-Badge HTML erzeugen
    function fondsDBBadge(item) {
        var info = lookupFonds(item.name);
        if (info) {
            return '<span class="depot-item-badge ' + info.farbe + '">' + info.farbe.toUpperCase() + '</span>';
        }
        if (item.name) {
            return '<span class="depot-item-badge custom">EIGEN</span>';
        }
        return '';
    }

    function renderDepotList() {
        depotModal.list.innerHTML = '';
        var total = 0;
        _blauIdx = 0;
        _rotIdx = 0;
        depotItems.forEach(function(item, index) {
            total += item.allocation;
            if (!item.risk) item.risk = 'conservative';

            var itemEl = document.createElement('div');
            itemEl.className = 'grid grid-cols-12 gap-2 items-center mb-2';

            // Badge fuer Rot/Blau
            var badgeHtml = fondsDBBadge(item);

            itemEl.innerHTML =
                '<div class="col-span-6">' +
                    '<div class="flex items-center gap-2">' +
                        badgeHtml +
                        '<input type="text" value="' + (item.name || '').replace(/"/g, '&quot;') + '" ' +
                        'oninput="onFondsInput(this, ' + index + ')" ' +
                        'onfocus="onFondsInput(this, ' + index + ')" ' +
                        'onblur="setTimeout(function(){closeFondsDropdown()}, 200)" ' +
                        'placeholder="Fonds / ETF / WKN tippen..." class="flex-1 mlp-input-field-v2 p-1 text-sm" autocomplete="off">' +
                    '</div>' +
                '</div>' +
                '<div class="relative col-span-2">' +
                    '<input type="number" value="' + item.allocation + '" onchange="updateDepotItem(' + index + ', \'allocation\', this.value)" ' +
                    'class="w-full text-right pr-6 mlp-input-field-v2 p-1 text-sm">' +
                    '<span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs" style="color: var(--muted);">%</span>' +
                '</div>' +
                '<div class="col-span-3 risk-toggle ' + item.risk + '" onclick="updateDepotItem(' + index + ', \'risk\', \'' + (item.risk === 'conservative' ? 'aggressive' : 'conservative') + '\')" title="' + (item.risk === 'conservative' ? 'Konservativ' : 'Chancenreich') + '">' +
                    '<span class="risk-dot conservative"></span>' +
                    '<span class="risk-dot aggressive"></span>' +
                '</div>' +
                '<button type="button" onclick="removeDepotItem(' + index + ')" ' +
                'class="col-span-1 text-xl" style="color: var(--mlp-error); cursor: pointer;" title="Entfernen" onmouseover="this.style.opacity=\'0.7\'" onmouseout="this.style.opacity=\'1\'">&times;</button>';

            depotModal.list.appendChild(itemEl);
        });
        checkDepotTotal();
    }

    // v1.9.0: Autocomplete Event-Handler
    // v1.9.3: Globales Dropdown — positioniert sich per fixed am Input
    var _fondsDropdownIndex = -1;

    function onFondsInput(inputEl, index) {
        var query = inputEl.value;
        var dropdown = document.getElementById('fonds-dropdown-global');
        if (!dropdown) return;

        // Update name live
        depotItems[index].name = query;
        _fondsDropdownIndex = index;

        var results = searchFonds(query);
        if (results.length === 0) {
            dropdown.classList.remove('open');
            dropdown.innerHTML = '';
            return;
        }

        var html = '';
        for (var i = 0; i < results.length; i++) {
            var f = results[i];
            html += '<div class="fonds-ac-item" onmousedown="selectFonds(' + index + ', ' + i + ')">' +
                '<span class="fonds-ac-badge ' + f.farbe + '">' + f.farbe.toUpperCase() + '</span>' +
                '<span class="fonds-ac-wkn">' + f.wkn + '</span>' +
                '<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + f.name + '</span>' +
                '<span class="fonds-ac-kategorie">' + f.kategorie + '</span>' +
                '</div>';
        }
        dropdown.innerHTML = html;

        // Position: direkt unter dem Input-Feld
        var rect = inputEl.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = rect.bottom + 2 + 'px';
        dropdown.style.width = rect.width + 'px';
        dropdown.classList.add('open');
    }

    function selectFonds(index, resultIdx) {
        var query = depotItems[index].name || '';
        var results = searchFonds(query);
        var fonds = results[resultIdx];
        if (!fonds) return;

        depotItems[index].name = fonds.name;
        depotItems[index].color = getFondsColor(fonds.farbe);
        depotItems[index].risk = (fonds.farbe === 'blau') ? 'conservative' : 'aggressive';

        closeFondsDropdown();
        renderDepotList();
        renderDepotBasin();
    }

    function closeFondsDropdown() {
        var dropdown = document.getElementById('fonds-dropdown-global');
        if (dropdown) {
            dropdown.classList.remove('open');
            dropdown.innerHTML = '';
        }
        _fondsDropdownIndex = -1;
    }

    function updateDepotItem(index, key, value) {
        if (key === 'allocation') value = parseInt(value, 10) || 0;
        depotItems[index][key] = value;

        // v1.9.0: Wenn Name geaendert, pruefen ob Fonds in DB ist und Farbe/Risk auto-setzen
        if (key === 'name') {
            var info = lookupFonds(value);
            if (info) {
                depotItems[index].color = getFondsColor(info.farbe);
                depotItems[index].risk = (info.farbe === 'blau') ? 'conservative' : 'aggressive';
            }
        }

        debouncedRenderDepotList();
        renderDepotBasin();
    }

    function addDepotItem() {
        depotItems.push({
            name: '',
            allocation: 0,
            color: '#6b7280',
            risk: 'conservative'
        });
        renderDepotList();
    }
    function removeDepotItem(index) {
        depotItems.splice(index, 1);
        renderDepotList();
        renderDepotBasin();
    }

    function checkDepotTotal() {
        const total = depotItems.reduce((sum, i) => sum + i.allocation, 0);
        depotModal.total.textContent = total + ' %';
        if (total === 100) {
            depotModal.total.style.color = '#47A190';
            depotModal.warning.textContent = '';
            depotModal.saveButton.disabled = false;
            depotModal.saveButton.style.opacity = '1';
            depotModal.saveButton.style.cursor = 'pointer';
            return true;
        } else {
            depotModal.total.style.color = '#C1293D';
            depotModal.warning.textContent = 'Die Summe der Verteilung muss 100% ergeben.';
            depotModal.saveButton.disabled = true;
            depotModal.saveButton.style.opacity = '0.5';
            depotModal.saveButton.style.cursor = 'not-allowed';
            return false;
        }
    }

    function renderDepotBasin() {
        if (!basins.depot) return;

        // MLP Design Palette - Blue scale for conservative, Red scale for aggressive
        const mlpColors = {
            conservative: [
                '#002f6c', // MLP Blue (darkest)
                '#0047a0', // MLP Blue medium
                '#3b82f6', // Blue-500
                '#60a5fa', // Blue-400
                '#93c5fd'  // Blue-300 (lightest)
            ],
            aggressive: [
                '#991b1b', // Red-800 (darkest)
                '#dc2626', // Red-600
                '#ef4444', // Red-500
                '#f87171', // Red-400
                '#fca5a5'  // Red-300 (lightest)
            ]
        };

        // Filter active funds (allocation > 0)
        const conservative = depotItems.filter(i => i.risk === 'conservative' && i.allocation > 0);
        const aggressive = depotItems.filter(i => i.risk === 'aggressive' && i.allocation > 0);

        // Generate fund blocks HTML - SQUARES (width = height)
        // Better scaling: 10% → 24px, 50% → 40px, 100% → 56px
        const calculateSize = (allocation) => {
            const baseSize = 24; // Minimum size
            const scaleFactor = 0.32; // Better visibility of differences
            return Math.round(baseSize + (allocation * scaleFactor));
        };

        const leftBlocks = conservative.map((item, index) => {
            const size = calculateSize(item.allocation);
            const color = mlpColors.conservative[index % mlpColors.conservative.length];
            return `<div class="fund-block" style="background: ${color}; width: ${size}px; height: ${size}px" title="${item.name} (${item.allocation}%)"></div>`;
        }).join('');

        const rightBlocks = aggressive.map((item, index) => {
            const size = calculateSize(item.allocation);
            const color = mlpColors.aggressive[index % mlpColors.aggressive.length];
            return `<div class="fund-block" style="background: ${color}; width: ${size}px; height: ${size}px" title="${item.name} (${item.allocation}%)"></div>`;
        }).join('');

        // Debug logs removed in v1.5.2

        // Render basin with fund blocks
        basins.depot.innerHTML = `
            <div class="depot-basin-content">
                <div class="fund-blocks left">${leftBlocks || '<div style="width: 8px"></div>'}</div>
                <div class="depot-info">
                    <div class="text-sm font-semibold">Vermögensaufbau</div>
                    <div class="text-2xl font-bold">${formatCurrency(inputs.depotCurrent.value)}</div>
                    <div class="text-xs text-gray-400">(Klick zum Bearbeiten)</div>
                </div>
                <div class="fund-blocks right">${rightBlocks || '<div style="width: 8px"></div>'}</div>
            </div>
        `;
    }


    // === MSCI RENDITEDREIECK FUNCTIONS ===
    let msciZoomState = {
        zoomed: false,
        scale: 1,
        translateX: 0,
        translateY: 0
    };

    function openMsciRenditedreieck() {
        resetMsciZoom();
        openModal('msci-modal');
    }

    function closeMsciRenditedreieck() {
        closeModal('msci-modal');
        resetMsciZoom();
    }

    function resetMsciZoom() {
        msciZoomState = { zoomed: false, scale: 1, translateX: 0, translateY: 0 };
        const img = getEl('msci-image');
        const container = getEl('msci-container');
        if (img) {
            img.style.transform = 'scale(1) translate(0, 0)';
            img.style.cursor = 'zoom-in';
        }
        if (container) {
            container.style.cursor = 'zoom-in';
        }
    }

    function toggleMsciZoom(event) {
        const img = getEl('msci-image');
        const container = getEl('msci-container');
        if (!img || !container) return;

        if (!msciZoomState.zoomed) {
            // Zoom in: Berechne Position relativ zum Klick
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Prozentuale Position (0-1)
            const xPercent = x / rect.width;
            const yPercent = y / rect.height;

            // Zoom-Level
            const zoomScale = 2.5;

            // Berechne Translation um den Klickpunkt zu zentrieren
            const translateX = (0.5 - xPercent) * 100 * (zoomScale - 1);
            const translateY = (0.5 - yPercent) * 100 * (zoomScale - 1);

            msciZoomState = {
                zoomed: true,
                scale: zoomScale,
                translateX: translateX,
                translateY: translateY
            };

            img.style.transform = `scale(${zoomScale}) translate(${translateX}%, ${translateY}%)`;
            img.style.cursor = 'zoom-out';
            container.style.cursor = 'zoom-out';
        } else {
            // Zoom out
            resetMsciZoom();
        }
    }

    // Filter-Funktionen entfernt - nur Zoom bleibt aktiv

    // === IMMOBILIEN FUNCTIONS ===
    // Immobilien-Daten Objekt (wird in localStorage gespeichert)
    // === IMMOBILIEN-DATENMODELL ===
    // Liste von Immobilien mit Wert und Darlehen
    let immobilienData = [];
    let immobilienAnzahl = 0;

    // === VERMIETERKONTO-DATENMODELL ===
    // Separates Datenmodell für Einnahmen und Ausgaben
    let vermieterkontoData = {
        miete: 0,                   // Monatliche Mieteinnahmen
        sonstigeEinnahmen: 0,       // Sonstige monatliche Einnahmen
        rate: 0,                    // Monatliche Darlehensrate (kann auto-berechnet oder manuell sein)
        zinssatz: 0,                // Zinssatz in % (für Annuitätenberechnung)
        tilgungssatz: 0,            // Tilgungssatz in % (für Annuitätenberechnung)
        wertsteigerung: 0,          // Wertsteigerung in % pro Jahr
        instandhaltung: 0,          // Monatliche Instandhaltungsrücklage
        steuern: 0,                 // Monatliche Steuern & Nebenkosten
        cashflowIntegration: false  // Toggle: Flows ins Gesamtsystem integrieren
    };

    function getVermieterkontoData() {
        const einnahmen = vermieterkontoData.miete + vermieterkontoData.sonstigeEinnahmen;
        const ausgaben = vermieterkontoData.rate + vermieterkontoData.instandhaltung + vermieterkontoData.steuern;
        const saldo = einnahmen - ausgaben;

        // Berechne Gesamtdarlehen aus allen Immobilien
        const gesamtdarlehen = immobilienData.reduce((sum, immo) => sum + (immo.darlehen || 0), 0);

        return {
            einnahmen,      // Gesamt-Einnahmen
            ausgaben,       // Gesamt-Ausgaben
            saldo,          // Netto-Cashflow (kann positiv oder negativ sein)
            // Zur Info: Wie viel davon ist Tilgung? (später für Tooltip)
            tilgung: calculateTilgungsanteil(vermieterkontoData.rate, gesamtdarlehen)
        };
    }

    // Berechnet monatliche Darlehensrate (Annuität)
    function berechneDarlehensrate(darlehen, zinssatz, tilgungssatz) {
        if (!darlehen || darlehen === 0) return { gesamt: 0, zinsen: 0, tilgung: 0 };
        if (!zinssatz && !tilgungssatz) return { gesamt: 0, zinsen: 0, tilgung: 0 };

        const jahresrate = darlehen * (zinssatz + tilgungssatz) / 100;
        const monatsrate = jahresrate / 12;

        const zinsenMonatlich = (darlehen * zinssatz / 100) / 12;
        const tilgungMonatlich = monatsrate - zinsenMonatlich;

        return {
            gesamt: monatsrate,
            zinsen: zinsenMonatlich,
            tilgung: tilgungMonatlich
        };
    }

    // Hilfsfunktion: Berechnet ungefähren Tilgungsanteil (vereinfacht: 1-2% Zinsen angenommen)
    function calculateTilgungsanteil(rate, restdarlehen) {
        if (restdarlehen === 0 || rate === 0) return 0;
        // Wenn wir Zinssatz haben, nutze echte Berechnung
        if (vermieterkontoData.zinssatz > 0) {
            const zinsenMonatlich = (restdarlehen * vermieterkontoData.zinssatz / 100) / 12;
            return Math.max(0, rate - zinsenMonatlich);
        }
        // Fallback: Annahme 2% Zinsen
        const geschaetzterZins = restdarlehen * 0.02 / 12;
        return Math.max(0, rate - geschaetzterZins);
    }

    // Lädt Immobilien-Daten aus sessionStorage
    function loadImmobilienData() {
        const saved = sessionStorage.getItem('immobilienData');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // Kompatibilität: Altes Objekt-Format in Array konvertieren
                if (!Array.isArray(parsed)) {
                    immobilienData = [{ wert: parsed.wert || 0, darlehen: parsed.darlehen || 0 }];
                } else {
                    immobilienData = parsed;
                }
            } catch (e) {
                console.warn('Fehler beim Laden der Immobilien-Daten', e);
            }
        }
        const savedAnzahl = sessionStorage.getItem('immobilienAnzahl');
        immobilienAnzahl = savedAnzahl ? parseInt(savedAnzahl) : (immobilienData.length > 0 && immobilienData[0].wert > 0 ? 1 : 0);
        updateImmobilienInputs();
        updateImmobilienSummary();
    }

    // Aktualisiert die Eingabefelder im Modal mit den gespeicherten Werten
    function updateImmobilienInputs() {
        // Quick-Fix: Zeige erste Immobilie im Modal
        const immo = immobilienData[0] || { wert: 0, darlehen: 0, darlehenOriginal: 0, zinssatz: 0, tilgungssatz: 0, wertsteigerung: 0 };

        if (getEl('immo-wert')) getEl('immo-wert').value = immo.wert || 0;
        if (getEl('immo-darlehen')) getEl('immo-darlehen').value = immo.darlehen || 0;
        if (getEl('immo-darlehen-original')) getEl('immo-darlehen-original').value = immo.darlehenOriginal || 0;
        if (getEl('immo-zinssatz')) getEl('immo-zinssatz').value = immo.zinssatz || 0;
        if (getEl('immo-tilgungssatz')) getEl('immo-tilgungssatz').value = immo.tilgungssatz || 0;
        if (getEl('immo-wertsteigerung')) getEl('immo-wertsteigerung').value = immo.wertsteigerung || 0;
        if (getEl('immo-anzahl')) getEl('immo-anzahl').value = immobilienAnzahl;

        // Trigger Darlehensberechnung wenn Werte vorhanden
        if (immo.zinssatz > 0 || immo.tilgungssatz > 0) {
            updateImmoDarlehensrateBerechnung();
        }
    }

    // Berechnet und zeigt Nettovermögen an (Cashflow jetzt im Vermieterkonto)
    function updateImmobilienSummary() {
        const wert = parseFloat(getEl('immo-wert')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const nettovermoegen = wert - darlehen;

        const nettoEl = getEl('immo-nettovermoegen');

        if (nettoEl) {
            nettoEl.textContent = formatCurrency(nettovermoegen);
            nettoEl.className = 'text-3xl font-bold';
            nettoEl.style.color = nettovermoegen >= 0 ? 'var(--mlp-success)' : 'var(--mlp-error)';
        }

        // Cashflow-Element ausblenden (jetzt im Vermieterkonto)
        const cashflowContainer = getEl('immo-cashflow')?.parentElement;
        if (cashflowContainer) {
            cashflowContainer.style.display = 'none';
        }
    }

    // Speichert Immobilien-Daten und schließt Modal
    function saveImmobilien() {
        // Quick-Fix: Erstelle/Update erste Immobilie aus Modal-Daten
        // TODO: Später erweitern für mehrere Immobilien
        const wert = parseFloat(getEl('immo-wert')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const darlehenOriginal = parseFloat(getEl('immo-darlehen-original')?.value || 0);
        const zinssatz = parseFloat(getEl('immo-zinssatz')?.value || 0);
        const tilgungssatz = parseFloat(getEl('immo-tilgungssatz')?.value || 0);
        const wertsteigerung = parseFloat(getEl('immo-wertsteigerung')?.value || 0);

        if (immobilienData.length === 0) {
            immobilienData.push({ wert, darlehen, darlehenOriginal, zinssatz, tilgungssatz, wertsteigerung });
        } else {
            immobilienData[0] = { wert, darlehen, darlehenOriginal, zinssatz, tilgungssatz, wertsteigerung };
        }

        // Übertrage berechnete Rate ins Vermieterkonto
        // WICHTIG: Verwende darlehenOriginal für Berechnung (Annuität bleibt konstant!)
        // Falls darlehenOriginal nicht gesetzt, fallback auf aktuelles Restdarlehen
        const darlehenFuerBerechnung = darlehenOriginal > 0 ? darlehenOriginal : darlehen;

        if ((zinssatz > 0 || tilgungssatz > 0) && darlehenFuerBerechnung > 0) {
            const result = berechneDarlehensrate(darlehenFuerBerechnung, zinssatz, tilgungssatz);
            vermieterkontoData.rate = Math.round(result.gesamt); // Auf volle Euro runden
            vermieterkontoData.zinssatz = zinssatz;
            vermieterkontoData.tilgungssatz = tilgungssatz;
            vermieterkontoData.wertsteigerung = wertsteigerung;
            sessionStorage.setItem('vermieterkontoData', JSON.stringify(vermieterkontoData));
        }

        immobilienAnzahl = parseInt(getEl('immo-anzahl')?.value || 0);
        sessionStorage.setItem('immobilienData', JSON.stringify(immobilienData));
        sessionStorage.setItem('immobilienAnzahl', immobilienAnzahl.toString());
        calculateAndUpdate(); // Aktualisiert alle Basins inkl. Vermieterkonto
        closeModal('immobilien-modal');
    }

    // Event Listener für Immobilien-Inputs (Live-Update der Zusammenfassung)
    function setupImmobilienListeners() {
        const fields = ['wert', 'darlehen'];
        fields.forEach(field => {
            const input = getEl('immo-' + field);
            if (input) {
                input.addEventListener('input', updateImmobilienSummary);
            }
        });

        // Darlehens-Felder: Auto-Berechnung der Rate
        const darlehensFields = ['zinssatz', 'tilgungssatz', 'darlehen-original'];
        darlehensFields.forEach(field => {
            const input = getEl('immo-' + field);
            if (input) {
                input.addEventListener('input', updateImmoDarlehensrateBerechnung);
            }
        });

        // Wertsteigerung: Update Tilgungsplan
        const wertsteigerungInput = getEl('immo-wertsteigerung');
        if (wertsteigerungInput) {
            wertsteigerungInput.addEventListener('input', updateImmoTilgungsplan);
        }

        // Tilgungsplan-Slider
        const slider = getEl('immo-tilgungsplan-slider');
        if (slider) {
            slider.addEventListener('input', updateImmoTilgungsplan);
        }
    }

    // Darlehensberechnung für Immobilien-Modal
    function updateImmoDarlehensrateBerechnung() {
        const zinssatz = parseFloat(getEl('immo-zinssatz')?.value || 0);
        const tilgungssatz = parseFloat(getEl('immo-tilgungssatz')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const darlehenOriginal = parseFloat(getEl('immo-darlehen-original')?.value || 0);

        // WICHTIG: Verwende ursprüngliches Darlehen für Berechnung (Annuität bleibt konstant!)
        // Falls nicht gesetzt, fallback auf aktuelles Restdarlehen
        const darlehenFuerBerechnung = darlehenOriginal > 0 ? darlehenOriginal : darlehen;

        if (darlehenFuerBerechnung === 0 || (zinssatz === 0 && tilgungssatz === 0)) {
            // Verstecke Anzeige, wenn keine Berechnung möglich
            const display = getEl('immo-rate-berechnet-display');
            if (display) display.classList.add('hidden');

            const tilgungsplanSection = getEl('immo-tilgungsplan-section');
            if (tilgungsplanSection) tilgungsplanSection.classList.add('hidden');
            return;
        }

        // Berechne Rate mit ursprünglichem Darlehen
        const result = berechneDarlehensrate(darlehenFuerBerechnung, zinssatz, tilgungssatz);

        // Zeige berechnete Rate
        const display = getEl('immo-rate-berechnet-display');
        const wertEl = getEl('immo-rate-berechnet-wert');
        const zinsenEl = getEl('immo-rate-zinsen');
        const tilgungEl = getEl('immo-rate-tilgung');

        if (display) display.classList.remove('hidden');
        if (wertEl) wertEl.textContent = formatCurrency(result.gesamt);
        if (zinsenEl) zinsenEl.textContent = formatCurrency(result.zinsen);
        if (tilgungEl) tilgungEl.textContent = formatCurrency(result.tilgung);

        // Zeige Tilgungsplan
        const tilgungsplanSection = getEl('immo-tilgungsplan-section');
        if (tilgungsplanSection) tilgungsplanSection.classList.remove('hidden');

        // Initial Tilgungsplan aktualisieren
        updateImmoTilgungsplan();
    }

    // Tilgungsplan-Berechnung für Immobilien-Modal
    function updateImmoTilgungsplan() {
        const jahre = parseInt(getEl('immo-tilgungsplan-slider')?.value || 10);
        const jahreEl = getEl('immo-tilgungsplan-jahre');
        if (jahreEl) jahreEl.textContent = jahre;

        const zinssatz = parseFloat(getEl('immo-zinssatz')?.value || 0);
        const tilgungssatz = parseFloat(getEl('immo-tilgungssatz')?.value || 0);
        const wertsteigerung = parseFloat(getEl('immo-wertsteigerung')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const darlehenOriginal = parseFloat(getEl('immo-darlehen-original')?.value || 0);
        const immowert = parseFloat(getEl('immo-wert')?.value || 0);

        if (darlehen === 0) return;

        // WICHTIG: Verwende ursprüngliches Darlehen für Ratenberechnung (Annuität konstant!)
        const darlehenFuerBerechnung = darlehenOriginal > 0 ? darlehenOriginal : darlehen;

        // Berechnung über Jahre (Tilgung beginnt bei aktuellem Restdarlehen)
        let restschuld = darlehen;
        let gezahlteZinsen = 0;
        const result = berechneDarlehensrate(darlehenFuerBerechnung, zinssatz, tilgungssatz);
        const monatsrate = result.gesamt;

        for (let monat = 1; monat <= jahre * 12; monat++) {
            const zinsenDiesenMonat = (restschuld * zinssatz / 100) / 12;
            const tilgungDiesenMonat = monatsrate - zinsenDiesenMonat;

            gezahlteZinsen += zinsenDiesenMonat;
            restschuld = Math.max(0, restschuld - tilgungDiesenMonat);

            if (restschuld === 0) break;
        }

        // Wertsteigerung der Immobilie
        const wertMitSteigerung = immowert * Math.pow(1 + wertsteigerung / 100, jahre);
        const eigenkapital = wertMitSteigerung - restschuld;

        // Anzeige aktualisieren
        const restschuldEl = getEl('immo-tilgungsplan-restschuld');
        const zinsenEl = getEl('immo-tilgungsplan-zinsen');
        const eigenkapitalEl = getEl('immo-tilgungsplan-eigenkapital');
        const wertEl = getEl('immo-tilgungsplan-wert');

        if (restschuldEl) restschuldEl.textContent = formatCurrency(restschuld);
        if (zinsenEl) zinsenEl.textContent = formatCurrency(gezahlteZinsen);
        if (eigenkapitalEl) eigenkapitalEl.textContent = formatCurrency(eigenkapital);
        if (wertEl) wertEl.textContent = formatCurrency(wertMitSteigerung);
    }

    // === END IMMOBILIEN FUNCTIONS ===

    // === VERMIETERKONTO FUNCTIONS ===
    function saveVermieterkonto() {
        // Zinssatz, Tilgungssatz, Wertsteigerung werden jetzt im Immobilien-Modal verwaltet
        // und automatisch beim Speichern der Immobilie ins vermieterkontoData übertragen
        vermieterkontoData.miete = parseFloat(getEl('vk-miete')?.value || 0);
        vermieterkontoData.sonstigeEinnahmen = parseFloat(getEl('vk-sonstige-einnahmen')?.value || 0);
        vermieterkontoData.rate = parseFloat(getEl('vk-rate')?.value || 0);
        vermieterkontoData.instandhaltung = parseFloat(getEl('vk-instandhaltung')?.value || 0);
        vermieterkontoData.steuern = parseFloat(getEl('vk-steuern')?.value || 0);
        vermieterkontoData.cashflowIntegration = getEl('vk-cashflow-integration')?.checked || false;

        sessionStorage.setItem('vermieterkontoData', JSON.stringify(vermieterkontoData));
        calculateAndUpdate();
        closeModal('vermieterkonto-modal');
    }

    // Event Listener für Vermieterkonto-Inputs (Live-Update der Zusammenfassung)
    function setupVermieterkontoListeners() {
        const fields = ['miete', 'sonstige-einnahmen', 'rate', 'instandhaltung', 'steuern'];
        fields.forEach(field => {
            const input = getEl('vk-' + field);
            if (input) {
                input.addEventListener('input', updateVermieterkontoSummary);
            }
        });
    }

    function updateVermieterkontoSummary() {
        const miete = parseFloat(getEl('vk-miete')?.value || 0);
        const sonstigeEinnahmen = parseFloat(getEl('vk-sonstige-einnahmen')?.value || 0);
        const rate = parseFloat(getEl('vk-rate')?.value || 0);
        const instandhaltung = parseFloat(getEl('vk-instandhaltung')?.value || 0);
        const steuern = parseFloat(getEl('vk-steuern')?.value || 0);

        const einnahmen = miete + sonstigeEinnahmen;
        const ausgaben = rate + instandhaltung + steuern;
        const saldo = einnahmen - ausgaben;

        // Zusammenfassung aktualisieren
        const einnahmenEl = getEl('vk-einnahmen-total');
        const ausgabenEl = getEl('vk-ausgaben-total');
        const saldoEl = getEl('vk-saldo');

        if (einnahmenEl) einnahmenEl.textContent = formatCurrency(einnahmen);
        if (ausgabenEl) ausgabenEl.textContent = formatCurrency(ausgaben);
        if (saldoEl) {
            saldoEl.textContent = formatCurrency(saldo);
            // Farbe je nach Saldo
            saldoEl.className = 'text-2xl font-bold';
            saldoEl.style.color = saldo >= 0 ? 'var(--mlp-success)' : 'var(--mlp-error)';
        }
    }

    function loadVermieterkontoData() {
        const saved = sessionStorage.getItem('vermieterkontoData');
        if (saved) {
            try {
                vermieterkontoData = JSON.parse(saved);
            } catch (e) {
                console.error('Failed to load vermieterkonto data:', e);
            }
        }

        // Felder im Modal befüllen
        if (getEl('vk-miete')) getEl('vk-miete').value = vermieterkontoData.miete || 0;
        if (getEl('vk-sonstige-einnahmen')) getEl('vk-sonstige-einnahmen').value = vermieterkontoData.sonstigeEinnahmen || 0;
        if (getEl('vk-rate')) getEl('vk-rate').value = vermieterkontoData.rate || 0;
        if (getEl('vk-instandhaltung')) getEl('vk-instandhaltung').value = vermieterkontoData.instandhaltung || 0;
        if (getEl('vk-steuern')) getEl('vk-steuern').value = vermieterkontoData.steuern || 0;
        if (getEl('vk-cashflow-integration')) getEl('vk-cashflow-integration').checked = vermieterkontoData.cashflowIntegration || false;

        updateVermieterkontoSummary();
    }
    // === END VERMIETERKONTO FUNCTIONS ===

    // --- Helpers: Export current SVG flow and Chart.js chart as images ---
    async function svgToPngDataUrl(svgElement, scale = 2, bg = '#ffffff') {
      const rect = svgElement.getBoundingClientRect();

      // Get actual viewBox or use bounding box to ensure complete SVG capture
      const viewBox = svgElement.getAttribute('viewBox');
      let width = rect.width;
      let height = rect.height;

      if (viewBox) {
        const parts = viewBox.split(/\s+|,/);
        width = parseFloat(parts[2]) || rect.width;
        height = parseFloat(parts[3]) || rect.height;
      }

      // 1) Clone the on-screen SVG so we can preprocess without affecting UI
      const clone = svgElement.cloneNode(true);
      clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
      clone.setAttribute('width', width);
      clone.setAttribute('height', height);
      if (viewBox) clone.setAttribute('viewBox', viewBox);
      clone.removeAttribute('style');

      // 2) Remove mask for export (avoids black rectangle in rasterization)
      const visuals = clone.querySelector('#flow-visuals');
      if (visuals) visuals.removeAttribute('mask');

      // 3) Inject background rect (theme-aware)
      const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bgRect.setAttribute('x', '0');
      bgRect.setAttribute('y', '0');
      bgRect.setAttribute('width', '100%');
      bgRect.setAttribute('height', '100%');
      bgRect.setAttribute('fill', bg);
      clone.insertBefore(bgRect, clone.firstChild);

      // 4) Inline stroke colors on cloned paths (in case CSS vars don't carry over)
      try {
        const originalPaths = svgElement.querySelectorAll('.flow-path, .flow-path-animation, .flow-erase');
        const clonedPaths   = clone.querySelectorAll('.flow-path, .flow-path-animation, .flow-erase');
        clonedPaths.forEach((node, i) => {
          const src = originalPaths[i];
          if (!src) return;
          const cs = getComputedStyle(src);
          if (cs && cs.stroke && cs.stroke !== 'none') node.setAttribute('stroke', cs.stroke);
        });
      } catch (_) {}

      // 5) Serialize the prepared clone and draw it onto a canvas
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(clone);
      const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(800, Math.floor(width * scale));
      canvas.height = Math.max(600, Math.floor(height * scale));

      const ctx = canvas.getContext('2d');
      ctx.fillStyle = bg;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      await new Promise((resolve, reject) => {
        img.onload = () => {
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          URL.revokeObjectURL(url);
          resolve();
        };
        img.onerror = reject;
        img.src = url;
      });

      return canvas.toDataURL('image/jpeg', 0.95);
    }
    function getFlowSnapshotDataUrl() {
      const svg = document.getElementById('flow-svg');
      if (!svg) return null;
      return svgToPngDataUrl(svg, 2, '#ffffff');
    }
    function getChartImageDataUrl() {
      // existierende Instanz nutzen
      if (prognoseChartInstance && typeof prognoseChartInstance.toBase64Image === 'function') {
        try { return prognoseChartInstance.toBase64Image('image/png', 1.0); } catch (_) {}
      }
      // Fallback: temporären Chart rendern
      try {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 1000;
        tempCanvas.height = 420;
        const ctx = tempCanvas.getContext('2d');

        const years = parseInt(inputs.anlagezeitraum.value, 10) || 15;
        const dataRangeRaw = (renditeExtremes && renditeExtremes[years]) || getRenditeDataForPeriod(years);
        const dataRange = dataRangeRaw ? (dataRangeRaw.mean === undefined ? buildRenditeStat(dataRangeRaw.min, dataRangeRaw.max) : dataRangeRaw) : null;
        const initialDepot = parseFloat(inputs.depotCurrent.value) || 0;

        const depotSparplanTotal = fixkostenItems
          .filter(i => i.target === 'depot')
          .reduce((s, it) => s + getMonthlyAmount(it), 0);

        const { depotOverflow } = calculateOverflow(
          parseFloat(inputs.tagesgeldCurrent.value) || 0,
          parseFloat(inputs.tagesgeldLimit.value) || 0
        );
        const monthlyInvestment = depotSparplanTotal + depotOverflow;

        const toSeries = (rate) => calculateCompoundInterest(initialDepot, monthlyInvestment, years, rate / 100);
        const derivedMin = dataRange ? dataRange.min : (dataRangeRaw ? dataRangeRaw.min : 0);
        const derivedMax = dataRange ? dataRange.max : (dataRangeRaw ? dataRangeRaw.max : derivedMin);
        const derivedMean = dataRange ? dataRange.mean : ((Number.isFinite(derivedMin) && Number.isFinite(derivedMax)) ? (derivedMin + derivedMax) / 2 : derivedMin);

        const sMin = toSeries(derivedMin);
        const sAvg = toSeries(derivedMean);
        const sMax = toSeries(derivedMax);

        const tmpChart = new Chart(ctx, {
          type: 'line',
          data: { labels: sAvg.labels, datasets: [
            { label: 'Pessimistisch', data: sMin.capitalData, borderColor: '#ef4444', fill: false, tension: 0.1 },
            { label: 'Erwartet',      data: sAvg.capitalData, borderColor: '#3b82f6', fill: false, tension: 0.1 },
            { label: 'Optimistisch',  data: sMax.capitalData, borderColor: '#22c55e', fill: false, tension: 0.1 }
          ]},
          options: { responsive: false, animation: false, plugins: { legend: { display: false } } }
        });
        // Sicherstellen, dass gezeichnet wurde
        tmpChart.update();
        const url = tempCanvas.toDataURL('image/png');
        tmpChart.destroy();
        return url;
      } catch (_) {
        return null;
      }
    }

    // Helper: wait for one or more animation frames (lets layout/theme settle)
    async function waitFrames(n = 1) {
      for (let i = 0; i < n; i++) {
        await new Promise(res => requestAnimationFrame(res));
      }
    }

    async function waitForImages(container, timeout = 2500) {
      const imgs = Array.from(container.querySelectorAll('img'));
      const pending = imgs.filter(img => !img.complete || img.naturalWidth === 0);

      if (pending.length === 0) return;

      await Promise.race([
        Promise.all(pending.map(img => new Promise(res => {
          img.addEventListener('load', res, { once: true });
          img.addEventListener('error', res, { once: true }); // not blocking on error
          // Falls das Bild bereits „complete“ ist, sofort auflösen:
          if (img.complete && img.naturalWidth > 0) res();
        }))),
        new Promise(res => setTimeout(res, timeout))
      ]);
    }

    
    function buildBookingPlanPrintHtml() {
        const plan = bookingPlan || {};
        const bucket = plan[String(selectedBookingMonth)] || plan[BOOKING_KEY] || {};
        const days = Object.keys(bucket)
            .map(key => parseInt(key, 10))
            .filter(num => Number.isInteger(num))
            .sort((a, b) => a - b);
        if (!days.length) {
            return `
      <h2>Buchungskalender</h2>
      <p class="muted">Aktuell sind keine Buchungstage hinterlegt.</p>
    `;
        }
        const rows = days.map(dayNum => {
            const key = String(dayNum);
            const entries = Array.isArray(bucket[key]) ? bucket[key] : [];
            const content = entries
                .map(typeId => {
                    const type = getBookingType(typeId);
                    if (!type) return '';
                    const color = type.badgeColor || '#111827';
                    const iconMarkup = getActiveBookingIcon(type) || type.icon || '';
                    const label = getActiveBookingLabel(type) || type.label || '';
                    return `<div class="print-booking-entry"><span class="print-booking-icon" style="color:${color};">${iconMarkup}</span><span>${label}</span></div>`;
                })
                .filter(Boolean)
                .join('') || '<div class="print-booking-entry">-</div>';
            return `<tr><td>Tag ${dayNum}</td><td>${content}</td></tr>`;
        }).join('');
        return `<h2>Buchungskalender</h2><table class="print-table print-table-bookings"><thead><tr><th>Tag</th><th>Aktion</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    async function prepareAndPrint() {
        const report = getEl('printable-report');

        // --- Force LIGHT THEME for export/print snapshot ---
        const prevTheme = loadTheme();           // 'dark' | 'light'
        applyTheme('light');                     // switch UI tokens
        saveTheme('light');

        // Re-render flows so computed styles & erase strokes match light mode
        calculateAndUpdate();
        await waitFrames(3);                     // let DOM/layout settle

        const themeNote = 'MLP Hell';

        // 1) Gather current inputs (after potential UI changes)
        const incomeVal = formatCurrency(inputs.income.value);
        const konsumMinVal = formatCurrency(inputs.konsumMin.value);
        const konsumLeftoverVal = formatCurrency(inputs.konsumLeftover.value);
        const tgCurVal = formatCurrency(inputs.tagesgeldCurrent.value);
        const tgLimitVal = formatCurrency(inputs.tagesgeldLimit.value);
        const depotCurVal = formatCurrency(inputs.depotCurrent.value);
        const jahre = parseInt(inputs.anlagezeitraum.value, 10);
        const renditeAnn = parseFloat(inputs.rendite.value).toFixed(1) + ' %';

        // 2) Export visualizations (always white background)
        const flowImg = await svgToPngDataUrl(getEl('flow-svg'), 1.2, '#ffffff');
        const chartImg = getChartImageDataUrl();

        // 3) Build Fixkosten & Depot tables
        const fixRows = fixkostenItems.map(i => `<tr><td>${i.name}</td><td>${formatCurrency(i.amount)}</td><td>${i.interval}</td><td>${i.target}</td></tr>`).join('');

        // Calculate sum of fixkosten (convert to monthly)
        const fixkostenSumme = fixkostenItems.reduce((sum, i) => {
            const amount = i.amount || 0;
            const monthly = i.interval === 'quarterly' ? amount / 3 : (i.interval === 'annually' ? amount / 12 : amount);
            return sum + monthly;
        }, 0);

        // Get Vermieterkonto data if exists
        const vermieterData = getVermieterkontoData();
        const hasVermieterData = vermieterData && (vermieterData.einnahmen > 0 || vermieterData.ausgaben > 0);

        // Add Vermieterkonto cashflow row if exists
        let vermieterRow = '';
        let vermieterMonthly = 0;
        if (hasVermieterData) {
            const cashflow = vermieterData.saldo;
            vermieterMonthly = Math.abs(cashflow);
            const cashflowText = cashflow >= 0
                ? `<span class="text-positive">+${formatCurrency(cashflow)}</span>`
                : `<span class="text-negative">-${formatCurrency(Math.abs(cashflow))}</span>`;
            const ziel = currentVariant === 'A' ? 'fixkosten' : 'konsum';
            vermieterRow = `<tr><td>Cashflow Vermieterkonto</td><td>${cashflowText}</td><td>monatlich</td><td>${ziel}</td></tr>`;
        }

        // Calculate total including Vermieterkonto
        const fixkostenTotal = fixkostenSumme + (hasVermieterData && vermieterData.saldo < 0 ? Math.abs(vermieterData.saldo) : 0);
        const sumRow = `<tr class="sum-row"><th>Summe (monatlich)</th><th>${formatCurrency(fixkostenTotal)}</th><th colspan="2"></th></tr>`;

        const depRows = depotItems.map(i => {
            const riskLabel = i.risk === 'conservative' ? 'Konservativ' : 'Chancenreich';
            const riskColor = i.risk === 'conservative' ? '#3b82f6' : '#ef4444';
            return `<tr>
                <td><span style="display: inline-block; width: 12px; height: 12px; background: ${i.color}; border-radius: 3px; margin-right: 6px; vertical-align: middle;"></span>${i.name}</td>
                <td>${i.allocation}%</td>
                <td><span style="color: ${riskColor}; font-weight: 600;">${riskLabel}</span></td>
            </tr>`;
        }).join('');

        // 4) Get session data
        const session = getCurrentSession();
        const kundenKuerzel = session?.kundenKuerzel || 'N/A';
        const berater = session?.berater || 'N/A';

        // 5) Compose report HTML (theme-neutral for print)
        let html = `
          <h1>Zusammenfassung: Das intelligente Vermögensmanagement</h1>
          <p class="muted">Planung für: <strong>${kundenKuerzel}</strong> • von: <strong>${berater}</strong></p>
          <p class="muted">Variante: <strong>${currentVariant}</strong> • Theme: <strong>${themeNote}</strong> • Datum: ${new Date().toLocaleDateString('de-DE')}</p>

          <h2>Ihre Planung</h2>
          <table class="print-table">
            <tbody>
              <tr><th style="width:40%">Nettoeinkommen</th><td>${incomeVal}</td></tr>
              <tr><th>Konsumkonto Mindestbestand</th><td>${konsumMinVal}</td></tr>
              <tr><th>Geschätzter monatlicher Überschuss</th><td>${konsumLeftoverVal}</td></tr>
              <tr><th>Tagesgeldkonto (aktuell)</th><td>${tgCurVal}</td></tr>
              <tr><th>Tagesgeldkonto (Sparziel)</th><td>${tgLimitVal}</td></tr>
              <tr><th>Depotstand (aktuell)</th><td>${depotCurVal}</td></tr>
              <tr><th>Anlagezeitraum</th><td>${jahre} Jahre</td></tr>
              <tr><th>Rendite-Annahme</th><td>${renditeAnn}</td></tr>
            </tbody>
          </table>

          <h2>Fixkosten &amp; Sparpläne</h2>
          <table class="print-table"><thead><tr><th>Posten</th><th>Betrag</th><th>Intervall</th><th>Ziel</th></tr></thead><tbody>${fixRows}${vermieterRow}${sumRow}</tbody></table>

          <h2>Depot-Aufteilung</h2>
          <table class="print-table"><thead><tr><th>Fonds/ETF</th><th>Verteilung</th><th>Strategie</th></tr></thead><tbody>${depRows}</tbody></table>
        `;

        // Add Immobilien section if data exists
        if (immobilienData && immobilienData.length > 0) {
            const immoRows = immobilienData.map(immo => {
                const wert = immo.wert || 0;
                const darlehen = immo.darlehen || 0;
                const eigenkapital = wert - darlehen;
                return `<tr><td>${immo.name || 'Objekt'}</td><td>${formatCurrency(wert)}</td><td>${formatCurrency(darlehen)}</td><td>${formatCurrency(eigenkapital)}</td></tr>`;
            }).join('');

            const gesamtwert = immobilienData.reduce((sum, immo) => sum + (immo.wert || 0), 0);
            const gesamtdarlehen = immobilienData.reduce((sum, immo) => sum + (immo.darlehen || 0), 0);
            const gesamtEigenkapital = gesamtwert - gesamtdarlehen;

            const sumRowImmo = `<tr class="sum-row"><th>Gesamt</th><th>${formatCurrency(gesamtwert)}</th><th>${formatCurrency(gesamtdarlehen)}</th><th>${formatCurrency(gesamtEigenkapital)}</th></tr>`;

            html += `
              <h2>Immobilien-Portfolio</h2>
              <table class="print-table">
                <thead><tr><th>Objekt</th><th>Marktwert</th><th>Darlehen</th><th>Eigenkapital</th></tr></thead>
                <tbody>${immoRows}${sumRowImmo}</tbody>
              </table>
            `;

            // Add details about rates and appreciation if available
            if (vermieterkontoData.zinssatz > 0 || vermieterkontoData.wertsteigerung > 0) {
                const details = [];
                if (vermieterkontoData.wertsteigerung > 0) {
                    details.push(`Wertsteigerung: ${vermieterkontoData.wertsteigerung}% p.a.`);
                }
                if (vermieterkontoData.zinssatz > 0) {
                    details.push(`Zinssatz: ${vermieterkontoData.zinssatz}%`);
                }
                if (vermieterkontoData.tilgungssatz > 0) {
                    details.push(`Tilgung: ${vermieterkontoData.tilgungssatz}%`);
                }
                if (details.length > 0) {
                    html += `<p class="muted">${details.join(' • ')}</p>`;
                }
            }
        }

        // Add Vermieterkonto section if data exists
        if (hasVermieterData) {
            const einnahmenRows = [];
            if (vermieterkontoData.miete > 0) {
                einnahmenRows.push(`<tr><td>Mieteinnahmen</td><td class="text-positive">+${formatCurrency(vermieterkontoData.miete)}</td></tr>`);
            }
            if (vermieterkontoData.sonstigeEinnahmen > 0) {
                einnahmenRows.push(`<tr><td>Sonstige Einnahmen</td><td class="text-positive">+${formatCurrency(vermieterkontoData.sonstigeEinnahmen)}</td></tr>`);
            }
            einnahmenRows.push(`<tr class="sum-row"><th>Gesamt-Einnahmen</th><th class="text-positive">+${formatCurrency(vermieterData.einnahmen)}</th></tr>`);

            const ausgabenRows = [];
            if (vermieterkontoData.rate > 0) {
                ausgabenRows.push(`<tr><td>Darlehensrate</td><td class="text-negative">-${formatCurrency(vermieterkontoData.rate)}</td></tr>`);
            }
            if (vermieterkontoData.instandhaltung > 0) {
                ausgabenRows.push(`<tr><td>Instandhaltung</td><td class="text-negative">-${formatCurrency(vermieterkontoData.instandhaltung)}</td></tr>`);
            }
            if (vermieterkontoData.steuern > 0) {
                ausgabenRows.push(`<tr><td>Steuern &amp; Nebenkosten</td><td class="text-negative">-${formatCurrency(vermieterkontoData.steuern)}</td></tr>`);
            }
            ausgabenRows.push(`<tr class="sum-row"><th>Gesamt-Ausgaben</th><th class="text-negative">-${formatCurrency(vermieterData.ausgaben)}</th></tr>`);

            const saldoClass = vermieterData.saldo >= 0 ? 'text-positive' : 'text-negative';
            const saldoSign = vermieterData.saldo >= 0 ? '+' : '-';
            const cashflowRow = `<tr class="sum-row" style="background-color: #f9fafb;"><th>Netto-Cashflow (monatlich)</th><th class="${saldoClass}">${saldoSign}${formatCurrency(Math.abs(vermieterData.saldo))}</th></tr>`;

            html += `
              <h2>Vermieterkonto (Cashflow-Analyse)</h2>
              <table class="print-table">
                <tbody>
                  ${einnahmenRows.join('')}
                  ${ausgabenRows.join('')}
                  ${cashflowRow}
                </tbody>
              </table>
            `;

            // Integration status
            if (vermieterkontoData.cashflowIntegration) {
                html += `<p class="muted">✅ Cashflows sind ins Gesamtsystem integriert</p>`;
            }

            // Tilgung info
            if (vermieterData.tilgung > 0) {
                html += `<p class="muted">ℹ️ Davon Tilgung (Vermögensaufbau): ${formatCurrency(vermieterData.tilgung)}/Monat</p>`;
            }
        }

        html += buildBookingPlanPrintHtml(); // (Überschrift wird unten im <section> gesetzt)
        report.innerHTML = html;

        // Eigene Seite vorbereiten
        const section = document.createElement('section');
        section.className = 'print-finanzfluss';
        // Fallbacks für Browser, die die CSS-Regel ignorieren
        section.style.breakBefore = 'page';
        section.style.pageBreakBefore = 'always';
        section.innerHTML = `<h2>Dein Finanzfluss (aktueller Stand)</h2>`;

        // Live-DOM klonen: Ströme + Konten + Werte
        const live = getEl('flow-container');
        if (live) {
          const clone = live.cloneNode(true);
          clone.id = 'flow-container-print';

          // Interaktivität entfernen (keine Modals im Print)
          clone.querySelectorAll('[onclick]').forEach(n => n.removeAttribute('onclick'));

          // Deterministische Größe wie im Live-UI
          const cs = getComputedStyle(live);
          clone.style.position = 'relative';
          clone.style.minHeight = cs.minHeight || '1150px';
          clone.style.height    = cs.height || '1150px';
          // NO width constraint - let print CSS handle scaling

          const holder = document.createElement('div');
          holder.style.marginTop = '8px';
          holder.appendChild(clone);
          section.appendChild(holder);
        }

        // Abschnitt (eigene Seite) anhängen
        report.appendChild(section);

        // v1.7.2: Add educational modules if they were discussed
        const currentSession = getCurrentSession();
        if (currentSession?.erklaererBesucht) {
            // Cost-Average-Effekt Erklärer
            if (currentSession.erklaererBesucht.costAverage) {
                const caSection = document.createElement('section');
                caSection.className = 'print-erklaerer';
                caSection.style.breakBefore = 'page';
                caSection.style.pageBreakBefore = 'always';
                caSection.innerHTML = `
                    <h2>✅ Besprochenes Thema: Cost-Average-Effekt</h2>
                    <p class="muted">Dieses Thema wurde in der Beratung erklärt und demonstriert.</p>
                    <div class="erklaerer-summary">
                        <h3>Kernaussage</h3>
                        <p>Der Cost-Average-Effekt (Durchschnittskosteneffekt) zeigt, dass regelmäßiges Sparen in volatilen Märkten
                        oft bessere Ergebnisse liefert als eine einmalige Investition. Bei fallenden Kursen kaufen Sie automatisch
                        mehr Anteile, bei steigenden Kursen weniger - Ihr Durchschnittspreis sinkt.</p>

                        <h3>Vergleich der Szenarien</h3>
                        <ul>
                            <li><strong>Szenario A (Konstanter Kurs):</strong> Baseline-Vergleich mit stabilem Markt</li>
                            <li><strong>Szenario B (Volatiler Kurs):</strong> Zeigt den Vorteil bei Kursschwankungen</li>
                        </ul>

                        <h3>Praktische Anwendung</h3>
                        <p>✓ Monatliche Sparrate ins Depot einrichten<br>
                        ✓ Nicht bei Crashs verkaufen - weiter sparen!<br>
                        ✓ Langfristiger Anlagehorizont (10+ Jahre)<br>
                        ✓ Emotionen ausschalten, System beibehalten</p>
                    </div>
                `;
                report.appendChild(caSection);
            }

            // Sequence of Returns Risk Erklärer
            if (currentSession.erklaererBesucht.sorr) {
                const sorrSection = document.createElement('section');
                sorrSection.className = 'print-erklaerer';
                sorrSection.style.breakBefore = 'page';
                sorrSection.style.pageBreakBefore = 'always';
                sorrSection.innerHTML = `
                    <h2>✅ Besprochenes Thema: Sequence of Returns Risk</h2>
                    <p class="muted">Dieses Thema wurde in der Beratung erklärt und demonstriert.</p>
                    <div class="erklaerer-summary">
                        <h3>Kernaussage</h3>
                        <p>Das Reihenfolge-Risiko (Sequence of Returns Risk) ist eines der größten Risiken in der Entnahmephase.
                        Selbst bei identischer Durchschnittsrendite kann die <strong>Reihenfolge</strong> der Renditen über
                        "Reichtum" oder "Pleite" entscheiden.</p>

                        <h3>Vergleich der Szenarien</h3>
                        <ul>
                            <li><strong>Historisch (2005-2024):</strong> Crash am Anfang (2008), starke Erholung</li>
                            <li><strong>Best-First (2009→2008):</strong> Beste Renditen zuerst, schlechteste am Ende</li>
                            <li><strong>Worst-First:</strong> Schlechteste Jahre zuerst (-40% im ersten Jahr!)</li>
                        </ul>

                        <h3>Praktische Lösung</h3>
                        <p><strong>Liquiditätsreserve aufbauen:</strong><br>
                        ✓ Tagesgeld/Festgeld für 2-3 Jahre Entnahmen<br>
                        ✓ Bei Crash: Aus Reserve leben, Depot erholen lassen<br>
                        ✓ Bei guten Jahren: Reserve wieder auffüllen<br>
                        ✓ So vermeiden Sie Verkäufe zu ungünstigen Zeitpunkten</p>

                        <p class="muted"><strong>Wichtig:</strong> Frühe Verluste in der Entnahmephase wiegen doppelt schwer,
                        da sich das entnommene Geld nie wieder erholen kann. Eine Kriegskasse schützt Sie vor diesem Risiko.</p>
                    </div>
                `;
                report.appendChild(sorrSection);
            }
        }

        // NEU: sicherstellen, dass die <img>-Tags wirklich fertig sind
        await waitForImages(report, 2500);
        await waitFrames(1); // ein Frame für Layout

        // 5) Print
        const restoreTheme = () => {
          // Restore theme
          applyTheme(prevTheme || 'light');
          saveTheme(prevTheme || 'light');
          calculateAndUpdate();
        };
        const onAfterPrint = () => { window.removeEventListener('afterprint', onAfterPrint); restoreTheme(); };
        window.addEventListener('afterprint', onAfterPrint);
        window.print();
    }
    
    // --- THEME HANDLING (Dark/MLP Light) ---
    function applyTheme(theme) {
        const root = document.getElementById('theme-root');
        if (!root) return;
        root.classList.remove('theme-dark','theme-light');
        root.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

        // Flow gradient colors adapt to theme
        const grad = document.querySelector('#flow-gradient');
        if (grad) {
            const stops = grad.querySelectorAll('stop');
            if (stops.length >= 2) {
                if (theme === 'light') {
                    // Pure MLP blue stream
                    stops[0].setAttribute('style', 'stop-color: var(--mlp-blue-1);');
                    stops[1].setAttribute('style', 'stop-color: var(--mlp-blue-1);');
                } else {
                    // v2.0: MLP Blau Dark + Türkis statt Tailwind Blue/Indigo
                    stops[0].setAttribute('style', 'stop-color: #033D5D;');
                    stops[1].setAttribute('style', 'stop-color: #47A190;');
                }
            }
        }
    }
    function loadTheme() {
        try { return localStorage.getItem('vd_theme') || 'light'; } catch(_) { return 'light'; }
    }
    function saveTheme(theme) {
        try { localStorage.setItem('vd_theme', theme); } catch(_) {}
    }

    // ===== KEYBOARD SHORTCUTS & EMERGENCY ACCESS (v1.3.8) =====

    // Global keyboard shortcuts for critical functions
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Shift + E = Emergency JSON Export
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            console.log('🚨 Emergency Export triggered via keyboard');
            exportAsJSON(false);
            showToast('Notfall-Export erstellt!', 'success', 3000);
        }

        // Ctrl/Cmd + Shift + D = Emergency Print/PDF (D wie Druck)
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            console.log('🚨 Emergency Print triggered via keyboard');
            prepareAndPrint();
        }

        // Ctrl/Cmd + Shift + S = Show Session Menu (even if hidden)
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            const buttonContainer = getEl('session-button-container');
            if (buttonContainer) {
                buttonContainer.style.display = 'block';
                toggleSessionMenu();
                console.log('🚨 Session-Menü erzwungen (Notfall-Zugriff)');
            }
        }

        // Ctrl/Cmd + Shift + C = Export CSV
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            console.log('🚨 Emergency CSV Export triggered via keyboard');
            exportAsCSV();
            showToast('CSV-Export erstellt!', 'success', 3000);
        }
    });

    // Console helper functions (accessible via browser console)
    window.mlpEmergency = {
        exportJSON: () => {
            exportAsJSON(false);
            console.log('✅ JSON-Export erstellt');
        },
        exportCSV: () => {
            exportAsCSV();
            console.log('✅ CSV-Export erstellt');
        },
        print: () => {
            prepareAndPrint();
            console.log('✅ Druck-Dialog geöffnet');
        },
        showSession: () => {
            const buttonContainer = getEl('session-button-container');
            if (buttonContainer) buttonContainer.style.display = 'block';
            toggleSessionMenu();
            console.log('✅ Session-Menü angezeigt');
        },
        help: () => {
            console.log(`
🚨 MLP NOTFALL-FUNKTIONEN:

Keyboard-Shortcuts:
- Ctrl+Shift+E: JSON-Export
- Ctrl+Shift+C: CSV-Export
- Ctrl+Shift+D: PDF drucken (D = Druck)
- Ctrl+Shift+S: Session-Menü öffnen

Console-Commands:
- mlpEmergency.exportJSON()  → JSON exportieren
- mlpEmergency.exportCSV()   → CSV exportieren
- mlpEmergency.print()       → PDF drucken
- mlpEmergency.showSession() → Session-Menü zeigen
- mlpEmergency.help()        → Diese Hilfe

Diese Funktionen funktionieren auch wenn das UI nicht reagiert!
            `);
        }
    };

    // Show help on load
    console.log('💡 Notfall-Zugriff: mlpEmergency.help() für Hilfe');

    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        // === SESSION INITIALIZATION (v1.2.0) ===

        // Initialize File System Access API (v1.3.7)
        restoreAutoExportDirectory();

        // Check for existing session or show start dialog
        const existingSession = getCurrentSession();

        // Check if we just imported a backup (skip recovery dialog)
        const skipRecovery = sessionStorage.getItem('skipRecoveryDialog');
        if (skipRecovery) {
            sessionStorage.removeItem('skipRecoveryDialog');
            // Imported session - continue directly without asking
            if (existingSession) {
                updateSessionInfoBar();
                startSessionTimer();
                resetInactivityTimers();
                console.log('📥 Importierte Session fortgesetzt:', existingSession.id);
            }
        } else if (existingSession) {
            // Session found - show recovery dialog
            const sessionAge = new Date() - new Date(existingSession.startzeit);
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours

            if (sessionAge > maxAge) {
                // Session too old, discard and start new
                sessionStorage.clear();
                showSessionStartDialog();
            } else {
                // Session valid, offer recovery
                showSessionRecoveryDialog(existingSession);
            }
        } else {
            // No session, show start dialog
            showSessionStartDialog();
        }
        // === END SESSION INITIALIZATION ===

        inputs = { income: getEl('income'), konsumMin: getEl('konsumMin'), konsumLeftover: getEl('konsumLeftover'), tagesgeldCurrent: getEl('tagesgeldCurrent'), tagesgeldLimit: getEl('tagesgeldLimit'), depotCurrent: getEl('depotCurrent'), anlagezeitraum: getEl('anlagezeitraum'), rendite: getEl('rendite') };

        // Restore input values from sessionStorage (after import reload)
        try {
            const savedInputs = sessionStorage.getItem('mlp_inputs');
            if (savedInputs) {
                const inputValues = JSON.parse(savedInputs);
                if (inputs.income) inputs.income.value = inputValues.income || 3000;
                if (inputs.konsumMin) inputs.konsumMin.value = inputValues.konsumMin || 100;
                if (inputs.konsumLeftover) inputs.konsumLeftover.value = inputValues.konsumLeftover || 250;
                if (inputs.tagesgeldCurrent) inputs.tagesgeldCurrent.value = inputValues.tagesgeldCurrent || 4800;
                if (inputs.tagesgeldLimit) inputs.tagesgeldLimit.value = inputValues.tagesgeldLimit || 5000;
                if (inputs.depotCurrent) inputs.depotCurrent.value = inputValues.depotCurrent || 25000;
                if (inputs.anlagezeitraum) inputs.anlagezeitraum.value = inputValues.anlagezeitraum || 15;
                if (inputs.rendite) inputs.rendite.value = inputValues.rendite || 7;
                console.log('✅ Input-Werte aus sessionStorage wiederhergestellt');
                // Clear after restore to prevent stale data
                sessionStorage.removeItem('mlp_inputs');
            }
        } catch (e) {
            console.error('Fehler beim Laden der Input-Werte aus sessionStorage:', e);
        }

        basins = { einkommen: getEl('einkommen-basin'), fixkosten: getEl('fixkosten-basin'), konsum: getEl('konsum-basin'), tagesgeld: getEl('tagesgeld-basin'), depot: getEl('depot-basin'), vermieterkonto: getEl('vermieterkonto-basin'), immobilien: getEl('immobilien-basin') };
        flowContainer = getEl('flow-container');
        flowSvg = getEl('flow-svg');
        setupBookingPlanner();

        // v1.6.1: Initialize Schutzschild click handler
        initSchutzschildClickHandler();

        // v1.6.1 Level 2: Initialize Schutzschild hover tooltip
        initSchutzschildTooltip();

        // THEME init
        const themeSwitch = getEl('theme-switch');
        const initialTheme = loadTheme(); // 'dark' | 'light'
        applyTheme(initialTheme);
        if (themeSwitch) {
            // checked == Dark (rechts), unchecked == MLP Light (links)
            themeSwitch.checked = (initialTheme === 'dark');
            themeSwitch.addEventListener('change', (e) => {
                const t = e.target.checked ? 'dark' : 'light';
                applyTheme(t);
                saveTheme(t);
                // Nach Themewechsel neu zeichnen
                calculateAndUpdate();
            });
        }

        // AUTO-SAVE TOGGLE init
        const autoSaveToggle = getEl('auto-save-toggle');
        if (autoSaveToggle) {
            // Initialize UI based on saved preference
            updateAutoSaveUI();

            // Add event listener
            autoSaveToggle.addEventListener('change', (e) => {
                toggleAutoSave(e.target.checked);
            });
        }

        const anlagezeitraumLabel = getEl('anlagezeitraum-label');
        const variantSwitch = getEl('variant-switch');
        const varianteALabel = getEl('variante-a-label');
        const varianteBLabel = getEl('variante-b-label');
        const variantInfo = getEl('variant-info');

        function setVariantUI() {
            if (variantSwitch) {
                variantSwitch.checked = (currentVariant === 'B');
            }
            // Sync control bar switch
            const barSwitch = getEl('variant-switch-bar');
            if (barSwitch) barSwitch.checked = (currentVariant === 'B');
            // Sync control bar labels
            const aBar = getEl('variante-a-label-bar');
            const bBar = getEl('variante-b-label-bar');
            if (aBar && bBar) {
                if (currentVariant === 'A') {
                    aBar.classList.add('bar-state--active');
                    bBar.classList.remove('bar-state--active');
                } else {
                    bBar.classList.add('bar-state--active');
                    aBar.classList.remove('bar-state--active');
                }
            }
            if (currentVariant === 'A') {
                if (varianteALabel) varianteALabel.classList.add('chip-state--active');
                if (varianteBLabel) varianteBLabel.classList.remove('chip-state--active');
                if (variantInfo) variantInfo.textContent = 'Variante A: Einkommen geht auf das Fixkostenkonto.';
            } else {
                if (varianteBLabel) varianteBLabel.classList.add('chip-state--active');
                if (varianteALabel) varianteALabel.classList.remove('chip-state--active');
                if (variantInfo) variantInfo.textContent = 'Variante B: Einkommen geht auf das Konsumkonto.';
            }
            renderBookingTypeButtons();
            renderBookingCalendar();
            updateBookingHint();
            renderBookingTimeline(); // v1.7.3
            // Keep consultation view consistent when variant changes
            applyConsultationVisibility();
            calculateAndUpdate();
        }

        if (variantSwitch) {
            variantSwitch.addEventListener('change', (e) => {
                currentVariant = e.target.checked ? 'B' : 'A';
                sessionStorage.setItem('mlp_current_variant', currentVariant);
                setVariantUI();
            });
        }

        const observer = new ResizeObserver(() => calculateAndUpdate());
        observer.observe(flowContainer);
        
        setTimeout(() => {
            renderFixkostenList();
            renderDepotList();
            loadImmobilienData();        // Immobilien-Daten laden
            setupImmobilienListeners();  // Event-Listener für Immobilien-Inputs
            loadVermieterkontoData();    // Vermieterkonto-Daten laden
            setupVermieterkontoListeners(); // Event-Listener für Vermieterkonto-Inputs
            setVariantUI();
            updateRenditeSuggestions(parseInt(inputs.anlagezeitraum.value, 10));
            calculateAndUpdate();
            renderBookingTimeline(); // v1.7.3: Initial timeline render

            // Load fine-grained min/max ranges from TXT (MLP-Dreieck)
            loadRenditeExtremes();

            // Helper function to update range slider fill (v1.5.0)
            function updateRangeSliderFill(slider) {
                if (!slider) return;
                const min = parseInt(slider.min) || 0;
                const max = parseInt(slider.max) || 100;
                const value = parseInt(slider.value) || 0;
                const percentage = ((value - min) / (max - min)) * 100;

                const color1 = getComputedStyle(document.documentElement).getPropertyValue('--mlp-blue').trim() || '#002f6c';
                const color2 = document.body.classList.contains('theme-light') ? '#e5e7eb' : 'rgba(100, 116, 139, 0.3)';

                slider.style.background = `linear-gradient(to right, ${color1} 0%, ${color1} ${percentage}%, ${color2} ${percentage}%, ${color2} 100%)`;
            }

            // Keep info live while sliding (v1.5.0 - with null-check)
            if (inputs.anlagezeitraum) {
                inputs.anlagezeitraum.addEventListener('input', () => {
                    const jahre = parseInt(inputs.anlagezeitraum.value, 10);
                    const label = getEl('anlagezeitraum-label');
                    if (label) label.textContent = `${jahre} Jahre`;
                    updateRenditeSuggestions(jahre);
                    // Update slider fill dynamically
                    updateRangeSliderFill(inputs.anlagezeitraum);
                    // Auto-Prognose (v1.4.0)
                    debouncedProjection();
                });

                // Initialize slider fill AND label on load (v1.5.0 fix)
                const currentValue = parseInt(inputs.anlagezeitraum.value, 10);
                const label = getEl('anlagezeitraum-label');
                if (label) label.textContent = `${currentValue} Jahre`;
                updateRangeSliderFill(inputs.anlagezeitraum);
            } else {
                console.error('[MLP ERROR] Anlagezeitraum slider not found!');
            }

            // ===== AUTO-PROGNOSE (v1.4.0) =====
            // Auto-calculate projection on depot input changes
            if (inputs.depotCurrent) {
                inputs.depotCurrent.addEventListener('input', () => {
                    debouncedProjection();
                });
            }
            if (inputs.rendite) {
                inputs.rendite.addEventListener('input', () => {
                    debouncedProjection();
                });
            }

            // Beratungsansicht Buttons (Old - Sidebar)
            const consultToggle = getEl('consult-toggle-btn');
            const consultNext   = getEl('consult-next-btn');
            if (consultToggle) consultToggle.addEventListener('click', () => setConsultationMode(!consultationMode));
            if (consultNext)   consultNext.addEventListener('click', () => nextConsultationStep());

            // ===== INLINE EDITOR EVENT LISTENERS (v1.4.0) =====
            // Add click listeners to editable basins
            if (basins.einkommen) {
                basins.einkommen.addEventListener('click', (e) => {
                    // Only open if not already editing
                    if (!basins.einkommen.querySelector('.basin-inline-editor')) {
                        openInlineEditor(e, 'einkommen');
                    }
                });
            }
            if (basins.konsum) {
                basins.konsum.addEventListener('click', (e) => {
                    if (!basins.konsum.querySelector('.basin-inline-editor')) {
                        openInlineEditor(e, 'konsum');
                    }
                });
            }
            if (basins.tagesgeld) {
                basins.tagesgeld.addEventListener('click', (e) => {
                    if (!basins.tagesgeld.querySelector('.basin-inline-editor')) {
                        openInlineEditor(e, 'tagesgeld');
                    }
                });
            }

            // ===== CONTROL BAR EVENT LISTENERS (v1.4.0) =====
            // Theme Toggle
            const themeSwitchBar = getEl('theme-switch-bar');
            if (themeSwitchBar) {
                themeSwitchBar.checked = (initialTheme === 'dark');
                themeSwitchBar.addEventListener('change', (e) => {
                    const t = e.target.checked ? 'dark' : 'light';
                    applyTheme(t);
                    saveTheme(t);
                    calculateAndUpdate();
                    // Sync with old sidebar switch
                    if (themeSwitch) themeSwitch.checked = e.target.checked;
                });
            }

            // Variant Toggle
            const variantSwitchBar = getEl('variant-switch-bar');
            const varianteALabelBar = getEl('variante-a-label-bar');
            const varianteBLabelBar = getEl('variante-b-label-bar');
            if (variantSwitchBar) {
                variantSwitchBar.addEventListener('change', (e) => {
                    currentVariant = e.target.checked ? 'B' : 'A';
                    sessionStorage.setItem('mlp_current_variant', currentVariant);
                    // Update Control Bar UI
                    if (varianteALabelBar && varianteBLabelBar) {
                        if (currentVariant === 'A') {
                            varianteALabelBar.classList.add('bar-state--active');
                            varianteBLabelBar.classList.remove('bar-state--active');
                        } else {
                            varianteBLabelBar.classList.add('bar-state--active');
                            varianteALabelBar.classList.remove('bar-state--active');
                        }
                    }
                    // Update old sidebar UI
                    setVariantUI();
                    // Sync with old sidebar switch
                    if (variantSwitch) variantSwitch.checked = e.target.checked;
                });
            }

            // Consultation Buttons
            const consultToggleBar = getEl('consult-toggle-btn-bar');
            const consultNextBar = getEl('consult-next-btn-bar');
            if (consultToggleBar) {
                consultToggleBar.addEventListener('click', () => {
                    setConsultationMode(!consultationMode);
                });
            }
            if (consultNextBar) {
                consultNextBar.addEventListener('click', () => {
                    nextConsultationStep();
                });
            }

            // ===== BOOKING FAB (v1.4.0) =====
            const bookingFab = getEl('booking-fab');
            const bookingModal = getEl('booking-modal');

            if (bookingFab) {
                bookingFab.addEventListener('click', () => {
                    console.log('📅 Booking FAB clicked');
                    openBookingModal();
                });
            } else {
                console.error('❌ Booking FAB not found!');
            }

            // Close modal on backdrop click
            if (bookingModal) {
                bookingModal.addEventListener('click', (e) => {
                    if (e.target === bookingModal) {
                        closeBookingModal();
                    }
                });
            }

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && bookingModal && bookingModal.classList.contains('active')) {
                    closeBookingModal();
                }
            });
        }, 100);
    });

    // ===== DEV TOOL: Basin Drag-and-Drop Positionierung (Ctrl+Alt+F12) =====
    (function() {
        let dragMode = false;
        let dragTarget = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let overlay = null;
        let infoPanel = null;

        function toggleDragMode() {
            dragMode = !dragMode;
            if (dragMode) { enableDragMode(); } else { disableDragMode(); }
        }

        function enableDragMode() {
            const fc = document.getElementById('flow-container');
            if (!fc) return;
            _devDragMode = true;
            overlay = document.createElement('div');
            overlay.id = 'dev-grid-overlay';
            overlay.style.cssText = 'position:absolute;inset:0;pointer-events:none;z-index:5;' +
                'background-image:linear-gradient(rgba(96,165,250,0.08) 1px,transparent 1px),linear-gradient(90deg,rgba(96,165,250,0.08) 1px,transparent 1px);' +
                'background-size:40px 40px;';
            fc.appendChild(overlay);
            infoPanel = document.createElement('div');
            infoPanel.id = 'dev-info-panel';
            infoPanel.style.cssText = 'position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:9999;' +
                'background:#1e293b;border:2px solid #60a5fa;border-radius:12px;padding:16px 24px;' +
                'font-family:ui-monospace,monospace;font-size:13px;color:#e2e8f0;max-width:700px;width:90%;';
            infoPanel.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
                '<span style="font-weight:bold;color:#60a5fa;">Basin Positionierung (Drag & Drop)</span>' +
                '<div>' +
                '<button id="dev-copy-btn" style="background:#3b82f6;color:white;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;margin-right:8px;font-size:13px;">Positionen kopieren</button>' +
                '<button id="dev-close-btn" style="background:#ef4444;color:white;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;">Schlie\u00dfen</button>' +
                '</div></div>' +
                '<div id="dev-positions" style="font-size:12px;line-height:1.8;color:#94a3b8;"></div>';
            document.body.appendChild(infoPanel);
            document.getElementById('dev-copy-btn').addEventListener('click', copyPositions);
            document.getElementById('dev-close-btn').addEventListener('click', toggleDragMode);
            var basinIds = ['einkommen-basin','fixkosten-basin','konsum-basin','tagesgeld-basin','depot-basin','vermieterkonto-basin','immobilien-basin'];
            basinIds.forEach(function(id) {
                var el = document.getElementById(id);
                if (!el) return;
                el.style.cursor = 'grab';
                el.style.outline = '2px dashed rgba(96,165,250,0.5)';
                el.setAttribute('data-draggable', 'true');
            });
            fc.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            updatePositionDisplay();
        }

        function disableDragMode() {
            _devDragMode = false;
            if (overlay) { overlay.remove(); overlay = null; }
            if (infoPanel) { infoPanel.remove(); infoPanel = null; }
            var els = document.querySelectorAll('[data-draggable]');
            els.forEach(function(el) { el.style.cursor = ''; el.style.outline = ''; el.removeAttribute('data-draggable'); });
            var fc = document.getElementById('flow-container');
            if (fc) fc.removeEventListener('mousedown', onMouseDown);
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        function onMouseDown(e) {
            var el = e.target.closest('[data-draggable]');
            if (!el) return;
            e.preventDefault();
            dragTarget = el;
            el.style.cursor = 'grabbing';
            el.style.zIndex = '100';
            dragOffsetX = e.clientX - el.getBoundingClientRect().left;
            dragOffsetY = e.clientY - el.getBoundingClientRect().top;
        }

        function onMouseMove(e) {
            if (!dragTarget) return;
            var fc = document.getElementById('flow-container');
            if (!fc) return;
            var fcRect = fc.getBoundingClientRect();
            var newLeft = Math.round((e.clientX - fcRect.left - dragOffsetX) / 8) * 8;
            var newTop = Math.round((e.clientY - fcRect.top - dragOffsetY) / 8) * 8;
            dragTarget.style.left = newLeft + 'px';
            dragTarget.style.top = newTop + 'px';
            updatePositionDisplay();
        }

        function onMouseUp() {
            if (dragTarget) { dragTarget.style.cursor = 'grab'; dragTarget.style.zIndex = '10'; dragTarget = null; }
        }

        function getBasinPositions() {
            var fc = document.getElementById('flow-container');
            if (!fc) return {};
            var names = { 'einkommen-basin':'einkommen', 'fixkosten-basin':'fixkosten', 'konsum-basin':'konsum', 'tagesgeld-basin':'tagesgeld', 'depot-basin':'depot', 'vermieterkonto-basin':'vermieterkonto', 'immobilien-basin':'immobilien' };
            var result = {};
            Object.keys(names).forEach(function(id) { var el = document.getElementById(id); if (el) result[names[id]] = { top: parseInt(el.style.top) || 0, left: parseInt(el.style.left) || 0 }; });
            return result;
        }

        function updatePositionDisplay() {
            var posDiv = document.getElementById('dev-positions');
            if (!posDiv) return;
            var pos = getBasinPositions();
            var lines = [];
            ['einkommen','konsum','fixkosten','vermieterkonto','tagesgeld','depot','immobilien'].forEach(function(name) {
                if (pos[name]) lines.push('<span style="color:#60a5fa;font-weight:600;">' + name + '</span>: top: <span style="color:#fbbf24;">' + pos[name].top + '</span>, left: <span style="color:#fbbf24;">' + pos[name].left + '</span>');
            });
            posDiv.innerHTML = lines.join('<br>');
        }

        function copyPositions() {
            var pos = getBasinPositions();
            var code = 'positions = {\n';
            ['einkommen','konsum','fixkosten','vermieterkonto','tagesgeld','depot','immobilien'].forEach(function(name) {
                if (pos[name]) code += '                ' + name + ': '.padEnd(16 - name.length) + '{ top: ' + pos[name].top + ', left: ' + pos[name].left + ' },\n';
            });
            code += '            };';
            navigator.clipboard.writeText(code).then(function() {
                var btn = document.getElementById('dev-copy-btn');
                btn.textContent = 'Kopiert!';
                btn.style.background = '#22c55e';
                setTimeout(function() { btn.textContent = 'Positionen kopieren'; btn.style.background = '#3b82f6'; }, 2000);
            });
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.altKey && e.key === 'F12') {
                e.preventDefault();
                toggleDragMode();
            }
        });
    })();

    </script>

    <!-- ===== SESSION UI ELEMENTS (v1.2.0) ===== -->

    <!-- Elegant Session Button (Top Left) -->
    <div id="session-button-container" style="display: none;" class="fixed top-4 left-4 z-50">
        <button onclick="toggleSessionMenu()" id="session-menu-button" class="group bg-gray-800 bg-opacity-80 backdrop-blur-sm hover:bg-opacity-95 text-gray-300 hover:text-white px-3 py-2 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2 border border-gray-700 hover:border-gray-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span class="text-xs font-medium">Session</span>
            <svg id="session-menu-chevron" class="w-3 h-3 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>

        <!-- Dropdown Menu -->
        <div id="session-dropdown" style="display: none;" class="absolute top-full left-0 mt-2 w-72 bg-gray-800 bg-opacity-95 backdrop-blur-md rounded-lg shadow-2xl border border-gray-700 overflow-hidden">
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Session-ID</span>
                    <span id="session-id-display" class="text-xs font-mono text-white bg-gray-900 px-2 py-1 rounded">-</span>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Kunde</span>
                    <span id="session-kunden-display" class="text-xs text-white">-</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Dauer</span>
                    <span id="session-timer" class="text-xs font-semibold text-green-400">0 Min.</span>
                </div>
            </div>
            <!-- v1.7.2: Educational Modules Status -->
            <div class="p-2 border-b border-gray-700">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2">Besprochene Erklärer</div>
                <div class="px-3 py-2 space-y-2">
                    <div class="flex items-center gap-2">
                        <span id="erklaerer-ca-icon" class="text-gray-600">⭕</span>
                        <span class="text-xs text-gray-400">Cost-Average-Effekt</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="erklaerer-sorr-icon" class="text-gray-600">⭕</span>
                        <span class="text-xs text-gray-400">Sequence of Returns Risk</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="erklaerer-anleihen-icon" class="text-gray-600">⭕</span>
                        <span class="text-xs text-gray-400">Aktien & Anleihen</span>
                    </div>
                </div>
                <p class="text-xs text-gray-500 px-3 mt-2">✅ = im PDF enthalten</p>
            </div>
            <div class="p-2 border-b border-gray-700">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2">Auto-Export</div>
                <div class="px-3 py-2 mb-2">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs text-gray-400">Automatische Speicherung</span>
                        <label class="switch">
                            <input type="checkbox" id="auto-save-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between text-xs mb-2">
                        <span class="text-gray-400">Zielordner:</span>
                        <span id="auto-export-folder-display" class="font-mono text-xs">
                            <span class="text-gray-400">📥 Download-Ordner</span>
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">Letzter Export:</span>
                        <span id="auto-export-status" class="font-mono">
                            <span class="text-yellow-400">⏳ Wartet...</span>
                        </span>
                    </div>
                    <p id="auto-save-interval-info" class="text-xs text-gray-500 mt-2">Automatisch alle 2 Minuten</p>
                </div>
                <button onclick="selectAutoExportDirectory();" class="w-full text-left px-3 py-2 mb-1 text-sm text-blue-400 hover:bg-blue-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                    Ordner auswählen
                </button>
                <button onclick="exportAsJSON(true); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-green-400 hover:bg-green-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Jetzt exportieren
                </button>
            </div>
            <div class="p-2 border-b border-gray-700">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2">Manueller Export</div>
                <button onclick="exportAsCSV(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:bg-opacity-50 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Als CSV exportieren
                </button>
                <button onclick="exportAsJSON(false); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:bg-opacity-50 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
                    </svg>
                    Als JSON exportieren
                </button>
                <button onclick="exportAsExcel(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-blue-400 hover:bg-blue-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Als Excel exportieren
                </button>
                <button onclick="prepareAndPrint(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:bg-opacity-50 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Als PDF drucken
                </button>
            </div>
            <div class="p-2 border-b border-gray-700">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2">Import</div>
                <button onclick="importSessionBackup(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-blue-400 hover:bg-blue-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Session importieren
                </button>
            </div>
            <div class="p-2">
                <button onclick="showSessionEndDialog(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-red-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    Session beenden
                </button>
            </div>
            <div class="px-3 py-2 border-t border-gray-700">
                <div class="text-xs text-gray-500 text-center">
                    <span class="font-mono">v1.7.8</span>
                </div>
                <div class="text-xs text-gray-600 text-center mt-1">
                    Notfall: <kbd class="text-xs">Ctrl+Shift+E</kbd>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CONTROL BAR (v1.4.0) ===== -->
    <div id="control-bar">
        <!-- Theme Toggle -->
        <label class="control-bar-item control-bar-item--theme" title="Darstellung wechseln">
            <input type="checkbox" id="theme-switch-bar" aria-label="Theme umschalten (Hell/Dunkel)">
            <span class="bar-icon" aria-hidden="true">
                <svg class="icon icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="4" />
                    <path d="M12 2v2" />
                    <path d="M12 20v2" />
                    <path d="M4.93 4.93l1.42 1.42" />
                    <path d="M17.65 17.65l1.42 1.42" />
                    <path d="M2 12h2" />
                    <path d="M20 12h2" />
                    <path d="M4.93 19.07l1.42-1.42" />
                    <path d="M17.65 6.35l1.42-1.42" />
                </svg>
                <svg class="icon icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79z" />
                </svg>
            </span>
        </label>

        <!-- Variant Toggle (A/B) -->
        <label class="control-bar-item control-bar-item--variant" title="Variante A/B umschalten">
            <input type="checkbox" id="variant-switch-bar" aria-label="Variante A/B umschalten">
            <span class="bar-pair" aria-hidden="true">
                <span id="variante-a-label-bar" class="bar-state bar-state--active">A</span>
                <span id="variante-b-label-bar" class="bar-state">B</span>
            </span>
        </label>

        <!-- Consultation Button -->
        <div class="control-bar-item control-bar-item--consultation" title="Beratung">
            <button id="consult-toggle-btn-bar" class="bar-button" type="button" aria-label="Beratung starten">
                <svg class="icon icon-mlp" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="10" cy="12" r="5.5" stroke="currentColor" stroke-width="1.6" fill="none" />
                    <path d="M10 8.5v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                    <path d="M18 7h3v10h-3z" fill="currentColor" />
                </svg>
            </button>
            <button id="consult-next-btn-bar" class="bar-button hidden" type="button" aria-label="Weiter zur naechsten Beratungsphase" title="Weiter zur naechsten Beratungsphase">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14" />
                    <path d="M13 6l6 6-6 6" />
                </svg>
            </button>
        </div>
    </div>

    <!-- ===== BOOKING FAB (v1.4.0) ===== -->
    <button id="booking-fab" aria-label="Buchungskalender öffnen">
        <span class="fab-label">Buchungskalender</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
    </button>

    <!-- Booking Modal -->
    <div id="booking-modal">
        <div class="booking-modal-content">
            <div class="booking-modal-header">
                <h2>Buchungskalender</h2>
                <button class="booking-modal-close" onclick="closeBookingModal()" aria-label="Schließen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="booking-modal-body" id="booking-modal-body">
                <!-- Content will be moved here from sidebar -->
            </div>
        </div>
    </div>

    <!-- Session Start Dialog -->
    <div id="session-start-dialog" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Neue Beratung beginnen</h2>
            <p class="text-gray-300 mb-6">
                Starten Sie eine neue Beratungssession. Alle Daten werden nur während der Session gespeichert und beim Schließen automatisch gelöscht.
            </p>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="session-kunden-kuerzel" class="block text-sm font-semibold text-gray-300 mb-2">
                        Kundenkürzel (optional)
                    </label>
                    <input type="text" id="session-kunden-kuerzel"
                           placeholder="z.B. MX-2025-001"
                           class="mlp-session-input">
                    <p class="text-xs text-gray-500 mt-1">Für interne Zuordnung. Keine persönlichen Daten!</p>
                </div>

                <div>
                    <label for="session-berater" class="block text-sm font-semibold text-gray-300 mb-2">
                        Berater (optional)
                    </label>
                    <input type="text" id="session-berater"
                           placeholder="Ihr Name"
                           class="mlp-session-input">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="startSessionFromDialog()" class="mlp-btn mlp-btn-primary flex-1 py-3 px-6 text-base">
                    Session starten
                </button>
            </div>

            <div class="mt-4">
                <div class="text-center">
                    <span class="text-gray-500 text-sm">oder</span>
                </div>
                <button onclick="importSessionBackup(); closeModal('session-start-dialog');" class="mlp-btn mlp-btn-tertiary w-full mt-3 py-3 px-6 text-base">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Session-Backup importieren
                </button>
            </div>

            <div id="privacy-notice-box" class="mt-4 p-4 rounded-lg" style="background: rgba(3,61,93,0.15);">
                <p class="text-sm text-gray-300 mb-3">
                    <strong>ℹ️ Datenschutz & DSGVO-Konformität:</strong>
                </p>
                <ul class="text-xs text-gray-300 space-y-1 mb-3 ml-4 list-disc">
                    <li>Alle Daten werden <strong>nur in Ihrem Browser</strong> gespeichert (sessionStorage)</li>
                    <li><strong>Keine Cloud</strong>, keine Datenbank, kein Server-Upload</li>
                    <li>Beim Schließen des Tabs werden <strong>alle Daten automatisch gelöscht</strong></li>
                    <li>Export nur manuell durch Sie (PDF, CSV, JSON)</li>
                    <li>Session-Daten bleiben bei Ihnen - <strong>100% DSGVO-konform</strong></li>
                </ul>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="privacy-understood-checkbox" class="w-4 h-4 rounded">
                    <span class="text-xs text-gray-400">Verstanden, diesen Hinweis nicht mehr anzeigen</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Session Recovery Dialog -->
    <div id="session-recovery-dialog" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Vorherige Session gefunden</h2>
            <p class="text-gray-300 mb-4">
                Eine vorherige Beratungssession wurde gefunden. Möchten Sie diese fortsetzen?
            </p>

            <div id="recovery-session-info" class="bg-gray-800 p-4 rounded-lg mb-6 text-sm text-gray-300">
                <!-- Wird dynamisch befüllt -->
            </div>

            <div class="flex gap-3">
                <button onclick="continueSession()" class="mlp-btn mlp-btn-primary flex-1 py-3 px-6 text-base">
                    Fortsetzen
                </button>
                <button onclick="startNewSessionAndDiscard()" class="mlp-btn mlp-btn-secondary flex-1 py-3 px-6 text-base">
                    Neue Session
                </button>
            </div>
        </div>
    </div>

    <!-- Session End Dialog -->
    <div id="session-end-dialog" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Beratung beenden?</h2>
            <p class="text-gray-300 mb-6">
                Alle Daten werden gelöscht. Möchten Sie vor dem Beenden die Daten exportieren?
            </p>

            <div class="bg-yellow-900 bg-opacity-50 border border-yellow-600 rounded-lg p-4 mb-6">
                <p class="text-sm text-yellow-200">
                    <strong>Warnung:</strong> Diese Aktion kann nicht rückgängig gemacht werden!
                </p>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="endSession(true)" class="mlp-btn mlp-btn-primary w-full py-3 px-6 text-base">
                    Exportieren & Beenden
                </button>
                <button onclick="endSession(false)" class="mlp-btn mlp-btn-danger w-full py-3 px-6 text-base">
                    Ohne Export beenden
                </button>
                <button onclick="closeModal('session-end-dialog')" class="mlp-btn mlp-btn-tertiary w-full py-3 px-6 text-base">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>

    <!-- ===== END SESSION UI ELEMENTS ===== -->

    <script src="scripts/a11y.js" defer></script>
    <script src="scripts/autoRecalc.js" defer></script>
    <script src="scripts/variantFix.js" defer></script>
    <script src="scripts/reloadButton.js" defer></script>
    <script src="scripts/recalcFab.js" defer></script>
    <script src="scripts/removeHeaderIcon.js" defer></script>
</body>
</html>
