<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das strategische Vermögensmanagement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .skip-link { position: absolute; left: -1000px; top: auto; width: 1px; height: 1px; overflow: hidden; }
        .skip-link:focus { left: 50%; top: 1rem; width: auto; height: auto; padding: 0.75rem 1rem; background: var(--accent1, #3b82f6); color: #ffffff; border-radius: 999px; transform: translateX(-50%); z-index: 9999; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
        .account-basin {
            background-color: #1f2937; border: 1px solid #374151; padding: 1rem; border-radius: 0.75rem;
            text-align: center; width: 220px; height: 140px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out; position: absolute; z-index: 10; overflow: hidden;
        }
        button.account-basin { appearance: none; background-color: #1f2937; color: inherit; border: 1px solid #374151; }
        button.account-basin:focus { outline: none; }
        button.account-basin:focus-visible { outline: 3px solid var(--accent1, #3b82f6); outline-offset: 4px; }
        .flow-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; overflow: visible; }
        .flow-path { fill: none; stroke: var(--mlp-blue-1); stroke: url(#flow-gradient); stroke-linecap: round; stroke-linejoin: round; transition: opacity 0.5s, stroke-width 0.5s; opacity: 0; }
        .flow-path.active { opacity: 1; }
        .flow-path-animation { stroke: white; stroke-width: 2px; stroke-dasharray: 10 15; animation: flow 2s linear infinite; opacity: 0; transition: opacity 0.5s; }
        .flow-path.active + .flow-path-animation { opacity: 0.6; }
        /* Erase any underlay with background color (covers legacy grey ribbons) */
        .flow-erase {
          fill: none;
          stroke-linecap: round;
          stroke-linejoin: round;
          opacity: 1;
          pointer-events: none;
          shape-rendering: geometricPrecision;
        }
        .theme-light .flow-erase { stroke: #ffffff !important; }
        .theme-dark  .flow-erase { stroke: #111827 !important; }
        /* Light theme: full blue flows, no grey halo */
        .theme-light .flow-path { stroke: var(--mlp-blue-1); filter: none; }
        .theme-light .flow-path-animation { stroke: #2f6fb2; stroke-dasharray: 8 14; opacity: .9; }
        .flow-dot { fill: #60a5fa; opacity: .95; }
        .theme-light .flow-dot { fill: var(--mlp-blue-2); }
        @keyframes flow { from { stroke-dashoffset: 0; } to { stroke-dashoffset: -25; } }
        .flow-label { position: absolute; color: #9ca3af; font-size: 0.75rem; font-weight: 500; z-index: 15; transform: translate(-50%, -130%); white-space: nowrap; transition: top 0.3s, left 0.3s; }
        /* Better readability for labels on blue rivers (light) */
        .theme-light .flow-label {
          color: var(--fg);
          background: rgba(255,255,255,.95);
          border: 1px solid var(--border);
          padding: 2px 6px;
          border-radius: 999px;
          line-height: 1.1;
          box-shadow: 0 1px 2px rgba(0,0,0,.06);
        }
        .flow-value { position: absolute; background-color: #111827; color: #d1d5db; padding: 4px 10px; border-radius: 9999px; font-size: 0.9rem; font-weight: 600; z-index: 15; border: 1px solid #4b5563; white-space: nowrap; transform: translate(-50%, -50%); transition: top 0.3s, left 0.3s; }
        .limit-line { position: absolute; width: 100%; height: 2px; left: 0; z-index: 12; }
        .limit-line span { position: absolute; right: 4px; transform: translateY(-50%); font-size: 10px; background: #1f2937; padding: 0 3px; font-weight: 500;}
        .modal { display: none !important; }
        .modal-active { display: flex !important; }
        .schutzschirm {
            fill: rgba(59, 130, 246, 0.15);
            stroke: rgba(96, 165, 250, 0.4);
            stroke-width: 2px;
            transition: opacity 0.5s;
            animation: pulse-shield 4s infinite ease-in-out;
            pointer-events: none;
        }
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #printable-report { display: none; }

        /* No-print class for elements that should never be printed */
        @media print {
          /* Page setup: minimal margins for maximum content space */
          @page {
            size: A4;
            margin: 8mm 10mm;
          }

          .no-print { display: none !important; }

          /* Hide everything except the report */
          body > *:not(#printable-report) { display: none !important; }

          /* Report container */
          #printable-report {
            display: block;
            color: #000;
            background: #fff;
            padding: 8mm 10mm;
            max-width: 100%;
            overflow: hidden;
          }

          /* Images: use transform scale for guaranteed sizing */
          #printable-report img {
            max-width: none !important;
            width: auto !important;
            height: auto !important;
            transform: scale(0.38) !important;
            transform-origin: center top !important;
            display: block !important;
            margin: 0 auto !important;
            page-break-inside: avoid !important;
          }

          /* Headers */
          #printable-report h1 {
            font-size: 24pt;
            margin-bottom: 12pt;
            color: #002F6C; /* MLP Blue */
          }

          #printable-report h2 {
            font-size: 16pt;
            margin-top: 20pt;
            margin-bottom: 10pt;
            color: #002F6C;
            break-after: avoid;
            page-break-after: avoid;
          }

          #printable-report p.muted {
            font-size: 10pt;
            color: #666;
            margin-bottom: 8pt;
          }

          /* Tables */
          .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 2rem;
            break-inside: avoid;
            page-break-inside: avoid;
          }

          .print-table th, .print-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            font-size: 10pt;
          }

          .print-table th {
            background-color: #f2f2f2;
            font-weight: bold;
          }

          /* Sum rows in tables */
          .print-table tr.sum-row th,
          .print-table tr.sum-row td {
            font-weight: bold;
            background-color: #e8e8e8;
            border-top: 2px solid #999;
          }

          /* Positive/Negative values */
          .text-positive { color: #059669; font-weight: 600; }
          .text-negative { color: #dc2626; font-weight: 600; }

          /* Prevent orphaned table headers */
          .print-table thead {
            break-after: avoid;
            page-break-after: avoid;
          }

          /* Print breaks */
          .print-break {
            page-break-after: always;
            break-after: page;
            height: 1px;
          }

          /* Eigene Seite für den Finanzfluss */
          .print-finanzfluss {
            break-before: page;
            page-break-before: always;
          }

          /* Verhindert „hängende" Überschrift am Seitenende */
          .print-finanzfluss h2 {
            break-after: avoid;
            page-break-after: avoid;
          }

          /* Optimize flowchart container for print */
          #flow-container-print {
            break-inside: avoid;
            page-break-inside: avoid;
            transform: scale(0.75) !important;
            transform-origin: top center !important;
            width: 1100px !important;
            margin: 0 auto -380px auto !important;
            position: relative !important;
            left: 50% !important;
            margin-left: -720px !important;
          }
        }

        /* === THEME TOKENS (Dark stays default) === */
        :root {
          --mlp-blue: #002F6C;
          --mlp-blue-1: #002F6C;  /* deep navy */
          --mlp-blue-2: #3C6AA3;  /* lighter MLP blue for shading */
          --mlp-gold: #BDA177;
          --input-bg: #1f2937;
          --input-border: #374151;
        }
        .theme-dark {
          --bg: #111827;        /* body bg */
          --fg: #FFFFFF;        /* text color */
          --card: #1f2937;      /* panels */
          --border: #374151;    /* borders */
          --muted: #9ca3af;     /* secondary text */
          --accent1: #3b82f6;   /* gradient start */
          --accent2: #6366f1;   /* gradient end */
          --input-bg: rgba(17, 24, 39, 0.92);
          --input-border: #374151;
        }
        .theme-light {
          --bg: #FFFFFF;
          --fg: #111827;
          --card: #F9FAFB;
          --border: #E5E7EB;
          --muted: #6B7280;
          --accent1: var(--mlp-blue);  /* MLP Blau */
          --accent2: var(--mlp-gold);  /* MLP Gold */
          --input-bg: #ffffff;
          --input-border: #d0d7e3;
        }

        /* Base background/text via CSS vars (keine Änderung an Tailwind nötig) */
        body { background: var(--bg); color: var(--fg); }

        /* === HORIZONTAL GRADIENT ZONES === */
        .gradient-zone {
            position: absolute;
            left: 0;
            right: 0;
            pointer-events: none;
            z-index: 0;
            transition: opacity 0.6s ease;
        }

        /* Ebene 1: WOLKEN - Einkommen (Himmelblau, luftig) */
        .gradient-zone-1 {
            background: linear-gradient(
                to bottom,
                rgba(100, 180, 255, 0.15) 0%,
                rgba(60, 120, 200, 0.20) 100%
            );
        }

        /* Ebene 2: HORIZONT - Girokonten (Grau-Blau, geerdet) */
        .gradient-zone-2 {
            background: linear-gradient(
                to bottom,
                rgba(60, 120, 200, 0.20) 0%,
                rgba(70, 90, 120, 0.25) 100%
            );
        }

        /* Ebene 3: SCHUPPEN - Liquidität (Dunkel-Teal, geschützt) */
        .gradient-zone-3 {
            background: linear-gradient(
                to bottom,
                rgba(70, 90, 120, 0.25) 0%,
                rgba(40, 80, 100, 0.30) 100%
            );
        }

        /* Ebene 4: FELDER - Vermögensaufbau (MLP Platin, fruchtbar) */
        .gradient-zone-4 {
            background: linear-gradient(
                to bottom,
                rgba(40, 80, 100, 0.30) 0%,
                rgba(189, 161, 119, 0.25) 50%,
                rgba(189, 161, 119, 0.35) 100%
            );
        }

        /* Light Theme - Metapher bleibt, nur heller */
        .theme-light .gradient-zone-1 {
            background: linear-gradient(
                to bottom,
                rgba(100, 180, 255, 0.10) 0%,
                rgba(60, 120, 200, 0.12) 100%
            );
        }

        .theme-light .gradient-zone-2 {
            background: linear-gradient(
                to bottom,
                rgba(60, 120, 200, 0.12) 0%,
                rgba(70, 90, 120, 0.15) 100%
            );
        }

        .theme-light .gradient-zone-3 {
            background: linear-gradient(
                to bottom,
                rgba(70, 90, 120, 0.15) 0%,
                rgba(40, 80, 100, 0.18) 100%
            );
        }

        .theme-light .gradient-zone-4 {
            background: linear-gradient(
                to bottom,
                rgba(40, 80, 100, 0.18) 0%,
                rgba(189, 161, 119, 0.15) 50%,
                rgba(189, 161, 119, 0.22) 100%
            );
        }

        /* === SESSION MODAL OVERLAY (v1.2.0) === */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-overlay.modal-active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Smooth scrollbar for modal content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }

        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border: 0;
        }

        /* Planning cockpit */
        .planning-panel{position:relative;background:var(--card);border-radius:24px;border:1px solid var(--border);padding:clamp(2.4rem,3vw+2rem,3.5rem) clamp(1.6rem,2vw+1.2rem,2.6rem);display:flex;flex-direction:column;gap:1.75rem;box-shadow:0 24px 48px -28px rgba(0,47,108,0.45);}
        .theme-dark .planning-panel{background:linear-gradient(150deg,#1e293b 0%,#0f172a 100%);border-color:rgba(148,163,184,0.15);box-shadow:0 35px 55px -35px rgba(15,23,42,0.8);}
        .panel-header{display:flex;flex-direction:column;gap:1.5rem;align-items:flex-start;}
        @media (min-width:768px){.panel-header{flex-direction:row;justify-content:space-between;align-items:flex-end;gap:2rem;}}
        .panel-title{max-width:420px;display:flex;flex-direction:column;gap:.4rem;align-items:flex-start;text-align:left;padding-left:1.5rem;}
        .panel-eyebrow{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:700;}
        .panel-title h2{margin:0;font-size:clamp(1.9rem,2vw+1.6rem,2.4rem);font-weight:700;color:var(--fg);}
        .panel-controls{display:none;} /* Hidden in v1.4.0 - moved to Control Bar */
        .control-chip{position:relative;display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border:1px solid var(--border);border-radius:14px;background:rgba(0,47,108,0.04);transition:all .25s ease;cursor:pointer;}
        .panel-controls .control-chip:hover{border-color:var(--accent1);color:var(--accent1);}
        .control-chip:focus-within{box-shadow:0 0 0 3px rgba(0,47,108,0.18);}
        .theme-dark .control-chip{background:rgba(148,163,184,0.08);border-color:rgba(148,163,184,0.2);}
        .control-chip input{position:absolute;inset:0;opacity:0;cursor:pointer;}
        .chip-icon,.chip-pair{display:flex;align-items:center;justify-content:center;width:100%;height:100%;border-radius:inherit;background:transparent;gap:.2rem;transition:background .25s ease,color .25s ease;}
        .control-chip .icon{width:18px;height:18px;color:var(--muted);transition:opacity .2s ease,transform .2s ease;}
        .control-chip--toggle .icon-moon{opacity:0;transform:scale(.65);}
        .control-chip--toggle input:checked + .chip-icon{background:rgba(0,47,108,0.08);}
        .theme-light .control-chip--toggle input:checked + .chip-icon{background:rgba(0,47,108,0.12);}
        .control-chip--toggle input:checked + .chip-icon .icon-sun{opacity:0;transform:scale(.65);}
        .control-chip--toggle input:checked + .chip-icon .icon-moon{opacity:1;transform:scale(1);}
        .control-chip--toggle input:checked + .chip-icon .icon{color:var(--accent1);}
        .chip-pair{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.2rem;align-items:center;justify-items:center;}
        .chip-state{display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:999px;font-size:.8rem;font-weight:600;color:var(--muted);background:rgba(0,47,108,0.05);transition:all .2s ease;}
        .theme-dark .chip-state{background:rgba(148,163,184,0.12);color:#cbd5f5;}
        .chip-state--active{color:#ffffff;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 10px 18px -12px rgba(0,47,108,0.6);}
        .control-chip--consultation{width:44px;}
        .control-chip--consultation .chip-button{display:flex;align-items:center;justify-content:center;width:100%;height:100%;border:none;background:transparent;color:var(--muted);cursor:pointer;transition:color .2s ease,background .2s ease;}
        .control-chip--consultation .chip-button:hover{color:var(--accent1);}
        .control-chip--consultation .chip-button .icon{width:20px;height:20px;}
        .control-chip--consultation .chip-button.hidden{display:none;}
        .control-chip--consultation.is-active{background:linear-gradient(135deg,var(--accent1),var(--accent2));border-color:transparent;box-shadow:0 10px 18px -12px rgba(0,47,108,0.6);}
        .control-chip--consultation.is-active .chip-button .icon{color:#ffffff;}

        /* ========================================
           CONTROL BAR (v1.4.0) - Top-Right Fixed
           ======================================== */
        #control-bar {
            position: fixed;
            top: 16px; /* 2 * 8px grid */
            right: 16px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px; /* 8px grid */
            padding: 8px;
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.25s ease;
        }
        .theme-dark #control-bar {
            background: rgba(15, 23, 42, 0.90);
            border-color: rgba(148, 163, 184, 0.2);
        }

        /* Control Bar Items (same as control-chip but adapted) */
        .control-bar-item {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 44px; /* Touch target minimum */
            height: 44px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(0, 47, 108, 0.04);
            transition: all 0.25s ease;
            cursor: pointer;
        }
        .control-bar-item:hover {
            border-color: var(--accent1);
            color: var(--accent1);
        }
        .control-bar-item:focus-within {
            box-shadow: 0 0 0 3px rgba(0, 47, 108, 0.18);
        }
        .theme-dark .control-bar-item {
            background: rgba(148, 163, 184, 0.08);
            border-color: rgba(148, 163, 184, 0.2);
        }

        /* Theme Toggle */
        .control-bar-item--theme input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .control-bar-item--theme .bar-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border-radius: inherit;
        }
        .control-bar-item--theme .icon {
            width: 18px;
            height: 18px;
            color: var(--muted);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .control-bar-item--theme .icon-moon {
            opacity: 0;
            transform: scale(0.65);
        }
        .control-bar-item--theme input:checked + .bar-icon {
            background: rgba(0, 47, 108, 0.08);
        }
        .theme-light .control-bar-item--theme input:checked + .bar-icon {
            background: rgba(0, 47, 108, 0.12);
        }
        .control-bar-item--theme input:checked + .bar-icon .icon-sun {
            opacity: 0;
            transform: scale(0.65);
        }
        .control-bar-item--theme input:checked + .bar-icon .icon-moon {
            opacity: 1;
            transform: scale(1);
        }
        .control-bar-item--theme input:checked + .bar-icon .icon {
            color: var(--accent1);
        }

        /* Variant Toggle */
        .control-bar-item--variant {
            min-width: 64px; /* Space for A|B */
        }
        .control-bar-item--variant input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .control-bar-item--variant .bar-pair {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 4px; /* Half of 8px for tight grouping */
            align-items: center;
            justify-items: center;
            width: 100%;
            height: 100%;
            padding: 6px;
        }
        .control-bar-item--variant .bar-state {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--muted);
            background: rgba(0, 47, 108, 0.05);
            transition: all 0.2s ease;
        }
        .theme-dark .control-bar-item--variant .bar-state {
            background: rgba(148, 163, 184, 0.12);
            color: #cbd5f5;
        }
        .control-bar-item--variant .bar-state--active {
            color: #ffffff;
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            box-shadow: 0 4px 8px -4px rgba(0, 47, 108, 0.6);
        }

        /* Consultation Button */
        .control-bar-item--consultation {
            min-width: 44px;
        }
        .control-bar-item--consultation .bar-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .control-bar-item--consultation .bar-button:hover {
            color: var(--accent1);
        }
        .control-bar-item--consultation .bar-button .icon {
            width: 20px;
            height: 20px;
        }
        .control-bar-item--consultation .bar-button.hidden {
            display: none;
        }
        .control-bar-item--consultation.is-active {
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            border-color: transparent;
            box-shadow: 0 4px 8px -4px rgba(0, 47, 108, 0.6);
        }
        .control-bar-item--consultation.is-active .bar-button .icon {
            color: #ffffff;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #control-bar {
                top: 64px; /* Below session button */
                right: 16px;
                flex-direction: column;
                gap: 8px;
            }
        }

        /* ========================================
           INLINE EDITOR (v1.4.0) - Basin Editing
           ======================================== */
        .account-basin--editable {
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .account-basin--editable:hover {
            border-color: var(--accent1) !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18);
        }

        /* Inline Editor Overlay */
        .basin-inline-editor {
            position: fixed; /* Fixed statt absolute - schwebt über allem */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999; /* Sehr hoch, über allem */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px; /* 2 * 8px grid */
            padding: 40px; /* 5 * 8px grid - viel Platz */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            min-width: 400px; /* Mindestbreite */
            max-width: 90vw; /* Max 90% Viewport-Breite */

            /* Smooth animation without transform conflict */
            opacity: 0;
            animation: smoothFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        .theme-dark .basin-inline-editor {
            background: rgba(15, 23, 42, 0.98);
        }

        /* Backdrop for inline editor */
        .basin-inline-backdrop {
            position: fixed;
            inset: 0;
            z-index: 9998;
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: backdropFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Smooth Animations */
        @keyframes smoothFadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -48%);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes smoothFadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -48%);
            }
        }

        @keyframes backdropFadeIn {
            0% {
                opacity: 0;
                background: rgba(0, 0, 0, 0);
                backdrop-filter: blur(0px);
            }
            100% {
                opacity: 1;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
            }
        }

        @keyframes backdropFadeOut {
            0% {
                opacity: 1;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
            }
            100% {
                opacity: 0;
                background: rgba(0, 0, 0, 0);
                backdrop-filter: blur(0px);
            }
        }

        /* Old animations - keep for backward compatibility */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Inline Editor Input */
        .basin-inline-input {
            width: 100%;
            max-width: 280px;
            padding: 10px 12px; /* 8px grid: kompakter für Dual-Input */
            font-size: 1rem; /* 16px - kleiner für mehr Platz */
            font-weight: 600;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            color: var(--fg);
            transition: all 0.25s ease;
            font-family: 'Courier New', monospace;
        }
        .basin-inline-input:focus {
            outline: none;
            border-color: var(--accent1);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18);
        }
        .basin-inline-input::placeholder {
            color: var(--muted);
            opacity: 0.6;
        }

        /* Inline Editor Label */
        .basin-inline-label {
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Inline Editor Hint */
        .basin-inline-hint {
            font-size: 0.75rem; /* 12px */
            color: var(--muted);
            text-align: center;
        }

        /* Inline Editor Button Group */
        .basin-inline-buttons {
            display: flex;
            gap: 8px; /* 8px grid */
            margin-top: 8px;
        }

        .basin-inline-btn {
            padding: 8px 16px; /* 8px grid: 1 * 8, 2 * 8 */
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--fg);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .basin-inline-btn:hover {
            border-color: var(--accent1);
            color: var(--accent1);
        }
        .basin-inline-btn--primary {
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            color: #ffffff;
            border-color: transparent;
        }
        .basin-inline-btn--primary:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }

        /* Multi-Input Grid (for Konsum, Tagesgeld) */
        .basin-inline-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; /* 1.5 * 8px grid - kompakter */
            width: 100%;
            max-width: 360px; /* Etwas kleiner für bessere Passform */
        }

        .basin-inline-field {
            display: flex;
            flex-direction: column;
            gap: 6px; /* Kompakter Gap */
        }

        .basin-inline-field .basin-inline-input {
            max-width: 100%; /* Volle Breite im Grid */
            font-size: 0.9rem; /* Noch kleiner für Dual-Input */
            padding: 8px 10px;
        }

        /* Edit Indicator (Pencil Icon) - v1.5.3: 44px minimum touch target (WCAG 2.1 AA) */
        .basin-edit-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(79, 70, 229, 0.15);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        .account-basin--editable:hover .basin-edit-indicator {
            opacity: 1;
        }
        .basin-edit-indicator svg {
            width: 16px;
            height: 16px;
            color: var(--accent1);
        }

        /* ========================================
           FAB (Floating Action Button) - v1.4.0
           ======================================== */
        #booking-fab {
            position: fixed;
            bottom: 24px; /* 3 * 8px grid */
            right: 24px;
            z-index: 1000;
            width: 56px; /* Material Design Standard */
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
        }

        #booking-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.5);
        }

        #booking-fab:active {
            transform: scale(0.95);
        }

        #booking-fab svg {
            width: 24px;
            height: 24px;
            color: #ffffff;
        }

        /* FAB Label (appears on hover) */
        .fab-label {
            position: absolute;
            right: 72px; /* 56px FAB + 16px gap */
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transform: translateX(8px);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #booking-fab:hover .fab-label {
            opacity: 1;
            transform: translateX(0);
        }

        /* Booking Modal (v1.4.0) */
        #booking-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            padding: 24px;
            animation: fadeIn 0.3s ease;
        }

        #booking-modal.active {
            display: flex;
        }

        .booking-modal-content {
            background: var(--bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: smoothFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .booking-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
        }

        .booking-modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--fg);
            margin: 0;
        }

        .booking-modal-close {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .booking-modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--fg);
        }

        .theme-dark .booking-modal-close:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .booking-modal-body {
            padding: 32px;
            overflow-y: auto;
        }

        /* Mobile: FAB anpassen */
        @media (max-width: 768px) {
            #booking-fab {
                bottom: 80px; /* Platz für Session-Button */
                right: 16px;
                width: 48px;
                height: 48px;
            }
            #booking-fab svg {
                width: 20px;
                height: 20px;
            }
            .fab-label {
                display: none; /* Kein Label auf Mobile */
            }
        }

        /* v1.5.3: Button minimum heights aligned to 44px touch target (WCAG 2.1 AA) */
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:.35rem;border-radius:999px;font-weight:600;transition:all .25s ease;cursor:pointer;border:none;min-height:44px;}
        .btn:focus{outline:none;}
        .btn:focus-visible{outline:3px solid var(--accent1);outline-offset:4px;}
        .btn-sm{font-size:.85rem;padding:.55rem 1rem;}
        .btn-lg{font-size:.95rem;padding:.85rem 1.5rem;min-height:48px;}
        .btn-block{width:100%;}
        .btn-primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;}
        .btn-primary:hover{filter:brightness(1.05);box-shadow:0 18px 32px -18px rgba(0,47,108,0.65);}
        .btn-secondary{background:transparent;border:1px solid var(--border);color:var(--fg);}
        .btn-secondary:hover{border-color:var(--accent1);color:var(--accent1);box-shadow:0 0 0 3px rgba(0,47,108,0.12);}
        .btn-ghost{background:transparent;color:var(--muted);}
        .btn-ghost:hover{color:var(--accent1);}
        .panel-note{display:flex;align-items:flex-start;gap:.75rem;font-size:.85rem;color:var(--muted);background:rgba(0,47,108,0.05);border-radius:14px;padding:.9rem 1.1rem;border:1px solid rgba(0,47,108,0.1);}
        .panel-note::before{content:'i';display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:rgba(0,47,108,0.12);color:var(--accent1);font-weight:700;flex-shrink:0;}
        .theme-dark .panel-note{background:rgba(148,163,184,0.08);border-color:rgba(148,163,184,0.16);color:#e2e8f0;}
        .theme-dark .panel-note::before{background:rgba(99,102,241,0.2);color:var(--accent2);}
        .panel-body{display:flex;flex-direction:column;gap:1.25rem;}
        .panel-section{display:flex;flex-direction:column;gap:1rem;padding:1.25rem 1.35rem 1.5rem;border-radius:18px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.7)0%,rgba(244,247,252,0.85)100%);}
        .theme-dark .panel-section{background:rgba(15,23,42,0.55);border-color:rgba(148,163,184,0.12);}
        .panel-section[data-tone="blue"] .section-heading h3{color:var(--accent1);}
        .panel-section[data-tone="gold"] .section-heading h3{color:var(--mlp-gold);}
        .panel-section[data-tone="teal"] .section-heading h3{color:#3aa8a2;}
        .panel-section[data-tone="slate"] .section-heading h3{color:#4c65a8;}
        .section-heading{display:flex;flex-direction:column;gap:.35rem;}
        .section-heading h3{margin:0;font-size:1.2rem;font-weight:700;color:var(--fg);}
        .section-heading .section-subtitle{font-size:.75rem;font-weight:600;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;}
        .section-eyebrow{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:700;}
        .section-grid{display:grid;gap:1rem;}
        .section-grid--two{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
        .section-stack{display:flex;flex-direction:column;gap:1rem;}
        .mlp-input{display:flex;flex-direction:column;gap:.55rem;}
        .mlp-input label{font-size:.85rem;font-weight:600;color:var(--muted);}
        .mlp-range-group{gap:0.4rem;}
        .range-meta{display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;color:var(--muted);margin-bottom:0.25rem;}
        .range-value{font-weight:600;color:var(--accent1);}
        .input-frame{display:flex;align-items:center;gap:.6rem;background:var(--input-bg);border:1px solid var(--input-border);border-radius:12px;padding:0 1rem;height:48px;transition:border-color .25s ease,box-shadow .25s ease;}
        .mlp-input-field{flex:1;border:none;background:transparent;color:var(--fg);font-size:1rem;font-weight:600;outline:none;}
        .mlp-input-field::-webkit-outer-spin-button,.mlp-input-field::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
        .mlp-input-field[type=number]{-moz-appearance:textfield;appearance: textfield;}
        .input-prefix,.input-suffix{font-size:.9rem;font-weight:600;color:var(--muted);}
        .input-frame:focus-within{border-color:var(--accent1);box-shadow:0 0 0 3px rgba(0,47,108,0.18);}
        .theme-dark .input-frame{background:rgba(15,23,42,0.9);border-color:rgba(148,163,184,0.18);}
        .theme-dark .input-frame:focus-within{border-color:var(--accent1);box-shadow:0 0 0 3px rgba(63,103,190,0.35);}
        .theme-dark .input-prefix,.theme-dark .input-suffix{color:#cbd5f5;}
        .label-highlight{color:var(--accent1);font-weight:700;}
        .mlp-range{width:100%;height:6px;border-radius:999px;background:linear-gradient(90deg,rgba(0,47,108,0.15),rgba(189,161,119,0.15));outline:none;-webkit-appearance:none;appearance:none;}
        .mlp-range::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));border:none;box-shadow:0 8px 18px rgba(0,47,108,0.25);cursor:pointer;}
        .mlp-range::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));border:none;box-shadow:0 8px 18px rgba(0,47,108,0.25);cursor:pointer;}
        .mlp-range::-webkit-slider-runnable-track{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));}
        .mlp-range::-moz-range-track{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));}
        .section-note{font-size:.8rem;color:var(--muted);background:rgba(0,47,108,0.05);padding:.75rem 1rem;border-radius:12px;text-align:center;}
        .theme-dark .section-note{background:rgba(148,163,184,0.12);color:#e2e8f0;}
        .booking-type-group{display:flex;flex-wrap:wrap;gap:.55rem;justify-content:center;}
        .booking-toolbar{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;font-size:.8rem;color:var(--muted);}
        .booking-toolbar label{font-weight:600;color:var(--muted);}
        .select-field{width:100%;background:var(--input-bg);border:1px solid var(--input-border);border-radius:12px;padding:.6rem .9rem;color:var(--fg);font-size:.9rem;transition:border-color .25s ease,box-shadow .25s ease;outline:none;}
        .select-field:focus{border-color:var(--accent1);box-shadow:0 0 0 3px rgba(0,47,108,0.18);}
        .theme-dark .select-field{background:rgba(15,23,42,0.9);border-color:rgba(148,163,184,0.18);color:#f1f5f9;}
        .link-danger{color:#ef4444;font-weight:600;}
        .link-danger:hover{color:#dc2626;}
        .print-area{margin-top:.5rem;}
        .print-area .print-btn{display:inline-flex;align-items:center;justify-content:center;gap:.75rem;border-radius:16px;padding:.9rem 1.2rem;}
        .print-area .print-btn svg{width:20px;height:20px;}
        /* Panels/Borders auf Theme heben */
        .theme-light .bg-gray-800 { background-color: var(--card) !important; }
        .theme-light .bg-gray-900 { background-color: var(--bg) !important; }
        .theme-light .border-gray-700 { border-color: var(--border) !important; }
        .theme-light .text-white { color: var(--fg) !important; }
        .theme-light .text-gray-400 { color: var(--muted) !important; }

        /* Flow labels/pills harmonisieren */
        .flow-label { color: var(--muted); }
        .flow-value { background-color: #111827; color: #d1d5db; border-color: #4b5563; }
        .theme-light .flow-value { background-color: rgba(255,255,255,0.85); border-color: var(--border); color: var(--fg); }

        /* Mini Theme Toggle (Header) */
        /* -------- Light Theme Polish & Overrides -------- */
        /* Inputs & selects */
        .theme-light input[type="number"],
        .theme-light input[type="text"],
        .theme-light input[type="range"],
        .theme-light select,
        .theme-light textarea {
          background: #ffffff !important;
          color: #111827 !important;
          border-color: var(--border) !important;
        }
        .theme-light .bg-gray-700 { background-color: #ffffff !important; }
        .theme-light .text-gray-300 { color: #374151 !important; }
        .theme-light .bg-gray-700 .text-gray-400,
        .theme-light .text-gray-400 { color: var(--muted) !important; }

        /* Panels / cards / modals */
        .theme-light .account-basin {
          background-color: var(--card) !important;
          border-color: var(--border) !important;
          box-shadow: 0 8px 18px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.05) !important;
        }
        .theme-light .modal .bg-gray-800 { background-color: #ffffff !important; }
        .theme-light .modal .bg-gray-900 { background-color: #ffffff !important; }
        .theme-light .border-gray-600 { border-color: var(--border) !important; }

        /* Badges / helper boxes */
        .theme-light .limit-line span { background: #ffffff !important; color: #111827 !important; }

        /* Flow animation color on light */
        .theme-light .flow-path-animation { stroke: white; opacity: .5; }

        /* Mask strokes (define visible river area) */
        .flow-mask-stroke {
          fill: none;
          stroke: #ffffff;
          stroke-linecap: round;
          stroke-linejoin: round;
          pointer-events: none;
          shape-rendering: geometricPrecision;
        }

        /* Ensure text colors in headings/labels are dark enough */
        .theme-light h1, .theme-light h2, .theme-light h3, .theme-light label, .theme-light p { color: #111827; }
        .theme-light .text-blue-400, .theme-light .text-green-400, .theme-light .text-red-400, .theme-light .text-yellow-300 { filter: saturate(.95); }

        /* ===== UI Polish ===== */
        /* Smooth theme transitions */
        body, .account-basin, input, select, textarea, .flow-value, .flow-label {
          transition: background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
        }

        /* Light header text overrides (keeps markup unchanged) */
        .theme-light h1.text-white { color: var(--fg) !important; }
        .theme-light p.text-gray-400 { color: var(--muted) !important; }

        /* Inputs focus ring tuned to MLP blue */
        .theme-light input:focus, .theme-light select:focus, .theme-light textarea:focus {
          outline: none;
          border-color: var(--mlp-blue) !important;
          box-shadow: 0 0 0 3px rgba(0,47,108,.15);
        }

        /* Primary action hover gentle for light */
        .theme-light .bg-purple-600:hover { filter: brightness(1.05); }

        /* Print button styling */
        .print-btn {
          transition: all .25s ease;
          border: 1px solid var(--border);
          background: transparent;
          color: var(--fg);
        }
        .print-btn:hover {
          border-color: var(--accent1);
          color: var(--accent1);
        }
        .theme-dark .print-btn {
          background: rgba(148, 163, 184, 0.08);
          border-color: rgba(148, 163, 184, 0.2);
          color: #f1f5f9;
        }
        .theme-light .print-btn {
          background: linear-gradient(135deg, rgba(0, 47, 108, 0.9), rgba(189, 161, 119, 0.9));
          border-color: transparent;
          color: #ffffff;
        }
        .theme-light .print-btn:hover {
          filter: brightness(1.05);
        }

        /* Cards subtle separation in light */
        .theme-light .bg-gray-800 {
          box-shadow: 0 10px 24px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04) !important;
        }

        /* Section dividers lighter in light */
        .theme-light hr.border-gray-700 { border-color: #e5e7eb !important; }

        /* Flow pill font weight slightly lower in light */
        .theme-light .flow-value { font-weight: 500; }
        .theme-light .flow-value {
          box-shadow: 0 1px 2px rgba(0,0,0,.06);
        }

        /* --- Ensure body flips to light despite Tailwind classes --- */
        .theme-light.bg-gray-900 { background-color: var(--bg) !important; }
        .theme-light.text-white  { color: var(--fg) !important; }

        /* --- Extra MLP accents in Light --- */
        /* Primary action becomes MLP blue in light */
        .theme-light .bg-purple-600 { background-color: var(--mlp-blue) !important; }
        .theme-light .hover\:bg-purple-700:hover { background-color: #003a84 !important; }

        /* Headings and section titles in MLP blue, yellow accents in MLP gold */
        .theme-light h1, .theme-light h2, .theme-light h3,
        .theme-light .section-title { color: var(--mlp-blue) !important; }
        .theme-light .text-yellow-300 { color: var(--mlp-gold) !important; }

        /* Light theme info badges and pills with MLP tint */
        .theme-light .flow-value { border-color: #d5e0ee !important; }

        /* ===== MODERN RANGE SLIDER (v1.5.0) ===== */
        input[type="range"],
        .mlp-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right,
                var(--mlp-blue, #002f6c) 0%,
                var(--mlp-blue, #002f6c) 50%,
                rgba(100, 116, 139, 0.3) 50%,
                rgba(100, 116, 139, 0.3) 100%);
            outline: none;
            transition: opacity 0.2s;
            cursor: pointer;
        }

        input[type="range"]:hover {
            opacity: 0.9;
        }

        /* v1.5.3: Focus indicator for keyboard navigation */
        input[type="range"]:focus-visible {
            outline: 3px solid var(--accent1, #3b82f6);
            outline-offset: 4px;
            border-radius: 6px;
        }

        /* Webkit (Chrome, Safari, Edge) - Thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--mlp-blue, #002f6c);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            margin-top: -7px; /* Centers thumb on track (20px thumb - 6px track)/2 */
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 47, 108, 0.4);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.05);
        }

        /* Firefox - Thumb */
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--mlp-blue, #002f6c);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 47, 108, 0.4);
        }

        input[type="range"]::-moz-range-thumb:active {
            transform: scale(1.05);
        }

        /* Firefox - Track */
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: transparent;
        }

        /* Light Theme Overrides */
        .theme-light input[type="range"] {
            background: linear-gradient(to right,
                var(--mlp-blue) 0%,
                var(--mlp-blue) 50%,
                #e5e7eb 50%,
                #e5e7eb 100%) !important;
        }

        .theme-light input[type="range"]::-webkit-slider-thumb {
            background: var(--mlp-blue);
            border-color: #f8fafc;
        }

        /* ===== RISK TOGGLE & FUND BLOCKS (v1.5.1+) ===== */

        /* Risk Toggle Component */
        .risk-toggle {
            display: flex;
            gap: 4px;
            background: #1f2937;
            padding: 2px;
            border-radius: 8px;
        }

        .risk-btn {
            flex: 1;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            border: none;
            color: #9ca3af;
            background: transparent;
        }

        .risk-btn:hover {
            background: #2d3748;
            color: #d1d5db;
        }

        .risk-btn.active {
            background: #374151;
            color: #ffffff;
            font-weight: 600;
        }

        .risk-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .risk-btn.active .risk-dot {
            transform: scale(1.2);
        }

        .risk-dot.conservative {
            background: #3b82f6;
        }

        .risk-dot.aggressive {
            background: #ef4444;
        }

        /* Fund Blocks in Depot Basin */
        .depot-basin-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
            padding: 8px;
        }

        .fund-blocks {
            display: flex;
            gap: 4px;
            align-items: center;
            min-width: 40px;
        }

        .fund-block {
            /* Dynamic squares: width = height, set inline based on allocation */
            border-radius: 8px;
            cursor: help;
            animation: fundPulse 3s ease-in-out infinite;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        @keyframes fundPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.15);
            }
        }

        .fund-block:nth-child(2) {
            animation-delay: 0.5s;
        }

        .fund-block:nth-child(3) {
            animation-delay: 1s;
        }

        .fund-block:nth-child(4) {
            animation-delay: 1.5s;
        }

        .fund-block:nth-child(5) {
            animation-delay: 2s;
        }

        .depot-info {
            text-align: center;
            flex: 1;
        }

        /* Light theme overrides */
        .theme-light .risk-toggle {
            background: #e5e7eb;
        }

        .theme-light input[type="range"]::-moz-range-thumb {
            background: var(--mlp-blue);
            border-color: #f8fafc;
        }

        #rendite-info .text-xs { font-size: 0.7rem; }
    /* --- Print helpers for embedded images --- */
    #printable-report img { max-width: 100%; height: auto; display: block; margin: 10px auto; }
    #printable-report h1, #printable-report h2, #printable-report h3 { color: #000 !important; }
    #printable-report .muted { color: #333 !important; font-size: 12px; }
        .booking-type-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 16px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            background-color: rgba(59, 130, 246, 0.15);
            color: #dbeafe;
            outline: none;
        }
        .booking-type-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 18px -10px rgba(15, 23, 42, 0.35);
        }
        .booking-type-btn svg {
            width: 22px;
            height: 22px;
            pointer-events: none;
        }
        .booking-type-btn:focus-visible {
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.6);
        }
        .booking-type-btn-active {
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.35);
            border-color: rgba(96, 165, 250, 0.65) !important;
            transform: translateY(-1px);
        }
        .booking-calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.5rem;
        }
        .booking-day {
            position: relative;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 0.35rem 0.3rem 0.5rem;
            min-height: 64px;
            background-color: rgba(17, 24, 39, 0.6);
            cursor: pointer;
            transition: border-color 0.2s ease, transform 0.15s ease;
        }
        .booking-day:hover {
            transform: translateY(-1px);
            border-color: rgba(96, 165, 250, 0.7);
        }
        .booking-day.has-booking {
            border-color: rgba(96, 165, 250, 0.8);
            background-color: rgba(37, 99, 235, 0.12);
        }
        .booking-day--overflow{background-color:rgba(189,161,119,0.12);border-color:rgba(189,161,119,0.45);} .booking-day--overflow .booking-day-number{color:var(--accent1);}
        .booking-day-number {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
        }
        .booking-day-content {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.35rem;
        }
        .booking-entry-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            border: 1px solid transparent;
            background-color: rgba(255, 255, 255, 0.04);
            color: #d1d5db;
            transition: transform 0.15s ease, border-color 0.2s ease, color 0.2s ease;
        }
        .booking-entry-btn svg {
            width: 0.9rem;
            height: 0.9rem;
        }
        .booking-entry-btn:hover {
            transform: scale(1.05);
            border-color: rgba(239, 68, 68, 0.6);
            color: #fca5a5;
        }
        .booking-calendar .booking-day-header {
            cursor: default;
            background: transparent;
            border: none;
            min-height: auto;
            padding: 0;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
        }
        .booking-day-empty {
            pointer-events: none;
            cursor: default;
            border: none;
            background: transparent;
            min-height: 0;
            padding: 0;
        }
        .booking-hint-strong {
            color: #bfdbfe;
        }
        .theme-light .booking-type-btn {
            background-color: rgba(15, 47, 85, 0.08);
            color: #0f2f55;
            border-color: rgba(15, 47, 85, 0.12);
        }
        .theme-light .booking-day {
            background-color: rgba(249, 250, 251, 0.9);
            border-color: #d1d5db;
        }
        .theme-light .booking-day:hover {
            border-color: rgba(15, 47, 85, 0.55);
        }
        .theme-light .booking-day.has-booking {
            background-color: rgba(214, 226, 247, 0.9);
        }
        .theme-light .booking-day--overflow{background-color:rgba(240,233,222,0.9);border-color:rgba(189,161,119,0.45);} .theme-light .booking-day--overflow .booking-day-number{color:#7b5a30;}
        .theme-light .booking-day-number {
            color: #4b5563;
        }
        .theme-light .booking-entry-btn {
            background-color: rgba(15, 47, 85, 0.05);
            color: #0f2f55;
        }
        .theme-light .booking-entry-btn:hover {
            border-color: rgba(193, 50, 74, 0.6);
            color: #c1324a;
        }
        .print-booking-entry {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .print-booking-entry svg {
            width: 16px;
            height: 16px;
        }
        .print-booking-icon {
            display: inline-flex;
            align-items: center;
        }
        .print-booking-entry + .print-booking-entry {
            margin-top: 4px;
        }
        #printable-report .print-table-bookings td {
            vertical-align: top;
        }

        /* === MOBILE OPTIMIZATIONS === */

        /* Mobile Warning Overlay */
        #mobile-warning {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(8px);
            z-index: 50;
            padding: 2rem;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #mobile-warning .warning-content {
            max-width: 400px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 2px solid #374151;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        #mobile-warning .warning-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        #mobile-warning h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #f59e0b;
        }

        #mobile-warning p {
            color: #d1d5db;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        #mobile-warning .btn-mobile {
            background: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background 0.2s;
        }

        #mobile-warning .btn-mobile:hover {
            background: #4338ca;
        }

        @media (max-width: 768px) {
            #mobile-warning {
                display: flex;
            }

            /* Session button fixed on mobile */
            #session-button-container {
                position: fixed !important;
                top: 1rem !important;
                left: 1rem !important;
                z-index: 100 !important;
            }

            /* Smaller switch in mobile menu */
            #session-dropdown .switch {
                width: 48px;
                height: 28px;
            }

            #session-dropdown .switch .slider:before {
                height: 20px;
                width: 20px;
                left: 4px;
                bottom: 4px;
            }

            #session-dropdown input:checked + .slider:before {
                transform: translateX(20px);
            }

            /* Touch optimization */
            button, .account-basin, .control-chip {
                -webkit-tap-highlight-color: rgba(79, 70, 229, 0.3);
                touch-action: manipulation;
            }

            /* Larger touch targets */
            .account-basin {
                min-height: 80px;
            }

            /* Modal optimization */
            .modal-content {
                max-height: 85vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Sidebar full width on mobile */
            aside {
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Hide flowchart on very small screens */
            @media (max-width: 480px) {
                #flow-container {
                    min-height: 400px !important;
                }
            }
        }
    </style>
</head>
<body class="theme-dark bg-gray-900 text-white p-4 lg:p-8 overflow-x-hidden" id="theme-root">

    <a class="skip-link" href="#main-content">Zum Hauptinhalt springen</a>

    <main id="main-content" class="max-w-screen-2xl mx-auto" tabindex="-1">
        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-5xl font-bold text-white mb-2">Das strategische Vermögensmanagement</h1>
            <p class="text-md md:text-lg text-gray-400">vom Einkommen zum Investment.</p>
        </header>

        <!-- v1.4.0: Sidebar entfernt - Controls in Modals/FAB integriert -->
        <div class="w-full">
            <!-- v1.4.0: Control Bar (Top Right) -->
            <div id="control-bar" class="fixed top-4 right-4 z-50 flex items-center gap-2">
                <!-- Theme Toggle -->
                <label class="control-chip control-chip--toggle" title="Darstellung wechseln">
                    <input type="checkbox" id="theme-switch" aria-label="Theme umschalten (Hell/Dunkel)" />
                    <span class="chip-icon" aria-hidden="true">
                        <svg class="icon icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="4" />
                            <path d="M12 2v2" />
                            <path d="M12 20v2" />
                            <path d="M4.93 4.93l1.42 1.42" />
                            <path d="M17.65 17.65l1.42 1.42" />
                            <path d="M2 12h2" />
                            <path d="M20 12h2" />
                            <path d="M4.93 19.07l1.42-1.42" />
                            <path d="M17.65 6.35l1.42-1.42" />
                        </svg>
                        <svg class="icon icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79z" />
                        </svg>
                    </span>
                </label>

                <!-- Variant Toggle -->
                <label class="control-chip control-chip--variant" title="Variante A/B umschalten">
                    <input type="checkbox" id="variant-switch" aria-label="Variante A/B umschalten">
                    <span class="chip-pair" aria-hidden="true">
                        <span id="variante-a-label" class="chip-state chip-state--active">A</span>
                        <span id="variante-b-label" class="chip-state">B</span>
                    </span>
                </label>

                <!-- Consultation Toggle -->
                <div class="control-chip control-chip--consultation" title="Beratung">
                    <button id="consult-toggle-btn" class="chip-button" type="button" aria-label="Beratung starten">
                        <svg class="icon icon-mlp" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="10" cy="12" r="5.5" stroke="currentColor" stroke-width="1.6" fill="none" />
                            <path d="M10 8.5v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                            <path d="M18 7h3v10h-3z" fill="currentColor" />
                        </svg>
                    </button>
                    <button id="consult-next-btn" class="chip-button hidden" type="button" aria-label="Weiter zur naechsten Beratungsphase" title="Weiter zur naechsten Beratungsphase">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14" />
                            <path d="M13 6l6 6-6 6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- v1.4.0: Hidden input fields for global inputs reference -->
            <div style="display: none;">
                <input type="number" id="income" value="3000">
                <input type="number" id="konsumMin" value="100">
                <input type="number" id="konsumLeftover" value="250">
                <input type="number" id="tagesgeldCurrent" value="4800">
                <input type="number" id="tagesgeldLimit" value="5000">
                <input type="number" id="depotCurrent-hidden" value="0">
                <input type="number" id="anlagezeitraum-hidden" value="15" min="1" max="40">
                <input type="number" id="rendite-hidden" value="7.0" step="0.1">
            </div>

            <div id="flow-container" class="w-full relative min-h-[1150px]">
                <!-- Mobile Warning Overlay -->
                <div id="mobile-warning" class="no-print">
                    <div class="warning-content">
                        <div class="warning-icon">📱</div>
                        <h3>Desktop empfohlen</h3>
                        <p>
                            Die Flowchart-Visualisierung ist für größere Bildschirme optimiert.
                            <br><br>
                            <strong>Verfügbar auf Mobile:</strong><br>
                            ✓ Eingaben & Berechnungen<br>
                            ✓ Export-Funktionen (PDF, CSV, JSON)<br>
                            ✓ Session-Verwaltung
                        </p>
                        <button onclick="document.getElementById('mobile-warning').style.display='none'" class="btn-mobile">
                            Verstanden
                        </button>
                    </div>
                </div>
                <svg id="flow-svg" class="flow-svg">
                    <defs>
                      <linearGradient id="flow-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#3b82f6" />
                        <stop offset="100%" stop-color="#6366f1" />
                      </linearGradient>
                      <filter id="flow-glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="3" result="blur"/>
                        <feMerge>
                          <feMergeNode in="blur"/>
                          <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                      </filter>
                      <mask id="flow-mask" maskUnits="userSpaceOnUse">
                        <rect x="0" y="0" width="100%" height="100%" fill="black"></rect>
                        <path id="flow-path-1-mask" class="flow-mask-stroke"></path>
                        <path id="flow-path-2-mask" class="flow-mask-stroke"></path>
                        <path id="konsum-tagesgeld-flow-mask" class="flow-mask-stroke"></path>
                        <path id="tagesgeld-depot-flow-mask" class="flow-mask-stroke"></path>
                        <path id="fixkosten-depot-flow-mask" class="flow-mask-stroke"></path>
                        <path id="vermieterkonto-einkommen-flow-mask" class="flow-mask-stroke"></path>
                        <path id="fixkosten-vermieterkonto-flow-mask" class="flow-mask-stroke"></path>
                      </mask>
                    </defs>
                    <g id="flow-visuals" mask="url(#flow-mask)">
                      <!-- Deficitline ganz hinten (erstes Element = hinterste Ebene) -->
                      <path id="fixkosten-vermieterkonto-flow-erase" class="flow-erase"></path>
                      <path id="fixkosten-vermieterkonto-flow" class="flow-path"></path><path id="fixkosten-vermieterkonto-flow-anim" class="flow-path-animation"></path><g id="fixkosten-vermieterkonto-flow-dot"></g>
                      <!-- Normale Flows -->
                      <path id="flow-path-1-erase" class="flow-erase"></path>
                      <path id="flow-path-1" class="flow-path"></path><path id="flow-path-1-anim" class="flow-path-animation"></path><g id="flow-path-1-dot"></g>
                      <path id="flow-path-2-erase" class="flow-erase"></path>
                      <path id="flow-path-2" class="flow-path"></path><path id="flow-path-2-anim" class="flow-path-animation"></path><g id="flow-path-2-dot"></g>
                      <path id="konsum-tagesgeld-flow-erase" class="flow-erase"></path>
                      <path id="konsum-tagesgeld-flow" class="flow-path"></path><path id="konsum-tagesgeld-flow-anim" class="flow-path-animation"></path><g id="konsum-tagesgeld-flow-dot"></g>
                      <path id="tagesgeld-depot-flow-erase" class="flow-erase"></path>
                      <path id="tagesgeld-depot-flow" class="flow-path"></path><path id="tagesgeld-depot-flow-anim" class="flow-path-animation"></path><g id="tagesgeld-depot-flow-dot"></g>
                      <path id="fixkosten-depot-flow-erase" class="flow-erase"></path>
                      <path id="fixkosten-depot-flow" class="flow-path"></path><path id="fixkosten-depot-flow-anim" class="flow-path-animation"></path><g id="fixkosten-depot-flow-dot"></g>
                      <!-- Vermieterkonto positive Flow -->
                      <path id="vermieterkonto-einkommen-flow-erase" class="flow-erase"></path>
                      <path id="vermieterkonto-einkommen-flow" class="flow-path"></path><path id="vermieterkonto-einkommen-flow-anim" class="flow-path-animation"></path><g id="vermieterkonto-einkommen-flow-dot"></g>
                    </g>
                    <path id="schutzschirm-path" class="schutzschirm"></path>
                </svg>

                <!-- Horizontal Gradient Zones für visuelle Ebenen-Trennung -->
                <div id="gradient-zone-1" class="gradient-zone gradient-zone-1" style="top: 0; height: 240px;"></div>
                <div id="gradient-zone-2" class="gradient-zone gradient-zone-2" style="top: 240px; height: 480px;"></div>
                <div id="gradient-zone-3" class="gradient-zone gradient-zone-3" style="top: 720px; height: 240px;"></div>
                <div id="gradient-zone-4" class="gradient-zone gradient-zone-4" style="top: 960px; height: 300px;"></div>

                <div id="einkommen-basin" class="account-basin account-basin--editable"></div>
                <button id="fixkosten-basin" class="account-basin cursor-pointer hover:border-indigo-500" type="button" aria-controls="fixkosten-modal" aria-haspopup="dialog" onclick="openFixkostenModal()"></button>
                <div id="konsum-basin" class="account-basin account-basin--editable"></div>
                <div id="tagesgeld-basin" class="account-basin account-basin--editable"></div>
                <button id="depot-basin" class="account-basin cursor-pointer hover:border-purple-500" type="button" aria-controls="depot-modal" aria-haspopup="dialog" onclick="updateRenditeSuggestions(parseInt(document.getElementById('anlagezeitraum').value, 10)); openModal('depot-modal');"></button>
                <button id="vermieterkonto-basin" class="account-basin cursor-pointer hover:border-blue-500" type="button" aria-controls="vermieterkonto-modal" aria-haspopup="dialog" onclick="loadVermieterkontoData(); openModal('vermieterkonto-modal')" style="height: 100px;"></button>
                <button id="immobilien-basin" class="account-basin cursor-pointer hover:border-amber-500" type="button" aria-controls="immobilien-modal" aria-haspopup="dialog" onclick="openModal('immobilien-modal')"></button>
            </div>
        </div>
    </main>
    
    <div id="printable-report"></div>

    <!-- Modals -->

    <div id="prognose-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-[60]" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="prognose-modal-title" aria-describedby="prognose-summary">
        <div class="bg-gray-800 w-full max-w-3xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('prognose-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" aria-label="Prognose schließen">&times;</button>
            <h3 id="prognose-modal-title" class="text-xl font-bold mb-4">Prognose: Vermögensentwicklung</h3>
            <div class="bg-gray-900 p-4 rounded-lg">
                <canvas id="prognose-chart"></canvas>
            </div>
            <div id="prognose-summary" class="mt-4 text-center"></div>
        </div>
    </div>
    </div>

    <div id="fixkosten-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="fixkosten-modal-title">
        <div class="bg-gray-800 w-full max-w-2xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('fixkosten-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" aria-label="Fixkostenfenster schließen">&times;</button>
            <h3 id="fixkosten-modal-title" class="text-xl font-bold mb-4">Fixkosten &amp; Sparpläne</h3>
            <div id="fixkosten-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            <button type="button" onclick="addFixkostenItem()" class="mt-4 text-sm bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded-md">+ Posten hinzufügen</button>
            <hr class="border-gray-600 my-4">
            <div class="flex justify-between items-center">
                <p class="text-lg">Monatliche Gesamtkosten:</p>
                <p id="modal-total" class="text-2xl font-bold text-red-400">? 0</p>
            </div>
            <button type="button" onclick="saveFixkosten()" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Speichern &amp; Schließen</button>
        </div>
    </div>

    <div id="depot-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="depot-modal-title" aria-describedby="depot-modal-description">
        <div class="bg-gray-800 w-full max-w-2xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('depot-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" aria-label="Depotfenster schließen">&times;</button>
            <h3 id="depot-modal-title" class="text-xl font-bold mb-4">Depot-Aufteilung</h3>
            <p id="depot-modal-description" class="text-sm text-gray-400 -mt-3 mb-4">Lege fest, wie neue Investments verteilt werden.</p>
            <div id="depot-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            <button type="button" onclick="addDepotItem()" class="mt-4 text-sm bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded-md">+ Fonds hinzufügen</button>
            <hr class="border-gray-600 my-4">
            <div class="flex justify-between items-center">
                <p class="text-lg">Gesamt-Verteilung:</p>
                <p id="depot-total" class="text-2xl font-bold">100 %</p>
            </div>
            <p id="depot-warning" class="text-center text-yellow-400 mt-2 h-6"></p>

            <!-- Prognose Section (v1.4.0) -->
            <hr class="border-gray-600 my-6">
            <h4 class="text-lg font-bold mb-4">Prognose-Einstellungen</h4>

            <div class="space-y-4">
                <!-- Aktueller Depotstand -->
                <div>
                    <label for="depotCurrent" class="text-sm text-gray-400 block mb-2">Aktueller Depotstand</label>
                    <div class="flex items-center gap-2 bg-gray-700 rounded-lg px-3 py-2">
                        <span class="text-gray-400">€</span>
                        <input type="number" id="depotCurrent" value="25000" class="flex-1 bg-transparent text-white outline-none" inputmode="decimal" placeholder="Aktueller Depotstand">
                    </div>
                </div>

                <!-- Anlagezeitraum Slider -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label for="anlagezeitraum" class="text-sm text-gray-400">Anlagezeitraum</label>
                        <span id="anlagezeitraum-label" class="text-sm font-bold text-white">15 Jahre</span>
                    </div>
                    <input type="range" id="anlagezeitraum" min="1" max="30" value="15" class="mlp-range">
                </div>

                <!-- Erwartete Rendite -->
                <div>
                    <label for="rendite" class="text-sm text-gray-400 block mb-2">Erwartete Rendite p.a.</label>
                    <div class="flex items-center gap-2 bg-gray-700 rounded-lg px-3 py-2">
                        <input type="number" id="rendite" step="0.1" value="7" class="flex-1 bg-transparent text-white outline-none" inputmode="decimal" placeholder="Rendite p.a.">
                        <span class="text-gray-400">%</span>
                    </div>
                    <div id="rendite-info" class="text-xs text-gray-300 mt-2 p-2 bg-gray-900 rounded-lg"></div>
                </div>

                <!-- Prognose Button -->
                <button type="button" onclick="showProjection();" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    Prognose anzeigen
                </button>
            </div>

            <hr class="border-gray-600 my-6">

            <button id="depot-save-button" type="button" onclick="saveDepot()" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Speichern &amp; Schließen</button>
            <button type="button" onclick="openMsciRenditedreieck()" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                MSCI Renditedreieck anzeigen
            </button>
        </div>
    </div>

    <!-- MSCI Renditedreieck Modal -->
    <div id="msci-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="msci-modal-title">
        <div class="w-full h-full max-w-7xl max-h-screen relative flex flex-col" role="document" tabindex="-1">
            <div class="flex justify-between items-center mb-3">
                <h3 id="msci-modal-title" class="text-2xl font-bold text-white">MSCI World Renditedreieck</h3>
                <button type="button" onclick="closeMsciRenditedreieck()" class="text-gray-400 hover:text-white text-3xl" aria-label="MSCI Renditedreieck schließen">&times;</button>
            </div>

            <div class="flex-1 bg-white rounded-lg overflow-hidden relative cursor-zoom-in" id="msci-container" onclick="toggleMsciZoom(event)">
                <img id="msci-image" src="assets/msci_renditedreieck.png" alt="MSCI World Renditedreieck" class="w-full h-full object-contain transition-transform duration-300">
            </div>
            <p class="text-sm text-gray-400 text-center mt-3">Klicke auf das Bild zum Zoomen</p>
        </div>
    </div>

    <!-- Immobilien Modal -->
    <div id="immobilien-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="immobilien-modal-title" aria-describedby="immobilien-modal-description">
        <div class="bg-gray-800 w-full max-w-3xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('immobilien-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" aria-label="Immobilienfenster schließen">&times;</button>
            <h3 id="immobilien-modal-title" class="text-xl font-bold mb-4">Immobilien-Verwaltung</h3>
            <p id="immobilien-modal-description" class="text-sm text-gray-400 -mt-3 mb-4">Verwalte deine Immobilien, Einnahmen und Ausgaben.</p>

            <!-- Grid für 2 Kategorien -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Vermögen (Immobilienwert) -->
                <div class="bg-gray-900 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-3 text-green-400">Vermögen</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Immobilienwert</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-wert" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="Wert der Immobilie">
                                <span class="text-gray-400">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Wertsteigerung (optional)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-wertsteigerung" value="0" step="0.1" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="z.B. 2.0">
                                <span class="text-gray-400">% p.a.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verbindlichkeiten -->
                <div class="bg-gray-900 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-3 text-red-400">Verbindlichkeiten</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Restdarlehen (aktuell)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-darlehen" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="Aktuelle Restschuld">
                                <span class="text-gray-400">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Ursprüngliches Darlehen</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-darlehen-original" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="Darlehensbetrag bei Aufnahme">
                                <span class="text-gray-400">€</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Für korrekte Ratenberechnung (Annuität bleibt konstant)</p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Zinssatz (optional)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-zinssatz" value="0" step="0.1" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="z.B. 3.5">
                                <span class="text-gray-400">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Tilgungssatz (optional)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="immo-tilgungssatz" value="0" step="0.1" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="z.B. 2.0">
                                <span class="text-gray-400">%</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Zusammenfassung -->
            <div class="mt-6 bg-gray-900 p-4 rounded-lg">
                <div class="text-center">
                    <p class="text-sm text-gray-400 mb-2">Nettovermögen (Wert - Darlehen)</p>
                    <p id="immo-nettovermoegen" class="text-3xl font-bold text-green-400">0 €</p>
                </div>
            </div>

            <!-- Berechnete Darlehensrate anzeigen -->
            <div id="immo-rate-berechnet-display" class="mt-6 p-4 bg-blue-900 bg-opacity-30 rounded-lg border border-blue-500 hidden">
                <h4 class="text-sm font-semibold text-blue-300 mb-2">📊 Berechnete monatliche Darlehensrate</h4>
                <p class="text-2xl font-bold text-white"><span id="immo-rate-berechnet-wert">0 €</span></p>
                <p class="text-xs text-gray-400 mt-1">
                    Zinsen: <span id="immo-rate-zinsen">0 €</span> | Tilgung: <span id="immo-rate-tilgung">0 €</span>
                </p>
                <p class="text-xs text-blue-300 mt-2">💡 Diese Rate wird automatisch ins Vermieterkonto übertragen.</p>
            </div>

            <!-- Tilgungsplan Slider -->
            <div id="immo-tilgungsplan-section" class="mt-6 bg-gray-900 p-4 rounded-lg hidden">
                <h4 class="text-lg font-bold mb-3 text-blue-400">📈 Tilgungsplan & Vermögensaufbau</h4>

                <div class="mb-4">
                    <label class="text-sm text-gray-400 block mb-2">
                        Zeitraum: <span id="immo-tilgungsplan-jahre" class="font-bold text-white">10</span> Jahre
                    </label>
                    <input type="range" id="immo-tilgungsplan-slider" min="0" max="20" value="10" step="1" class="w-full">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>0 Jahre</span>
                        <span>20 Jahre</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div class="text-center">
                        <p class="text-xs text-gray-400">Restschuld</p>
                        <p id="immo-tilgungsplan-restschuld" class="text-lg font-bold text-red-400">0 €</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400">Gezahlte Zinsen</p>
                        <p id="immo-tilgungsplan-zinsen" class="text-lg font-bold text-yellow-400">0 €</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400">Eigenkapital</p>
                        <p id="immo-tilgungsplan-eigenkapital" class="text-lg font-bold text-green-400">0 €</p>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <p class="text-xs text-gray-400">Immobilienwert (mit Wertsteigerung)</p>
                    <p id="immo-tilgungsplan-wert" class="text-xl font-bold text-blue-400">0 €</p>
                </div>
            </div>

            <div class="mt-4 p-3 bg-blue-900 bg-opacity-30 rounded-lg border border-blue-500">
                <p class="text-sm text-blue-300">💡 <strong>Tipp:</strong> Einnahmen und Ausgaben werden im <strong>Vermieterkonto</strong> verwaltet.</p>
            </div>

            <button type="button" onclick="saveImmobilien()" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Speichern &amp; Schließen</button>
        </div>
    </div>

    <!-- Vermieterkonto Modal -->
    <div id="vermieterkonto-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="vermieterkonto-modal-title">
        <div class="bg-gray-800 w-full max-w-2xl rounded-xl shadow-2xl p-6 relative" role="document" tabindex="-1">
            <button type="button" onclick="closeModal('vermieterkonto-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" aria-label="Vermieterkonto schließen">&times;</button>
            <h3 id="vermieterkonto-modal-title" class="text-xl font-bold mb-4">Vermieterkonto</h3>
            <p class="text-sm text-gray-400 -mt-3 mb-4">Alle Einnahmen und Ausgaben deiner Immobilien laufen über dieses kostenlose Konto.</p>

            <!-- Grid für 2 Kategorien -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Monatliche Einnahmen -->
                <div class="bg-gray-900 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-3 text-green-400">Monatliche Einnahmen</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Mieteinnahmen</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-miete" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="Monatliche Miete">
                                <span class="text-gray-400">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Sonstige Einnahmen</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-sonstige-einnahmen" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="z.B. Stellplatz, Garage">
                                <span class="text-gray-400">€</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monatliche Ausgaben -->
                <div class="bg-gray-900 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-3 text-red-400">Monatliche Ausgaben</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Darlehensrate</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-rate" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="Monatliche Rate">
                                <span class="text-gray-400">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Instandhaltung</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-instandhaltung" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="Rücklagen">
                                <span class="text-gray-400">€</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">Steuern & Nebenkosten</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="vk-steuern" value="0" class="flex-1 bg-gray-700 p-2 rounded-lg text-white" inputmode="decimal" placeholder="Grundsteuer, Versicherung">
                                <span class="text-gray-400">€</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Zusammenfassung -->
            <div class="mt-6 bg-gray-900 p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-400">Einnahmen</p>
                        <p id="vk-einnahmen-total" class="text-xl font-bold text-green-400">0 €</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Ausgaben</p>
                        <p id="vk-ausgaben-total" class="text-xl font-bold text-red-400">0 €</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Monatlicher Saldo</p>
                        <p id="vk-saldo" class="text-2xl font-bold text-blue-400">0 €</p>
                    </div>
                </div>
            </div>

            <button type="button" onclick="saveVermieterkonto()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Speichern &amp; Schließen</button>
        </div>
    </div>

    <script>
    // ===== SESSION MANAGEMENT SYSTEM (v1.2.0) =====
    // Implements DSGVO-compliant session-based data storage

    const SESSION_STORAGE_KEY = 'mlp_current_session';
    const INACTIVITY_WARNING_MS = 30 * 60 * 1000; // 30 minutes
    const INACTIVITY_TIMEOUT_MS = 60 * 60 * 1000; // 60 minutes

    let sessionInactivityWarningTimer = null;
    let sessionInactivityTimeoutTimer = null;
    let sessionStartTime = null;
    let sessionTimerInterval = null;

    // Generate unique session ID: YYYYMMDD-HHMM-XXXX
    function generateSessionId() {
        const now = new Date();
        const date = now.toISOString().slice(0, 10).replace(/-/g, '');
        const time = now.toTimeString().slice(0, 5).replace(':', '');
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `${date}-${time}-${random}`;
    }

    // Get current session data
    function getCurrentSession() {
        try {
            const raw = sessionStorage.getItem(SESSION_STORAGE_KEY);
            return raw ? JSON.parse(raw) : null;
        } catch (e) {
            console.warn('Failed to load session:', e);
            return null;
        }
    }

    // Save session data
    function saveSession(session) {
        try {
            session.letzteAktivitaet = new Date().toISOString();
            sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(session));
            resetInactivityTimers();
        } catch (e) {
            console.error('Failed to save session:', e);
        }
    }

    // Start new session
    function startSession(kundenKuerzel = null, berater = null) {
        const sessionId = generateSessionId();
        const now = new Date().toISOString();

        const session = {
            id: sessionId,
            kundenKuerzel: kundenKuerzel || null,
            berater: berater || null,
            startzeit: now,
            letzteAktivitaet: now,
            status: 'aktiv'
        };

        sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(session));
        sessionStartTime = new Date();

        // Start session timer
        updateSessionInfoBar();
        startSessionTimer();
        resetInactivityTimers();

        // Start auto-export timer (v1.3.6)
        startAutoExport();

        // Hide session start dialog
        closeModal('session-start-dialog');

        console.log(`📋 Session gestartet: ${sessionId}`);
        return session;
    }

    // End session and clear all data
    function endSession(exportFirst = false) {
        const session = getCurrentSession();

        if (exportFirst) {
            // Export session as JSON before ending
            exportAsJSON(false);
        }

        // Stop auto-export timer (v1.3.6)
        stopAutoExport();

        // Clear all session storage
        sessionStorage.clear();

        if (session) {
            console.log(`🗑️ Session gelöscht: ${session.id} am ${new Date().toISOString()}`);
        }

        // Stop timers
        if (sessionTimerInterval) {
            clearInterval(sessionTimerInterval);
            sessionTimerInterval = null;
        }
        clearInactivityTimers();

        // Reload to show session start dialog
        window.location.reload();
    }

    // Update session button and dropdown
    function updateSessionInfoBar() {
        const session = getCurrentSession();
        if (!session) return;

        const buttonContainer = getEl('session-button-container');
        if (!buttonContainer) return;

        const sessionIdEl = getEl('session-id-display');
        const kundenKuerzelEl = getEl('session-kunden-display');
        const timerEl = getEl('session-timer');

        if (sessionIdEl) sessionIdEl.textContent = session.id;
        if (kundenKuerzelEl) {
            kundenKuerzelEl.textContent = session.kundenKuerzel || 'Keine Angabe';
        }

        buttonContainer.style.display = 'block';
    }

    // Toggle session dropdown menu
    function toggleSessionMenu() {
        const dropdown = getEl('session-dropdown');
        const chevron = getEl('session-menu-chevron');

        if (!dropdown) return;

        const isOpen = dropdown.style.display === 'block';

        if (isOpen) {
            dropdown.style.display = 'none';
            if (chevron) chevron.style.transform = 'rotate(0deg)';
        } else {
            dropdown.style.display = 'block';
            if (chevron) chevron.style.transform = 'rotate(180deg)';
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const buttonContainer = getEl('session-button-container');
        const dropdown = getEl('session-dropdown');
        const chevron = getEl('session-menu-chevron');

        if (!buttonContainer || !dropdown) return;

        // If click is outside the button container and dropdown is open
        if (!buttonContainer.contains(e.target) && dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
            if (chevron) chevron.style.transform = 'rotate(0deg)';
        }
    });

    // Start session duration timer
    function startSessionTimer() {
        if (sessionTimerInterval) {
            clearInterval(sessionTimerInterval);
        }

        sessionTimerInterval = setInterval(() => {
            const session = getCurrentSession();
            if (!session) return;

            const start = new Date(session.startzeit);
            const now = new Date();
            const diffMs = now - start;
            const diffMins = Math.floor(diffMs / 60000);

            const timerEl = getEl('session-timer');
            if (timerEl) {
                if (diffMins < 60) {
                    timerEl.textContent = `${diffMins} Min.`;
                } else {
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    timerEl.textContent = `${hours}h ${mins}m`;
                }
            }
        }, 30000); // Update every 30 seconds
    }

    // Reset inactivity timers
    function resetInactivityTimers() {
        clearInactivityTimers();

        // Warning after 30 min
        sessionInactivityWarningTimer = setTimeout(() => {
            showInactivityWarning();
        }, INACTIVITY_WARNING_MS);

        // Auto-end after 60 min
        sessionInactivityTimeoutTimer = setTimeout(() => {
            showInactivityTimeout();
        }, INACTIVITY_TIMEOUT_MS);
    }

    // Clear inactivity timers
    function clearInactivityTimers() {
        if (sessionInactivityWarningTimer) {
            clearTimeout(sessionInactivityWarningTimer);
            sessionInactivityWarningTimer = null;
        }
        if (sessionInactivityTimeoutTimer) {
            clearTimeout(sessionInactivityTimeoutTimer);
            sessionInactivityTimeoutTimer = null;
        }
    }

    // Show inactivity warning
    function showInactivityWarning() {
        const toast = document.createElement('div');
        toast.id = 'inactivity-warning-toast';
        toast.className = 'fixed bottom-4 right-4 bg-yellow-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 max-w-md';
        toast.innerHTML = `
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div>
                    <p class="font-bold mb-1">Beratung noch aktiv?</p>
                    <p class="text-sm mb-3">Daten werden bei weiterer Inaktivität nach 60 Min. automatisch gelöscht.</p>
                    <button onclick="confirmSessionActive()" class="bg-white text-yellow-600 px-4 py-2 rounded font-bold hover:bg-yellow-50">
                        Ich bin noch da
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(toast);
    }

    // Confirm session is still active
    function confirmSessionActive() {
        const toast = getEl('inactivity-warning-toast');
        if (toast) toast.remove();

        const session = getCurrentSession();
        if (session) {
            saveSession(session);
        }

        // Reset inactivity timers so user gets another 30 minutes
        resetInactivityTimers();
    }

    // Show inactivity timeout dialog
    function showInactivityTimeout() {
        if (confirm('Die Beratung wurde wegen Inaktivität beendet. Alle Daten werden gelöscht.\n\nMöchten Sie die Daten vor dem Löschen exportieren?')) {
            endSession(true);
        } else {
            endSession(false);
        }
    }

    // Show session start dialog
    function showSessionStartDialog() {
        openModal('session-start-dialog');

        // Check if privacy notice was previously acknowledged
        const privacyAcknowledged = localStorage.getItem('mlp-privacy-acknowledged') === 'true';
        const privacyBox = getEl('privacy-notice-box');
        if (privacyBox) {
            privacyBox.style.display = privacyAcknowledged ? 'none' : 'block';
        }
    }

    // Show session recovery dialog
    function showSessionRecoveryDialog(session) {
        const dialog = getEl('session-recovery-dialog');
        if (!dialog) return;

        const sessionInfo = getEl('recovery-session-info');
        if (sessionInfo) {
            const start = new Date(session.startzeit);
            const now = new Date();
            const diffMins = Math.floor((now - start) / 60000);

            sessionInfo.innerHTML = `
                <p class="mb-2"><strong>Session-ID:</strong> ${session.id}</p>
                <p class="mb-2"><strong>Kunde:</strong> ${session.kundenKuerzel || 'Keine Angabe'}</p>
                <p><strong>Gestartet:</strong> vor ${diffMins} Min.</p>
            `;
        }

        openModal('session-recovery-dialog');
    }

    // Continue existing session
    function continueSession() {
        const session = getCurrentSession();
        if (session) {
            sessionStartTime = new Date(session.startzeit);
            updateSessionInfoBar();
            startSessionTimer();
            resetInactivityTimers();
            closeModal('session-recovery-dialog');
            console.log(`▶️ Session fortgesetzt: ${session.id}`);
        }
    }

    // Start new session (discard old one)
    function startNewSessionAndDiscard() {
        sessionStorage.clear();
        closeModal('session-recovery-dialog');
        showSessionStartDialog();
    }

    // Show session end confirmation dialog
    function showSessionEndDialog() {
        const session = getCurrentSession();
        if (!session) return;

        const dialog = getEl('session-end-dialog');
        if (!dialog) return;

        openModal('session-end-dialog');
    }

    // Prevent tab close without confirmation
    let allowReloadWithoutWarning = false;
    window.addEventListener('beforeunload', (e) => {
        // Skip warning if we're reloading after import
        if (allowReloadWithoutWarning) {
            return;
        }

        const session = getCurrentSession();
        if (session && session.status !== 'exportiert') {
            e.preventDefault();
            e.returnValue = 'Beratung beenden? Daten gehen verloren!';
        }
    });

    // Track user activity
    function trackActivity() {
        const session = getCurrentSession();
        if (session) {
            saveSession(session);
        }
    }

    // Attach activity listeners
    ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, trackActivity, { passive: true, once: false });
    });

    // Start session from dialog with user input
    function startSessionFromDialog() {
        const kundenKuerzel = getEl('session-kunden-kuerzel')?.value.trim() || null;
        const berater = getEl('session-berater')?.value.trim() || null;

        // Save privacy acknowledgment if checkbox is checked
        const privacyCheckbox = getEl('privacy-understood-checkbox');
        if (privacyCheckbox && privacyCheckbox.checked) {
            localStorage.setItem('mlp-privacy-acknowledged', 'true');
        }

        startSession(kundenKuerzel, berater);
    }

    // ===== END SESSION MANAGEMENT SYSTEM =====

    // ===== EXPORT FUNCTIONS (v1.3.0) =====

    // Export all session data as CSV
    function exportAsCSV() {
        const session = getCurrentSession();
        if (!session) {
            alert('Keine Session gefunden!');
            return;
        }

        // Check if inputs are initialized
        if (typeof inputs === 'undefined') {
            console.error('Export failed: inputs not initialized');
            alert('Export-Fehler: Bitte warten Sie, bis die Seite vollständig geladen ist.');
            return;
        }

        // Collect all data
        const income = parseFloat(inputs.income?.value) || 0;
        const konsumMin = parseFloat(inputs.konsumMin?.value) || 0;
        const konsumLeftover = parseFloat(inputs.konsumLeftover?.value) || 0;
        const tagesgeldCurrent = parseFloat(inputs.tagesgeldCurrent?.value) || 0;
        const tagesgeldLimit = parseFloat(inputs.tagesgeldLimit?.value) || 0;
        const depotCurrent = parseFloat(inputs.depotCurrent?.value) || 0;
        const anlagezeitraum = parseInt(inputs.anlagezeitraum?.value, 10) || 15;
        const rendite = parseFloat(inputs.rendite?.value) || 0;

        // Build CSV content
        const BOM = '\uFEFF'; // UTF-8 BOM for Excel compatibility
        let csv = '';

        // Header with session metadata
        csv += `# Beratungsprotokoll - MLP Vermögensmanagement\n`;
        csv += `# Session-ID: ${session.id}\n`;
        csv += `# Kunde: ${session.kundenKuerzel || 'N/A'}\n`;
        csv += `# Berater: ${session.berater || 'N/A'}\n`;
        csv += `# Datum: ${new Date(session.startzeit).toLocaleDateString('de-DE')}\n`;
        csv += `# Exportiert am: ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}\n`;
        csv += `# Variante: ${currentVariant}\n`;
        csv += `\n`;

        // Data section
        csv += `Kategorie;Beschreibung;Betrag (EUR);Intervall;Ziel\n`;

        // Einkommen
        csv += `Einkommen;Haupteinkommen;${income};monatlich;einkommen\n`;

        // Fixkosten & Sparpläne
        fixkostenItems.forEach(item => {
            const monthlyAmount = getMonthlyAmount(item);
            const kategorie = item.target === 'depot' ? 'Sparplan' : 'Fixkosten';
            const intervall = item.interval === 'monthly' ? 'monatlich' :
                             item.interval === 'quarterly' ? 'vierteljährlich' : 'jährlich';
            csv += `${kategorie};${item.name};${monthlyAmount};${intervall};${item.target}\n`;
        });

        // Konsum
        csv += `Konsum;Mindestbetrag;${konsumMin};monatlich;konsum\n`;
        csv += `Konsum;Überschuss;${konsumLeftover};monatlich;konsum\n`;

        // Tagesgeld
        csv += `Tagesgeld;Aktueller Stand;${tagesgeldCurrent};einmalig;tagesgeld\n`;
        csv += `Tagesgeld;Sparziel;${tagesgeldLimit};einmalig;tagesgeld\n`;

        // Depot
        csv += `Depot;Aktueller Stand;${depotCurrent};einmalig;depot\n`;
        csv += `Depot;Anlagezeitraum (Jahre);${anlagezeitraum};-;depot\n`;
        csv += `Depot;Erwartete Rendite (%);${rendite};jährlich;depot\n`;

        // Depot-Allocation
        csv += `\n# Depot-Aufteilung\n`;
        csv += `Fonds/ETF;Allocation (%)\n`;
        depotItems.forEach(item => {
            csv += `${item.name};${item.allocation}\n`;
        });

        // Immobilien
        if (immobilienData && immobilienData.length > 0) {
            csv += `\n# Immobilien\n`;
            csv += `Objekt;Wert (EUR);Darlehen (EUR);Zinssatz (%);Tilgungssatz (%);Mieteinnahmen (EUR);Kosten (EUR)\n`;
            immobilienData.forEach(immo => {
                csv += `${immo.objekt || 'Immobilie'};${immo.wert || 0};${immo.darlehen || 0};${immo.zinssatz || 0};${immo.tilgungssatz || 0};${immo.mieteinnahmen || 0};${immo.kosten || 0}\n`;
            });
        }

        // Vermieterkonto
        const vermieterData = getVermieterkontoData();
        if (vermieterData) {
            csv += `\n# Vermieterkonto\n`;
            csv += `Beschreibung;Betrag (EUR)\n`;
            csv += `Mieteinnahmen (netto);${vermieterData.mieteinnahmenNetto}\n`;
            csv += `Darlehenszinsen;${vermieterData.darlehenszinsen}\n`;
            csv += `Tilgung;${vermieterData.tilgung}\n`;
            csv += `Nebenkosten & Instandhaltung;${vermieterData.nebenkostenInstand}\n`;
            csv += `Gesamt-Ausgaben;${vermieterData.gesamtAusgaben}\n`;
            csv += `Saldo (monatlich);${vermieterData.saldo}\n`;
        }

        // Buchungsplaner
        if (typeof bookingPlan !== 'undefined' && bookingPlan && Object.keys(bookingPlan).length > 0) {
            csv += `\n# Buchungsplaner (Transaktionstermine)\n`;
            csv += `Tag;Beschreibung\n`;

            Object.keys(bookingPlan).forEach(month => {
                const monthData = bookingPlan[month];
                if (monthData && typeof monthData === 'object') {
                    Object.keys(monthData).forEach(day => {
                        const bookings = monthData[day];
                        if (Array.isArray(bookings)) {
                            bookings.forEach(bookingTypeId => {
                                const bookingType = bookingTypeLookup[bookingTypeId];
                                if (bookingType) {
                                    const description = getActiveBookingDescription(bookingType);
                                    csv += `${day};${description}\n`;
                                }
                            });
                        }
                    });
                }
            });
        }

        // Create download
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8' });
        const filename = `Beratung_${session.kundenKuerzel || session.id}_${new Date().toISOString().slice(0, 10)}.csv`;
        downloadFile(blob, filename);

        console.log('📄 CSV-Export erstellt:', filename);
    }

    // ===== AUTO-EXPORT SYSTEM (v1.3.7) =====
    let autoExportInterval = null;
    let lastAutoExportTime = null;
    let autoExportDirectoryHandle = null; // File System Access API handle
    let useFileSystemAPI = false;

    // IndexedDB for persisting directory handle
    const DB_NAME = 'mlp-auto-export-db';
    const DB_VERSION = 1;
    const STORE_NAME = 'directory-handles';
    const HANDLE_KEY = 'auto-export-directory';

    // Open IndexedDB
    function openHandleDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
        });
    }

    // Save directory handle to IndexedDB
    async function saveDirectoryHandle(handle) {
        try {
            const db = await openHandleDB();
            const transaction = db.transaction(STORE_NAME, 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(handle, HANDLE_KEY);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log('✅ Directory Handle in IndexedDB gespeichert');
                    resolve(true);
                };
                transaction.onerror = () => reject(transaction.error);
            });
        } catch (err) {
            console.error('Fehler beim Speichern des Handles:', err);
            return false;
        }
    }

    // Load directory handle from IndexedDB
    async function loadDirectoryHandle() {
        try {
            const db = await openHandleDB();
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(HANDLE_KEY);

            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const handle = request.result;
                    if (handle) {
                        console.log('📂 Directory Handle aus IndexedDB geladen');
                        resolve(handle);
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        } catch (err) {
            console.error('Fehler beim Laden des Handles:', err);
            return null;
        }
    }

    // Verify permission for directory handle
    async function verifyHandlePermission(handle, requestIfNeeded = false) {
        const permission = await handle.queryPermission({ mode: 'readwrite' });
        if (permission === 'granted') {
            return true;
        }

        // Only request permission if explicitly requested (requires user gesture)
        if (requestIfNeeded) {
            try {
                const requestResult = await handle.requestPermission({ mode: 'readwrite' });
                return requestResult === 'granted';
            } catch (err) {
                // Permission request failed (likely no user gesture)
                return false;
            }
        }

        return false;
    }

    // Check if File System Access API is available
    function checkFileSystemAPISupport() {
        return 'showDirectoryPicker' in window;
    }

    // Request directory access from user
    async function selectAutoExportDirectory() {
        if (!checkFileSystemAPISupport()) {
            alert('Ihr Browser unterstützt keine direkte Ordner-Speicherung.\n\nBitte nutzen Sie Chrome oder Edge (Version 86+) für diese Funktion.\n\nFallback: Dateien werden in den Download-Ordner gespeichert.');
            return false;
        }

        try {
            // Show directory picker
            const dirHandle = await window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            });

            // Request permission
            const permission = await dirHandle.requestPermission({ mode: 'readwrite' });

            if (permission !== 'granted') {
                alert('Ordner-Zugriff wurde verweigert. Auto-Export verwendet Download-Ordner.');
                return false;
            }

            // Store handle in memory AND IndexedDB
            autoExportDirectoryHandle = dirHandle;

            // Save to IndexedDB (persistent across reloads!)
            await saveDirectoryHandle(dirHandle);

            // Save preference to localStorage (as backup indicator)
            localStorage.setItem('mlp-auto-export-dir-name', dirHandle.name);
            localStorage.setItem('mlp-use-filesystem-api', 'true');
            useFileSystemAPI = true;

            console.log('✅ Auto-Export-Ordner ausgewählt:', dirHandle.name);
            updateAutoExportFolderDisplay();

            showToast(`Auto-Export-Ordner eingerichtet: ${dirHandle.name}\n\nEin Test-Export wird erstellt...`, 'success', 4000);

            // Trigger immediate test export to verify it works
            setTimeout(() => {
                exportAsJSON(true);
            }, 500);

            return true;
        } catch (err) {
            if (err.name === 'AbortError') {
                console.log('Ordner-Auswahl abgebrochen');
            } else {
                console.error('Fehler bei Ordner-Auswahl:', err);
                alert('Fehler beim Einrichten des Auto-Export-Ordners.');
            }
            return false;
        }
    }

    // Restore directory handle on page load
    async function restoreAutoExportDirectory() {
        const useFSAPI = localStorage.getItem('mlp-use-filesystem-api') === 'true';

        if (!useFSAPI || !checkFileSystemAPISupport()) {
            useFileSystemAPI = false;
            updateAutoExportFolderDisplay();
            return;
        }

        try {
            // Load handle from IndexedDB
            const savedHandle = await loadDirectoryHandle();

            if (!savedHandle) {
                console.log('⚠️ Kein Handle in IndexedDB gefunden');
                useFileSystemAPI = true;
                updateAutoExportFolderDisplay();
                return;
            }

            // Verify permission
            const hasPermission = await verifyHandlePermission(savedHandle);

            if (hasPermission) {
                // Success! Handle restored and permission granted
                autoExportDirectoryHandle = savedHandle;
                useFileSystemAPI = true;
                console.log('✅ Directory Handle wiederhergestellt:', savedHandle.name);
                showToast(`Auto-Export-Ordner wiederhergestellt: ${savedHandle.name}`, 'success', 3000);
            } else {
                // Permission denied
                console.log('❌ Permission verweigert für gespeicherten Ordner');
                useFileSystemAPI = true; // Keep trying, will fallback to downloads
            }

            updateAutoExportFolderDisplay();
        } catch (err) {
            console.error('Fehler beim Wiederherstellen des Handles:', err);
            useFileSystemAPI = false;
            updateAutoExportFolderDisplay();
        }
    }

    // Update folder display in UI
    function updateAutoExportFolderDisplay() {
        const folderDisplayEl = document.getElementById('auto-export-folder-display');
        if (!folderDisplayEl) return;

        if (useFileSystemAPI && autoExportDirectoryHandle) {
            folderDisplayEl.innerHTML = `<span class="text-green-400">📁 ${autoExportDirectoryHandle.name}</span>`;
        } else if (useFileSystemAPI) {
            const savedName = localStorage.getItem('mlp-auto-export-dir-name');
            if (savedName) {
                folderDisplayEl.innerHTML = `<span class="text-yellow-400">📁 ${savedName} (reaktivieren)</span>`;
            } else {
                folderDisplayEl.innerHTML = `<span class="text-gray-400">📁 Nicht konfiguriert</span>`;
            }
        } else {
            folderDisplayEl.innerHTML = `<span class="text-gray-400">📥 Download-Ordner</span>`;
        }
    }

    // Write file to selected directory using File System Access API
    async function writeToDirectory(filename, blob) {
        if (!autoExportDirectoryHandle) {
            // Can't show picker automatically (needs user gesture)
            // Return false to trigger fallback to download
            console.warn('⚠️ Kein Ordner-Handle verfügbar. Bitte "Ordner auswählen" klicken.');

            // Show user a hint (only once per session)
            if (!sessionStorage.getItem('folder-hint-shown')) {
                sessionStorage.setItem('folder-hint-shown', 'true');
                setTimeout(() => {
                    showToast('💡 Tipp: Klicke im Session-Menü auf "Ordner auswählen" für direkte Speicherung', 'info', 5000);
                }, 1000);
            }

            return false;
        }

        try {
            // Create/overwrite file in directory
            const fileHandle = await autoExportDirectoryHandle.getFileHandle(filename, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(blob);
            await writable.close();

            console.log(`✅ Datei gespeichert: ${autoExportDirectoryHandle.name}/${filename}`);
            return true;
        } catch (err) {
            console.error('Fehler beim Speichern:', err);

            // If permission was revoked, reset
            if (err.name === 'NotAllowedError') {
                autoExportDirectoryHandle = null;
                localStorage.removeItem('mlp-use-filesystem-api');
                useFileSystemAPI = false;
                updateAutoExportFolderDisplay();
            }

            return false;
        }
    }

    // Generate auto-export filename: {DATUM}_{KÜRZEL}_{UHRZEIT}_{SESSION-ID}.json
    function generateAutoExportFilename() {
        const session = getCurrentSession();
        if (!session) return null;

        const now = new Date();

        // DATUM: YYYY-MM-DD
        const datum = now.toISOString().slice(0, 10);

        // KÜRZEL: from session or "ANON"
        const kuerzel = session.kundenKuerzel || 'ANON';

        // UHRZEIT: HHMM
        const stunden = String(now.getHours()).padStart(2, '0');
        const minuten = String(now.getMinutes()).padStart(2, '0');
        const uhrzeit = stunden + minuten;

        // SESSION-ID: first 4 chars
        const sessionId = session.id.substring(0, 8).toUpperCase();

        return `${datum}_${kuerzel}_${uhrzeit}_SES-${sessionId}.json`;
    }

    // Export all session data as JSON (used for manual and auto-export)
    function exportAsJSON(isAutoExport = false) {
        const session = getCurrentSession();
        if (!session) {
            if (!isAutoExport) alert('Keine Session gefunden!');
            return;
        }

        // Check if inputs are initialized
        if (typeof inputs === 'undefined') {
            console.error('Export failed: inputs not initialized');
            if (!isAutoExport) alert('Export-Fehler: Bitte warten Sie, bis die Seite vollständig geladen ist.');
            return;
        }

        // Collect ALL application data for complete session backup
        const exportData = {
            // Format version for future compatibility
            version: '1.3.7',
            exportType: 'FULL_SESSION_BACKUP',

            // LLM Prompt for generating consultation protocol
            llmPrompt: `Du bist ein professioneller Finanzberater bei MLP. Erstelle aus den folgenden Session-Daten ein strukturiertes, professionelles Gesprächsprotokoll für die Kundendokumentation.

**Aufgabe:**
Erstelle ein Beratungsprotokoll im MLP-Stil mit folgender Struktur:

1. **Kopfdaten**
   - Session-ID, Datum, Berater, Kunde
   - Beratungsdauer

2. **Ist-Situation (Einnahmen)**
   - Monatliches Einkommen
   - Sonstige Einnahmen (falls vorhanden)

3. **Ausgabenstruktur**
   - Fixkosten (detailliert auflisten)
   - Lebenshaltungskosten
   - Kontenmodell (Variante A oder B?)

4. **Vermögenssituation**
   - Tagesgeld (aktuell, Ziel)
   - Depot (aktuell, Sparplan, Allocation, Renditeerwartung)
   - Immobilien (falls vorhanden: Wert, Darlehen, Cashflow)
   - Vermieterkonto (falls vorhanden: Einnahmen/Ausgaben)

5. **Finanzplanung**
   - Monatliche Sparrate
   - Anlagehorizont
   - Buchungsplan (Transaktionstermine)

6. **Empfehlungen**
   - Basierend auf den Daten: Was läuft gut? Wo gibt es Optimierungspotenzial?
   - Nächste Schritte

**Tonalität:**
- Professionell, aber verständlich
- Faktenbasiert
- Positive Formulierungen
- Konkrete Zahlen nennen

**Format:** Markdown mit klaren Überschriften und Bullet-Points.

Die Daten findest du in diesem JSON unter den Feldern: session, settings, inputs, fixkostenItems, depotItems, immobilienData, vermieterkontoData, buchungsplan.`,

            // Session metadata
            session: {
                id: session.id,
                kundenKuerzel: session.kundenKuerzel,
                berater: session.berater,
                startzeit: session.startzeit,
                letzteAktivitaet: session.letzteAktivitaet,
                exportiert: new Date().toISOString(),
                status: session.status
            },

            // Application settings (for UI state restoration)
            settings: {
                currentVariant: currentVariant,
                consultationMode: consultationMode,
                consultationStep: consultationStep,
                theme: localStorage.getItem('theme') || 'dark'
            },

            // All financial input data
            inputs: {
                income: parseFloat(inputs.income?.value) || 0,
                konsumMin: parseFloat(inputs.konsumMin?.value) || 0,
                konsumLeftover: parseFloat(inputs.konsumLeftover?.value) || 0,
                tagesgeldCurrent: parseFloat(inputs.tagesgeldCurrent?.value) || 0,
                tagesgeldLimit: parseFloat(inputs.tagesgeldLimit?.value) || 0,
                depotCurrent: parseFloat(inputs.depotCurrent?.value) || 0,
                anlagezeitraum: parseInt(inputs.anlagezeitraum?.value, 10) || 15,
                rendite: parseFloat(inputs.rendite?.value) || 0
            },

            // Structured data arrays
            fixkostenItems: fixkostenItems || [],
            depotItems: depotItems || [],
            immobilienData: immobilienData || [],

            // Vermieterkonto (complete structure)
            vermieterkontoData: (function() {
                try {
                    const saved = sessionStorage.getItem('vermieterkontoData');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    return null;
                }
            })(),

            // Buchungsplan (transaction scheduler)
            buchungsplan: (typeof bookingPlan !== 'undefined') ? bookingPlan : {},

            // Raw sessionStorage snapshot (for complete restoration)
            sessionStorageSnapshot: {
                mlp_current_session: sessionStorage.getItem('mlp_current_session'),
                mlp_booking_plan_v1: sessionStorage.getItem('mlp_booking_plan_v1'),
                immobilienData: sessionStorage.getItem('immobilienData'),
                vermieterkontoData: sessionStorage.getItem('vermieterkontoData')
            }
        };

        // Create pretty-printed JSON
        const json = JSON.stringify(exportData, null, 2);
        const blob = new Blob([json], { type: 'application/json;charset=utf-8' });

        // Use auto-export filename format or fallback to old format
        const filename = isAutoExport
            ? generateAutoExportFilename()
            : `Session-Backup_${session.kundenKuerzel || session.id}_${new Date().toISOString().slice(0, 10)}.json`;

        // Try File System API for auto-export, fallback to download
        if (isAutoExport && useFileSystemAPI) {
            writeToDirectory(filename, blob).then(success => {
                if (success) {
                    lastAutoExportTime = Date.now();
                    updateAutoExportStatus();
                    console.log('🔄 Auto-Export (File System API):', filename);
                } else {
                    // Fallback to download
                    downloadFile(blob, filename);
                    lastAutoExportTime = Date.now();
                    updateAutoExportStatus();
                    console.log('🔄 Auto-Export (Download fallback):', filename);
                }
            }).catch(err => {
                console.error('Auto-Export Fehler:', err);
                // Fallback to download on error
                downloadFile(blob, filename);
                lastAutoExportTime = Date.now();
                updateAutoExportStatus();
            });
        } else {
            // Manual export or File System API not available
            downloadFile(blob, filename);

            // Update last export time
            if (isAutoExport) {
                lastAutoExportTime = Date.now();
                updateAutoExportStatus();
                console.log('🔄 Auto-Export erstellt:', filename);
            } else {
                console.log('📄 JSON-Backup erstellt:', filename);
                console.log('💾 Vollständiges Session-Backup - kann für Re-Import verwendet werden');
            }
        }
    }

    // Start auto-export timer (runs every 2 minutes)
    // Check if auto-save is enabled
    function isAutoSaveEnabled() {
        // Default: OFF (manual save only)
        const enabled = localStorage.getItem('mlp-auto-save-enabled');
        return enabled === 'true';
    }

    // Save auto-save preference
    function setAutoSaveEnabled(enabled) {
        localStorage.setItem('mlp-auto-save-enabled', enabled ? 'true' : 'false');
        console.log(`🔄 Auto-Save ${enabled ? 'aktiviert' : 'deaktiviert'}`);
    }

    function startAutoExport() {
        // Only start if auto-save is enabled
        if (!isAutoSaveEnabled()) {
            console.log('⏸️ Auto-Export nicht gestartet (manueller Modus)');
            return;
        }

        // Clear existing timer
        if (autoExportInterval) {
            clearInterval(autoExportInterval);
        }

        // First export after 30 seconds (give user time to enter data)
        setTimeout(() => {
            if (isAutoSaveEnabled()) {
                exportAsJSON(true);
            }
        }, 30000);

        // Then export every 2 minutes (120000ms)
        autoExportInterval = setInterval(() => {
            if (isAutoSaveEnabled()) {
                exportAsJSON(true);
            }
        }, 120000);

        console.log('✅ Auto-Export aktiviert (alle 2 Min., erster Export in 30 Sek.)');
    }

    // Stop auto-export timer
    function stopAutoExport() {
        if (autoExportInterval) {
            clearInterval(autoExportInterval);
            autoExportInterval = null;
            console.log('⏹️ Auto-Export gestoppt');
        }
    }

    // Toggle auto-save on/off
    function toggleAutoSave(enabled) {
        setAutoSaveEnabled(enabled);

        if (enabled) {
            startAutoExport();
            showToast('Automatische Speicherung aktiviert (alle 2 Min.)', 'success', 3000);
        } else {
            stopAutoExport();
            showToast('Automatische Speicherung deaktiviert', 'info', 3000);
        }

        // Update UI
        updateAutoSaveUI();
    }

    // Update auto-save UI elements
    function updateAutoSaveUI() {
        const toggle = document.getElementById('auto-save-toggle');
        const intervalInfo = document.getElementById('auto-save-interval-info');
        const enabled = isAutoSaveEnabled();

        if (toggle) {
            toggle.checked = enabled;
        }

        if (intervalInfo) {
            if (enabled) {
                intervalInfo.textContent = 'Automatisch alle 2 Minuten';
                intervalInfo.classList.remove('text-gray-500');
                intervalInfo.classList.add('text-green-500');
            } else {
                intervalInfo.textContent = 'Manueller Speichermodus';
                intervalInfo.classList.remove('text-green-500');
                intervalInfo.classList.add('text-gray-500');
            }
        }
    }

    // Update auto-export status display
    function updateAutoExportStatus() {
        const statusEl = document.getElementById('auto-export-status');
        if (!statusEl) return;

        if (!lastAutoExportTime) {
            statusEl.innerHTML = '<span class="text-yellow-400">⏳ Wartet auf ersten Export...</span>';
            return;
        }

        const secondsAgo = Math.floor((Date.now() - lastAutoExportTime) / 1000);

        if (secondsAgo < 60) {
            statusEl.innerHTML = `<span class="text-green-400">🟢 Vor ${secondsAgo} Sek.</span>`;
        } else {
            const minutesAgo = Math.floor(secondsAgo / 60);
            statusEl.innerHTML = `<span class="text-green-400">🟢 Vor ${minutesAgo} Min.</span>`;
        }
    }

    // Update status display every 5 seconds
    setInterval(() => {
        updateAutoExportStatus();
    }, 5000);

    // Import session from JSON backup file
    function importSessionBackup() {
        // Create file input element
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const backup = JSON.parse(text);

                // Validate backup format
                if (!backup.version || backup.exportType !== 'FULL_SESSION_BACKUP') {
                    showToast('Ungültiges Backup-Format! Bitte wähle eine gültige Session-Backup-Datei.', 'error', 5000);
                    return;
                }

                // Show confirmation modal (keep the existing modal from screenshot)
                const confirmed = confirm(
                    `Session-Backup importieren?\n\n` +
                    `Session-ID: ${backup.session?.id || 'Unbekannt'}\n` +
                    `Kunde: ${backup.session?.kundenKuerzel || 'N/A'}\n` +
                    `Berater: ${backup.session?.berater || 'N/A'}\n` +
                    `Exportiert: ${backup.session?.exportiert ? new Date(backup.session.exportiert).toLocaleString('de-DE') : 'N/A'}\n\n` +
                    `Alle aktuellen Daten werden überschrieben!`
                );

                if (!confirmed) return;

                // Restore sessionStorage
                if (backup.sessionStorageSnapshot) {
                    Object.keys(backup.sessionStorageSnapshot).forEach(key => {
                        const value = backup.sessionStorageSnapshot[key];
                        if (value) {
                            sessionStorage.setItem(key, value);
                        }
                    });
                }

                // Restore input field values AND persist to sessionStorage for reload
                if (backup.inputs) {
                    // Persist to sessionStorage (to survive reload)
                    sessionStorage.setItem('mlp_inputs', JSON.stringify(backup.inputs));

                    // Set values (will be overwritten by reload, but needed for consistency)
                    if (inputs.income) inputs.income.value = backup.inputs.income || 0;
                    if (inputs.konsumMin) inputs.konsumMin.value = backup.inputs.konsumMin || 0;
                    if (inputs.konsumLeftover) inputs.konsumLeftover.value = backup.inputs.konsumLeftover || 0;
                    if (inputs.tagesgeldCurrent) inputs.tagesgeldCurrent.value = backup.inputs.tagesgeldCurrent || 0;
                    if (inputs.tagesgeldLimit) inputs.tagesgeldLimit.value = backup.inputs.tagesgeldLimit || 0;
                    if (inputs.depotCurrent) inputs.depotCurrent.value = backup.inputs.depotCurrent || 0;
                    if (inputs.anlagezeitraum) inputs.anlagezeitraum.value = backup.inputs.anlagezeitraum || 15;
                    if (inputs.rendite) inputs.rendite.value = backup.inputs.rendite || 7;
                }

                // Restore global variables AND persist to sessionStorage for reload
                if (backup.fixkostenItems) {
                    fixkostenItems = backup.fixkostenItems;
                    // Persist to survive reload
                    sessionStorage.setItem('mlp_fixkostenItems', JSON.stringify(backup.fixkostenItems));
                }
                if (backup.depotItems) {
                    depotItems = backup.depotItems;
                    // Persist to survive reload
                    sessionStorage.setItem('mlp_depotItems', JSON.stringify(backup.depotItems));
                }
                if (backup.immobilienData) {
                    immobilienData = backup.immobilienData;
                    // Already persisted via sessionStorageSnapshot
                }
                if (backup.buchungsplan && typeof bookingPlan !== 'undefined') {
                    bookingPlan = backup.buchungsplan;
                    saveBookingPlan(); // This already saves to sessionStorage
                }

                // Restore UI settings
                if (backup.settings) {
                    if (backup.settings.currentVariant) {
                        currentVariant = backup.settings.currentVariant;
                    }
                    if (typeof backup.settings.consultationMode !== 'undefined') {
                        consultationMode = backup.settings.consultationMode;
                    }
                    if (typeof backup.settings.consultationStep !== 'undefined') {
                        consultationStep = backup.settings.consultationStep;
                    }
                    if (backup.settings.theme) {
                        localStorage.setItem('theme', backup.settings.theme);
                        loadTheme();
                    }
                }

                console.log('✅ Session-Backup erfolgreich importiert:', backup.session?.id);

                // Set flag to skip recovery dialog after reload
                sessionStorage.setItem('skipRecoveryDialog', 'true');

                // Show success toast and reload automatically after 2 seconds
                showToast(
                    `Session-Backup erfolgreich importiert! Seite wird neu geladen...`,
                    'success',
                    2000
                );

                // Reload page automatically after toast (without confirmation)
                setTimeout(() => {
                    allowReloadWithoutWarning = true;
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('Import-Fehler:', error);
                showToast(`Fehler beim Importieren: ${error.message}`, 'error', 6000);
            }
        };

        // Trigger file picker
        input.click();
    }

    // Helper function to download files
    function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ===== END EXPORT FUNCTIONS =====

    let currentVariant = 'A';
    
    const BOOKING_DAYS = 31;
    const BOOKING_KEY = "0";
    const bookingTypes = [
        {
            id: 'salary_to_fix',
            label: 'Einkommen → Fixkosten',
            labelB: 'Einkommen → Konsum',
            description: 'Einkommen landet auf dem Fixkostenkonto.',
            descriptionB: 'Einkommen landet auf dem Konsumkonto.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3.5" y="6.5" width="7.5" height="11" rx="2"></rect><path d="M6.5 9.5h2"></path><path d="M6.5 12h1.6"></path><circle cx="16.5" cy="12" r="3"></circle><path d="M11 12h3.5"></path><path d="M14.5 10l2 2-2 2"></path></svg>`,
            accent: '#34d399',
            border: 'rgba(16, 185, 129, 0.65)',
            dayBackground: 'rgba(16, 185, 129, 0.18)',
            badgeBackground: 'rgba(16, 185, 129, 0.18)',
            badgeColor: '#34d399'
        },
        {
            id: 'standing_to_konsum',
            label: 'Fixkosten → Konsum',
            labelB: 'Konsum → Fixkosten',
            description: 'Regelmäßiger Übertrag vom Fixkostenkonto auf das Konsumkonto.',
            descriptionB: 'Regelmäßiger Übertrag vom Konsumkonto auf das Fixkostenkonto.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M7 8h8a4 4 0 0 1 4 4v0"></path><path d="M17 10l2 2-2 2"></path><path d="M17 14h-8a4 4 0 0 1-4-4v0"></path><path d="M7 16l-2-2 2-2"></path></svg>`,
            iconB: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8h-8a4 4 0 0 0-4 4v0"></path><path d="M7 10l-2 2 2 2"></path><path d="M7 14h8a4 4 0 0 0 4-4v0"></path><path d="M17 16l2-2-2-2"></path></svg>`,
            accent: '#60a5fa',
            border: 'rgba(96, 165, 250, 0.6)',
            dayBackground: 'rgba(59, 130, 246, 0.16)',
            badgeBackground: 'rgba(59, 130, 246, 0.16)',
            badgeColor: '#60a5fa'
        },
        {
            id: 'sparplan',
            label: 'Fixkosten → Sparplan',
            description: 'Sparrate wird in den Depot-Sparplan investiert.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 16l4-5 3 2 5-6"></path><path d="M15.5 6.5h3v3"></path><path d="M6 18v2"></path><path d="M11 15v5"></path><path d="M16 17v3"></path></svg>`,
            accent: '#c084fc',
            border: 'rgba(168, 85, 247, 0.6)',
            dayBackground: 'rgba(168, 85, 247, 0.16)',
            badgeBackground: 'rgba(168, 85, 247, 0.18)',
            badgeColor: '#c084fc'
        },
        {
            id: 'konsum_to_tagesgeld',
            label: 'Konsum → Tagesgeld',
            description: 'Restbetrag wird auf das Tagesgeld geschoben.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="3"></circle><path d="M12 11v7"></path><path d="M9 15l3 3 3-3"></path><path d="M6 20h12"></path></svg>`,
            accent: '#facc15',
            border: 'rgba(250, 204, 21, 0.6)',
            dayBackground: 'rgba(250, 204, 21, 0.14)',
            badgeBackground: 'rgba(250, 204, 21, 0.18)',
            badgeColor: '#facc15'
        },
        {
            id: 'tagesgeld_to_depot',
            label: 'Tagesgeld → Depot',
            description: 'Überschüsse vom Tagesgeld fließen ins Depot.',
            icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 17h14"></path><path d="M8 17v-4"></path><path d="M12 17v-7"></path><path d="M16 17v-2"></path><path d="M12 5l-3 3h2v4h2V8h2z"></path></svg>`,
            accent: '#f97316',
            border: 'rgba(249, 115, 22, 0.6)',
            dayBackground: 'rgba(249, 115, 22, 0.16)',
            badgeBackground: 'rgba(249, 115, 22, 0.18)',
            badgeColor: '#f97316'
        }
    ];
    function getActiveBookingLabel(type) {
        if (!type) return '';
        if (currentVariant === 'B' && type.labelB) return type.labelB;
        return type.label || '';
    }

    function getActiveBookingDescription(type) {
        if (!type) return '';
        if (currentVariant === 'B' && type.descriptionB) return type.descriptionB;
        return type.description || getActiveBookingLabel(type);
    }

    function getActiveBookingIcon(type) {
        if (!type) return '';
        if (currentVariant === 'B' && type.iconB) return type.iconB;
        return type.icon || '';
    }

const bookingTypeLookup = {};
    bookingTypes.forEach((type, index) => {
        bookingTypeLookup[type.id] = Object.assign({ order: index }, type);
    });
    const bookingStorageKey = 'mlp_booking_plan_v1';
    let bookingPlan = loadBookingPlan() || createDefaultBookingPlan();
    let selectedBookingMonth = String(determineInitialBookingMonth(bookingPlan));
    let selectedBookingTypeId = bookingTypes.length ? bookingTypes[0].id : null;
    let bookingTypeButtonsEl = null;
    let bookingCalendarEl = null;
    let bookingHintEl = null;
    let bookingClearMonthBtn = null;

    function loadBookingPlan() {
        try {
            const raw = sessionStorage.getItem(bookingStorageKey);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            return (parsed && typeof parsed === 'object') ? parsed : null;
        } catch (err) {
            console.warn('Buchungsplan konnte nicht geladen werden.', err);
            return null;
        }
    }

    function saveBookingPlan() {
        pruneEmptyMonths();
        try {
            sessionStorage.setItem(bookingStorageKey, JSON.stringify(bookingPlan));
        } catch (err) {
            console.warn('Buchungsplan konnte nicht gespeichert werden.', err);
        }
    }

    function pruneEmptyMonths() {
        Object.keys(bookingPlan).forEach(key => {
            const monthPlan = bookingPlan[key];
            if (!monthPlan || !Object.keys(monthPlan).length) {
                delete bookingPlan[key];
            }
        });
    }

    function createDefaultBookingPlan() {
        return {
            [BOOKING_KEY]: {
                '1': ['salary_to_fix'],
                '3': ['standing_to_konsum'],
                '15': ['sparplan'],
                '27': ['konsum_to_tagesgeld'],
                '28': ['tagesgeld_to_depot']
            }
        };
    }

    function determineInitialBookingMonth(plan) {
        if (plan && hasEntriesForMonth(BOOKING_KEY, plan)) return BOOKING_KEY;
        const keys = plan ? Object.keys(plan) : [];
        return keys.length ? keys[0] : BOOKING_KEY;
    }

    function hasEntriesForMonth(month, plan = bookingPlan) {
        const monthPlan = plan[String(month)];
        return !!(monthPlan && Object.keys(monthPlan).length);
    }

    function ensureMonthPlan(month) {
        const key = String(month);
        if (!bookingPlan[key]) bookingPlan[key] = {};
        return bookingPlan[key];
    }

    function renderBookingTypeButtons() {
        if (!bookingTypeButtonsEl) return;
        bookingTypeButtonsEl.innerHTML = '';
        bookingTypes.forEach(type => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'booking-type-btn';
            if (type.badgeBackground) btn.style.backgroundColor = type.badgeBackground;
            if (type.border) btn.style.borderColor = type.border;
            if (type.badgeColor) btn.style.color = type.badgeColor;
            const iconMarkup = getActiveBookingIcon(type);
            const activeLabel = getActiveBookingLabel(type);
            const activeDesc = getActiveBookingDescription(type);
            // Icon-only, compact and clean
            btn.innerHTML = iconMarkup;
            const tooltip = activeDesc || activeLabel || type.id;
            btn.title = tooltip;
            btn.setAttribute('aria-label', tooltip);
            btn.setAttribute('aria-pressed', selectedBookingTypeId === type.id ? 'true' : 'false');
            if (selectedBookingTypeId === type.id) btn.classList.add('booking-type-btn-active');
            btn.addEventListener('click', () => handleBookingTypeSelect(type.id));
            bookingTypeButtonsEl.appendChild(btn);
        });
    }

    function handleBookingTypeSelect(typeId) {
        if (selectedBookingTypeId === typeId) return;
        selectedBookingTypeId = typeId;
        renderBookingTypeButtons();
        updateBookingHint();
    }

    function renderBookingCalendar() {
        if (!bookingCalendarEl) return;
        bookingCalendarEl.innerHTML = '';
        const monthPlan = ensureMonthPlan(selectedBookingMonth);
        for (let day = 1; day <= BOOKING_DAYS; day++) {
            const dayKey = String(day);
            const entries = Array.isArray(monthPlan[dayKey]) ? monthPlan[dayKey] : [];
            const cell = document.createElement('div');
            cell.className = 'booking-day';
            if (day >= 29) cell.classList.add('booking-day--overflow');
            cell.dataset.day = dayKey;
            cell.setAttribute('role', 'button');
            cell.setAttribute('tabindex', '0');
            cell.addEventListener('click', () => toggleDayBooking(day));
            cell.addEventListener('keydown', evt => {
                if (evt.key === 'Enter' || evt.key === ' ') {
                    evt.preventDefault();
                    toggleDayBooking(day);
                }
            });
            const number = document.createElement('div');
            number.className = 'booking-day-number';
            number.textContent = String(day);
            cell.appendChild(number);
            const content = document.createElement('div');
            content.className = 'booking-day-content';
            cell.appendChild(content);
            if (entries.length) {
                cell.classList.add('has-booking');
                const dominant = getBookingType(entries[0]);
                if (dominant && dominant.dayBackground) cell.style.backgroundColor = dominant.dayBackground;
                if (dominant && dominant.border) cell.style.borderColor = dominant.border;
            } else {
                cell.style.backgroundColor = '';
                cell.style.borderColor = '';
            }
            entries.slice().sort((a, b) => getTypeOrder(a) - getTypeOrder(b)).forEach(typeId => {
                const type = getBookingType(typeId);
                if (!type) return;
                const iconBtn = document.createElement('button');
                iconBtn.type = 'button';
                iconBtn.className = 'booking-entry-btn';
                const entryIcon = getActiveBookingIcon(type) || type.icon || '';
                const entryLabel = getActiveBookingLabel(type) || type.label || '';
                iconBtn.innerHTML = entryIcon;
                const removeTooltip = entryLabel ? `${entryLabel} entfernen` : 'Aktion entfernen';
                iconBtn.title = removeTooltip;
                iconBtn.setAttribute('aria-label', entryLabel ? `${entryLabel} am Tag ${day} entfernen` : `Aktion am Tag ${day} entfernen`);
                if (type.badgeBackground) iconBtn.style.backgroundColor = type.badgeBackground;
                if (type.badgeColor) iconBtn.style.color = type.badgeColor;
                iconBtn.addEventListener('click', evt => {
                    evt.stopPropagation();
                    removeBookingFromDay(day, typeId);
                });
                content.appendChild(iconBtn);
            });
            bookingCalendarEl.appendChild(cell);
        }
        updateClearButtonState();
    }

    function getTypeOrder(typeId) {
        const type = getBookingType(typeId);
        return typeof type?.order === 'number' ? type.order : Number.MAX_SAFE_INTEGER;
    }

    function toggleDayBooking(day) {
        if (!selectedBookingTypeId) {
            updateBookingHint('Waehle zuerst einen Buchungstyp.');
            return;
        }
        const type = getBookingType(selectedBookingTypeId);
        if (!type) return;
        const monthPlan = ensureMonthPlan(selectedBookingMonth);
        const key = String(day);
        let items = monthPlan[key];
        if (!Array.isArray(items)) {
            items = [];
            monthPlan[key] = items;
        }
        const idx = items.indexOf(selectedBookingTypeId);
        if (idx >= 0) {
            items.splice(idx, 1);
        } else {
            items.push(selectedBookingTypeId);
            items.sort((a, b) => getTypeOrder(a) - getTypeOrder(b));
        }
        if (!items.length) delete monthPlan[key];
        saveBookingPlan();
        renderBookingCalendar();
        updateBookingHint();
    }

    function removeBookingFromDay(day, typeId) {
        const monthPlan = bookingPlan[String(selectedBookingMonth)];
        if (!monthPlan) return;
        const key = String(day);
        const items = monthPlan[key];
        if (!Array.isArray(items)) return;
        const idx = items.indexOf(typeId);
        if (idx >= 0) items.splice(idx, 1);
        if (!items.length) delete monthPlan[key];
        saveBookingPlan();
        renderBookingCalendar();
        updateBookingHint();
    }

    function updateBookingHint(message) {
        if (!bookingHintEl) return;
        if (message) {
            bookingHintEl.textContent = message;
            return;
        }
        if (!selectedBookingTypeId) {
            bookingHintEl.textContent = 'Waehle einen Buchungstyp und klicke auf den passenden Tag.';
            return;
        }
        const type = getBookingType(selectedBookingTypeId);
        const activeLabel = getActiveBookingLabel(type);
        bookingHintEl.innerHTML = `Aktiver Typ: <span class="booking-hint-strong">${activeLabel || ''}</span>. Klicke auf einen Tag, um ihn hinzufuegen oder zu entfernen.`;
    }

    function clearCurrentMonthPlan() {
        const key = String(selectedBookingMonth);
        if (bookingPlan[key]) {
            bookingPlan[key] = {};
            saveBookingPlan();
            renderBookingCalendar();
            updateBookingHint();
        }
    }

    function updateClearButtonState() {
        if (!bookingClearMonthBtn) return;
        const hasEntries = hasEntriesForMonth(selectedBookingMonth);
        bookingClearMonthBtn.disabled = !hasEntries;
        bookingClearMonthBtn.classList.toggle('opacity-50', !hasEntries);
        bookingClearMonthBtn.classList.toggle('cursor-not-allowed', !hasEntries);
    }

    function getBookingType(typeId) {
        return bookingTypeLookup[typeId];
    }

    function setupBookingPlanner() {
        bookingTypeButtonsEl = getEl('booking-type-buttons');
        bookingCalendarEl = getEl('booking-calendar');
        bookingHintEl = getEl('booking-hint');
        bookingClearMonthBtn = getEl('booking-clear-month');
        if (!bookingTypeButtonsEl || !bookingCalendarEl) return;
        renderBookingTypeButtons();
        renderBookingCalendar();
        updateBookingHint();
        if (bookingClearMonthBtn) {
            bookingClearMonthBtn.addEventListener('click', clearCurrentMonthPlan);
        }
    }

// Load from sessionStorage if available (for import restoration)
    let fixkostenItems = (() => {
        try {
            const saved = sessionStorage.getItem('mlp_fixkostenItems');
            if (saved) {
                console.log('✅ fixkostenItems aus sessionStorage geladen');
                return JSON.parse(saved);
            }
        } catch (e) {
            console.error('Fehler beim Laden von fixkostenItems aus sessionStorage:', e);
        }
        // Default values
        return [
            { name: 'Miete', amount: 850, interval: 'monthly', target: 'fixkosten' },
            { name: 'Strom', amount: 60, interval: 'monthly', target: 'fixkosten' },
            { name: 'Kommunikation (Handy/Netz)', amount: 40, interval: 'monthly', target: 'fixkosten' },
            { name: 'Mobilität (Auto/Ticket)', amount: 150, interval: 'monthly', target: 'fixkosten' },
            { name: 'Versicherungen', amount: 180, interval: 'quarterly', target: 'fixkosten' },
            { name: 'Sport/Hobbies', amount: 50, interval: 'monthly', target: 'fixkosten' },
            { name: 'Vorsorge (z.B. BU)', amount: 70, interval: 'monthly', target: 'fixkosten' },
            { name: 'Sparplan Depot', amount: 250, interval: 'monthly', target: 'depot' },
        ];
    })();

    let depotItems = (() => {
        try {
            const saved = sessionStorage.getItem('mlp_depotItems');
            if (saved) {
                console.log('✅ depotItems aus sessionStorage geladen');
                return JSON.parse(saved);
            }
        } catch (e) {
            console.error('Fehler beim Laden von depotItems aus sessionStorage:', e);
        }
        // Default values
        return [
            { name: 'MSCI World ETF', allocation: 70, color: '#3b82f6' },
            { name: 'Emerging Markets ETF', allocation: 30, color: '#8b5cf6' }
        ];
    })();
    let prognoseChartInstance = null;
    // Beratungsansicht state
    let consultationMode = false;      // off by default
    let consultationStep = 0;          // 0..6 per variant (Step 6: Immobilien)
    let allowDepotStream = true;       // normal mode shows depot stream

    // ===== DEBOUNCE UTILITY (v1.4.0) =====
    /**
     * Debounce function - delays execution until after wait time
     * @param {Function} func - Function to debounce
     * @param {number} wait - Wait time in ms
     */
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Debounced calculateProjection (v1.4.0 - Auto-Prognose)
    const debouncedProjection = debounce(calculateProjection, 300);

    // Debounced calculateAndUpdate (v1.5.0 - Performance Optimization)
    const debouncedCalculateAndUpdate = debounce(calculateAndUpdate, 150);

    // Debounced renderFixkostenList (v1.5.0 - Performance Optimization)
    const debouncedRenderFixkostenList = debounce(function() {
        // Will be defined after renderFixkostenList is available
        if (typeof renderFixkostenList === 'function') {
            renderFixkostenList();
        }
    }, 150);

    // Debounced renderDepotList (v1.5.0 - Performance Optimization)
    const debouncedRenderDepotList = debounce(function() {
        if (typeof renderDepotList === 'function') {
            renderDepotList();
        }
    }, 150);

    function setConsultationMode(on) {
      consultationMode = !!on;
      consultationStep = on ? 1 : 0;
      allowDepotStream = !on; // only enable depot stream at step 5 in consultation
      applyConsultationVisibility();
      calculateAndUpdate();

      // Update old sidebar buttons
      const nextBtn = getEl('consult-next-btn');
      const toggleBtn = getEl('consult-toggle-btn');
      const consultChip = toggleBtn ? toggleBtn.closest('.control-chip--consultation') : null;
      if (on) {
        if (nextBtn) nextBtn.classList.remove('hidden');
        if (toggleBtn) { toggleBtn.setAttribute('aria-label', 'Beratung beenden'); toggleBtn.setAttribute('title', 'Beratung beenden'); }
        if (consultChip) consultChip.classList.add('is-active');
      } else {
        if (nextBtn) nextBtn.classList.add('hidden');
        if (toggleBtn) { toggleBtn.setAttribute('aria-label', 'Beratung starten'); toggleBtn.setAttribute('title', 'Beratung starten'); }
        if (consultChip) consultChip.classList.remove('is-active');
      }

      // Update Control Bar buttons (v1.4.0)
      const nextBtnBar = getEl('consult-next-btn-bar');
      const toggleBtnBar = getEl('consult-toggle-btn-bar');
      const consultBarItem = toggleBtnBar ? toggleBtnBar.closest('.control-bar-item--consultation') : null;
      if (on) {
        if (nextBtnBar) nextBtnBar.classList.remove('hidden');
        if (toggleBtnBar) { toggleBtnBar.setAttribute('aria-label', 'Beratung beenden'); toggleBtnBar.setAttribute('title', 'Beratung beenden'); }
        if (consultBarItem) consultBarItem.classList.add('is-active');
      } else {
        if (nextBtnBar) nextBtnBar.classList.add('hidden');
        if (toggleBtnBar) { toggleBtnBar.setAttribute('aria-label', 'Beratung starten'); toggleBtnBar.setAttribute('title', 'Beratung starten'); }
        if (consultBarItem) consultBarItem.classList.remove('is-active');
      }
    }

    function nextConsultationStep() {
      if (!consultationMode) return;
      consultationStep = Math.min(6, consultationStep + 1);
      if (consultationStep === 5) allowDepotStream = true; // enable depot stream at step 5
      applyConsultationVisibility();
      calculateAndUpdate();
    }

    function isVisible(el) {
      return el && el.offsetParent !== null; // hidden via CSS class will report null
    }

    function show(el, on) {
      if (!el) return;
      if (on) el.classList.remove('hidden'); else el.classList.add('hidden');
    }

    function applyConsultationVisibility() {
      const secIncome = getEl('sec-income');
      const secKonsum = getEl('sec-konsum');
      const secTG     = getEl('sec-tagesgeld');
      const secProg   = getEl('sec-prognose');

      // Gradient zones
      const zone1 = getEl('gradient-zone-1');
      const zone2 = getEl('gradient-zone-2');
      const zone3 = getEl('gradient-zone-3');
      const zone4 = getEl('gradient-zone-4');

      // Default: all visible (normal mode)
      if (!consultationMode) {
        [secIncome, secKonsum, secTG, secProg].forEach(el => show(el, true));
        // all basins visible
        for (const key in basins) show(basins[key], true);
        // all zones visible
        [zone1, zone2, zone3, zone4].forEach(el => show(el, true));
        return;
      }

      const A = (currentVariant === 'A');
      // Step visibility by variant
      if (A) {
        show(secIncome, true);
        show(secKonsum, consultationStep >= 2);
        show(secTG,     consultationStep >= 3);
        show(secProg,   consultationStep >= 4);

        // Step 1: Nur Einkommen
        show(basins.einkommen, true);
        show(basins.fixkosten, consultationStep >= 2);
        show(basins.konsum, consultationStep >= 3);
        show(basins.tagesgeld, consultationStep >= 4);
        show(basins.depot, consultationStep >= 5);
        show(basins.immobilien, consultationStep >= 6); // Step 6: Immobilien
        show(basins.vermieterkonto, consultationStep >= 6); // Step 6: Vermieterkonto (zusammen mit Immobilien)

        // Gradient zones
        show(zone1, true); // Einkommen immer sichtbar
        show(zone2, consultationStep >= 2); // Girokonten ab Step 2
        show(zone3, consultationStep >= 4); // Liquidität ab Step 4
        show(zone4, consultationStep >= 5); // Vermögensaufbau ab Step 5
      } else {
        show(secIncome, true);
        show(secKonsum, consultationStep >= 2); // B: konsum ab step 2 (wie Fixkosten in A)
        show(secTG,     consultationStep >= 3);
        show(secProg,   consultationStep >= 4);

        show(basins.einkommen, true);
        show(basins.konsum, consultationStep >= 2); // Step 2: Konsum (wie Fixkosten in A)
        show(basins.fixkosten, consultationStep >= 3); // Step 3: Fixkosten
        show(basins.tagesgeld, consultationStep >= 4); // Step 4: Tagesgeld
        show(basins.depot, consultationStep >= 5); // Step 5: Depot
        show(basins.immobilien, consultationStep >= 6); // Step 6: Immobilien
        show(basins.vermieterkonto, consultationStep >= 6); // Step 6: Vermieterkonto (zusammen mit Immobilien)

        // Gradient zones (Variante B)
        show(zone1, true); // Einkommen immer sichtbar
        show(zone2, consultationStep >= 2); // Konsum/Fixkosten ab Step 2
        show(zone3, consultationStep >= 4); // Liquidität ab Step 4
        show(zone4, consultationStep >= 5); // Vermögensaufbau ab Step 5
      }
    }
    
    // Interpret historische Minimum/Maximum-Renditen als ca. 5. und 90. Perzentil einer Normalverteilung.
    const GAUSSIAN_LOWER_Q = 0.05;
    const GAUSSIAN_UPPER_Q = 0.9;

    // v1.5.4: Layout Constants (extracted from magic numbers for maintainability)
    const LAYOUT = {
        HORIZONTAL_GAP: 100,      // Abstand zwischen Basins horizontal (px)
        VERTICAL_GAP: 240,        // Abstand zwischen Ebenen (px)
        DEPOT_WIDTH: 440,         // Breite Depot-Basin (px)
        VERMIETERKONTO_HEIGHT: 100, // Höhe Vermieterkonto-Basin (px)
        MIN_FLOW_WIDTH: 10,       // Minimale Flow-Breite (px)
        MAX_FLOW_WIDTH: 45        // Maximale Flow-Breite (px)
    };

    const roundToDecimal = (value, digits = 1) => {
        const factor = Math.pow(10, digits);
        return Math.round((Number(value) || 0) * factor) / factor;
    };

    const clamp = (value, min, max) => {
        if (!Number.isFinite(value)) return value;
        if (Number.isFinite(min) && value < min) return min;
        if (Number.isFinite(max) && value > max) return max;
        return value;
    };

    function inverseStandardNormal(p) {
        if (p <= 0 || p >= 1) throw new RangeError('p must be in (0,1)');
        const a = [-39.6968302866538, 220.946098424521, -275.928510446969, 138.357751867269, -30.6647980661472, 2.50662827745924];
        const b = [-54.4760987982241, 161.585836858041, -155.698979859887, 66.8013118877197, -13.2806815528857];
        const c = [-0.00778489400243029, -0.322396458041136, -2.40075827716184, -2.54973253934373, 4.37466414146497, 2.93816398269878];
        const d = [0.00778469570904146, 0.32246712907004, 2.445134137143, 3.75440866190742];
        const plow = 0.02425;
        const phigh = 1 - plow;
        let q, r;
        if (p < plow) {
            q = Math.sqrt(-2 * Math.log(p));
            return (((((c[0] * q + c[1]) * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) /
                   ((((d[0] * q + d[1]) * q + d[2]) * q + d[3]) * q + 1);
        }
        if (phigh < p) {
            q = Math.sqrt(-2 * Math.log(1 - p));
            return -(((((c[0] * q + c[1]) * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) /
                    ((((d[0] * q + d[1]) * q + d[2]) * q + d[3]) * q + 1);
        }
        q = p - 0.5;
        r = q * q;
        return (((((a[0] * r + a[1]) * r + a[2]) * r + a[3]) * r + a[4]) * r + a[5]) * q /
               (((((b[0] * r + b[1]) * r + b[2]) * r + b[3]) * r + b[4]) * r + 1);
    }

    function buildRenditeStat(min, max) {
        const cleanMin = Number(min);
        const cleanMax = Number(max);
        if (!Number.isFinite(cleanMin) || !Number.isFinite(cleanMax)) {
            return { min: roundToDecimal(min), max: roundToDecimal(max), mean: roundToDecimal((Number(min) + Number(max)) / 2) };
        }
        const zLow = inverseStandardNormal(GAUSSIAN_LOWER_Q);
        const zHigh = inverseStandardNormal(GAUSSIAN_UPPER_Q);
        const range = cleanMax - cleanMin;
        let mean = (cleanMin + cleanMax) / 2;
        if (Number.isFinite(range) && range > 0 && Number.isFinite(zHigh - zLow)) {
            const sigma = range / (zHigh - zLow);
            const candidate = cleanMin - zLow * sigma;
            if (Number.isFinite(candidate)) {
                mean = candidate;
            }
        }
        const clampedMean = clamp(mean, cleanMin, cleanMax);
        return {
            min: roundToDecimal(cleanMin),
            max: roundToDecimal(cleanMax),
            mean: roundToDecimal(clampedMean)
        };
    }

    const renditeData = {
        1: buildRenditeStat(-40, 50),
        5: buildRenditeStat(-12, 32),
        10: buildRenditeStat(-1.5, 19),
        15: buildRenditeStat(3, 15),
        20: buildRenditeStat(4, 13),
        25: buildRenditeStat(5, 12),
        30: buildRenditeStat(6, 11)
    };
    // === Load fine-grained min/max returns from TXT (MLP Renditedreieck) ===
    // File: data/rendite_extreme_generated.txt
    // Format (tab/whitespace):
    // Anlagezeitraum (Jahre)    Minimale Rendite (%)   Maximale Rendite (%)
    // 1   -42.2   51.7
    let renditeExtremes = null;

    async function loadRenditeExtremes() {
    try {
        const res = await fetch('data/rendite_extreme_generated.txt', { cache: 'no-store' });
        if (!res.ok) throw new Error('not found');
        const txt = await res.text();
        renditeExtremes = parseRenditeExtremesTSV(txt);
        // refresh UI for current slider value
        const jahre = parseInt(inputs.anlagezeitraum.value, 10);
        updateRenditeSuggestions(jahre);
    } catch (e) {
        console.warn('Rendite-Extremwerte nicht geladen, nutze Fallback.', e);
        renditeExtremes = null;
    }
    }

    function parseRenditeExtremesTSV(tsv) {
    const map = {};
    tsv.split(/\r?\n/).forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (!/^\d+/.test(trimmed)) return; // skip header
        const parts = trimmed.split(/\t|\s+/).filter(Boolean);
        if (parts.length < 3) return;
        const years = parseInt(parts[0], 10);
        const min = parseFloat(String(parts[1]).replace(',', '.'));
        const max = parseFloat(String(parts[2]).replace(',', '.'));
        if (Number.isFinite(years) && Number.isFinite(min) && Number.isFinite(max)) {
                map[years] = buildRenditeStat(min, max);
        }
    });
    return map;
    }

    let inputs, basins, flowContainer, flowSvg; // Declare globally, assign in DOMContentLoaded
    const getEl = (id) => document.getElementById(id);
    const formatCurrency = (val) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val);
    const getMonthlyAmount = (item) => { const a = item.amount || 0; switch (item.interval) { case 'quarterly': return a / 3; case 'annually': return a / 12; default: return a; } };

function renderBasin(element, title, value, icon, subtext = '', { current = 0, min = 0, limit = Infinity, minScaleBase = null } = {}, specialContent = '') {
    // Fill height is only meaningful when a real capacity limit is provided
    const fillPercent = (limit > 0 && limit !== Infinity)
      ? Math.min(100, (current / limit) * 100)
      : 0;

    // The yellow minimum line can be scaled against an explicit base (minScaleBase),
    // falling back to the same limit if none provided. This allows Konsumkonto to
    // scale its Min-Linie gegen den monatlichen Überschuss statt gegen das Kartenlimit.
    const baseForMin = (minScaleBase != null && isFinite(minScaleBase) && minScaleBase > 0)
      ? minScaleBase
      : ((limit > 0 && limit !== Infinity) ? limit : null);
    const minPercent = baseForMin ? Math.min(100, (min / baseForMin) * 100) : 0;

    // Check if element is editable (v1.4.0)
    const isEditable = element.classList.contains('account-basin--editable');
    const editIcon = isEditable ? `
        <div class="basin-edit-indicator">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        </div>
    ` : '';

    element.innerHTML = `
        <div class="absolute inset-0 bg-sky-500/30 rounded-lg transition-all duration-500" style="height: ${fillPercent}%; top: auto; bottom: 0;"></div>
        ${min > 0 ? `<div class="limit-line bg-yellow-500/70 border-t-2 border-dashed border-yellow-400" style="bottom: ${minPercent}%;"><span class="text-yellow-300">Min</span></div>` : ''}
        ${limit > 0 && limit !== Infinity ? `<div class="limit-line bg-green-500/70" style="bottom: 100%;"><span class="text-green-300">Max</span></div>` : ''}
        ${limit > 0 && limit !== Infinity && /Tagesgeldkonto/i.test(title) ? `<div class="absolute top-1 right-2 text-xs text-gray-400">Sparziel: ${new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(limit)}</div>` : ''}
        ${editIcon}
        <div class="relative z-10 flex flex-col items-center justify-center h-full">
          ${specialContent || icon}
          <p class="font-bold">${title}</p>
          <p class="text-lg font-mono">${value}</p>
          ${subtext ? `<p class="text-xs text-gray-400 mt-1">${subtext}</p>` : ''}
        </div>
    `;
    }

    function positionCascade() {
        if (!flowContainer) return;
        const containerWidth = flowContainer.clientWidth;
        const h_gap_side = LAYOUT.HORIZONTAL_GAP;  // v1.5.4: Use named constant
        const v_gap = LAYOUT.VERTICAL_GAP;
        const depotWidth = LAYOUT.DEPOT_WIDTH;
        const immoWidth = 220;
        const gapBetweenDepotImmo = 50; // Erhöht von 30 auf 50 für klarere Trennung

        // Größen setzen
        basins.depot.style.width = `${depotWidth}px`;
        if (basins.immobilien) {
            basins.immobilien.style.width = `${immoWidth}px`;
        }
        if (basins.vermieterkonto) {
            basins.vermieterkonto.style.width = `${immoWidth}px`;
            basins.vermieterkonto.style.height = '100px'; // Kompakter als normale Basins
        }

        // === NEUE ZENTRIERUNG: Immobilien & Depot bilden Außenrahmen ===
        // Berechne Gesamtbreite des Außenrahmens
        const outerFrameWidth = immoWidth + gapBetweenDepotImmo + depotWidth; // 220 + 50 + 440 = 710px
        const vermieterkontoOffset = 140; // Vertikaler Abstand zwischen Vermieterkonto und Immobilien (erhöht von 90 auf 140)

        // Linker Rand des Außenrahmens (zentriert im Container)
        const outerFrameLeft = (containerWidth - outerFrameWidth) / 2;

        // Neuer Mittelpunkt X: Mitte zwischen Immobilien-Links und Depot-Rechts
        const newCenterX = outerFrameLeft + outerFrameWidth / 2;

        // === GIROKONTO-BEREICH: Ausrichtung an Depot & Immobilien ===
        const giroBasinWidth = 200; // Standard Basin-Breite

        // Berechne Positionen basierend auf Depot & Immobilien:
        // 1. Fixkostenkonto: Mitte über rechtem Rand des Depot-Basins
        const depotRightEdge = outerFrameLeft + immoWidth + gapBetweenDepotImmo + depotWidth;
        const giroLeft3 = depotRightEdge - (giroBasinWidth / 2); // Mitte über rechtem Depot-Rand

        // 2. Vermieterkonto: Mitte über linkem Rand des Immobilien-Basins
        const immobilienLeftEdge = outerFrameLeft;
        const giroLeft1 = immobilienLeftEdge - (giroBasinWidth / 2); // Mitte über linkem Immobilien-Rand

        // 3. Konsumkonto: Mittig zwischen rechtem Rand Vermieterkonto und linkem Rand Fixkosten
        const vermieterkontoRightEdge = giroLeft1 + giroBasinWidth;
        const fixkostenLeftEdge = giroLeft3;
        const giroLeft2 = (vermieterkontoRightEdge + fixkostenLeftEdge) / 2 - (giroBasinWidth / 2);

        // Höhen-Differenz: Vermieterkonto ist 100px, normale Basins sind größer (~150px?)
        // Um Untergrenze anzugleichen: Vermieterkonto muss TIEFER positioniert werden
        const normalBasinHeight = basins.konsum ? basins.konsum.offsetHeight : 150;
        const vermieterkontoHeight = LAYOUT.VERMIETERKONTO_HEIGHT;  // v1.5.4: Use named constant
        const heightDiff = normalBasinHeight - vermieterkontoHeight; // Differenz ausgleichen

        let positions;
        if (currentVariant === 'B') {
            // Variante B (Konsum-first): Einkommen -> Konsum -> (Fixkosten + Vermieterkonto) -> Tagesgeld -> Depot
            // Ebene 1: Konsum
            // Ebene 2: Fixkosten + Vermieterkonto (beide UNTERKANTE bündig!)
            positions = {
                einkommen:      { top: 0,          left: newCenterX - basins.einkommen.offsetWidth / 2 },
                konsum:         { top: v_gap,      left: giroLeft2 }, // Mitte
                // Ebene 2: UNTERKANTEN bündig (Vermieterkonto tiefer wegen kleinerer Höhe)
                vermieterkonto: { top: v_gap * 2 + heightDiff,  left: giroLeft1 }, // Links, tiefer!
                fixkosten:      { top: v_gap * 2,  left: giroLeft3 }, // Rechts (weiter rechts!)
                tagesgeld:      { top: v_gap * 3,  left: newCenterX - basins.tagesgeld.offsetWidth / 2 + 40 },
                depot:          { top: v_gap * 4.0, left: outerFrameLeft + immoWidth + gapBetweenDepotImmo },
                immobilien:     { top: v_gap * 4.0, left: outerFrameLeft },
            };
        } else { // Variante A
            // Variante A (Fixkosten-first): Einkommen -> Fixkosten -> (Konsum + Vermieterkonto) -> Tagesgeld -> Depot
            // Ebene 1: Fixkosten
            // Ebene 2: Konsum + Vermieterkonto (beide UNTERKANTE bündig!)
            positions = {
                einkommen:      { top: 0,          left: newCenterX - basins.einkommen.offsetWidth / 2 },
                fixkosten:      { top: v_gap,      left: giroLeft3 }, // Rechts (weiter rechts!)
                // Ebene 2: UNTERKANTEN bündig (Vermieterkonto tiefer wegen kleinerer Höhe)
                vermieterkonto: { top: v_gap * 2 + heightDiff,  left: giroLeft1 }, // Links, tiefer!
                konsum:         { top: v_gap * 2,  left: giroLeft2 }, // Mitte
                tagesgeld:      { top: v_gap * 3,  left: newCenterX - basins.tagesgeld.offsetWidth / 2 + 40 },
                depot:          { top: v_gap * 4.0, left: outerFrameLeft + immoWidth + gapBetweenDepotImmo },
                immobilien:     { top: v_gap * 4.0, left: outerFrameLeft },
            };
        }

        // Positionen anwenden
        for (const key in basins) {
            if (basins[key]) {
                basins[key].style.top = `${positions[key].top}px`;
                basins[key].style.left = `${positions[key].left}px`;
            }
        }
    }

    function attachFlowDot(pathId, radius = 4, speedSec = 3) {
        const dotGroupId = `${pathId}-dot`;
        let g = document.getElementById(dotGroupId);
        if (!g) {
            g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('id', dotGroupId);
            document.getElementById('flow-svg').appendChild(g);
        }
        // Clear existing content
        g.innerHTML = '';
        // Create circle + animateMotion referencing the path
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('class', 'flow-dot');
        circle.setAttribute('r', String(radius));
        const animateMotion = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
        animateMotion.setAttribute('dur', `${Math.max(1.2, speedSec)}s`);
        animateMotion.setAttribute('repeatCount', 'indefinite');
        const mpath = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
        mpath.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', `#${pathId}`);
        animateMotion.appendChild(mpath);
        circle.appendChild(animateMotion);
        g.appendChild(circle);
    }

    function drawFlow(pathId, fromBasin, toBasin, value, maxFlowValue, labelText = '', flowOpacity = 1.0) {
        if (!fromBasin || !toBasin) return;
        const path = getEl(pathId), pathAnim = getEl(`${pathId}-anim`);
        const fromRect = fromBasin.getBoundingClientRect(), toRect = toBasin.getBoundingClientRect(), containerRect = flowContainer.getBoundingClientRect();
        let fromX = fromRect.left - containerRect.left + fromRect.width / 2;
        let fromY = fromRect.bottom - containerRect.top;
        const toX = toRect.left - containerRect.left + toRect.width / 2;
        const toY = toRect.top - containerRect.top;
        const minWidth = LAYOUT.MIN_FLOW_WIDTH, maxWidth = LAYOUT.MAX_FLOW_WIDTH;  // v1.5.4: Use named constants
        const normalizedValue = Math.max(0, value) / maxFlowValue;
        const strokeWidth = minWidth + normalizedValue * (maxWidth - minWidth);
        path.style.strokeWidth = `${value > 0 ? Math.max(minWidth, strokeWidth) : 0}px`;
        // Nur für spezielle Flows (z.B. Deficitline) opacity setzen, sonst CSS-Animation überschreiben
        if (flowOpacity !== 1.0) {
            path.style.opacity = flowOpacity; // Opacity für dezente Flows
        } else {
            path.style.opacity = ''; // CSS-Default verwenden (für Animationen)
        }

        let pathData;
        // REPLACED BLOCK: custom anchor, curve, and offsets for each flow
        // --- BEGIN NEW BLOCK ---
        const EXIT_OFFSET_Y = 8; // slightly deeper anchor, hides seams better
        const CURVE_MAIN = 70;   // smaller curve radius for tighter, calmer streams
        const CURVE_SHORT = 55;  // short bends for side-to-side connections

        if (pathId === 'fixkosten-depot-flow') {
            // From right side of fixkosten into right half of depot
            fromX = fromRect.left - containerRect.left + fromRect.width * 0.75;
            const toDepotX = toRect.left - containerRect.left + toRect.width * 0.75;
            fromY -= EXIT_OFFSET_Y;
            pathData = `M ${fromX},${fromY} C ${fromX},${fromY + 70} ${toDepotX},${toY - 70} ${toDepotX},${toY}`;
        } else if (pathId === 'tagesgeld-depot-flow') {
            // From center of tagesgeld into left half of depot
            const toDepotX = toRect.left - containerRect.left + (toRect.width * 0.25);
            fromY -= EXIT_OFFSET_Y;
            pathData = `M ${fromX},${fromY} C ${fromX},${fromY + 55} ${toDepotX},${toY - 55} ${toDepotX},${toY}`;
        } else if (pathId === 'konsum-tagesgeld-flow') {
            // Überschuss-Stream aus dem Konsumkonto:
            //  • Variante B: unten links aus dem Konsumkonto starten (verhindert Kreuzungen)
            //  • Variante A: unten rechts aus dem Konsumkonto starten (spiegelbildlich zur Anordnung)
            if (typeof currentVariant !== 'undefined' && currentVariant === 'B') {
                // bottom-left anchor on Konsum → Tagesgeld (zentral) mit kurzer, ruhiger Kurve
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.20;
                fromY -= EXIT_OFFSET_Y;
                const c1x = fromX - 40, c1y = fromY + CURVE_SHORT;
                const c2x = toX - 20,  c2y = toY - CURVE_SHORT;
                pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toX},${toY}`;
            } else {
                // Variante A: bottom-right anchor (spiegelbildlich), kurze, sanfte Biegung
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.80;
                fromY -= EXIT_OFFSET_Y;
                const c1x = fromX + 40, c1y = fromY + CURVE_SHORT;
                const c2x = toX + 20,  c2y = toY - CURVE_SHORT;
                pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toX},${toY}`;
            }
        // --- BEGIN NEW BLOCK ---
        } else if (pathId === 'flow-path-2' && typeof currentVariant !== 'undefined' && currentVariant === 'A') {
            // Dauerauftrag: from left side of Fixkosten (right column) to right side of Konsum (left column)
            const R = 65; // curve radius
            fromX = fromRect.left - containerRect.left + fromRect.width * 0.20; // exit left
            fromY -= EXIT_OFFSET_Y;
            const toKonsumX = toRect.left - containerRect.left + toRect.width * 0.80; // enter right
            pathData = `M ${fromX},${fromY} C ${fromX - R},${fromY + R} ${toKonsumX + R},${toY - R} ${toKonsumX},${toY}`;
        } else if (pathId === 'flow-path-2' && typeof currentVariant !== 'undefined' && currentVariant === 'B') {
            // Dauerauftrag: from right side of Konsum (left column) to right-half of Fixkosten (right column)
            const R = 65; // curve radius
            fromX = fromRect.left - containerRect.left + fromRect.width * 0.80; // exit right
            fromY -= EXIT_OFFSET_Y;
            const toRightX = toRect.left - containerRect.left + toRect.width * 0.75; // enter right half
            pathData = `M ${fromX},${fromY} C ${fromX + R},${fromY + R} ${toRightX - R},${toY - R} ${toRightX},${toY}`;
        } else if (pathId === 'vermieterkonto-einkommen-flow') {
            // Flow von Vermieterkonto HOCH zum Einkommen (Mieteinnahmen fließen ins Einkommen)
            // Mäandernder organischer Flow wie alle anderen (kein Stilbruch!)
            // Start: Rechts-Oben am Vermieterkonto (damit es schön zur Seite mäandert)
            fromX = fromRect.left - containerRect.left + fromRect.width * 0.75; // Rechts (75%)
            fromY = fromRect.top - containerRect.top; // Oberkante

            // Ziel: Links-Unten am Einkommen (Andockpunkt NICHT in der Mitte wo Hauptflow abgeht!)
            const toEinkommenX = toRect.left - containerRect.left + toRect.width * 0.25; // Links (25%)
            const toEinkommenY = toRect.bottom - containerRect.top; // Unterkante

            // Mäandernde S-Kurve wie andere Flows (organisch, nicht linear!)
            const dx = toEinkommenX - fromX;
            const dy = toEinkommenY - fromY;

            // Zwei Kontrollpunkte für organische Kurve (erst nach rechts/oben, dann zurück nach links)
            const c1x = fromX + 60; // Erst nach rechts schwingen
            const c1y = fromY + dy * 0.35; // 35% des Weges nach oben
            const c2x = toEinkommenX - 50; // Dann zurück nach links zum Ziel
            const c2y = toEinkommenY - dy * 0.25; // 75% des Weges (nah am Ziel)

            pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toEinkommenX},${toEinkommenY}`;
        } else if (pathId === 'fixkosten-vermieterkonto-flow') {
            // Bidirektionaler Flow zwischen Vermieterkonto und Fixkosten/Konsum
            // Richtung wird durch fromBasin/toBasin bestimmt

            // Prüfe ob Vermieterkonto der Startpunkt ist (positiver Saldo)
            const isPositiveFlow = fromBasin.id === 'vermieterkonto-basin';

            if (isPositiveFlow) {
                // Positiv: Vermieterkonto → Fixkosten/Konsum
                // Start: Oberkante Mitte vom Vermieterkonto
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.5;
                fromY = fromRect.top - containerRect.top;

                // Ziel: Linke Seite Mitte vom Ziel-Basin (Fixkosten oder Konsum)
                const toTargetX = toRect.left - containerRect.left + toRect.width * 0.10;
                const toTargetY = toRect.top - containerRect.top + toRect.height * 0.5;

                // Umgekehrte mäandernde Kurve (nach oben und rechts)
                const c1x = fromX - 40; // Nach links schwingen
                const c1y = fromY - 60;
                const c2x = toTargetX - 60; // Nach links vorbei
                const c2y = toTargetY - (toTargetY - fromY) * 0.3;

                pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toTargetX},${toTargetY}`;
            } else {
                // Negativ: Fixkosten → Vermieterkonto (Deckung)
                // Start: Linker Rand vom Fixkostenkonto (10%)
                fromX = fromRect.left - containerRect.left + fromRect.width * 0.10;
                fromY = fromRect.top - containerRect.top + fromRect.height * 0.5;

                // Ziel: Oberkante Mitte vom Vermieterkonto
                const toVermX = toRect.left - containerRect.left + toRect.width * 0.5;
                const toVermY = toRect.top - containerRect.top;

                // Mäandernde Kurve (nach links und unten)
                const c1x = fromX - 60; // Nach links schwingen
                const c1y = fromY + (toVermY - fromY) * 0.3;
                const c2x = toVermX - 40; // Zurück zur Mitte
                const c2y = toVermY - 60;

                pathData = `M ${fromX},${fromY} C ${c1x},${c1y} ${c2x},${c2y} ${toVermX},${toVermY}`;
            }
        } else {
            // Default smooth S-curve between centers
            fromY -= EXIT_OFFSET_Y;
            pathData = `M ${fromX},${fromY} C ${fromX},${fromY + CURVE_MAIN} ${toX},${toY - CURVE_MAIN} ${toX},${toY}`;
        }
        // --- END NEW BLOCK ---
        path.setAttribute('d', pathData);
        pathAnim.setAttribute('d', pathData);
        // Reset inline opacity to allow CSS to control animation visibility
        pathAnim.style.opacity = '';

        // Update mask stroke to define visible river area
        const pathMask = getEl(`${pathId}-mask`);
        if (pathMask) {
            pathMask.setAttribute('d', pathData);
            const maskWidth = Math.max(0, parseFloat(path.style.strokeWidth || "0") + 2);
            pathMask.style.strokeWidth = `${maskWidth}px`;
        }

        // Eraser path covers any legacy underlay (stroke slightly wider than main)
        const pathErase = getEl(`${pathId}-erase`);
        if (pathErase) {
            pathErase.setAttribute('d', pathData);
            const eraseWidth = Math.max(0, parseFloat(path.style.strokeWidth || "0") + 40); // extra wide to fully cover any underlay, even at tight bends
            pathErase.style.strokeWidth = `${eraseWidth}px`;
        }

        // Add/update moving dot for direction cue
        const radius = Math.max(2, Math.min(5, parseFloat(path.style.strokeWidth) / 6));
        const speed = 6 + Math.max(0, (parseFloat(path.style.strokeWidth) - 10) / 8); // overall slower, more uniform
        attachFlowDot(pathId, radius, speed);
        
        const valueLabelId = `${pathId}-value`, textLabelId = `${pathId}-text`;
        let valueLabel = getEl(valueLabelId), textLabel = getEl(textLabelId);
        if (!valueLabel) { valueLabel = document.createElement('div'); valueLabel.className = 'flow-value'; valueLabel.id = valueLabelId; flowContainer.appendChild(valueLabel); }
        if (labelText && !textLabel) { textLabel = document.createElement('div'); textLabel.className = 'flow-label'; textLabel.id = textLabelId; flowContainer.appendChild(textLabel); }
        
        valueLabel.textContent = formatCurrency(value);
        if(textLabel) textLabel.textContent = labelText;

        // Spezielle Label-Positionierung für Vermieterkonto-Flows (näher am Vermieterkonto)
        let labelPosition = 0.5; // Standard: 50% (Mitte)
        if (pathId === 'vermieterkonto-einkommen-flow') {
            labelPosition = 0.35; // 35% - näher am Vermieterkonto (Start)
        } else if (pathId === 'fixkosten-vermieterkonto-flow') {
            labelPosition = 0.67; // 67% - im ersten Drittel vom Vermieterkonto aus (= letztes Drittel vom Start)
        }

        const midPoint = path.getPointAtLength(path.getTotalLength() * labelPosition);
        valueLabel.style.left = `${midPoint.x}px`; valueLabel.style.top = `${midPoint.y}px`;
        if (textLabel) {
            textLabel.style.left = `${midPoint.x}px`;
            textLabel.style.top  = `${midPoint.y - 22}px`; // closer spacing above the amount pill
        }
        path.classList.toggle('active', value > 0);
        valueLabel.style.display = (value > 0) ? 'block' : 'none';
        if(textLabel) textLabel.style.display = (value > 0) ? 'block' : 'none';
    }

    function hideFlow(pathId) {
        const path      = getEl(pathId);
        const pathAnim  = getEl(`${pathId}-anim`);
        const valueLbl  = getEl(`${pathId}-value`);
        const textLbl   = getEl(`${pathId}-text`);
        const pathErase = getEl(`${pathId}-erase`);
        const pathMask  = getEl(`${pathId}-mask`);
        const dotGroup  = getEl(`${pathId}-dot`);
        if (path) {
            path.classList.remove('active');
            path.style.strokeWidth = '0px';
        }
        if (pathAnim) {
            pathAnim.style.opacity = '0';
        }
        if (valueLbl) valueLbl.style.display = 'none';
        if (textLbl)  textLbl.style.display  = 'none';
        if (pathErase) pathErase.style.strokeWidth = '0px';
        if (pathMask)  pathMask.style.strokeWidth  = '0px';
        if (dotGroup)  dotGroup.innerHTML = '';
    }

    function drawConnectionLine(lineId, fromBasin, toBasin) {
        // Zeichnet eine gestrichelte vertikale Verbindungslinie (kein Flow, nur Visualisierung)
        if (!fromBasin || !toBasin) return;

        let line = getEl(lineId);
        if (!line) {
            line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.id = lineId;
            line.setAttribute('stroke', '#60a5fa'); // blue-400
            line.setAttribute('stroke-width', '1.5'); // Reduziert von 2 auf 1.5
            line.setAttribute('stroke-dasharray', '8,4'); // gestrichelt
            line.setAttribute('fill', 'none');
            line.setAttribute('opacity', '0.25'); // Reduziert von 0.5 auf 0.25 für dezentere Darstellung
            flowSvg.appendChild(line);
        }

        const fromRect = fromBasin.getBoundingClientRect();
        const toRect = toBasin.getBoundingClientRect();
        const containerRect = flowContainer.getBoundingClientRect();

        // Vertikale Linie von der Mitte des oberen Basins zur Mitte des unteren Basins
        const centerX = fromRect.left - containerRect.left + fromRect.width / 2;
        const fromY = fromRect.bottom - containerRect.top;
        const toY = toRect.top - containerRect.top;

        const pathData = `M ${centerX},${fromY} L ${centerX},${toY}`;
        line.setAttribute('d', pathData);
    }

    function drawSchutzschirm(fromBasin, toBasin) {
        if (!fromBasin || !toBasin) return;
        const path = getEl('schutzschirm-path');
        const toRect = toBasin.getBoundingClientRect(), containerRect = flowContainer.getBoundingClientRect();
        const toLeftX = toRect.left - containerRect.left, toRightX = toRect.right - containerRect.left, toY = toRect.top - containerRect.top;
        const controlX = toLeftX + toRect.width / 2;
        const controlY = toY - 80;
        const pathData = `M ${toLeftX}, ${toY} Q ${controlX}, ${controlY} ${toRightX}, ${toY}`;
        path.setAttribute('d', pathData);
    }

    // ===== INLINE EDITOR FUNCTIONS (v1.4.0) =====

    /**
     * Open inline editor for a specific basin
     * @param {Event} event - Click event (to stop propagation)
     * @param {string} basinType - 'einkommen', 'konsum', 'tagesgeld'
     */
    function openInlineEditor(event, basinType) {
        // Stop event propagation to prevent immediate close
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        const basin = basins[basinType];
        if (!basin) return;

        // Prevent opening if already editing
        if (basin.querySelector('.basin-inline-editor')) return;

        let editorHTML = '';

        switch (basinType) {
            case 'einkommen':
                editorHTML = `
                    <div class="basin-inline-editor">
                        <div class="basin-inline-label">Nettoeinkommen</div>
                        <input type="number"
                               class="basin-inline-input"
                               id="inline-income"
                               value="${inputs.income ? inputs.income.value : 3000}"
                               placeholder="3000"
                               inputmode="decimal"
                               step="100"
                               min="0"
                               max="1000000">
                        <div class="basin-inline-hint">Enter zum Speichern • Esc zum Abbrechen</div>
                        <div class="basin-inline-buttons">
                            <button class="basin-inline-btn" onclick="closeInlineEditor('${basinType}')">Abbrechen</button>
                            <button class="basin-inline-btn basin-inline-btn--primary" onclick="saveInlineEditor('${basinType}')">Speichern</button>
                        </div>
                    </div>
                `;
                break;

            case 'konsum':
                editorHTML = `
                    <div class="basin-inline-editor">
                        <div class="basin-inline-label">Konsumkonto</div>
                        <div class="basin-inline-grid">
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Mindestbestand</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-konsum-min"
                                       value="${inputs.konsumMin ? inputs.konsumMin.value : 100}"
                                       placeholder="100"
                                       inputmode="decimal"
                                       step="50"
                                       min="0">
                            </div>
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Überschuss</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-konsum-leftover"
                                       value="${inputs.konsumLeftover ? inputs.konsumLeftover.value : 250}"
                                       placeholder="250"
                                       inputmode="decimal"
                                       step="50"
                                       min="0">
                            </div>
                        </div>
                        <div class="basin-inline-hint">Enter zum Speichern • Esc zum Abbrechen</div>
                        <div class="basin-inline-buttons">
                            <button class="basin-inline-btn" onclick="closeInlineEditor('${basinType}')">Abbrechen</button>
                            <button class="basin-inline-btn basin-inline-btn--primary" onclick="saveInlineEditor('${basinType}')">Speichern</button>
                        </div>
                    </div>
                `;
                break;

            case 'tagesgeld':
                editorHTML = `
                    <div class="basin-inline-editor">
                        <div class="basin-inline-label">Tagesgeldkonto</div>
                        <div class="basin-inline-grid">
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Aktueller Stand</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-tagesgeld-current"
                                       value="${inputs.tagesgeldCurrent ? inputs.tagesgeldCurrent.value : 4800}"
                                       placeholder="4800"
                                       inputmode="decimal"
                                       step="100"
                                       min="0">
                            </div>
                            <div class="basin-inline-field">
                                <label class="basin-inline-label" style="font-size: 0.75rem;">Sparziel</label>
                                <input type="number"
                                       class="basin-inline-input"
                                       id="inline-tagesgeld-limit"
                                       value="${inputs.tagesgeldLimit ? inputs.tagesgeldLimit.value : 5000}"
                                       placeholder="5000"
                                       inputmode="decimal"
                                       step="100"
                                       min="0">
                            </div>
                        </div>
                        <div class="basin-inline-hint">Enter zum Speichern • Esc zum Abbrechen</div>
                        <div class="basin-inline-buttons">
                            <button class="basin-inline-btn" onclick="closeInlineEditor('${basinType}')">Abbrechen</button>
                            <button class="basin-inline-btn basin-inline-btn--primary" onclick="saveInlineEditor('${basinType}')">Speichern</button>
                        </div>
                    </div>
                `;
                break;
        }

        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'basin-inline-backdrop';
        backdrop.dataset.basinType = basinType;
        backdrop.addEventListener('click', () => closeInlineEditor(basinType));
        document.body.appendChild(backdrop);

        // Insert editor overlay into body (not basin)
        document.body.insertAdjacentHTML('beforeend', editorHTML);

        // Get editor element
        const editor = document.body.querySelector('.basin-inline-editor:last-child');
        if (!editor) return;

        // Store basin type on editor for cleanup
        editor.dataset.basinType = basinType;

        // Prevent clicks inside editor from closing it
        editor.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Focus first input
        const firstInput = editor.querySelector('.basin-inline-input');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }

        // Add keyboard handlers
        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveInlineEditor(basinType);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeInlineEditor(basinType);
            }
        });
    }

    /**
     * Validate and clamp numeric input to safe ranges
     */
    function validateAmount(value, min = 0, max = 1000000) {
        let num = parseFloat(value);
        if (!Number.isFinite(num)) return min;
        return Math.max(min, Math.min(max, num));
    }

    /**
     * Close inline editor without saving
     */
    function closeInlineEditor(basinType) {
        // Find editor and backdrop by data attribute
        const editor = document.querySelector(`.basin-inline-editor[data-basin-type="${basinType}"]`);
        const backdrop = document.querySelector(`.basin-inline-backdrop[data-basin-type="${basinType}"]`);

        if (editor) {
            editor.style.animation = 'smoothFadeOut 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards';
            setTimeout(() => editor.remove(), 250);
        }

        if (backdrop) {
            backdrop.style.animation = 'backdropFadeOut 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards';
            setTimeout(() => backdrop.remove(), 250);
        }
    }

    /**
     * Save inline editor values and update
     */
    function saveInlineEditor(basinType) {
        const basin = basins[basinType];
        if (!basin) return;

        switch (basinType) {
            case 'einkommen':
                const incomeInput = getEl('inline-income');
                if (incomeInput && inputs.income) {
                    inputs.income.value = validateAmount(incomeInput.value, 0, 1000000);
                }
                break;

            case 'konsum':
                const konsumMinInput = getEl('inline-konsum-min');
                const konsumLeftoverInput = getEl('inline-konsum-leftover');
                if (konsumMinInput && inputs.konsumMin) {
                    inputs.konsumMin.value = validateAmount(konsumMinInput.value, 0, 500000);
                }
                if (konsumLeftoverInput && inputs.konsumLeftover) {
                    inputs.konsumLeftover.value = validateAmount(konsumLeftoverInput.value, 0, 100000);
                }
                break;

            case 'tagesgeld':
                const tagesgeldCurrentInput = getEl('inline-tagesgeld-current');
                const tagesgeldLimitInput = getEl('inline-tagesgeld-limit');
                if (tagesgeldCurrentInput && inputs.tagesgeldCurrent) {
                    inputs.tagesgeldCurrent.value = validateAmount(tagesgeldCurrentInput.value, 0, 1000000);
                }
                if (tagesgeldLimitInput && inputs.tagesgeldLimit) {
                    inputs.tagesgeldLimit.value = validateAmount(tagesgeldLimitInput.value, 0, 1000000);
                }
                break;
        }

        // Close editor and recalculate
        closeInlineEditor(basinType);
        calculateAndUpdate();
    }

    // Add fadeOut animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeOutScale {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    `;
    document.head.appendChild(style);

    // ===== END INLINE EDITOR =====

    // ===== BOOKING MODAL (v1.4.0) =====

    /**
     * Open booking modal
     */
    function openBookingModal() {
        const modal = getEl('booking-modal');
        const modalBody = getEl('booking-modal-body');

        if (!modal || !modalBody) {
            console.error('❌ Modal or modalBody not found');
            return;
        }

        // Generate booking content directly in modal (v1.4.0: no sidebar)
        modalBody.innerHTML = `
            <div class="booking-section">
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px;">Buchungstyp wählen</h3>
                    <div class="booking-types" id="booking-type-buttons"></div>
                </div>
                <div class="booking-calendar" id="booking-calendar"></div>
                <div class="booking-hint" id="booking-hint" style="margin-top: 16px;"></div>
            </div>
        `;

        // Re-initialize booking planner with new modal elements
        setupBookingPlanner();

        // Show modal
        modal.classList.add('active');

        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    /**
     * Close booking modal
     */
    function closeBookingModal() {
        const modal = getEl('booking-modal');
        const modalBody = getEl('booking-modal-body');
        const bookingSection = getEl('sec-booking-plan');
        const sidebarContainer = document.querySelector('.panel-body'); // Original location

        if (!modal) return;

        // Move content back to sidebar (if needed for future use)
        if (bookingSection && sidebarContainer) {
            // Keep in modal for now, can be moved back if sidebar is restored
        }

        // Hide modal
        modal.classList.remove('active');

        // Restore body scroll
        document.body.style.overflow = '';
    }

    // ===== END BOOKING MODAL =====

    function calculateAndUpdate() {
        requestAnimationFrame(() => {
            positionCascade();

            // Safety: Check if all required basin elements exist
            if (!basins.einkommen || !basins.fixkosten || !basins.konsum ||
                !basins.tagesgeld || !basins.depot || !basins.vermieterkonto || !basins.immobilien) {
                console.error('[MLP ERROR] Basin elements not found. Cannot update visualization.');
                return;
            }

            // Vermieterkonto-Daten holen
            const vermieterData = getVermieterkontoData();
            const cashflowIntegrated = vermieterkontoData.cashflowIntegration || false;

            // Basiswerte
            let income = parseFloat(inputs.income?.value) || 0;
            const konsumMin = parseFloat(inputs.konsumMin?.value) || 0;
            const konsumLeftover = parseFloat(inputs.konsumLeftover?.value) || 0;
            const tagesgeldCurrent = parseFloat(inputs.tagesgeldCurrent?.value) || 0;
            const tagesgeldLimit = parseFloat(inputs.tagesgeldLimit?.value) || 0;

            // Vermieterkonto-Integration wird jetzt direkt in Fixkosten/Konsum gerechnet
            // (nicht mehr über Einkommen)

            // v1.5.2: Single-pass reduce for fixkostenItems (optimized from 2 filter passes)
            const { fixkostenTotal, depotTotal } = fixkostenItems.reduce((acc, item) => {
                const amount = getMonthlyAmount(item);
                if (item.target === 'fixkosten') {
                    acc.fixkostenTotal += amount;
                } else if (item.target === 'depot') {
                    acc.depotTotal += amount;
                }
                return acc;
            }, { fixkostenTotal: 0, depotTotal: 0 });

            let fixkostenOnlyTotal = fixkostenTotal;
            const depotSparplanTotal = depotTotal;

            // Vermieterkonto-Integration Variante A:
            // - Negativer Saldo: erhöht Fixkosten (Deckung)
            // - Positiver Saldo: reduziert Fixkosten (Miete senkt Abgänge)
            if (currentVariant === 'A') {
                if (vermieterData.saldo < 0) {
                    fixkostenOnlyTotal += Math.abs(vermieterData.saldo);
                } else {
                    fixkostenOnlyTotal = Math.max(0, fixkostenOnlyTotal - vermieterData.saldo);
                }
            } else {
                // Variante B: Negativer Saldo erhöht Fixkosten
                if (vermieterData.saldo < 0) {
                    fixkostenOnlyTotal += Math.abs(vermieterData.saldo);
                }
            }

            const totalAbgang = fixkostenOnlyTotal + depotSparplanTotal;
            // Zufluss (Inflow) in das Konsumkonto zur Skalierung der Min-Linie
            const konsumInflow = (currentVariant === 'A')
              ? Math.max(0, income - totalAbgang)   // Variante A: nach Abzug aller Abgänge (Fix + Sparplan)
              : Math.max(0, income);                // Variante B: Einkommen geht direkt auf Konsum

            const { tagesgeldInflow, depotOverflow } = calculateOverflow(konsumLeftover, tagesgeldCurrent, tagesgeldLimit);
            const finalTagesgeld = tagesgeldCurrent + tagesgeldInflow;
            const totalDepotInflow = depotSparplanTotal + depotOverflow;
            
            let konsumValue;
            if(currentVariant === 'A') {
                konsumValue = income - totalAbgang;
            } else {
                // Variante B: Konsum wird bei positivem Vermieterkonto-Saldo erhöht
                konsumValue = income - totalAbgang;
                if (vermieterData.saldo > 0) {
                    konsumValue += vermieterData.saldo;
                }
            }
            
            renderBasin(basins.einkommen, 'Einkommen', formatCurrency(income), '<svg class="w-7 h-7 mb-1 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>');
            renderBasin(basins.fixkosten, 'Fixkostenkonto', formatCurrency(totalAbgang), '<svg class="w-7 h-7 mb-1 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', '(Klick zum Bearbeiten)');
            // Scale the yellow min line relative to the available monthly surplus (Überschuss).
            renderBasin(
              basins.konsum,
              'Konsumkonto',
              formatCurrency(konsumValue),
              '<svg class="w-7 h-7 mb-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>',
              `Überschuss: ${formatCurrency(konsumLeftover)}`,
              { current: konsumValue, min: konsumMin, limit: Infinity, minScaleBase: konsumInflow }
            );
            renderBasin(basins.tagesgeld, 'Tagesgeldkonto', formatCurrency(finalTagesgeld), '<svg class="w-7 h-7 mb-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>', `Zufluss: ${formatCurrency(tagesgeldInflow)}`, { current: finalTagesgeld, min: 0, limit: tagesgeldLimit });

            // Use custom renderDepotBasin instead of renderBasin for fund blocks visualization
            renderDepotBasin();

            // Vermieterkonto-Basin rendern (über Immobilien) - vermieterData wurde bereits oben berechnet
            renderBasin(
                basins.vermieterkonto,
                'Vermieterkonto',
                formatCurrency(vermieterData.saldo),
                '',
                `Ein: ${formatCurrency(vermieterData.einnahmen)} | Aus: ${formatCurrency(vermieterData.ausgaben)}`,
                {},
                createAccountSVG()
            );

            // Immobilien-Basin rendern (Summe aller Immobilien)
            const gesamtwert = immobilienData.reduce((sum, immo) => sum + (immo.wert || 0), 0);
            const gesamtdarlehen = immobilienData.reduce((sum, immo) => sum + (immo.darlehen || 0), 0);
            const immoNettovermoegen = gesamtwert - gesamtdarlehen;
            const anzahlImmobilien = immobilienData.length;

            renderBasin(
                basins.immobilien,
                'Immobilien',
                formatCurrency(immoNettovermoegen),
                '',
                anzahlImmobilien > 0 ? `${anzahlImmobilien} Immobilie${anzahlImmobilien > 1 ? 'n' : ''}` : '(Klick zum Bearbeiten)',
                {},
                createHouseSVG()
            );

            // === BEGIN: Flow visibility control (consultation-aware) ===
            const bothVisible = (a, b) => isVisible(a) && isVisible(b);
            const maxFlow = income || 1;

            let show1 = false, show2 = false, showKTG = false, showTGDepot = false, showFixDepot = false;

            if (currentVariant === 'A') {
                // A: Einkommen -> Fixkosten -> Konsum -> Tagesgeld -> Depot; Sparrate erst Step 5
                show1       = bothVisible(basins.einkommen,   basins.fixkosten);                                      // Step 1+
                show2       = bothVisible(basins.fixkosten, basins.konsum)   && (!consultationMode || consultationStep >= 2);
                showKTG     = bothVisible(basins.konsum,    basins.tagesgeld) && (!consultationMode || consultationStep >= 3);
                showTGDepot = bothVisible(basins.tagesgeld, basins.depot)     && (!consultationMode || consultationStep >= 4);
                showFixDepot= bothVisible(basins.fixkosten, basins.depot)     && (!consultationMode || (consultationMode && allowDepotStream === true)); // Step 5 in consultation

                if (show1)       drawFlow('flow-path-1', basins.einkommen,    basins.fixkosten, income, maxFlow);
                else             hideFlow('flow-path-1');

                if (show2)       drawFlow('flow-path-2', basins.fixkosten, basins.konsum, Math.max(0, income - totalAbgang), maxFlow, 'Dauerauftrag');
                else             hideFlow('flow-path-2');

                if (showKTG)     drawFlow('konsum-tagesgeld-flow', basins.konsum,    basins.tagesgeld, konsumLeftover, maxFlow);
                else             hideFlow('konsum-tagesgeld-flow');

                if (showTGDepot) drawFlow('tagesgeld-depot-flow', basins.tagesgeld,  basins.depot, depotOverflow, maxFlow);
                else             hideFlow('tagesgeld-depot-flow');

                if (showFixDepot)drawFlow('fixkosten-depot-flow', basins.fixkosten,  basins.depot, depotSparplanTotal, maxFlow, 'Sparrate');
                else             hideFlow('fixkosten-depot-flow');

            } else {
                // B: Einkommen -> Konsum -> Fixkosten -> Tagesgeld -> Depot; Sparrate erst Step 5
                show1       = bothVisible(basins.einkommen,   basins.konsum);                                        // Step 1+
                show2       = bothVisible(basins.konsum,   basins.fixkosten) && (!consultationMode || consultationStep >= 2);
                showKTG     = bothVisible(basins.konsum,   basins.tagesgeld) && (!consultationMode || consultationStep >= 3);
                showTGDepot = bothVisible(basins.tagesgeld,basins.depot)    && (!consultationMode || consultationStep >= 4);
                showFixDepot= bothVisible(basins.fixkosten,basins.depot)    && (!consultationMode || (consultationMode && allowDepotStream === true)); // Step 5 in consultation

                if (show1)       drawFlow('flow-path-1', basins.einkommen,  basins.konsum, income, maxFlow);
                else             hideFlow('flow-path-1');

                if (show2)       drawFlow('flow-path-2', basins.konsum,  basins.fixkosten, totalAbgang, maxFlow, 'Dauerauftrag');
                else             hideFlow('flow-path-2');

                if (showKTG)     drawFlow('konsum-tagesgeld-flow', basins.konsum,   basins.tagesgeld, konsumLeftover, maxFlow);
                else             hideFlow('konsum-tagesgeld-flow');

                if (showTGDepot) drawFlow('tagesgeld-depot-flow', basins.tagesgeld, basins.depot, depotOverflow, maxFlow);
                else             hideFlow('tagesgeld-depot-flow');

                if (showFixDepot)drawFlow('fixkosten-depot-flow', basins.fixkosten, basins.depot, depotSparplanTotal, maxFlow, 'Sparrate');
                else             hideFlow('fixkosten-depot-flow');
            }
            // === END: Flow visibility control ===

            // === Vermieterkonto Flows ===
            const hasVermieterkontoCashflow = Math.abs(vermieterData.saldo) > 0;

            if (hasVermieterkontoCashflow) {
                if (vermieterData.saldo > 0) {
                    // Positiv: Vermieterkonto → Fixkosten (Variante A) oder Konsum (Variante B)
                    hideFlow('vermieterkonto-einkommen-flow'); // Alten Flow ausblenden

                    if (currentVariant === 'A') {
                        // Variante A: Vermieterkonto → Fixkosten (linke Seite Mitte)
                        if (bothVisible(basins.vermieterkonto, basins.fixkosten)) {
                            drawFlow('fixkosten-vermieterkonto-flow', basins.vermieterkonto, basins.fixkosten, vermieterData.saldo, maxFlow, 'Miete', 0.3);
                        } else {
                            hideFlow('fixkosten-vermieterkonto-flow');
                        }
                    } else {
                        // Variante B: Vermieterkonto → Konsum (linke Seite Mitte)
                        if (bothVisible(basins.vermieterkonto, basins.konsum)) {
                            drawFlow('fixkosten-vermieterkonto-flow', basins.vermieterkonto, basins.konsum, vermieterData.saldo, maxFlow, 'Miete', 0.3);
                        } else {
                            hideFlow('fixkosten-vermieterkonto-flow');
                        }
                    }
                } else {
                    // Negativ: Fixkosten → Vermieterkonto (Deckung der negativen Kosten)
                    hideFlow('vermieterkonto-einkommen-flow'); // Alten Flow ausblenden
                    if (bothVisible(basins.fixkosten, basins.vermieterkonto)) {
                        drawFlow('fixkosten-vermieterkonto-flow', basins.fixkosten, basins.vermieterkonto, Math.abs(vermieterData.saldo), maxFlow, 'Deckung', 1.0);
                        // Deficitline transparent machen - höhere Opacity für sichtbare Gradient-Farben
                        const deficitPath = getEl('fixkosten-vermieterkonto-flow');
                        if (deficitPath) deficitPath.style.filter = 'opacity(0.5)';
                    } else {
                        hideFlow('fixkosten-vermieterkonto-flow');
                    }
                }
            } else {
                hideFlow('vermieterkonto-einkommen-flow');
                hideFlow('fixkosten-vermieterkonto-flow');
            }

            // Visuelle Verbindung: Immobilien <-> Vermieterkonto (gestrichelte Linie, immer sichtbar)
            const showImmoVermieterbindung = bothVisible(basins.immobilien, basins.vermieterkonto);
            if (showImmoVermieterbindung) {
                drawConnectionLine('immobilien-vermieterkonto-connection', basins.immobilien, basins.vermieterkonto);
            } else {
                hideFlow('immobilien-vermieterkonto-connection');
            }

            drawSchutzschirm(basins.tagesgeld, basins.depot);
            // --- Shield visibility based on available liquidity on Tagesgeld, scaled by liquidity level ---
            const shield = getEl('schutzschirm-path');
            if (shield) {
                // Sichtbarkeit des Schutzschirms: sobald im Tagesgeld verwertbare Liquidität vorhanden ist
                const liquidity = Math.max(0, finalTagesgeld); // verfügbare Liquidität auf TG
                let strength = 0;
                if (isFinite(tagesgeldLimit) && tagesgeldLimit > 0) {
                    strength = Math.min(1, liquidity / tagesgeldLimit); // skaliert relativ zum Ziel
                } else {
                    strength = liquidity > 0 ? 1 : 0; // ohne Ziel: binär
                }
                if (strength > 0) {
                    // weiche Skalierung für Sichtbarkeit/Strichstärke
                    const opacity = Math.max(0.25, 0.15 + 0.85 * strength);
                    shield.style.opacity = String(opacity);
                    shield.style.strokeWidth = `${2 + 2 * strength}px`;
                } else {
                    shield.style.opacity = '0';
                }
            }
        });
    }
    
    // --- Projection Logic ---
    function calculateProjection() {
        const initialDepot = parseFloat(inputs.depotCurrent.value) || 0;
        const years = parseInt(inputs.anlagezeitraum.value, 10);
        const depotSparplanTotal = fixkostenItems
            .filter(i => i.target === 'depot')
            .reduce((sum, i) => sum + getMonthlyAmount(i), 0);
        const tagesgeldCurrent = parseFloat(inputs.tagesgeldCurrent.value) || 0;
        const tagesgeldLimit = parseFloat(inputs.tagesgeldLimit.value) || 0;
        const konsumLeftover = parseFloat(inputs.konsumLeftover.value) || 0;
        const { depotOverflow } = calculateOverflow(konsumLeftover, tagesgeldCurrent, tagesgeldLimit);
        const monthlyInvestment = depotSparplanTotal + depotOverflow;

        const dataRangeRaw = (renditeExtremes && renditeExtremes[years]) || getRenditeDataForPeriod(years);
        const stats = dataRangeRaw ? (dataRangeRaw.mean === undefined ? buildRenditeStat(dataRangeRaw.min, dataRangeRaw.max) : dataRangeRaw) : null;

        const fallbackMin = stats ? stats.min : 0;
        const fallbackMax = stats ? stats.max : fallbackMin;
        const fallbackMean = stats ? stats.mean : (fallbackMin + fallbackMax) / 2;

        const selectedRendite = Number(inputs.rendite.value);
        const normalizedSelected = Number.isFinite(selectedRendite) ? clamp(selectedRendite, fallbackMin, fallbackMax) : fallbackMean;
        const returnAvg = normalizedSelected / 100;
        const returnMin = fallbackMin / 100;
        const returnMax = fallbackMax / 100;

        const dataAvg = calculateCompoundInterest(initialDepot, monthlyInvestment, years, returnAvg);
        const dataMin = calculateCompoundInterest(initialDepot, monthlyInvestment, years, returnMin);
        const dataMax = calculateCompoundInterest(initialDepot, monthlyInvestment, years, returnMax);

        displayProjectionChart({
            labels: dataAvg.labels,
            datasets: [
                { label: 'Pessimistisch', data: dataMin.capitalData, color: '#ef4444' },
                { label: 'Erwartet', data: dataAvg.capitalData, color: '#3b82f6' },
                { label: 'Optimistisch', data: dataMax.capitalData, color: '#22c55e' },
                { label: 'Einzahlungen', data: dataAvg.contributionsData, color: '#6b7280' }
            ]
        });
        const summaryEl = getEl('prognose-summary');
        if (summaryEl) {
            summaryEl.innerHTML = `
            <p>Nach <span class="font-bold">${years} Jahren</span> könnte dein Vermögen zwischen <span class="font-bold text-red-400">${formatCurrency(dataMin.totalCapital)}</span> und <span class="font-bold text-green-400">${formatCurrency(dataMax.totalCapital)}</span> liegen.</p>
            <p>Deine erwartete Prognose liegt bei <span class="font-bold text-blue-400 text-lg">${formatCurrency(dataAvg.totalCapital)}</span>, basierend auf ${formatCurrency(dataAvg.totalContributions)} Einzahlungen.</p>
        `;
        }
        // NICHT automatisch Modal öffnen (v1.4.0) - nur bei explizitem Button-Klick
    }

    // v1.4.0: Separate Funktion um Prognose zu berechnen UND Modal zu öffnen
    function showProjection() {
        calculateProjection();
        openModal('prognose-modal');
    }

    function calculateCompoundInterest(initial, monthly, years, annualRate) {
        const monthlyRate = annualRate / 12;
        let totalCapital = initial;
        let totalContributions = initial;
        const labels = ['Start'];
        const capitalData = [initial];
        const contributionsData = [initial];

        for (let i = 1; i <= years; i++) {
            for (let j = 0; j < 12; j++) {
                totalCapital = totalCapital * (1 + monthlyRate) + monthly;
                totalContributions += monthly;
            }
            labels.push(`Jahr ${i}`);
            capitalData.push(totalCapital);
            contributionsData.push(totalContributions);
        }
        return { labels, capitalData, contributionsData, totalCapital, totalContributions };
    }

    function displayProjectionChart({labels, datasets}) {
        const ctx = getEl('prognose-chart')?.getContext('2d');
        if (!ctx) {
            console.error('[MLP ERROR] Chart canvas not found');
            return;
        }

        // Safety: Check before destroying chart instance
        if (prognoseChartInstance) {
            prognoseChartInstance.destroy();
            prognoseChartInstance = null;
        }
        
        const chartDatasets = datasets.map(ds => {
            // Custom styling for pessimistic and optimistic
            if (ds.label === 'Pessimistisch') {
                return {
                    label: ds.label,
                    data: ds.data,
                    borderWidth: 1.5,                // dünner
                    borderColor: 'rgba(239,68,68,0.3)', // rot mit hoher Transparenz
                    borderDash: [6, 6],              // gestrichelt
                    pointRadius: 0,                  // keine Punkte
                    fill: false,
                    tension: 0.1
                };
            } else if (ds.label === 'Optimistisch') {
                return {
                    label: ds.label,
                    data: ds.data,
                    borderWidth: 1.5,                // dünner
                    borderColor: 'rgba(34,197,94,0.3)', // grün mit hoher Transparenz
                    borderDash: [6, 6],              // gestrichelt
                    pointRadius: 0,                  // keine Punkte
                    fill: false,
                    tension: 0.1
                };
            } else {
                // Erwartet (blue), Einzahlungen (gray dashed): unchanged
                return {
                    label: ds.label,
                    data: ds.data,
                    borderColor: ds.color,
                    borderDash: ds.label.includes('Einzahlungen') ? [5, 5] : [],
                    fill: false,
                    tension: 0.1
                };
            }
        });

        prognoseChartInstance = new Chart(ctx, {
            type: 'line', data: { labels: labels, datasets: chartDatasets },
            options: { responsive: true, plugins: { legend: { labels: { color: '#d1d5db' } }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatCurrency(c.raw)}` } } },
                scales: { x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: '#9ca3af', callback: (v) => formatCurrency(v) }, grid: { color: 'rgba(255,255,255,0.1)' } } }
            }
        });
    }

    // --- Other Helpers ---
    function setRendite(value) { inputs.rendite.value = value; }
    
    function getRenditeDataForPeriod(jahre) {
        const key = [1, 5, 10, 15, 20, 25, 30].reduce((prev, curr) => (Math.abs(curr - jahre) < Math.abs(prev - jahre) ? curr : prev));
        return renditeData[key];
    }

    function updateRenditeSuggestions(jahre) {
        let source = null;
        if (renditeExtremes && renditeExtremes[jahre]) {
            source = renditeExtremes[jahre];
        } else {
            source = getRenditeDataForPeriod(jahre);
        }
        if (!source) return;

        const stats = source.mean === undefined ? buildRenditeStat(source.min, source.max) : source;
        const infoEl = getEl('rendite-info');
        const mostLikely = roundToDecimal(stats.mean);

        // BUGFIX (PDF): NEVER overwrite user's input - only show suggestion
        // User must manually copy suggestion if they want it
        // Old behavior: inputs.rendite.value = mostLikely.toFixed(1); // ❌ REMOVED

        const colorClass = (v) => (v < 0 ? 'text-red-400' : (v < 3 ? 'text-yellow-400' : 'text-green-400'));
        const minSpan = `<span class="font-bold ${colorClass(stats.min)}">${stats.min}%</span>`;
        const maxSpan = `<span class="font-bold ${colorClass(stats.max)}">${stats.max}%</span>`;

        if (infoEl) {
            // Show suggestion with "empfohlen" hint, but don't auto-fill
            infoEl.innerHTML = `Historische Spanne p.a.: ${minSpan} bis ${maxSpan}<br><span class="font-bold text-blue-400">Empfohlen (Normal): ${mostLikely.toFixed(1)}%</span>`;
        }
    }

    function createGrowthChartSVG() { return `<svg viewBox="0 0 100 60" class="w-20 h-12 mb-1"><rect x="10" y="40" width="15" height="20" fill="#3b82f6" opacity="0.6"></rect><rect x="30" y="30" width="15" height="30" fill="#3b82f6" opacity="0.8"></rect><rect x="50" y="20" width="15" height="40" fill="#3b82f6"></rect><rect x="70" y="10" width="15" height="50" fill="#6366f1"></rect></svg>`; }

    // Häuschen-SVG für Immobilien-Basin (minimalistisches Design)
    function createHouseSVG() {
        return `<svg viewBox="0 0 100 100" class="w-16 h-16 mb-1">
            <!-- Dach -->
            <path d="M 10 50 L 50 20 L 90 50 Z" fill="#f59e0b" opacity="0.9"/>
            <!-- Haus -->
            <rect x="20" y="50" width="60" height="45" fill="#3b82f6" opacity="0.8"/>
            <!-- Tür -->
            <rect x="55" y="70" width="15" height="25" fill="#1e3a8a" opacity="0.9"/>
            <!-- Fenster links -->
            <rect x="30" y="60" width="12" height="12" fill="#fbbf24" opacity="0.7"/>
            <!-- Fenster rechts -->
            <rect x="58" y="60" width="12" height="12" fill="#fbbf24" opacity="0.7"/>
        </svg>`;
    }

    // SVG für Vermieterkonto (Verrechnungskonto-Icon)
    function createAccountSVG() {
        return `<svg viewBox="0 0 100 60" class="w-16 h-12 mb-1">
            <!-- Konto-Karte -->
            <rect x="10" y="15" width="80" height="30" rx="4" fill="#3b82f6" opacity="0.85" stroke="#60a5fa" stroke-width="2"/>
            <!-- Magnetstreifen -->
            <rect x="10" y="25" width="80" height="8" fill="#1e3a8a" opacity="0.9"/>
            <!-- Chip -->
            <rect x="20" y="35" width="12" height="10" rx="2" fill="#fbbf24" opacity="0.8"/>
            <!-- Flow-Pfeile (rein/raus) -->
            <path d="M 5 30 L 10 30" stroke="#10b981" stroke-width="2" opacity="0.7"/>
            <path d="M 90 30 L 95 30" stroke="#ef4444" stroke-width="2" opacity="0.7"/>
        </svg>`;
    }

    function calculateOverflow(inflow, current, limit) { if (limit <= 0) return { tagesgeldInflow: inflow, depotOverflow: 0 }; const potential = current + inflow; if (potential <= limit) return { tagesgeldInflow: inflow, depotOverflow: 0 }; const overflow = potential - limit; return { tagesgeldInflow: inflow - overflow, depotOverflow: overflow }; }
    const modalFocusableSelectors = 'a[href], area[href], button:not([disabled]), input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])';
    const modalFocusState = { activeModal: null, lastFocusedElement: null };

    function openModal(modalId) {
        const modal = getEl(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        console.log('Opening modal:', modalId);

        const activeElement = document.activeElement;
        modalFocusState.lastFocusedElement = (activeElement && typeof activeElement.focus === 'function') ? activeElement : null;

        modal.classList.add('modal-active');
        modal.removeAttribute('aria-hidden');
        modalFocusState.activeModal = modal;

        const mainRegion = getEl('main-content');
        if (mainRegion) mainRegion.setAttribute('aria-hidden', 'true');

        const focusable = getFocusableElements(modal);
        const focusTarget = modal.querySelector('[tabindex="-1"]') || focusable[0] || modal;
        window.requestAnimationFrame(() => {
            if (focusTarget && typeof focusTarget.focus === 'function') focusTarget.focus();
        });

        document.addEventListener('keydown', handleModalKeydown, true);
    }

    function closeModal(modalId) {
        const modal = getEl(modalId);
        if (!modal) return;

        modal.classList.remove('modal-active');
        modal.setAttribute('aria-hidden', 'true');

        if (modalFocusState.activeModal && modalFocusState.activeModal.id === modalId) {
            const mainRegion = getEl('main-content');
            if (mainRegion) mainRegion.removeAttribute('aria-hidden');

            document.removeEventListener('keydown', handleModalKeydown, true);
            modalFocusState.activeModal = null;

            const returnFocus = modalFocusState.lastFocusedElement;
            modalFocusState.lastFocusedElement = null;
            if (returnFocus && typeof returnFocus.focus === 'function') returnFocus.focus();
        }
    }

    function handleModalKeydown(event) {
        const modal = modalFocusState.activeModal;
        if (!modal) return;

        if (event.key === 'Escape') {
            event.preventDefault();
            closeModal(modal.id);
            return;
        }

        if (event.key !== 'Tab') return;

        const focusable = getFocusableElements(modal);
        if (!focusable.length) {
            event.preventDefault();
            const fallback = modal.querySelector('[tabindex="-1"]') || modal;
            if (fallback && typeof fallback.focus === 'function') fallback.focus();
            return;
        }

        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        const activeElement = document.activeElement;

        if (event.shiftKey) {
            if (activeElement === first) {
                event.preventDefault();
                last.focus();
            }
        } else if (activeElement === last) {
            event.preventDefault();
            first.focus();
        }
    }

    function getFocusableElements(modal) {
        return Array.from(modal.querySelectorAll(modalFocusableSelectors)).filter(isElementFocusable);
    }

    function isElementFocusable(el) {
        if (!el || el.hasAttribute('disabled')) return false;
        if (el.getAttribute('tabindex') === '-1') return false;
        if (el.getAttribute('aria-hidden') === 'true') return false;
        return isVisible(el);
    }

    // Toast Notification System
    function showToast(message, type = 'success', duration = 4000) {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
            document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.style.cssText = `
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            max-width: 500px;
            font-size: 14px;
            line-height: 1.5;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
        `;
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>' :
                      type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>' :
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'}
                </svg>
                <span>${message}</span>
            </div>
        `;

        // Add animation styles if not already present
        if (!document.getElementById('toast-animations')) {
            const style = document.createElement('style');
            style.id = 'toast-animations';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Add toast to container
        toastContainer.appendChild(toast);

        // Remove toast on click
        toast.addEventListener('click', () => removeToast(toast));

        // Auto-remove after duration
        if (duration > 0) {
            setTimeout(() => removeToast(toast), duration);
        }

        return toast;
    }

    function removeToast(toast) {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }
    const fixkostenModal = { list: getEl('fixkosten-list'), total: getEl('modal-total') };

    function openFixkostenModal() {
        // Lade Vermieterkonto-Daten aus sessionStorage bevor Modal geöffnet wird
        const saved = sessionStorage.getItem('vermieterkontoData');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                Object.assign(vermieterkontoData, parsed);
            } catch (e) {
                console.error('Fehler beim Laden der Vermieterkonto-Daten:', e);
            }
        }
        openModal('fixkosten-modal');
        // Render list AFTER modal is opened to ensure DOM is ready
        renderFixkostenList();
    }

    function saveFixkosten() { calculateAndUpdate(); closeModal('fixkosten-modal'); }
    function renderFixkostenList() {
        fixkostenModal.list.innerHTML = '';
        let total = 0;

        // Vermieterkonto-Daten holen
        const vermieterData = getVermieterkontoData();

        // Automatische Zeile für Vermieterkonto (nur in Variante A)
        if (currentVariant === 'A' && vermieterData.saldo !== 0) {
            const autoItemEl = document.createElement('div');

            if (vermieterData.saldo < 0) {
                // Negativ: Zusätzliche Ausgabe (gelb/warnung)
                autoItemEl.className = 'grid grid-cols-12 gap-2 items-center bg-gray-750 p-2 rounded border border-yellow-600';
                autoItemEl.innerHTML = `
                    <div class="col-span-4 text-yellow-400 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        Vermieterkonto-Deckung
                    </div>
                    <div class="col-span-2 text-yellow-400 font-bold">${formatCurrency(Math.abs(vermieterData.saldo))}</div>
                    <div class="col-span-2 text-gray-500 text-sm">mtl.</div>
                    <div class="col-span-3 text-gray-500 text-sm">automatisch</div>
                    <div class="col-span-1"></div>
                `;
                total += Math.abs(vermieterData.saldo);
            } else {
                // Positiv: Einsparung (grün)
                autoItemEl.className = 'grid grid-cols-12 gap-2 items-center bg-gray-750 p-2 rounded border border-green-600';
                autoItemEl.innerHTML = `
                    <div class="col-span-4 text-green-400 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Mieteinnahmen
                    </div>
                    <div class="col-span-2 text-green-400 font-bold">-${formatCurrency(vermieterData.saldo)}</div>
                    <div class="col-span-2 text-gray-500 text-sm">mtl.</div>
                    <div class="col-span-3 text-gray-500 text-sm">automatisch</div>
                    <div class="col-span-1"></div>
                `;
                total -= vermieterData.saldo; // Reduziert die Fixkosten
            }

            fixkostenModal.list.appendChild(autoItemEl);
        }

        // Reguläre Fixkosten-Items
        fixkostenItems.forEach((item, index) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'grid grid-cols-12 gap-2 items-center';
            itemEl.innerHTML = `<input type="text" value="${item.name}" onchange="updateFixkostenItem(${index}, 'name', this.value)" placeholder="Posten" class="col-span-4 bg-gray-700 p-1 rounded"><input type="number" value="${item.amount}" onchange="updateFixkostenItem(${index}, 'amount', this.value)" placeholder="Betrag" class="col-span-2 bg-gray-700 p-1 rounded"><select onchange="updateFixkostenItem(${index}, 'interval', this.value)" class="col-span-2 bg-gray-700 p-1 rounded">${['monthly','quarterly','annually'].map(i => `<option value="${i}" ${item.interval === i ? 'selected' : ''}>${i==='monthly'?'mtl.':i==='quarterly'?'viertelj.':'jährl.'}</option>`).join('')}</select><select onchange="updateFixkostenItem(${index}, 'target', this.value)" class="col-span-3 bg-gray-700 p-1 rounded"><option value="fixkosten" ${item.target==='fixkosten'?'selected':''}>-> Fixkosten</option><option value="depot" ${item.target==='depot'?'selected':''}>-> Sparplan</option></select><button onclick="removeFixkostenItem(${index})" class="col-span-1 text-red-400 hover:text-red-300 text-xl">&times;</button>`;
            fixkostenModal.list.appendChild(itemEl);
            total += getMonthlyAmount(item);
        });

        fixkostenModal.total.textContent = formatCurrency(total);
    }
function updateFixkostenItem(index, key, value) {
  // Normalize types per field
  if (key === 'amount') {
    value = parseFloat(value);
    if (!Number.isFinite(value)) value = 0;
    // Allow negative values (for additional income items)
    if (value < -1000000) value = -1000000; // min realistic amount (-1M EUR)
    if (value > 1000000) value = 1000000; // max realistic amount (1M EUR)
  }
  // Persist change in model
  if (fixkostenItems[index]) {
    fixkostenItems[index][key] = value;
  }
  // Re-render modal list & totals (debounced for performance)
  debouncedRenderFixkostenList();
}
    function addFixkostenItem() { fixkostenItems.push({ name: '', amount: 0, interval: 'monthly', target: 'fixkosten' }); renderFixkostenList(); }
    function removeFixkostenItem(index) { fixkostenItems.splice(index, 1); renderFixkostenList(); }
    const depotModal = { list: getEl('depot-list'), total: getEl('depot-total'), warning: getEl('depot-warning'), saveButton: getEl('depot-save-button') };
    function saveDepot() { if(checkDepotTotal()) { calculateAndUpdate(); closeModal('depot-modal'); } }
    function renderDepotList() {
        depotModal.list.innerHTML = '';
        let total = 0;
        depotItems.forEach((item, index) => {
            total += item.allocation;
            // Ensure risk property exists (backward compatibility)
            if (!item.risk) item.risk = 'conservative';

            const itemEl = document.createElement('div');
            itemEl.className = 'grid grid-cols-12 gap-2 items-center mb-2';
            itemEl.innerHTML = `
                <input type="color" value="${item.color}" onchange="updateDepotItem(${index}, 'color', this.value)"
                       class="col-span-1 h-8 bg-gray-700 p-0 rounded" title="Fonds-Farbe">
                <input type="text" value="${item.name}" onchange="updateDepotItem(${index}, 'name', this.value)"
                       placeholder="Fonds / ETF Name" class="col-span-5 bg-gray-700 p-1 rounded text-sm">
                <div class="relative col-span-2">
                    <input type="number" value="${item.allocation}" onchange="updateDepotItem(${index}, 'allocation', this.value)"
                           class="w-full text-right pr-6 bg-gray-700 p-1 rounded text-sm">
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</span>
                </div>
                <div class="col-span-3 risk-toggle">
                    <button type="button" class="risk-btn ${item.risk === 'conservative' ? 'active' : ''}"
                            onclick="updateDepotItem(${index}, 'risk', 'conservative')" title="Konservativ">
                        <span class="risk-dot conservative"></span>
                    </button>
                    <button type="button" class="risk-btn ${item.risk === 'aggressive' ? 'active' : ''}"
                            onclick="updateDepotItem(${index}, 'risk', 'aggressive')" title="Chancenreich">
                        <span class="risk-dot aggressive"></span>
                    </button>
                </div>
                <button type="button" onclick="removeDepotItem(${index})"
                        class="col-span-1 text-red-400 hover:text-red-300 text-xl" title="Entfernen">&times;</button>
            `;
            depotModal.list.appendChild(itemEl);
        });
        checkDepotTotal();
    }

    function updateDepotItem(index, key, value) {
        if (key === 'allocation') value = parseInt(value, 10) || 0;
        depotItems[index][key] = value;
        debouncedRenderDepotList();
        renderDepotBasin(); // Update basin visualization
    }

    function addDepotItem() {
        depotItems.push({
            name: '',
            allocation: 0,
            color: '#' + Math.floor(Math.random() * 16777215).toString(16),
            risk: 'conservative'
        });
        renderDepotList();
    }
    function removeDepotItem(index) {
        depotItems.splice(index, 1);
        renderDepotList();
        renderDepotBasin(); // Update basin visualization
    }

    function checkDepotTotal() {
        const total = depotItems.reduce((sum, i) => sum + i.allocation, 0);
        depotModal.total.textContent = `${total} %`;
        if (total === 100) {
            depotModal.total.className = "text-2xl font-bold text-green-400";
            depotModal.warning.textContent = "";
            depotModal.saveButton.disabled = false;
            depotModal.saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
            return true;
        } else {
            depotModal.total.className = "text-2xl font-bold text-red-400";
            depotModal.warning.textContent = "Die Summe der Verteilung muss 100% ergeben.";
            depotModal.saveButton.disabled = true;
            depotModal.saveButton.classList.add('opacity-50', 'cursor-not-allowed');
            return false;
        }
    }

    function renderDepotBasin() {
        if (!basins.depot) return;

        // MLP Design Palette - Blue scale for conservative, Red scale for aggressive
        const mlpColors = {
            conservative: [
                '#002f6c', // MLP Blue (darkest)
                '#0047a0', // MLP Blue medium
                '#3b82f6', // Blue-500
                '#60a5fa', // Blue-400
                '#93c5fd'  // Blue-300 (lightest)
            ],
            aggressive: [
                '#991b1b', // Red-800 (darkest)
                '#dc2626', // Red-600
                '#ef4444', // Red-500
                '#f87171', // Red-400
                '#fca5a5'  // Red-300 (lightest)
            ]
        };

        // Filter active funds (allocation > 0)
        const conservative = depotItems.filter(i => i.risk === 'conservative' && i.allocation > 0);
        const aggressive = depotItems.filter(i => i.risk === 'aggressive' && i.allocation > 0);

        // Generate fund blocks HTML - SQUARES (width = height)
        // Better scaling: 10% → 24px, 50% → 40px, 100% → 56px
        const calculateSize = (allocation) => {
            const baseSize = 24; // Minimum size
            const scaleFactor = 0.32; // Better visibility of differences
            return Math.round(baseSize + (allocation * scaleFactor));
        };

        const leftBlocks = conservative.map((item, index) => {
            const size = calculateSize(item.allocation);
            const color = mlpColors.conservative[index % mlpColors.conservative.length];
            return `<div class="fund-block" style="background: ${color}; width: ${size}px; height: ${size}px" title="${item.name} (${item.allocation}%)"></div>`;
        }).join('');

        const rightBlocks = aggressive.map((item, index) => {
            const size = calculateSize(item.allocation);
            const color = mlpColors.aggressive[index % mlpColors.aggressive.length];
            return `<div class="fund-block" style="background: ${color}; width: ${size}px; height: ${size}px" title="${item.name} (${item.allocation}%)"></div>`;
        }).join('');

        console.log('Fund block sizes:', conservative.map(i => `${i.name}: ${i.allocation}% → ${calculateSize(i.allocation)}px`));
        console.log('Fund block sizes:', aggressive.map(i => `${i.name}: ${i.allocation}% → ${calculateSize(i.allocation)}px`));

        // Render basin with fund blocks
        basins.depot.innerHTML = `
            <div class="depot-basin-content">
                <div class="fund-blocks left">${leftBlocks || '<div style="width: 8px"></div>'}</div>
                <div class="depot-info">
                    <div class="text-sm font-semibold">Vermögensaufbau</div>
                    <div class="text-2xl font-bold">${formatCurrency(inputs.depotCurrent.value)}</div>
                    <div class="text-xs text-gray-400">(Klick zum Bearbeiten)</div>
                </div>
                <div class="fund-blocks right">${rightBlocks || '<div style="width: 8px"></div>'}</div>
            </div>
        `;
    }

    // === MSCI RENDITEDREIECK FUNCTIONS ===
    let msciZoomState = {
        zoomed: false,
        scale: 1,
        translateX: 0,
        translateY: 0
    };

    function openMsciRenditedreieck() {
        resetMsciZoom();
        openModal('msci-modal');
    }

    function closeMsciRenditedreieck() {
        closeModal('msci-modal');
        resetMsciZoom();
    }

    function resetMsciZoom() {
        msciZoomState = { zoomed: false, scale: 1, translateX: 0, translateY: 0 };
        const img = getEl('msci-image');
        const container = getEl('msci-container');
        if (img) {
            img.style.transform = 'scale(1) translate(0, 0)';
            img.style.cursor = 'zoom-in';
        }
        if (container) {
            container.style.cursor = 'zoom-in';
        }
    }

    function toggleMsciZoom(event) {
        const img = getEl('msci-image');
        const container = getEl('msci-container');
        if (!img || !container) return;

        if (!msciZoomState.zoomed) {
            // Zoom in: Berechne Position relativ zum Klick
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Prozentuale Position (0-1)
            const xPercent = x / rect.width;
            const yPercent = y / rect.height;

            // Zoom-Level
            const zoomScale = 2.5;

            // Berechne Translation um den Klickpunkt zu zentrieren
            const translateX = (0.5 - xPercent) * 100 * (zoomScale - 1);
            const translateY = (0.5 - yPercent) * 100 * (zoomScale - 1);

            msciZoomState = {
                zoomed: true,
                scale: zoomScale,
                translateX: translateX,
                translateY: translateY
            };

            img.style.transform = `scale(${zoomScale}) translate(${translateX}%, ${translateY}%)`;
            img.style.cursor = 'zoom-out';
            container.style.cursor = 'zoom-out';
        } else {
            // Zoom out
            resetMsciZoom();
        }
    }

    // Filter-Funktionen entfernt - nur Zoom bleibt aktiv

    // === IMMOBILIEN FUNCTIONS ===
    // Immobilien-Daten Objekt (wird in localStorage gespeichert)
    // === IMMOBILIEN-DATENMODELL ===
    // Liste von Immobilien mit Wert und Darlehen
    let immobilienData = [];

    // === VERMIETERKONTO-DATENMODELL ===
    // Separates Datenmodell für Einnahmen und Ausgaben
    let vermieterkontoData = {
        miete: 0,                   // Monatliche Mieteinnahmen
        sonstigeEinnahmen: 0,       // Sonstige monatliche Einnahmen
        rate: 0,                    // Monatliche Darlehensrate (kann auto-berechnet oder manuell sein)
        zinssatz: 0,                // Zinssatz in % (für Annuitätenberechnung)
        tilgungssatz: 0,            // Tilgungssatz in % (für Annuitätenberechnung)
        wertsteigerung: 0,          // Wertsteigerung in % pro Jahr
        instandhaltung: 0,          // Monatliche Instandhaltungsrücklage
        steuern: 0,                 // Monatliche Steuern & Nebenkosten
        cashflowIntegration: false  // Toggle: Flows ins Gesamtsystem integrieren
    };

    function getVermieterkontoData() {
        const einnahmen = vermieterkontoData.miete + vermieterkontoData.sonstigeEinnahmen;
        const ausgaben = vermieterkontoData.rate + vermieterkontoData.instandhaltung + vermieterkontoData.steuern;
        const saldo = einnahmen - ausgaben;

        // Berechne Gesamtdarlehen aus allen Immobilien
        const gesamtdarlehen = immobilienData.reduce((sum, immo) => sum + (immo.darlehen || 0), 0);

        return {
            einnahmen,      // Gesamt-Einnahmen
            ausgaben,       // Gesamt-Ausgaben
            saldo,          // Netto-Cashflow (kann positiv oder negativ sein)
            // Zur Info: Wie viel davon ist Tilgung? (später für Tooltip)
            tilgung: calculateTilgungsanteil(vermieterkontoData.rate, gesamtdarlehen)
        };
    }

    // Berechnet monatliche Darlehensrate (Annuität)
    function berechneDarlehensrate(darlehen, zinssatz, tilgungssatz) {
        if (!darlehen || darlehen === 0) return { gesamt: 0, zinsen: 0, tilgung: 0 };
        if (!zinssatz && !tilgungssatz) return { gesamt: 0, zinsen: 0, tilgung: 0 };

        const jahresrate = darlehen * (zinssatz + tilgungssatz) / 100;
        const monatsrate = jahresrate / 12;

        const zinsenMonatlich = (darlehen * zinssatz / 100) / 12;
        const tilgungMonatlich = monatsrate - zinsenMonatlich;

        return {
            gesamt: monatsrate,
            zinsen: zinsenMonatlich,
            tilgung: tilgungMonatlich
        };
    }

    // Hilfsfunktion: Berechnet ungefähren Tilgungsanteil (vereinfacht: 1-2% Zinsen angenommen)
    function calculateTilgungsanteil(rate, restdarlehen) {
        if (restdarlehen === 0 || rate === 0) return 0;
        // Wenn wir Zinssatz haben, nutze echte Berechnung
        if (vermieterkontoData.zinssatz > 0) {
            const zinsenMonatlich = (restdarlehen * vermieterkontoData.zinssatz / 100) / 12;
            return Math.max(0, rate - zinsenMonatlich);
        }
        // Fallback: Annahme 2% Zinsen
        const geschaetzterZins = restdarlehen * 0.02 / 12;
        return Math.max(0, rate - geschaetzterZins);
    }

    // Lädt Immobilien-Daten aus sessionStorage
    function loadImmobilienData() {
        const saved = sessionStorage.getItem('immobilienData');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // Kompatibilität: Altes Objekt-Format in Array konvertieren
                if (!Array.isArray(parsed)) {
                    immobilienData = [{ wert: parsed.wert || 0, darlehen: parsed.darlehen || 0 }];
                } else {
                    immobilienData = parsed;
                }
            } catch (e) {
                console.warn('Fehler beim Laden der Immobilien-Daten', e);
            }
        }
        updateImmobilienInputs();
        updateImmobilienSummary();
    }

    // Aktualisiert die Eingabefelder im Modal mit den gespeicherten Werten
    function updateImmobilienInputs() {
        // Quick-Fix: Zeige erste Immobilie im Modal
        const immo = immobilienData[0] || { wert: 0, darlehen: 0, darlehenOriginal: 0, zinssatz: 0, tilgungssatz: 0, wertsteigerung: 0 };

        if (getEl('immo-wert')) getEl('immo-wert').value = immo.wert || 0;
        if (getEl('immo-darlehen')) getEl('immo-darlehen').value = immo.darlehen || 0;
        if (getEl('immo-darlehen-original')) getEl('immo-darlehen-original').value = immo.darlehenOriginal || 0;
        if (getEl('immo-zinssatz')) getEl('immo-zinssatz').value = immo.zinssatz || 0;
        if (getEl('immo-tilgungssatz')) getEl('immo-tilgungssatz').value = immo.tilgungssatz || 0;
        if (getEl('immo-wertsteigerung')) getEl('immo-wertsteigerung').value = immo.wertsteigerung || 0;

        // Trigger Darlehensberechnung wenn Werte vorhanden
        if (immo.zinssatz > 0 || immo.tilgungssatz > 0) {
            updateImmoDarlehensrateBerechnung();
        }
    }

    // Berechnet und zeigt Nettovermögen an (Cashflow jetzt im Vermieterkonto)
    function updateImmobilienSummary() {
        const wert = parseFloat(getEl('immo-wert')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const nettovermoegen = wert - darlehen;

        const nettoEl = getEl('immo-nettovermoegen');

        if (nettoEl) {
            nettoEl.textContent = formatCurrency(nettovermoegen);
            nettoEl.className = `text-2xl font-bold ${nettovermoegen >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        // Cashflow-Element ausblenden (jetzt im Vermieterkonto)
        const cashflowContainer = getEl('immo-cashflow')?.parentElement;
        if (cashflowContainer) {
            cashflowContainer.style.display = 'none';
        }
    }

    // Speichert Immobilien-Daten und schließt Modal
    function saveImmobilien() {
        // Quick-Fix: Erstelle/Update erste Immobilie aus Modal-Daten
        // TODO: Später erweitern für mehrere Immobilien
        const wert = parseFloat(getEl('immo-wert')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const darlehenOriginal = parseFloat(getEl('immo-darlehen-original')?.value || 0);
        const zinssatz = parseFloat(getEl('immo-zinssatz')?.value || 0);
        const tilgungssatz = parseFloat(getEl('immo-tilgungssatz')?.value || 0);
        const wertsteigerung = parseFloat(getEl('immo-wertsteigerung')?.value || 0);

        if (immobilienData.length === 0) {
            immobilienData.push({ wert, darlehen, darlehenOriginal, zinssatz, tilgungssatz, wertsteigerung });
        } else {
            immobilienData[0] = { wert, darlehen, darlehenOriginal, zinssatz, tilgungssatz, wertsteigerung };
        }

        // Übertrage berechnete Rate ins Vermieterkonto
        // WICHTIG: Verwende darlehenOriginal für Berechnung (Annuität bleibt konstant!)
        // Falls darlehenOriginal nicht gesetzt, fallback auf aktuelles Restdarlehen
        const darlehenFuerBerechnung = darlehenOriginal > 0 ? darlehenOriginal : darlehen;

        if ((zinssatz > 0 || tilgungssatz > 0) && darlehenFuerBerechnung > 0) {
            const result = berechneDarlehensrate(darlehenFuerBerechnung, zinssatz, tilgungssatz);
            vermieterkontoData.rate = Math.round(result.gesamt); // Auf volle Euro runden
            vermieterkontoData.zinssatz = zinssatz;
            vermieterkontoData.tilgungssatz = tilgungssatz;
            vermieterkontoData.wertsteigerung = wertsteigerung;
            sessionStorage.setItem('vermieterkontoData', JSON.stringify(vermieterkontoData));
        }

        sessionStorage.setItem('immobilienData', JSON.stringify(immobilienData));
        calculateAndUpdate(); // Aktualisiert alle Basins inkl. Vermieterkonto
        closeModal('immobilien-modal');
    }

    // Event Listener für Immobilien-Inputs (Live-Update der Zusammenfassung)
    function setupImmobilienListeners() {
        const fields = ['wert', 'darlehen'];
        fields.forEach(field => {
            const input = getEl('immo-' + field);
            if (input) {
                input.addEventListener('input', updateImmobilienSummary);
            }
        });

        // Darlehens-Felder: Auto-Berechnung der Rate
        const darlehensFields = ['zinssatz', 'tilgungssatz', 'darlehen-original'];
        darlehensFields.forEach(field => {
            const input = getEl('immo-' + field);
            if (input) {
                input.addEventListener('input', updateImmoDarlehensrateBerechnung);
            }
        });

        // Wertsteigerung: Update Tilgungsplan
        const wertsteigerungInput = getEl('immo-wertsteigerung');
        if (wertsteigerungInput) {
            wertsteigerungInput.addEventListener('input', updateImmoTilgungsplan);
        }

        // Tilgungsplan-Slider
        const slider = getEl('immo-tilgungsplan-slider');
        if (slider) {
            slider.addEventListener('input', updateImmoTilgungsplan);
        }
    }

    // Darlehensberechnung für Immobilien-Modal
    function updateImmoDarlehensrateBerechnung() {
        const zinssatz = parseFloat(getEl('immo-zinssatz')?.value || 0);
        const tilgungssatz = parseFloat(getEl('immo-tilgungssatz')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const darlehenOriginal = parseFloat(getEl('immo-darlehen-original')?.value || 0);

        // WICHTIG: Verwende ursprüngliches Darlehen für Berechnung (Annuität bleibt konstant!)
        // Falls nicht gesetzt, fallback auf aktuelles Restdarlehen
        const darlehenFuerBerechnung = darlehenOriginal > 0 ? darlehenOriginal : darlehen;

        if (darlehenFuerBerechnung === 0 || (zinssatz === 0 && tilgungssatz === 0)) {
            // Verstecke Anzeige, wenn keine Berechnung möglich
            const display = getEl('immo-rate-berechnet-display');
            if (display) display.classList.add('hidden');

            const tilgungsplanSection = getEl('immo-tilgungsplan-section');
            if (tilgungsplanSection) tilgungsplanSection.classList.add('hidden');
            return;
        }

        // Berechne Rate mit ursprünglichem Darlehen
        const result = berechneDarlehensrate(darlehenFuerBerechnung, zinssatz, tilgungssatz);

        // Zeige berechnete Rate
        const display = getEl('immo-rate-berechnet-display');
        const wertEl = getEl('immo-rate-berechnet-wert');
        const zinsenEl = getEl('immo-rate-zinsen');
        const tilgungEl = getEl('immo-rate-tilgung');

        if (display) display.classList.remove('hidden');
        if (wertEl) wertEl.textContent = formatCurrency(result.gesamt);
        if (zinsenEl) zinsenEl.textContent = formatCurrency(result.zinsen);
        if (tilgungEl) tilgungEl.textContent = formatCurrency(result.tilgung);

        // Zeige Tilgungsplan
        const tilgungsplanSection = getEl('immo-tilgungsplan-section');
        if (tilgungsplanSection) tilgungsplanSection.classList.remove('hidden');

        // Initial Tilgungsplan aktualisieren
        updateImmoTilgungsplan();
    }

    // Tilgungsplan-Berechnung für Immobilien-Modal
    function updateImmoTilgungsplan() {
        const jahre = parseInt(getEl('immo-tilgungsplan-slider')?.value || 10);
        const jahreEl = getEl('immo-tilgungsplan-jahre');
        if (jahreEl) jahreEl.textContent = jahre;

        const zinssatz = parseFloat(getEl('immo-zinssatz')?.value || 0);
        const tilgungssatz = parseFloat(getEl('immo-tilgungssatz')?.value || 0);
        const wertsteigerung = parseFloat(getEl('immo-wertsteigerung')?.value || 0);
        const darlehen = parseFloat(getEl('immo-darlehen')?.value || 0);
        const darlehenOriginal = parseFloat(getEl('immo-darlehen-original')?.value || 0);
        const immowert = parseFloat(getEl('immo-wert')?.value || 0);

        if (darlehen === 0) return;

        // WICHTIG: Verwende ursprüngliches Darlehen für Ratenberechnung (Annuität konstant!)
        const darlehenFuerBerechnung = darlehenOriginal > 0 ? darlehenOriginal : darlehen;

        // Berechnung über Jahre (Tilgung beginnt bei aktuellem Restdarlehen)
        let restschuld = darlehen;
        let gezahlteZinsen = 0;
        const result = berechneDarlehensrate(darlehenFuerBerechnung, zinssatz, tilgungssatz);
        const monatsrate = result.gesamt;

        for (let monat = 1; monat <= jahre * 12; monat++) {
            const zinsenDiesenMonat = (restschuld * zinssatz / 100) / 12;
            const tilgungDiesenMonat = monatsrate - zinsenDiesenMonat;

            gezahlteZinsen += zinsenDiesenMonat;
            restschuld = Math.max(0, restschuld - tilgungDiesenMonat);

            if (restschuld === 0) break;
        }

        // Wertsteigerung der Immobilie
        const wertMitSteigerung = immowert * Math.pow(1 + wertsteigerung / 100, jahre);
        const eigenkapital = wertMitSteigerung - restschuld;

        // Anzeige aktualisieren
        const restschuldEl = getEl('immo-tilgungsplan-restschuld');
        const zinsenEl = getEl('immo-tilgungsplan-zinsen');
        const eigenkapitalEl = getEl('immo-tilgungsplan-eigenkapital');
        const wertEl = getEl('immo-tilgungsplan-wert');

        if (restschuldEl) restschuldEl.textContent = formatCurrency(restschuld);
        if (zinsenEl) zinsenEl.textContent = formatCurrency(gezahlteZinsen);
        if (eigenkapitalEl) eigenkapitalEl.textContent = formatCurrency(eigenkapital);
        if (wertEl) wertEl.textContent = formatCurrency(wertMitSteigerung);
    }

    // === END IMMOBILIEN FUNCTIONS ===

    // === VERMIETERKONTO FUNCTIONS ===
    function saveVermieterkonto() {
        // Zinssatz, Tilgungssatz, Wertsteigerung werden jetzt im Immobilien-Modal verwaltet
        // und automatisch beim Speichern der Immobilie ins vermieterkontoData übertragen
        vermieterkontoData.miete = parseFloat(getEl('vk-miete')?.value || 0);
        vermieterkontoData.sonstigeEinnahmen = parseFloat(getEl('vk-sonstige-einnahmen')?.value || 0);
        vermieterkontoData.rate = parseFloat(getEl('vk-rate')?.value || 0);
        vermieterkontoData.instandhaltung = parseFloat(getEl('vk-instandhaltung')?.value || 0);
        vermieterkontoData.steuern = parseFloat(getEl('vk-steuern')?.value || 0);
        vermieterkontoData.cashflowIntegration = getEl('vk-cashflow-integration')?.checked || false;

        sessionStorage.setItem('vermieterkontoData', JSON.stringify(vermieterkontoData));
        calculateAndUpdate();
        closeModal('vermieterkonto-modal');
    }

    // Event Listener für Vermieterkonto-Inputs (Live-Update der Zusammenfassung)
    function setupVermieterkontoListeners() {
        const fields = ['miete', 'sonstige-einnahmen', 'rate', 'instandhaltung', 'steuern'];
        fields.forEach(field => {
            const input = getEl('vk-' + field);
            if (input) {
                input.addEventListener('input', updateVermieterkontoSummary);
            }
        });
    }

    function updateVermieterkontoSummary() {
        const miete = parseFloat(getEl('vk-miete')?.value || 0);
        const sonstigeEinnahmen = parseFloat(getEl('vk-sonstige-einnahmen')?.value || 0);
        const rate = parseFloat(getEl('vk-rate')?.value || 0);
        const instandhaltung = parseFloat(getEl('vk-instandhaltung')?.value || 0);
        const steuern = parseFloat(getEl('vk-steuern')?.value || 0);

        const einnahmen = miete + sonstigeEinnahmen;
        const ausgaben = rate + instandhaltung + steuern;
        const saldo = einnahmen - ausgaben;

        // Zusammenfassung aktualisieren
        const einnahmenEl = getEl('vk-einnahmen-total');
        const ausgabenEl = getEl('vk-ausgaben-total');
        const saldoEl = getEl('vk-saldo');

        if (einnahmenEl) einnahmenEl.textContent = formatCurrency(einnahmen);
        if (ausgabenEl) ausgabenEl.textContent = formatCurrency(ausgaben);
        if (saldoEl) {
            saldoEl.textContent = formatCurrency(saldo);
            // Farbe je nach Saldo
            saldoEl.className = saldo >= 0
                ? 'text-2xl font-bold text-green-400'
                : 'text-2xl font-bold text-red-400';
        }
    }

    function loadVermieterkontoData() {
        const saved = sessionStorage.getItem('vermieterkontoData');
        if (saved) {
            try {
                vermieterkontoData = JSON.parse(saved);
            } catch (e) {
                console.error('Failed to load vermieterkonto data:', e);
            }
        }

        // Felder im Modal befüllen
        if (getEl('vk-miete')) getEl('vk-miete').value = vermieterkontoData.miete || 0;
        if (getEl('vk-sonstige-einnahmen')) getEl('vk-sonstige-einnahmen').value = vermieterkontoData.sonstigeEinnahmen || 0;
        if (getEl('vk-rate')) getEl('vk-rate').value = vermieterkontoData.rate || 0;
        if (getEl('vk-instandhaltung')) getEl('vk-instandhaltung').value = vermieterkontoData.instandhaltung || 0;
        if (getEl('vk-steuern')) getEl('vk-steuern').value = vermieterkontoData.steuern || 0;
        if (getEl('vk-cashflow-integration')) getEl('vk-cashflow-integration').checked = vermieterkontoData.cashflowIntegration || false;

        updateVermieterkontoSummary();
    }
    // === END VERMIETERKONTO FUNCTIONS ===

    // --- Helpers: Export current SVG flow and Chart.js chart as images ---
    async function svgToPngDataUrl(svgElement, scale = 2, bg = '#ffffff') {
      const rect = svgElement.getBoundingClientRect();

      // Get actual viewBox or use bounding box to ensure complete SVG capture
      const viewBox = svgElement.getAttribute('viewBox');
      let width = rect.width;
      let height = rect.height;

      if (viewBox) {
        const parts = viewBox.split(/\s+|,/);
        width = parseFloat(parts[2]) || rect.width;
        height = parseFloat(parts[3]) || rect.height;
      }

      // 1) Clone the on-screen SVG so we can preprocess without affecting UI
      const clone = svgElement.cloneNode(true);
      clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
      clone.setAttribute('width', width);
      clone.setAttribute('height', height);
      if (viewBox) clone.setAttribute('viewBox', viewBox);
      clone.removeAttribute('style');

      // 2) Remove mask for export (avoids black rectangle in rasterization)
      const visuals = clone.querySelector('#flow-visuals');
      if (visuals) visuals.removeAttribute('mask');

      // 3) Inject background rect (theme-aware)
      const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bgRect.setAttribute('x', '0');
      bgRect.setAttribute('y', '0');
      bgRect.setAttribute('width', '100%');
      bgRect.setAttribute('height', '100%');
      bgRect.setAttribute('fill', bg);
      clone.insertBefore(bgRect, clone.firstChild);

      // 4) Inline stroke colors on cloned paths (in case CSS vars don't carry over)
      try {
        const originalPaths = svgElement.querySelectorAll('.flow-path, .flow-path-animation, .flow-erase');
        const clonedPaths   = clone.querySelectorAll('.flow-path, .flow-path-animation, .flow-erase');
        clonedPaths.forEach((node, i) => {
          const src = originalPaths[i];
          if (!src) return;
          const cs = getComputedStyle(src);
          if (cs && cs.stroke && cs.stroke !== 'none') node.setAttribute('stroke', cs.stroke);
        });
      } catch (_) {}

      // 5) Serialize the prepared clone and draw it onto a canvas
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(clone);
      const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(800, Math.floor(width * scale));
      canvas.height = Math.max(600, Math.floor(height * scale));

      const ctx = canvas.getContext('2d');
      ctx.fillStyle = bg;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      await new Promise((resolve, reject) => {
        img.onload = () => {
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          URL.revokeObjectURL(url);
          resolve();
        };
        img.onerror = reject;
        img.src = url;
      });

      return canvas.toDataURL('image/jpeg', 0.95);
    }
    function getFlowSnapshotDataUrl() {
      const svg = document.getElementById('flow-svg');
      if (!svg) return null;
      return svgToPngDataUrl(svg, 2, '#ffffff');
    }
    function getChartImageDataUrl() {
      // existierende Instanz nutzen
      if (prognoseChartInstance && typeof prognoseChartInstance.toBase64Image === 'function') {
        try { return prognoseChartInstance.toBase64Image('image/png', 1.0); } catch (_) {}
      }
      // Fallback: temporären Chart rendern
      try {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 1000;
        tempCanvas.height = 420;
        const ctx = tempCanvas.getContext('2d');

        const years = parseInt(inputs.anlagezeitraum.value, 10) || 15;
        const dataRangeRaw = (renditeExtremes && renditeExtremes[years]) || getRenditeDataForPeriod(years);
        const dataRange = dataRangeRaw ? (dataRangeRaw.mean === undefined ? buildRenditeStat(dataRangeRaw.min, dataRangeRaw.max) : dataRangeRaw) : null;
        const initialDepot = parseFloat(inputs.depotCurrent.value) || 0;

        const depotSparplanTotal = fixkostenItems
          .filter(i => i.target === 'depot')
          .reduce((s, it) => s + getMonthlyAmount(it), 0);

        const { depotOverflow } = calculateOverflow(
          parseFloat(inputs.tagesgeldCurrent.value) || 0,
          parseFloat(inputs.tagesgeldLimit.value) || 0
        );
        const monthlyInvestment = depotSparplanTotal + depotOverflow;

        const toSeries = (rate) => calculateCompoundInterest(initialDepot, monthlyInvestment, years, rate / 100);
        const derivedMin = dataRange ? dataRange.min : (dataRangeRaw ? dataRangeRaw.min : 0);
        const derivedMax = dataRange ? dataRange.max : (dataRangeRaw ? dataRangeRaw.max : derivedMin);
        const derivedMean = dataRange ? dataRange.mean : ((Number.isFinite(derivedMin) && Number.isFinite(derivedMax)) ? (derivedMin + derivedMax) / 2 : derivedMin);

        const sMin = toSeries(derivedMin);
        const sAvg = toSeries(derivedMean);
        const sMax = toSeries(derivedMax);

        const tmpChart = new Chart(ctx, {
          type: 'line',
          data: { labels: sAvg.labels, datasets: [
            { label: 'Pessimistisch', data: sMin.capitalData, borderColor: '#ef4444', fill: false, tension: 0.1 },
            { label: 'Erwartet',      data: sAvg.capitalData, borderColor: '#3b82f6', fill: false, tension: 0.1 },
            { label: 'Optimistisch',  data: sMax.capitalData, borderColor: '#22c55e', fill: false, tension: 0.1 }
          ]},
          options: { responsive: false, animation: false, plugins: { legend: { display: false } } }
        });
        // Sicherstellen, dass gezeichnet wurde
        tmpChart.update();
        const url = tempCanvas.toDataURL('image/png');
        tmpChart.destroy();
        return url;
      } catch (_) {
        return null;
      }
    }

    // Helper: wait for one or more animation frames (lets layout/theme settle)
    async function waitFrames(n = 1) {
      for (let i = 0; i < n; i++) {
        await new Promise(res => requestAnimationFrame(res));
      }
    }

    async function waitForImages(container, timeout = 2500) {
      const imgs = Array.from(container.querySelectorAll('img'));
      const pending = imgs.filter(img => !img.complete || img.naturalWidth === 0);

      if (pending.length === 0) return;

      await Promise.race([
        Promise.all(pending.map(img => new Promise(res => {
          img.addEventListener('load', res, { once: true });
          img.addEventListener('error', res, { once: true }); // not blocking on error
          // Falls das Bild bereits „complete“ ist, sofort auflösen:
          if (img.complete && img.naturalWidth > 0) res();
        }))),
        new Promise(res => setTimeout(res, timeout))
      ]);
    }

    
    function buildBookingPlanPrintHtml() {
        const plan = bookingPlan || {};
        const bucket = plan[String(selectedBookingMonth)] || plan[BOOKING_KEY] || {};
        const days = Object.keys(bucket)
            .map(key => parseInt(key, 10))
            .filter(num => Number.isInteger(num))
            .sort((a, b) => a - b);
        if (!days.length) {
            return `
      <h2>Buchungskalender</h2>
      <p class="muted">Aktuell sind keine Buchungstage hinterlegt.</p>
    `;
        }
        const rows = days.map(dayNum => {
            const key = String(dayNum);
            const entries = Array.isArray(bucket[key]) ? bucket[key] : [];
            const content = entries
                .map(typeId => {
                    const type = getBookingType(typeId);
                    if (!type) return '';
                    const color = type.badgeColor || '#111827';
                    const iconMarkup = getActiveBookingIcon(type) || type.icon || '';
                    const label = getActiveBookingLabel(type) || type.label || '';
                    return `<div class="print-booking-entry"><span class="print-booking-icon" style="color:${color};">${iconMarkup}</span><span>${label}</span></div>`;
                })
                .filter(Boolean)
                .join('') || '<div class="print-booking-entry">-</div>';
            return `<tr><td>Tag ${dayNum}</td><td>${content}</td></tr>`;
        }).join('');
        return `<h2>Buchungskalender</h2><table class="print-table print-table-bookings"><thead><tr><th>Tag</th><th>Aktion</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    async function prepareAndPrint() {
        const report = getEl('printable-report');

        // --- Force LIGHT THEME for export/print snapshot ---
        const prevTheme = loadTheme();           // 'dark' | 'light'
        applyTheme('light');                     // switch UI tokens
        saveTheme('light');

        // Re-render flows so computed styles & erase strokes match light mode
        calculateAndUpdate();
        await waitFrames(3);                     // let DOM/layout settle

        const themeNote = 'MLP Hell';

        // 1) Gather current inputs (after potential UI changes)
        const incomeVal = formatCurrency(inputs.income.value);
        const konsumMinVal = formatCurrency(inputs.konsumMin.value);
        const konsumLeftoverVal = formatCurrency(inputs.konsumLeftover.value);
        const tgCurVal = formatCurrency(inputs.tagesgeldCurrent.value);
        const tgLimitVal = formatCurrency(inputs.tagesgeldLimit.value);
        const depotCurVal = formatCurrency(inputs.depotCurrent.value);
        const jahre = parseInt(inputs.anlagezeitraum.value, 10);
        const renditeAnn = parseFloat(inputs.rendite.value).toFixed(1) + ' %';

        // 2) Export visualizations (always white background)
        const flowImg = await svgToPngDataUrl(getEl('flow-svg'), 1.2, '#ffffff');
        const chartImg = getChartImageDataUrl();

        // 3) Build Fixkosten & Depot tables
        const fixRows = fixkostenItems.map(i => `<tr><td>${i.name}</td><td>${formatCurrency(i.amount)}</td><td>${i.interval}</td><td>${i.target}</td></tr>`).join('');

        // Calculate sum of fixkosten (convert to monthly)
        const fixkostenSumme = fixkostenItems.reduce((sum, i) => {
            const amount = i.amount || 0;
            const monthly = i.interval === 'quarterly' ? amount / 3 : (i.interval === 'annually' ? amount / 12 : amount);
            return sum + monthly;
        }, 0);

        // Get Vermieterkonto data if exists
        const vermieterData = getVermieterkontoData();
        const hasVermieterData = vermieterData && (vermieterData.einnahmen > 0 || vermieterData.ausgaben > 0);

        // Add Vermieterkonto cashflow row if exists
        let vermieterRow = '';
        let vermieterMonthly = 0;
        if (hasVermieterData) {
            const cashflow = vermieterData.saldo;
            vermieterMonthly = Math.abs(cashflow);
            const cashflowText = cashflow >= 0
                ? `<span class="text-positive">+${formatCurrency(cashflow)}</span>`
                : `<span class="text-negative">-${formatCurrency(Math.abs(cashflow))}</span>`;
            const ziel = currentVariant === 'A' ? 'fixkosten' : 'konsum';
            vermieterRow = `<tr><td>Cashflow Vermieterkonto</td><td>${cashflowText}</td><td>monatlich</td><td>${ziel}</td></tr>`;
        }

        // Calculate total including Vermieterkonto
        const fixkostenTotal = fixkostenSumme + (hasVermieterData && vermieterData.saldo < 0 ? Math.abs(vermieterData.saldo) : 0);
        const sumRow = `<tr class="sum-row"><th>Summe (monatlich)</th><th>${formatCurrency(fixkostenTotal)}</th><th colspan="2"></th></tr>`;

        const depRows = depotItems.map(i => `<tr><td>${i.name}</td><td>${i.allocation}%</td></tr>`).join('');

        // 4) Get session data
        const session = getCurrentSession();
        const kundenKuerzel = session?.kundenKuerzel || 'N/A';
        const berater = session?.berater || 'N/A';

        // 5) Compose report HTML (theme-neutral for print)
        let html = `
          <h1>Zusammenfassung: Das intelligente Vermögensmanagement</h1>
          <p class="muted">Planung für: <strong>${kundenKuerzel}</strong> • von: <strong>${berater}</strong></p>
          <p class="muted">Variante: <strong>${currentVariant}</strong> • Theme: <strong>${themeNote}</strong> • Datum: ${new Date().toLocaleDateString('de-DE')}</p>

          <h2>Ihre Planung</h2>
          <table class="print-table">
            <tbody>
              <tr><th style="width:40%">Nettoeinkommen</th><td>${incomeVal}</td></tr>
              <tr><th>Konsumkonto Mindestbestand</th><td>${konsumMinVal}</td></tr>
              <tr><th>Geschätzter monatlicher Überschuss</th><td>${konsumLeftoverVal}</td></tr>
              <tr><th>Tagesgeldkonto (aktuell)</th><td>${tgCurVal}</td></tr>
              <tr><th>Tagesgeldkonto (Sparziel)</th><td>${tgLimitVal}</td></tr>
              <tr><th>Depotstand (aktuell)</th><td>${depotCurVal}</td></tr>
              <tr><th>Anlagezeitraum</th><td>${jahre} Jahre</td></tr>
              <tr><th>Rendite-Annahme</th><td>${renditeAnn}</td></tr>
            </tbody>
          </table>

          <h2>Fixkosten &amp; Sparpläne</h2>
          <table class="print-table"><thead><tr><th>Posten</th><th>Betrag</th><th>Intervall</th><th>Ziel</th></tr></thead><tbody>${fixRows}${vermieterRow}${sumRow}</tbody></table>

          <h2>Depot-Aufteilung</h2>
          <table class="print-table"><thead><tr><th>Fonds/ETF</th><th>Verteilung</th></tr></thead><tbody>${depRows}</tbody></table>
        `;

        // Add Immobilien section if data exists
        if (immobilienData && immobilienData.length > 0) {
            const immoRows = immobilienData.map(immo => {
                const wert = immo.wert || 0;
                const darlehen = immo.darlehen || 0;
                const eigenkapital = wert - darlehen;
                return `<tr><td>${immo.name || 'Objekt'}</td><td>${formatCurrency(wert)}</td><td>${formatCurrency(darlehen)}</td><td>${formatCurrency(eigenkapital)}</td></tr>`;
            }).join('');

            const gesamtwert = immobilienData.reduce((sum, immo) => sum + (immo.wert || 0), 0);
            const gesamtdarlehen = immobilienData.reduce((sum, immo) => sum + (immo.darlehen || 0), 0);
            const gesamtEigenkapital = gesamtwert - gesamtdarlehen;

            const sumRowImmo = `<tr class="sum-row"><th>Gesamt</th><th>${formatCurrency(gesamtwert)}</th><th>${formatCurrency(gesamtdarlehen)}</th><th>${formatCurrency(gesamtEigenkapital)}</th></tr>`;

            html += `
              <h2>Immobilien-Portfolio</h2>
              <table class="print-table">
                <thead><tr><th>Objekt</th><th>Marktwert</th><th>Darlehen</th><th>Eigenkapital</th></tr></thead>
                <tbody>${immoRows}${sumRowImmo}</tbody>
              </table>
            `;

            // Add details about rates and appreciation if available
            if (vermieterkontoData.zinssatz > 0 || vermieterkontoData.wertsteigerung > 0) {
                const details = [];
                if (vermieterkontoData.wertsteigerung > 0) {
                    details.push(`Wertsteigerung: ${vermieterkontoData.wertsteigerung}% p.a.`);
                }
                if (vermieterkontoData.zinssatz > 0) {
                    details.push(`Zinssatz: ${vermieterkontoData.zinssatz}%`);
                }
                if (vermieterkontoData.tilgungssatz > 0) {
                    details.push(`Tilgung: ${vermieterkontoData.tilgungssatz}%`);
                }
                if (details.length > 0) {
                    html += `<p class="muted">${details.join(' • ')}</p>`;
                }
            }
        }

        // Add Vermieterkonto section if data exists
        if (hasVermieterData) {
            const einnahmenRows = [];
            if (vermieterkontoData.miete > 0) {
                einnahmenRows.push(`<tr><td>Mieteinnahmen</td><td class="text-positive">+${formatCurrency(vermieterkontoData.miete)}</td></tr>`);
            }
            if (vermieterkontoData.sonstigeEinnahmen > 0) {
                einnahmenRows.push(`<tr><td>Sonstige Einnahmen</td><td class="text-positive">+${formatCurrency(vermieterkontoData.sonstigeEinnahmen)}</td></tr>`);
            }
            einnahmenRows.push(`<tr class="sum-row"><th>Gesamt-Einnahmen</th><th class="text-positive">+${formatCurrency(vermieterData.einnahmen)}</th></tr>`);

            const ausgabenRows = [];
            if (vermieterkontoData.rate > 0) {
                ausgabenRows.push(`<tr><td>Darlehensrate</td><td class="text-negative">-${formatCurrency(vermieterkontoData.rate)}</td></tr>`);
            }
            if (vermieterkontoData.instandhaltung > 0) {
                ausgabenRows.push(`<tr><td>Instandhaltung</td><td class="text-negative">-${formatCurrency(vermieterkontoData.instandhaltung)}</td></tr>`);
            }
            if (vermieterkontoData.steuern > 0) {
                ausgabenRows.push(`<tr><td>Steuern &amp; Nebenkosten</td><td class="text-negative">-${formatCurrency(vermieterkontoData.steuern)}</td></tr>`);
            }
            ausgabenRows.push(`<tr class="sum-row"><th>Gesamt-Ausgaben</th><th class="text-negative">-${formatCurrency(vermieterData.ausgaben)}</th></tr>`);

            const saldoClass = vermieterData.saldo >= 0 ? 'text-positive' : 'text-negative';
            const saldoSign = vermieterData.saldo >= 0 ? '+' : '-';
            const cashflowRow = `<tr class="sum-row" style="background-color: #f9fafb;"><th>Netto-Cashflow (monatlich)</th><th class="${saldoClass}">${saldoSign}${formatCurrency(Math.abs(vermieterData.saldo))}</th></tr>`;

            html += `
              <h2>Vermieterkonto (Cashflow-Analyse)</h2>
              <table class="print-table">
                <tbody>
                  ${einnahmenRows.join('')}
                  ${ausgabenRows.join('')}
                  ${cashflowRow}
                </tbody>
              </table>
            `;

            // Integration status
            if (vermieterkontoData.cashflowIntegration) {
                html += `<p class="muted">✅ Cashflows sind ins Gesamtsystem integriert</p>`;
            }

            // Tilgung info
            if (vermieterData.tilgung > 0) {
                html += `<p class="muted">ℹ️ Davon Tilgung (Vermögensaufbau): ${formatCurrency(vermieterData.tilgung)}/Monat</p>`;
            }
        }

        html += buildBookingPlanPrintHtml(); // (Überschrift wird unten im <section> gesetzt)
        report.innerHTML = html;

        // Eigene Seite vorbereiten
        const section = document.createElement('section');
        section.className = 'print-finanzfluss';
        // Fallbacks für Browser, die die CSS-Regel ignorieren
        section.style.breakBefore = 'page';
        section.style.pageBreakBefore = 'always';
        section.innerHTML = `<h2>Dein Finanzfluss (aktueller Stand)</h2>`;

        // Live-DOM klonen: Ströme + Konten + Werte
        const live = getEl('flow-container');
        if (live) {
          const clone = live.cloneNode(true);
          clone.id = 'flow-container-print';

          // Interaktivität entfernen (keine Modals im Print)
          clone.querySelectorAll('[onclick]').forEach(n => n.removeAttribute('onclick'));

          // Deterministische Größe wie im Live-UI
          const cs = getComputedStyle(live);
          clone.style.position = 'relative';
          clone.style.minHeight = cs.minHeight || '1150px';
          clone.style.height    = cs.height || '1150px';
          // NO width constraint - let print CSS handle scaling

          const holder = document.createElement('div');
          holder.style.marginTop = '8px';
          holder.appendChild(clone);
          section.appendChild(holder);
        }

        // Abschnitt (eigene Seite) anhängen
        report.appendChild(section);

        // NEU: sicherstellen, dass die <img>-Tags wirklich fertig sind
        await waitForImages(report, 2500);
        await waitFrames(1); // ein Frame für Layout

        // 5) Print
        const restoreTheme = () => {
          // Restore theme
          applyTheme(prevTheme || 'dark');
          saveTheme(prevTheme || 'dark');
          calculateAndUpdate();
        };
        const onAfterPrint = () => { window.removeEventListener('afterprint', onAfterPrint); restoreTheme(); };
        window.addEventListener('afterprint', onAfterPrint);
        window.print();
    }
    
    // --- THEME HANDLING (Dark/MLP Light) ---
    function applyTheme(theme) {
        const root = document.getElementById('theme-root');
        if (!root) return;
        root.classList.remove('theme-dark','theme-light');
        root.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');

        // Flow gradient colors adapt to theme
        const grad = document.querySelector('#flow-gradient');
        if (grad) {
            const stops = grad.querySelectorAll('stop');
            if (stops.length >= 2) {
                if (theme === 'light') {
                    // Pure MLP blue stream
                    stops[0].setAttribute('style', 'stop-color: var(--mlp-blue-1);');
                    stops[1].setAttribute('style', 'stop-color: var(--mlp-blue-1);');
                } else {
                    // force classic dark gradient
                    stops[0].setAttribute('style', 'stop-color: #3b82f6;');
                    stops[1].setAttribute('style', 'stop-color: #6366f1;');
                }
            }
        }
    }
    function loadTheme() {
        try { return localStorage.getItem('vd_theme') || 'dark'; } catch(_) { return 'dark'; }
    }
    function saveTheme(theme) {
        try { localStorage.setItem('vd_theme', theme); } catch(_) {}
    }

    // ===== KEYBOARD SHORTCUTS & EMERGENCY ACCESS (v1.3.8) =====

    // Global keyboard shortcuts for critical functions
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Shift + E = Emergency JSON Export
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            console.log('🚨 Emergency Export triggered via keyboard');
            exportAsJSON(false);
            showToast('Notfall-Export erstellt!', 'success', 3000);
        }

        // Ctrl/Cmd + Shift + D = Emergency Print/PDF (D wie Druck)
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            console.log('🚨 Emergency Print triggered via keyboard');
            prepareAndPrint();
        }

        // Ctrl/Cmd + Shift + S = Show Session Menu (even if hidden)
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            const buttonContainer = getEl('session-button-container');
            if (buttonContainer) {
                buttonContainer.style.display = 'block';
                toggleSessionMenu();
                console.log('🚨 Session-Menü erzwungen (Notfall-Zugriff)');
            }
        }

        // Ctrl/Cmd + Shift + C = Export CSV
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            console.log('🚨 Emergency CSV Export triggered via keyboard');
            exportAsCSV();
            showToast('CSV-Export erstellt!', 'success', 3000);
        }
    });

    // Console helper functions (accessible via browser console)
    window.mlpEmergency = {
        exportJSON: () => {
            exportAsJSON(false);
            console.log('✅ JSON-Export erstellt');
        },
        exportCSV: () => {
            exportAsCSV();
            console.log('✅ CSV-Export erstellt');
        },
        print: () => {
            prepareAndPrint();
            console.log('✅ Druck-Dialog geöffnet');
        },
        showSession: () => {
            const buttonContainer = getEl('session-button-container');
            if (buttonContainer) buttonContainer.style.display = 'block';
            toggleSessionMenu();
            console.log('✅ Session-Menü angezeigt');
        },
        help: () => {
            console.log(`
🚨 MLP NOTFALL-FUNKTIONEN:

Keyboard-Shortcuts:
- Ctrl+Shift+E: JSON-Export
- Ctrl+Shift+C: CSV-Export
- Ctrl+Shift+D: PDF drucken (D = Druck)
- Ctrl+Shift+S: Session-Menü öffnen

Console-Commands:
- mlpEmergency.exportJSON()  → JSON exportieren
- mlpEmergency.exportCSV()   → CSV exportieren
- mlpEmergency.print()       → PDF drucken
- mlpEmergency.showSession() → Session-Menü zeigen
- mlpEmergency.help()        → Diese Hilfe

Diese Funktionen funktionieren auch wenn das UI nicht reagiert!
            `);
        }
    };

    // Show help on load
    console.log('💡 Notfall-Zugriff: mlpEmergency.help() für Hilfe');

    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        // === SESSION INITIALIZATION (v1.2.0) ===

        // Initialize File System Access API (v1.3.7)
        restoreAutoExportDirectory();

        // Check for existing session or show start dialog
        const existingSession = getCurrentSession();

        // Check if we just imported a backup (skip recovery dialog)
        const skipRecovery = sessionStorage.getItem('skipRecoveryDialog');
        if (skipRecovery) {
            sessionStorage.removeItem('skipRecoveryDialog');
            // Imported session - continue directly without asking
            if (existingSession) {
                updateSessionInfoBar();
                startSessionTimer();
                resetInactivityTimers();
                console.log('📥 Importierte Session fortgesetzt:', existingSession.id);
            }
        } else if (existingSession) {
            // Session found - show recovery dialog
            const sessionAge = new Date() - new Date(existingSession.startzeit);
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours

            if (sessionAge > maxAge) {
                // Session too old, discard and start new
                sessionStorage.clear();
                showSessionStartDialog();
            } else {
                // Session valid, offer recovery
                showSessionRecoveryDialog(existingSession);
            }
        } else {
            // No session, show start dialog
            showSessionStartDialog();
        }
        // === END SESSION INITIALIZATION ===

        inputs = { income: getEl('income'), konsumMin: getEl('konsumMin'), konsumLeftover: getEl('konsumLeftover'), tagesgeldCurrent: getEl('tagesgeldCurrent'), tagesgeldLimit: getEl('tagesgeldLimit'), depotCurrent: getEl('depotCurrent'), anlagezeitraum: getEl('anlagezeitraum'), rendite: getEl('rendite') };

        // Restore input values from sessionStorage (after import reload)
        try {
            const savedInputs = sessionStorage.getItem('mlp_inputs');
            if (savedInputs) {
                const inputValues = JSON.parse(savedInputs);
                if (inputs.income) inputs.income.value = inputValues.income || 3000;
                if (inputs.konsumMin) inputs.konsumMin.value = inputValues.konsumMin || 100;
                if (inputs.konsumLeftover) inputs.konsumLeftover.value = inputValues.konsumLeftover || 250;
                if (inputs.tagesgeldCurrent) inputs.tagesgeldCurrent.value = inputValues.tagesgeldCurrent || 4800;
                if (inputs.tagesgeldLimit) inputs.tagesgeldLimit.value = inputValues.tagesgeldLimit || 5000;
                if (inputs.depotCurrent) inputs.depotCurrent.value = inputValues.depotCurrent || 25000;
                if (inputs.anlagezeitraum) inputs.anlagezeitraum.value = inputValues.anlagezeitraum || 15;
                if (inputs.rendite) inputs.rendite.value = inputValues.rendite || 7;
                console.log('✅ Input-Werte aus sessionStorage wiederhergestellt');
                // Clear after restore to prevent stale data
                sessionStorage.removeItem('mlp_inputs');
            }
        } catch (e) {
            console.error('Fehler beim Laden der Input-Werte aus sessionStorage:', e);
        }

        basins = { einkommen: getEl('einkommen-basin'), fixkosten: getEl('fixkosten-basin'), konsum: getEl('konsum-basin'), tagesgeld: getEl('tagesgeld-basin'), depot: getEl('depot-basin'), vermieterkonto: getEl('vermieterkonto-basin'), immobilien: getEl('immobilien-basin') };
        flowContainer = getEl('flow-container');
        flowSvg = getEl('flow-svg');
        setupBookingPlanner();

        // THEME init
        const themeSwitch = getEl('theme-switch');
        const initialTheme = loadTheme(); // 'dark' | 'light'
        applyTheme(initialTheme);
        if (themeSwitch) {
            // checked == Dark (rechts), unchecked == MLP Light (links)
            themeSwitch.checked = (initialTheme === 'dark');
            themeSwitch.addEventListener('change', (e) => {
                const t = e.target.checked ? 'dark' : 'light';
                applyTheme(t);
                saveTheme(t);
                // Nach Themewechsel neu zeichnen
                calculateAndUpdate();
            });
        }

        // AUTO-SAVE TOGGLE init
        const autoSaveToggle = getEl('auto-save-toggle');
        if (autoSaveToggle) {
            // Initialize UI based on saved preference
            updateAutoSaveUI();

            // Add event listener
            autoSaveToggle.addEventListener('change', (e) => {
                toggleAutoSave(e.target.checked);
            });
        }

        const anlagezeitraumLabel = getEl('anlagezeitraum-label');
        const variantSwitch = getEl('variant-switch');
        const varianteALabel = getEl('variante-a-label');
        const varianteBLabel = getEl('variante-b-label');
        const variantInfo = getEl('variant-info');

        function setVariantUI() {
            if (variantSwitch) {
                variantSwitch.checked = (currentVariant === 'B');
            }
            if (currentVariant === 'A') {
                if (varianteALabel) varianteALabel.classList.add('chip-state--active');
                if (varianteBLabel) varianteBLabel.classList.remove('chip-state--active');
                if (variantInfo) variantInfo.textContent = 'Variante A: Einkommen geht auf das Fixkostenkonto.';
            } else {
                if (varianteBLabel) varianteBLabel.classList.add('chip-state--active');
                if (varianteALabel) varianteALabel.classList.remove('chip-state--active');
                if (variantInfo) variantInfo.textContent = 'Variante B: Einkommen geht auf das Konsumkonto.';
            }
            renderBookingTypeButtons();
            renderBookingCalendar();
            updateBookingHint();
            // Keep consultation view consistent when variant changes
            applyConsultationVisibility();
            calculateAndUpdate();
        }

        if (variantSwitch) {
            variantSwitch.addEventListener('change', (e) => {
                currentVariant = e.target.checked ? 'B' : 'A';
                setVariantUI();
            });
        }

        const observer = new ResizeObserver(() => calculateAndUpdate());
        observer.observe(flowContainer);
        
        setTimeout(() => {
            renderFixkostenList();
            renderDepotList();
            loadImmobilienData();        // Immobilien-Daten laden
            setupImmobilienListeners();  // Event-Listener für Immobilien-Inputs
            loadVermieterkontoData();    // Vermieterkonto-Daten laden
            setupVermieterkontoListeners(); // Event-Listener für Vermieterkonto-Inputs
            setVariantUI();
            updateRenditeSuggestions(parseInt(inputs.anlagezeitraum.value, 10));
            calculateAndUpdate();

            // Load fine-grained min/max ranges from TXT (MLP-Dreieck)
            loadRenditeExtremes();

            // Helper function to update range slider fill (v1.5.0)
            function updateRangeSliderFill(slider) {
                if (!slider) return;
                const min = parseInt(slider.min) || 0;
                const max = parseInt(slider.max) || 100;
                const value = parseInt(slider.value) || 0;
                const percentage = ((value - min) / (max - min)) * 100;

                const color1 = getComputedStyle(document.documentElement).getPropertyValue('--mlp-blue').trim() || '#002f6c';
                const color2 = document.body.classList.contains('theme-light') ? '#e5e7eb' : 'rgba(100, 116, 139, 0.3)';

                slider.style.background = `linear-gradient(to right, ${color1} 0%, ${color1} ${percentage}%, ${color2} ${percentage}%, ${color2} 100%)`;
            }

            // Keep info live while sliding (v1.5.0 - with null-check)
            if (inputs.anlagezeitraum) {
                inputs.anlagezeitraum.addEventListener('input', () => {
                    const jahre = parseInt(inputs.anlagezeitraum.value, 10);
                    const label = getEl('anlagezeitraum-label');
                    if (label) label.textContent = `${jahre} Jahre`;
                    updateRenditeSuggestions(jahre);
                    // Update slider fill dynamically
                    updateRangeSliderFill(inputs.anlagezeitraum);
                    // Auto-Prognose (v1.4.0)
                    debouncedProjection();
                });

                // Initialize slider fill AND label on load (v1.5.0 fix)
                const currentValue = parseInt(inputs.anlagezeitraum.value, 10);
                const label = getEl('anlagezeitraum-label');
                if (label) label.textContent = `${currentValue} Jahre`;
                updateRangeSliderFill(inputs.anlagezeitraum);
            } else {
                console.error('[MLP ERROR] Anlagezeitraum slider not found!');
            }

            // ===== AUTO-PROGNOSE (v1.4.0) =====
            // Auto-calculate projection on depot input changes
            if (inputs.depotCurrent) {
                inputs.depotCurrent.addEventListener('input', () => {
                    debouncedProjection();
                });
            }
            if (inputs.rendite) {
                inputs.rendite.addEventListener('input', () => {
                    debouncedProjection();
                });
            }

            // Beratungsansicht Buttons (Old - Sidebar)
            const consultToggle = getEl('consult-toggle-btn');
            const consultNext   = getEl('consult-next-btn');
            if (consultToggle) consultToggle.addEventListener('click', () => setConsultationMode(!consultationMode));
            if (consultNext)   consultNext.addEventListener('click', () => nextConsultationStep());

            // ===== INLINE EDITOR EVENT LISTENERS (v1.4.0) =====
            // Add click listeners to editable basins
            if (basins.einkommen) {
                basins.einkommen.addEventListener('click', (e) => {
                    // Only open if not already editing
                    if (!basins.einkommen.querySelector('.basin-inline-editor')) {
                        openInlineEditor(e, 'einkommen');
                    }
                });
            }
            if (basins.konsum) {
                basins.konsum.addEventListener('click', (e) => {
                    if (!basins.konsum.querySelector('.basin-inline-editor')) {
                        openInlineEditor(e, 'konsum');
                    }
                });
            }
            if (basins.tagesgeld) {
                basins.tagesgeld.addEventListener('click', (e) => {
                    if (!basins.tagesgeld.querySelector('.basin-inline-editor')) {
                        openInlineEditor(e, 'tagesgeld');
                    }
                });
            }

            // ===== CONTROL BAR EVENT LISTENERS (v1.4.0) =====
            // Theme Toggle
            const themeSwitchBar = getEl('theme-switch-bar');
            if (themeSwitchBar) {
                themeSwitchBar.checked = (initialTheme === 'dark');
                themeSwitchBar.addEventListener('change', (e) => {
                    const t = e.target.checked ? 'dark' : 'light';
                    applyTheme(t);
                    saveTheme(t);
                    calculateAndUpdate();
                    // Sync with old sidebar switch
                    if (themeSwitch) themeSwitch.checked = e.target.checked;
                });
            }

            // Variant Toggle
            const variantSwitchBar = getEl('variant-switch-bar');
            const varianteALabelBar = getEl('variante-a-label-bar');
            const varianteBLabelBar = getEl('variante-b-label-bar');
            if (variantSwitchBar) {
                variantSwitchBar.addEventListener('change', (e) => {
                    currentVariant = e.target.checked ? 'B' : 'A';
                    // Update Control Bar UI
                    if (varianteALabelBar && varianteBLabelBar) {
                        if (currentVariant === 'A') {
                            varianteALabelBar.classList.add('bar-state--active');
                            varianteBLabelBar.classList.remove('bar-state--active');
                        } else {
                            varianteBLabelBar.classList.add('bar-state--active');
                            varianteALabelBar.classList.remove('bar-state--active');
                        }
                    }
                    // Update old sidebar UI
                    setVariantUI();
                    // Sync with old sidebar switch
                    if (variantSwitch) variantSwitch.checked = e.target.checked;
                });
            }

            // Consultation Buttons
            const consultToggleBar = getEl('consult-toggle-btn-bar');
            const consultNextBar = getEl('consult-next-btn-bar');
            if (consultToggleBar) {
                consultToggleBar.addEventListener('click', () => {
                    setConsultationMode(!consultationMode);
                });
            }
            if (consultNextBar) {
                consultNextBar.addEventListener('click', () => {
                    nextConsultationStep();
                });
            }

            // ===== BOOKING FAB (v1.4.0) =====
            const bookingFab = getEl('booking-fab');
            const bookingModal = getEl('booking-modal');

            if (bookingFab) {
                bookingFab.addEventListener('click', () => {
                    console.log('📅 Booking FAB clicked');
                    openBookingModal();
                });
            } else {
                console.error('❌ Booking FAB not found!');
            }

            // Close modal on backdrop click
            if (bookingModal) {
                bookingModal.addEventListener('click', (e) => {
                    if (e.target === bookingModal) {
                        closeBookingModal();
                    }
                });
            }

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && bookingModal && bookingModal.classList.contains('active')) {
                    closeBookingModal();
                }
            });
        }, 100);
    });
    </script>

    <!-- ===== SESSION UI ELEMENTS (v1.2.0) ===== -->

    <!-- Elegant Session Button (Top Left) -->
    <div id="session-button-container" style="display: none;" class="fixed top-4 left-4 z-50">
        <button onclick="toggleSessionMenu()" id="session-menu-button" class="group bg-gray-800 bg-opacity-80 backdrop-blur-sm hover:bg-opacity-95 text-gray-300 hover:text-white px-3 py-2 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2 border border-gray-700 hover:border-gray-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span class="text-xs font-medium">Session</span>
            <svg id="session-menu-chevron" class="w-3 h-3 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>

        <!-- Dropdown Menu -->
        <div id="session-dropdown" style="display: none;" class="absolute top-full left-0 mt-2 w-72 bg-gray-800 bg-opacity-95 backdrop-blur-md rounded-lg shadow-2xl border border-gray-700 overflow-hidden">
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Session-ID</span>
                    <span id="session-id-display" class="text-xs font-mono text-white bg-gray-900 px-2 py-1 rounded">-</span>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Kunde</span>
                    <span id="session-kunden-display" class="text-xs text-white">-</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Dauer</span>
                    <span id="session-timer" class="text-xs font-semibold text-green-400">0 Min.</span>
                </div>
            </div>
            <div class="p-2 border-b border-gray-700">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2">Auto-Export</div>
                <div class="px-3 py-2 mb-2">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs text-gray-400">Automatische Speicherung</span>
                        <label class="switch">
                            <input type="checkbox" id="auto-save-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between text-xs mb-2">
                        <span class="text-gray-400">Zielordner:</span>
                        <span id="auto-export-folder-display" class="font-mono text-xs">
                            <span class="text-gray-400">📥 Download-Ordner</span>
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">Letzter Export:</span>
                        <span id="auto-export-status" class="font-mono">
                            <span class="text-yellow-400">⏳ Wartet...</span>
                        </span>
                    </div>
                    <p id="auto-save-interval-info" class="text-xs text-gray-500 mt-2">Automatisch alle 2 Minuten</p>
                </div>
                <button onclick="selectAutoExportDirectory();" class="w-full text-left px-3 py-2 mb-1 text-sm text-blue-400 hover:bg-blue-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                    Ordner auswählen
                </button>
                <button onclick="exportAsJSON(true); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-green-400 hover:bg-green-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Jetzt exportieren
                </button>
            </div>
            <div class="p-2 border-b border-gray-700">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2">Manueller Export</div>
                <button onclick="exportAsCSV(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:bg-opacity-50 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Als CSV exportieren
                </button>
                <button onclick="exportAsJSON(false); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:bg-opacity-50 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
                    </svg>
                    Als JSON exportieren
                </button>
                <button onclick="prepareAndPrint(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:bg-opacity-50 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Als PDF drucken
                </button>
            </div>
            <div class="p-2 border-b border-gray-700">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2">Import</div>
                <button onclick="importSessionBackup(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-blue-400 hover:bg-blue-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Session importieren
                </button>
            </div>
            <div class="p-2">
                <button onclick="showSessionEndDialog(); toggleSessionMenu();" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-red-900 hover:bg-opacity-30 rounded transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    Session beenden
                </button>
            </div>
            <div class="px-3 py-2 border-t border-gray-700">
                <div class="text-xs text-gray-500 text-center">
                    <span class="font-mono">v1.3.8</span>
                </div>
                <div class="text-xs text-gray-600 text-center mt-1">
                    Notfall: <kbd class="text-xs">Ctrl+Shift+E</kbd>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CONTROL BAR (v1.4.0) ===== -->
    <div id="control-bar">
        <!-- Theme Toggle -->
        <label class="control-bar-item control-bar-item--theme" title="Darstellung wechseln">
            <input type="checkbox" id="theme-switch-bar" aria-label="Theme umschalten (Hell/Dunkel)">
            <span class="bar-icon" aria-hidden="true">
                <svg class="icon icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="4" />
                    <path d="M12 2v2" />
                    <path d="M12 20v2" />
                    <path d="M4.93 4.93l1.42 1.42" />
                    <path d="M17.65 17.65l1.42 1.42" />
                    <path d="M2 12h2" />
                    <path d="M20 12h2" />
                    <path d="M4.93 19.07l1.42-1.42" />
                    <path d="M17.65 6.35l1.42-1.42" />
                </svg>
                <svg class="icon icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79z" />
                </svg>
            </span>
        </label>

        <!-- Variant Toggle (A/B) -->
        <label class="control-bar-item control-bar-item--variant" title="Variante A/B umschalten">
            <input type="checkbox" id="variant-switch-bar" aria-label="Variante A/B umschalten">
            <span class="bar-pair" aria-hidden="true">
                <span id="variante-a-label-bar" class="bar-state bar-state--active">A</span>
                <span id="variante-b-label-bar" class="bar-state">B</span>
            </span>
        </label>

        <!-- Consultation Button -->
        <div class="control-bar-item control-bar-item--consultation" title="Beratung">
            <button id="consult-toggle-btn-bar" class="bar-button" type="button" aria-label="Beratung starten">
                <svg class="icon icon-mlp" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="10" cy="12" r="5.5" stroke="currentColor" stroke-width="1.6" fill="none" />
                    <path d="M10 8.5v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                    <path d="M18 7h3v10h-3z" fill="currentColor" />
                </svg>
            </button>
            <button id="consult-next-btn-bar" class="bar-button hidden" type="button" aria-label="Weiter zur naechsten Beratungsphase" title="Weiter zur naechsten Beratungsphase">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14" />
                    <path d="M13 6l6 6-6 6" />
                </svg>
            </button>
        </div>
    </div>

    <!-- ===== BOOKING FAB (v1.4.0) ===== -->
    <button id="booking-fab" aria-label="Buchungskalender öffnen">
        <span class="fab-label">Buchungskalender</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
    </button>

    <!-- Booking Modal -->
    <div id="booking-modal">
        <div class="booking-modal-content">
            <div class="booking-modal-header">
                <h2>Buchungskalender</h2>
                <button class="booking-modal-close" onclick="closeBookingModal()" aria-label="Schließen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="booking-modal-body" id="booking-modal-body">
                <!-- Content will be moved here from sidebar -->
            </div>
        </div>
    </div>

    <!-- Session Start Dialog -->
    <div id="session-start-dialog" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Neue Beratung beginnen</h2>
            <p class="text-gray-300 mb-6">
                Starten Sie eine neue Beratungssession. Alle Daten werden nur während der Session gespeichert und beim Schließen automatisch gelöscht.
            </p>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="session-kunden-kuerzel" class="block text-sm font-semibold text-gray-300 mb-2">
                        Kundenkürzel (optional)
                    </label>
                    <input type="text" id="session-kunden-kuerzel"
                           placeholder="z.B. MX-2025-001"
                           class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-gray-500 mt-1">Für interne Zuordnung. Keine persönlichen Daten!</p>
                </div>

                <div>
                    <label for="session-berater" class="block text-sm font-semibold text-gray-300 mb-2">
                        Berater (optional)
                    </label>
                    <input type="text" id="session-berater"
                           placeholder="Ihr Name"
                           class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="startSessionFromDialog()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Session starten
                </button>
            </div>

            <div class="mt-4">
                <div class="text-center">
                    <span class="text-gray-500 text-sm">oder</span>
                </div>
                <button onclick="importSessionBackup(); closeModal('session-start-dialog');" class="w-full mt-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Session-Backup importieren
                </button>
            </div>

            <div id="privacy-notice-box" class="mt-4 p-4 bg-blue-900 bg-opacity-50 rounded-lg">
                <p class="text-sm text-gray-300 mb-3">
                    <strong>ℹ️ Datenschutz & DSGVO-Konformität:</strong>
                </p>
                <ul class="text-xs text-gray-300 space-y-1 mb-3 ml-4 list-disc">
                    <li>Alle Daten werden <strong>nur in Ihrem Browser</strong> gespeichert (sessionStorage)</li>
                    <li><strong>Keine Cloud</strong>, keine Datenbank, kein Server-Upload</li>
                    <li>Beim Schließen des Tabs werden <strong>alle Daten automatisch gelöscht</strong></li>
                    <li>Export nur manuell durch Sie (PDF, CSV, JSON)</li>
                    <li>Session-Daten bleiben bei Ihnen - <strong>100% DSGVO-konform</strong></li>
                </ul>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="privacy-understood-checkbox" class="w-4 h-4 rounded">
                    <span class="text-xs text-gray-400">Verstanden, diesen Hinweis nicht mehr anzeigen</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Session Recovery Dialog -->
    <div id="session-recovery-dialog" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Vorherige Session gefunden</h2>
            <p class="text-gray-300 mb-4">
                Eine vorherige Beratungssession wurde gefunden. Möchten Sie diese fortsetzen?
            </p>

            <div id="recovery-session-info" class="bg-gray-800 p-4 rounded-lg mb-6 text-sm text-gray-300">
                <!-- Wird dynamisch befüllt -->
            </div>

            <div class="flex gap-3">
                <button onclick="continueSession()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Fortsetzen
                </button>
                <button onclick="startNewSessionAndDiscard()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Neue Session
                </button>
            </div>
        </div>
    </div>

    <!-- Session End Dialog -->
    <div id="session-end-dialog" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Beratung beenden?</h2>
            <p class="text-gray-300 mb-6">
                Alle Daten werden gelöscht. Möchten Sie vor dem Beenden die Daten exportieren?
            </p>

            <div class="bg-yellow-900 bg-opacity-50 border border-yellow-600 rounded-lg p-4 mb-6">
                <p class="text-sm text-yellow-200">
                    <strong>Warnung:</strong> Diese Aktion kann nicht rückgängig gemacht werden!
                </p>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="endSession(true)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Exportieren & Beenden
                </button>
                <button onclick="endSession(false)" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Ohne Export beenden
                </button>
                <button onclick="closeModal('session-end-dialog')" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>

    <!-- ===== END SESSION UI ELEMENTS ===== -->

    <script src="scripts/a11y.js" defer></script>
    <script src="scripts/autoRecalc.js" defer></script>
    <script src="scripts/variantFix.js" defer></script>
    <script src="scripts/reloadButton.js" defer></script>
    <script src="scripts/recalcFab.js" defer></script>
    <script src="scripts/removeHeaderIcon.js" defer></script>
</body>
</html>
